# ガントチャート機能 実装計画

> **ステータス**: 計画段階
> **作成日**: 2026-01-27
> **関連文書**: [GANTT_CHART_SPEC.md](./GANTT_CHART_SPEC.md)

---

## 1. プロジェクト概要

### 1.1 目標
- バグを最小限に抑えた高品質な実装
- 段階的な実装による確実な進行
- 既存コードとの整合性維持

### 1.2 成功基準
- 全テストケースが通過
- 既存機能への影響なし
- レスポンシブ対応完了

---

## 2. 前準備（実装開始前に完了すべき事項）

### 2.1 仕様確認 ✅
- [x] 表示内容の決定
- [x] 時間軸の決定（日単位・終日）
- [x] 配置場所の決定（新規タブ）
- [x] 予定作成方法の決定（自動生成+手動）
- [x] 削除時の挙動決定
- [x] 色の割り当て方法決定

### 2.2 既存コード調査
- [ ] 見積データ構造の詳細確認
- [ ] 休日・休暇データ構造の確認
- [ ] Canvas描画パターンの確認（report.jsのグラフ実装）
- [ ] モーダル実装パターンの確認
- [ ] localStorage保存パターンの確認

### 2.3 設計文書作成
- [ ] データ構造設計書
- [ ] 関数設計書（主要関数のシグネチャ）
- [ ] UI設計書（HTML構造）

---

## 3. 実装フェーズ（更新版）

### Phase 1: 基盤構築 + 基本表示

#### Step 1.1: データ層
**ファイル**: `js/state.js`, `js/storage.js`, `js/constants.js`

| # | タスク | 確認方法 |
|---|--------|----------|
| 1 | `schedules` 配列を state.js に追加 | コンソールで変数確認 |
| 2 | `nextScheduleId` を state.js に追加 | コンソールで変数確認 |
| 3 | storage.js の `loadData()` を拡張 | リロード後にデータ復元確認 |
| 4 | storage.js の `saveData()` を拡張 | localStorageにschedules保存確認 |
| 5 | constants.js にスケジュール関連定数追加 | - |

**完了条件**: `schedules` が正しく保存・読み込みされる

#### Step 1.2: HTMLタブ構造
**ファイル**: `index.html`, `style.css`

| # | タスク | 確認方法 |
|---|--------|----------|
| 1 | タブボタン「スケジュール」追加 | 画面に表示確認 |
| 2 | タブコンテンツ `#schedule` 追加 | タブ切替で表示確認 |
| 3 | サマリーパネル領域 | レイアウト確認 |
| 4 | Canvasガントチャート領域 | レイアウト確認 |
| 5 | ツールバー（月移動、表示切替ボタン） | ボタン表示確認 |
| 6 | style.css にスタイル追加 | 見た目確認 |

**完了条件**: タブ切替が正常に動作、レイアウト完成

#### Step 1.3: ガントチャート描画（基本）
**ファイル**: `js/schedule-render.js`（新規作成）

| # | タスク | 確認方法 |
|---|--------|----------|
| 1 | Canvas初期化・リサイズ対応 | Canvas表示確認 |
| 2 | 日付ヘッダー描画（日・曜日） | ヘッダー表示確認 |
| 3 | 休日・祝日の背景色描画 | 背景色確認 |
| 4 | 今日ライン描画 | 縦線表示確認 |
| 5 | 月移動処理（前月/次月/今日） | ナビゲーション確認 |
| 6 | 担当者行の描画 | 行表示確認 |

**完了条件**: 空のガントチャートが正しく描画される

---

### Phase 2: 予定作成・操作

#### Step 2.1: 予定作成機能
**ファイル**: `js/schedule.js`（新規作成）, `js/schedule-modal.js`（新規作成）

| # | タスク | 確認方法 |
|---|--------|----------|
| 1 | 終了日自動計算ロジック（営業日ベース） | ユニットテスト |
| 2 | `addSchedule(data)` - 予定追加 | コンソールテスト |
| 3 | `updateSchedule(id, data)` - 予定更新 | コンソールテスト |
| 4 | `deleteSchedule(id)` - 予定削除 | コンソールテスト |
| 5 | 予定作成モーダルHTML/CSS | モーダル表示確認 |
| 6 | 見積データとの連携（版数/タスク/工程選択） | ドロップダウン動作確認 |
| 7 | 着手日選択 → 終了日自動表示 | 計算結果確認 |

**完了条件**: モーダルから予定を作成できる

#### Step 2.2: 計画バー描画
**ファイル**: `js/schedule-render.js`

| # | タスク | 確認方法 |
|---|--------|----------|
| 1 | 予定バーの位置・幅計算 | バー表示確認 |
| 2 | タスク名ラベル表示 | ラベル確認 |
| 3 | 色の自動割り当て | 色確認 |
| 4 | 行の折りたたみ機能 | 折りたたみ動作確認 |
| 5 | 表示モード切替（担当者→タスク / タスク→担当者） | 切替動作確認 |

**完了条件**: 予定がバーとして正しく表示される

#### Step 2.3: ドラッグ&ドロップ操作
**ファイル**: `js/schedule-render.js`, `js/schedule.js`

| # | タスク | 確認方法 |
|---|--------|----------|
| 1 | バーのマウスイベント検出 | クリック反応確認 |
| 2 | ドラッグ開始処理 | ドラッグ開始確認 |
| 3 | ドラッグ中のプレビュー表示 | プレビュー確認 |
| 4 | ドロップ時の着手日更新 | 日付更新確認 |
| 5 | キャンセル処理（Escキー） | キャンセル動作確認 |

**完了条件**: ドラッグで着手日を変更できる

#### Step 2.4: 予定編集・削除
**ファイル**: `js/schedule-modal.js`

| # | タスク | 確認方法 |
|---|--------|----------|
| 1 | バークリックで詳細モーダル表示 | モーダル表示確認 |
| 2 | 着手日変更 | 更新確認 |
| 3 | 削除（確認ダイアログ付き） | 削除確認 |

**完了条件**: モーダルから編集・削除ができる

---

### Phase 3: 実績連携・進捗表示

#### Step 3.1: 実績データとの連携
**ファイル**: `js/schedule.js`, `js/schedule-render.js`

| # | タスク | 確認方法 |
|---|--------|----------|
| 1 | 予定と実績のマッチングロジック | マッチング確認 |
| 2 | 実績バーの描画（計画バーの上に重ねる） | 2層表示確認 |
| 3 | 進捗率計算（実績時間÷見積時間） | 計算確認 |

**完了条件**: 計画と実績が2層で表示される

#### Step 3.2: 進捗・遅延表示
**ファイル**: `js/schedule-render.js`

| # | タスク | 確認方法 |
|---|--------|----------|
| 1 | 進捗率のバー上表示 | パーセント表示確認 |
| 2 | 遅延検出（計画終了日 < 今日 && 未完了） | 検出確認 |
| 3 | 遅延バーの赤ハイライト | 色確認 |
| 4 | 残作業時間の計算・表示 | 残時間確認 |

**完了条件**: 進捗状況が視覚的にわかる

#### Step 3.3: サマリーパネル
**ファイル**: `js/schedule.js`, `index.html`

| # | タスク | 確認方法 |
|---|--------|----------|
| 1 | 完了タスク数の集計 | 数値確認 |
| 2 | 遅延タスク数の集計 | 数値確認 |
| 3 | 残作業時間の集計 | 数値確認 |
| 4 | サマリーパネルUI | 表示確認 |

**完了条件**: サマリーが正しく表示される

---

### Phase 4: 機能拡充（オプション）

- 週表示モード
- 一括予定作成（版数単位で自動割り当て）
- フィルタリング（担当者、版数、タスク）
- 工程順序の自動調整（設計→実装→テスト）
- Excel出力

---

## 4. テスト戦略

### 4.1 各ステップの完了確認
各ステップ完了時に以下を確認:
1. 新機能の動作確認
2. 既存機能への影響確認（リグレッション）
3. ブラウザのコンソールエラーなし

### 4.2 テストデータ
開発用のテストデータを準備:

```javascript
// テスト用予定データ
const testSchedules = [
  {
    id: "sch_test_001",
    member: "田中",
    version: "1.0",
    task: "機能A",
    process: "設計",
    startDate: "2026-01-15",
    endDate: "2026-01-17",
    color: "#4A90D9",
    autoGenerated: false
  },
  // ... 複数パターン用意
];
```

### 4.3 テストチェックリスト

#### データ操作
- [ ] 予定追加: 必須項目のみで追加成功
- [ ] 予定追加: 全項目入力で追加成功
- [ ] 予定追加: 必須項目不足でエラー
- [ ] 予定追加: 開始日 > 終了日でエラー
- [ ] 予定編集: 正常に更新される
- [ ] 予定削除: 正常に削除される
- [ ] localStorage: 保存・読み込みが正常

#### 表示
- [ ] 月表示: 正しい日数が表示される
- [ ] 月表示: 月移動で正しく更新される
- [ ] 予定バー: 正しい位置・長さで表示
- [ ] 予定バー: 複数予定が重ならない
- [ ] 休日: 背景色が正しい
- [ ] 今日ライン: 正しい位置に表示

#### 自動生成
- [ ] 見積から予定が正しく生成される
- [ ] 土日がスキップされる
- [ ] 祝日がスキップされる
- [ ] 個人休暇がスキップされる

#### 統合
- [ ] 見積削除時に確認ダイアログ表示
- [ ] バックアップに予定データ含まれる
- [ ] リストアで予定データ復元される

---

## 5. リスク管理

### 5.1 想定リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 既存機能の破壊 | 高 | 各ステップで既存機能のテスト |
| Canvas描画のパフォーマンス | 中 | 100件程度で負荷テスト |
| 日付計算のバグ | 中 | エッジケース（月末、年末）のテスト |
| localStorageの容量超過 | 低 | データ量の監視 |

### 5.2 ロールバック計画
各フェーズ完了時にGitコミットを作成し、問題発生時にロールバック可能にする。

```bash
# コミットポイント
git commit -m "feat(schedule): Phase 1 Step 1.1 - データ層実装"
git commit -m "feat(schedule): Phase 1 Step 1.2 - HTMLタブ構造"
# ...
```

---

## 6. 作業見積（目安）

> **注意**: 時間見積は参考値です。実際の進行状況に応じて調整してください。

| フェーズ | ステップ数 | 複雑度 |
|----------|------------|--------|
| Phase 1 | 5 | 基本 |
| Phase 2 | 3 | 中 |
| Phase 3 | 4 | 高（オプション） |

---

## 7. 開始前の準備事項（ユーザー側）

### 7.1 必要な準備
1. **現在のデータのバックアップ**
   - 設定タブ → バックアップ → エクスポート
   - 万が一の場合に備えて保存

2. **テスト環境の準備**（推奨）
   - 本番データとは別に、テスト用のブラウザ/プロファイルを用意
   - または、テスト用のダミーデータで作業

### 7.2 確認いただきたい事項
- 仕様書の内容に問題がないか
- 実装の優先度（Phase 1を先に完成させるか、Phase 2まで一気に進めるか）
- 追加の要望や変更点

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|----------|------|
| 2026-01-27 | 初版作成 | Claude |

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥æ•°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@holiday-jp/holiday_jp/holiday_jp.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Yu Gothic', 'Meiryo', sans-serif;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 15px;
        }

        h1 {
            font-size: 22px;
            margin-bottom: 8px;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .tabs {
            display: flex;
            gap: 4px;
            background: #ecf0f1;
            padding: 8px;
            overflow-x: auto;
        }

        .tab {
            padding: 10px 16px;
            background: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }

        .tab.active {
            color: white;
        }

        /* ãƒ†ãƒ¼ãƒãŒé©ç”¨ã•ã‚Œã¦ã„ãªã„ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
        .tab.active:not([class*="tab-theme-"]) {
            background: #3498db;
        }

        .content {
            padding: 15px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 13px;
        }

        input, select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .quick-input {
            padding: 15px;
            border-radius: 10px;
            color: white;
            margin-bottom: 15px;
        }

        .quick-form {
            display: grid;
            gap: 8px;
            margin-top: 10px;
        }

        /* è¦‹ç©ãƒ†ãƒ¼ãƒ–ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .estimate-table {
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .estimate-table th {
            background: #e8f5e9;
            color: #2c3e50;
            font-size: 12px;
            font-weight: 600;
            padding: 8px;
            border-bottom: 2px solid #4caf50;
        }

        .estimate-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #eee;
        }

        .estimate-table select,
        .estimate-table input {
            padding: 6px 8px;
            font-size: 13px;
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            min-width: 600px;
        }

        th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            white-space: nowrap;
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        /* ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        table tr td:first-child,
        table tr th:first-child {
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
        }

        table tr th:first-child {
            z-index: 2;
        }

        /* rowspanå›ºå®šåˆ—ã®æ”¹å–„ - ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯æ”¹è¡Œã—ãªã„ */
        table td[rowspan] {
            white-space: nowrap;
            position: sticky;
            left: 0;
            z-index: 1;
        }

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸‹ã§æ”¹è¡Œã‚’è¨±å¯ */
        @media (max-width: 1024px) {
            table td[rowspan] {
                white-space: normal;
                word-wrap: break-word;
                overflow-wrap: break-word;
                max-width: 14vw; /* ç”»é¢å¹…ã®14% (16%â†’14%) */
            }

            table tr td:first-child {
                max-width: 14vw;
                white-space: normal;
                word-wrap: break-word;
            }
        }

        /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®å›ºå®šåˆ—ã®å¹…åˆ¶é™ */
        @media (max-width: 768px) {
            /* æ—¥åˆ¥åˆè¨ˆåˆ—ã‚’éè¡¨ç¤ºã«ã—ã¦ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¯€ç´„ */
            .daily-total {
                display: none !important;
            }

            /* ã™ã¹ã¦ã®th, tdã®min-widthã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
            table th,
            table td {
                min-width: auto !important;
                padding: 4px 6px;
            }

            table td[rowspan] {
                max-width: 16vw; /* ç”»é¢å¹…ã®16% (18%â†’16%) */
                padding: 6px 4px;
            }

            table tr td:first-child,
            table tr th:first-child {
                max-width: 16vw;
                min-width: 70px !important; /* å›ºå®šåˆ—ã®æœ€å°å¹…ã‚’70pxã«åˆ¶é™ (80â†’70) */
                padding: 6px 4px;
            }
        }

        /* å°å‹ãƒ¢ãƒã‚¤ãƒ« */
        @media (max-width: 480px) {
            /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«ç¸®å° */
            table th,
            table td {
                padding: 3px 4px;
            }

            table td[rowspan] {
                max-width: 20vw; /* ç”»é¢å¹…ã®20% (25%â†’20%) */
                padding: 4px 3px;
            }

            table tr td:first-child,
            table tr th:first-child {
                max-width: 20vw;
                min-width: 60px !important; /* å›ºå®šåˆ—ã®æœ€å°å¹…ã‚’60pxã«åˆ¶é™ (70â†’60) */
                padding: 4px 3px;
            }

            /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã‚’ã•ã‚‰ã«ç¸®å° */
            .content {
                padding: 8px !important;
            }

            /* ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã•ã‚‰ã«ç¸®å° */
            .version-header {
                padding: 6px 10px !important;
                font-size: 14px !important;
                margin-bottom: 8px !important;
            }

            /* ã‚«ãƒ¼ãƒ‰è¦ç´ ã‚’ã•ã‚‰ã«ç¸®å° */
            [style*="padding: 15px"],
            [style*="padding: 20px"],
            [style*="padding: 10px"] {
                padding: 8px !important;
            }

            /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å…¨ä½“çš„ã«ç¸®å° */
            h3 {
                font-size: 14px !important;
                margin-bottom: 8px !important;
            }
        }

        /* é€±æœ«ãƒ»ç¥æ—¥ã®è¡Œã®å›ºå®šåˆ—èƒŒæ™¯è‰² */
        table tr[style*="ffebee"] td:first-child,
        table tr[style*="ffebee"] td[rowspan] {
            background: #ffebee;
        }

        /* å°è¨ˆè¡Œ */
        table tr[style*="fff3cd"] td:first-child,
        table tr[style*="fff3cd"] td[rowspan] {
            background: #fff3cd;
        }

        /* ç‰ˆæ•°åˆè¨ˆè¡Œï¼ˆã‚°ãƒ¬ãƒ¼èƒŒæ™¯ï¼‰ */
        table tr[style*="f5f5f5"] td:first-child {
            background: #f5f5f5;
        }

        /* ç·åˆè¨ˆè¡Œï¼ˆæ¿ƒã„ã‚°ãƒ¬ãƒ¼ï¼‰ */
        table tr[style*="2c3e50"] td:first-child,
        table tr[style*="2c3e50"] td[rowspan] {
            background: #2c3e50;
            color: white;
        }

        /* ç·åˆè¨ˆè¡Œï¼ˆé’ï¼‰ */
        table tr[style*="1565c0"] td:first-child,
        table tr[style*="1565c0"] td[rowspan],
        table tr[style*="1565c0"] th:first-child {
            background: #1565c0;
            color: white;
        }

        /* ç¥æ—¥è¡¨ç¤ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–åˆ¶å¾¡ */
        /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: 1è¡Œã§è¡¨ç¤º */
        .holiday-inline {
            display: inline;
        }
        .holiday-break {
            display: none;
        }

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸‹: 2è¡Œã§è¡¨ç¤º */
        @media (max-width: 1024px) {
            .holiday-inline {
                display: none;
            }
            .holiday-break {
                display: inline;
            }
        }

        /* å¯¾å¿œåã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆç¥æ—¥ã¨åŒã˜æ–¹å¼ï¼‰ */
        /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: 1è¡Œã§è¡¨ç¤º */
        .task-separator-inline {
            display: inline;
        }
        .task-separator-break {
            display: none;
        }

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸‹: ã€Œ:ã€ã€Œï¼šã€ã§æ”¹è¡Œ */
        @media (max-width: 1024px) {
            .task-separator-inline {
                display: none;
            }
            .task-separator-break {
                display: inline;
            }
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.2s;
            align-items: flex-start;
            justify-content: center;
            padding-top: 3%;
            box-sizing: border-box;
        }

        .custom-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            margin-top: 4px;
        }

        .custom-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
            font-size: 14px;
            color: #333;
        }

        .custom-dropdown-item:last-child {
            border-bottom: none;
        }

        .custom-dropdown-item:hover {
            background-color: #e3f2fd;
            color: #000;
        }

        .custom-dropdown-item.selected {
            background-color: #e3f2fd;
            color: #000;
        }

        .custom-dropdown-empty {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 14px;
        }

        #quickTaskSearch {
            cursor: text;
        }

        #quickTaskSearch:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .modal-content {
            background-color: white;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
        }

        .modal-header {
            color: white;
            padding: 12px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²ï¼ˆãƒ†ãƒ¼ãƒé©ç”¨å‰ï¼‰ */
        .modal-header:not([class*="modal-theme-"]) {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ãƒ†ãƒ¼ãƒè‰² */
        .modal-theme-purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .modal-theme-deep-blue { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); }
        .modal-theme-teal { background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); }
        .modal-theme-cyan { background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); }
        .modal-theme-ocean { background: linear-gradient(135deg, #0c4a6e 0%, #0284c7 100%); }
        .modal-theme-sky { background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%); }
        .modal-theme-indigo { background: linear-gradient(135deg, #4338ca 0%, #6366f1 100%); }
        .modal-theme-navy { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .modal-theme-slate { background: linear-gradient(135deg, #334155 0%, #475569 100%); }
        .modal-theme-green { background: linear-gradient(135deg, #047857 0%, #10b981 100%); }
        .modal-theme-emerald { background: linear-gradient(135deg, #059669 0%, #34d399 100%); }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
        }

        .modal-close:hover {
            opacity: 0.8;
        }

        .modal-body {
            padding: 15px 20px;
            overflow-y: auto;
            max-height: 75vh;
        }

        .work-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .work-item:last-child {
            margin-bottom: 0;
        }

        .work-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .work-item-title {
            font-weight: 600;
            font-size: 15px;
            color: #2c3e50;
        }

        .work-item-hours {
            font-size: 18px;
            font-weight: 700;
            color: #3498db;
        }

        .work-item-details {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .work-item-details span {
            display: inline-block;
            margin-right: 12px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-ui { background: #e3f2fd; color: #1976d2; }
        .badge-pg { background: #f3e5f5; color: #7b1fa2; }
        .badge-pt { background: #fff3e0; color: #f57c00; }
        .badge-it { background: #e8f5e9; color: #388e3c; }
        .badge-st { background: #fce4ec; color: #c2185b; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            padding: 20px;
            border-radius: 10px;
            color: white;
        }

        .stat-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ¬ãƒãƒ¼ãƒˆé›†è¨ˆã‚«ãƒ¼ãƒ‰ã®æœ€é©åŒ– */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 10px;
                margin-bottom: 15px;
            }

            .stat-card {
                padding: 12px;
                border-radius: 8px;
            }

            .stat-card h3 {
                font-size: 11px;
                margin-bottom: 6px;
            }

            .stat-card .value {
                font-size: 22px;
            }

            .stat-card > div:last-child {
                font-size: 10px !important;
            }

            /* ãƒ¬ãƒãƒ¼ãƒˆåˆ†æãƒ‘ãƒãƒ«ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
            #reportDetailView > div {
                margin: 15px 0 !important;
                padding: 15px !important;
            }

            #reportDetailView h3 {
                font-size: 15px !important;
            }

            #reportDetailView h4 {
                font-size: 14px !important;
            }

            /* æ‹…å½“è€…ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚°ãƒªãƒƒãƒ‰ã®æœ€å°å¹…ã‚’èª¿æ•´ */
            #reportDetailView [style*="grid-template-columns"] {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
            }

            h1 {
                font-size: 18px;
            }

            .header-buttons {
                flex-direction: column;
            }

            .header-buttons .btn {
                width: 100%;
            }

            .quick-form {
                grid-template-columns: 1fr;
            }

            /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ä½™ç™½ã‚’ç¸®å° */
            .modal-content {
                margin: 2% auto;
                width: 95%;
            }

            /* è¦‹ç©ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
            .estimate-table-wrapper {
                /* overflow-xå‰Šé™¤ã§å…¨åˆ—è¡¨ç¤º */
            }

            .estimate-table {
                display: table;
                table-layout: fixed;
                width: 100%;
                min-width: 100%;
            }

            .estimate-table th,
            .estimate-table td {
                padding: 4px 6px;
            }

            /* è¦‹ç©ç™»éŒ²ã®å„åˆ—å¹…ã‚’ãƒ¢ãƒã‚¤ãƒ«ç”¨ã«èª¿æ•´ */
            .estimate-table th:nth-child(1),
            .estimate-table td:nth-child(1) {
                width: 20%;
            }

            .estimate-table th:nth-child(2),
            .estimate-table td:nth-child(2) {
                width: 42%;
            }

            .estimate-table th:nth-child(3),
            .estimate-table td:nth-child(3) {
                width: 38%;
            }

            .estimate-table td:nth-child(2) select {
                font-size: 12px;
                padding: 4px 6px;
                width: 100%;
                box-sizing: border-box;
            }

            .estimate-table td:nth-child(3) input {
                font-size: 12px;
                padding: 4px 6px;
                width: 100%;
                box-sizing: border-box;
            }

            table {
                font-size: 13px;
            }

            /* è¦‹ç©ä¸€è¦§ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ç¤ºå°‚ç”¨ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
            table.estimate-grouped,
            table.estimate-matrix {
                min-width: 100% !important;
            }

            table.estimate-grouped th,
            table.estimate-grouped td,
            table.estimate-matrix th,
            table.estimate-matrix td {
                padding: 4px 3px !important;
            }

            /* å®Ÿç¸¾ä¸€è¦§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºå°‚ç”¨ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
            table.actual-matrix {
                min-width: 100% !important;
            }

            table.actual-matrix th,
            table.actual-matrix td {
                padding: 4px 3px !important;
            }

            /* æ—¥ä»˜åˆ—ï¼ˆå›ºå®šå¹…ï¼‰ */
            table.actual-matrix th:first-child,
            table.actual-matrix td:first-child {
                width: 70px !important;
                min-width: 70px !important;
                max-width: 70px !important;
                padding: 4px 3px !important;
            }

            /* æ‹…å½“è€…åˆ—ãƒ»åˆè¨ˆåˆ— */
            table.actual-matrix th:not(:first-child),
            table.actual-matrix td:not(:first-child) {
                width: 55px !important;
                min-width: 55px !important;
                max-width: 55px !important;
                text-align: center !important;
            }

            /* å¯¾å¿œååˆ—ï¼ˆrowspanï¼‰ - ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºå°‚ç”¨ */
            table.estimate-grouped td[rowspan]:first-child,
            table.estimate-grouped td[rowspan]:nth-child(2) {
                width: 85px !important;
                min-width: 85px !important;
                max-width: 85px !important;
                padding: 6px 4px !important;
            }

            /* å·¥ç¨‹åˆ— - ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºå°‚ç”¨ */
            table.estimate-grouped td:not([rowspan]):nth-child(2),
            table.estimate-grouped td:not([rowspan]):nth-child(3) {
                width: 50px !important;
                min-width: 50px !important;
                max-width: 50px !important;
            }

            /* æ‹…å½“åˆ— - ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºå°‚ç”¨ */
            table.estimate-grouped td:not([rowspan]):nth-child(3),
            table.estimate-grouped td:not([rowspan]):nth-child(4) {
                width: 50px !important;
                min-width: 50px !important;
                max-width: 50px !important;
            }

            /* å·¥æ•°åˆ— - ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºå°‚ç”¨ */
            table.estimate-grouped td:not([rowspan]):nth-child(4),
            table.estimate-grouped td:not([rowspan]):nth-child(5) {
                width: 45px !important;
                min-width: 45px !important;
                max-width: 45px !important;
            }

            /* å¯¾å¿œåˆè¨ˆåˆ—ï¼ˆrowspanã€ç·¨é›†ãƒ¢ãƒ¼ãƒ‰OFFæ™‚ã¯æœ€å¾Œã®åˆ—ï¼‰ - ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºå°‚ç”¨ */
            table.estimate-grouped td[rowspan]:nth-last-child(1) {
                width: 75px !important;
                padding: 6px 4px !important;
                min-width: 75px !important;
                max-width: 75px !important;
            }

            /* å¯¾å¿œåˆè¨ˆåˆ—ï¼ˆrowspanã€ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ONæ™‚ã¯æœ€å¾Œã‹ã‚‰2ç•ªç›®ã®åˆ—ï¼‰ - ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºå°‚ç”¨ */
            table.estimate-grouped td[rowspan]:nth-last-child(2) {
                width: 75px !important;
                padding: 6px 4px !important;
                min-width: 75px !important;
                max-width: 75px !important;
            }

            /* å¯¾å¿œåˆè¨ˆã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ç¸®å° - ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºå°‚ç”¨ */
            table.estimate-grouped td[rowspan] > div:first-child {
                font-size: 14px !important;
            }

            table.estimate-grouped td[rowspan] > div:last-child {
                font-size: 10px !important;
            }

            /* å¯¾å¿œåˆè¨ˆã®äººæ—¥/äººæœˆã‚’ç¸¦ä¸¦ã³ã«ã™ã‚‹ */
            #estimateList .manpower-display {
                display: flex !important;
                flex-direction: column !important;
                line-height: 1.4 !important;
            }

            /* æ“ä½œåˆ—ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ONæ™‚ã®ã¿è¡¨ç¤ºï¼‰ - ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤ºå°‚ç”¨ */
            table.estimate-grouped td:last-child {
                width: 65px !important;
                min-width: 65px !important;
                max-width: 65px !important;
            }

            /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç¸®å° */
            .content {
                padding: 10px;
            }

            /* ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç¸®å° */
            .version-header {
                padding: 8px 12px !important;
                font-size: 16px !important;
                margin-bottom: 10px !important;
            }

            /* ã‚«ãƒ¼ãƒ‰è¦ç´ ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ãƒãƒ¼ã‚¸ãƒ³ã‚’ç¸®å° */
            [style*="padding: 15px"],
            [style*="padding: 20px"] {
                padding: 10px !important;
            }

            /* h3ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’ç¸®å° */
            h3 {
                margin-bottom: 10px !important;
            }

            /* ä½œæ¥­æœˆå‰²ã‚Šå½“ã¦ãƒ¢ãƒ¼ãƒ‰ã®ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
            #workMonthAssignmentMode > div {
                flex-direction: column;
                align-items: stretch !important;
            }

            #workMonthAssignmentMode > div > div,
            #workMonthAssignmentMode > div > button {
                width: 100%;
            }

            #selectedWorkHours {
                margin-left: 0 !important;
                margin-top: 10px;
                text-align: center;
            }
        }
        
        /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ç”¨CSS */
        .theme-bg {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        /* è‰²ã®å®šç¾© */
        .theme-purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .theme-deep-blue { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); }
        .theme-teal { background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); }
        .theme-cyan { background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); }
        .theme-ocean { background: linear-gradient(135deg, #0c4a6e 0%, #0284c7 100%); }
        .theme-sky { background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%); }
        .theme-indigo { background: linear-gradient(135deg, #4338ca 0%, #6366f1 100%); }
        .theme-navy { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .theme-slate { background: linear-gradient(135deg, #334155 0%, #475569 100%); }
        .theme-green { background: linear-gradient(135deg, #047857 0%, #10b981 100%); }
        .theme-emerald { background: linear-gradient(135deg, #059669 0%, #34d399 100%); }
        
        /* ã‚¿ãƒ–ç”¨ã®è‰²ã‚¯ãƒ©ã‚¹ï¼ˆæ¨¡æ§˜ãªã—ã€position/overflowãªã—ï¼‰ */
        .tab-theme-purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .tab-theme-deep-blue { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); }
        .tab-theme-teal { background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); }
        .tab-theme-cyan { background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); }
        .tab-theme-ocean { background: linear-gradient(135deg, #0c4a6e 0%, #0284c7 100%); }
        .tab-theme-sky { background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%); }
        .tab-theme-indigo { background: linear-gradient(135deg, #4338ca 0%, #6366f1 100%); }
        .tab-theme-navy { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .tab-theme-slate { background: linear-gradient(135deg, #334155 0%, #475569 100%); }
        .tab-theme-green { background: linear-gradient(135deg, #047857 0%, #10b981 100%); }
        .tab-theme-emerald { background: linear-gradient(135deg, #059669 0%, #34d399 100%); }
        
        /* ã‚°ãƒ­ãƒ¼åŠ¹æœ */
        .theme-cyan.pattern-glow { box-shadow: 0 4px 20px rgba(8, 145, 178, 0.3); }
        
        /* æ¨¡æ§˜ã®å®šç¾© */
        .theme-bg.pattern-wave::before {
            content: '';
            position: absolute;
            top: -30%;
            right: -5%;
            width: 150px;
            height: 150px;
            background: rgba(255,255,255,0.08);
            border-radius: 50%;
            pointer-events: none;
        }
        
        .theme-bg.pattern-wave::after {
            content: '';
            position: absolute;
            bottom: -20%;
            left: -5%;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
            pointer-events: none;
        }
        
        .theme-bg.pattern-stripe::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 3px;
            background: rgba(255,255,255,0.25);
            pointer-events: none;
        }
        
        .theme-bg.pattern-corner::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.12);
            border-radius: 0 10px 0 100%;
            pointer-events: none;
        }
        
        .theme-bg.pattern-dot::before {
            content: '';
            position: absolute;
            top: 20px;
            right: 20px;
            width: 10px;
            height: 10px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            pointer-events: none;
        }
        
        .theme-bg.pattern-dots::before {
            content: '';
            position: absolute;
            top: 20px;
            right: 20px;
            width: 8px;
            height: 8px;
            background: rgba(255,255,255,0.25);
            border-radius: 50%;
            box-shadow: 18px 0 0 rgba(255,255,255,0.25), 36px 0 0 rgba(255,255,255,0.25);
            pointer-events: none;
        }
        
        .theme-bg.pattern-diagonal::before {
            content: '';
            position: absolute;
            top: -20px;
            right: 40px;
            width: 80px;
            height: 150%;
            background: rgba(255,255,255,0.06);
            transform: skewX(-15deg);
            pointer-events: none;
        }
        
        .theme-bg.pattern-circle::before {
            content: '';
            position: absolute;
            top: 50%;
            right: -30px;
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        
        .theme-bg.pattern-layer::before {
            content: '';
            position: absolute;
            top: 0;
            right: -60px;
            width: 180px;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.04) 100%);
            transform: skewX(-20deg);
            pointer-events: none;
        }
        
        .theme-bg.pattern-line::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
            pointer-events: none;
        }
        
        .theme-bg.pattern-bar {
            border-left: 3px solid rgba(255,255,255,0.35);
        }
        
        .theme-bg.pattern-border {
            border-top: 2px solid rgba(255,255,255,0.25);
        }
        
        .theme-bg.pattern-glow::after {
            content: '';
            position: absolute;
            top: -20%;
            right: -10%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            pointer-events: none;
        }
        
        /* ä½œæ¥­æœˆè¡¨ç¤º */
        /* PCãƒ»ãƒ¢ãƒã‚¤ãƒ«å…±é€š: æ¬¡ã®è¡Œã«è¡¨ç¤º */
        .work-month-inline {
            display: none;
        }
        .work-month-block {
            display: block;
        }
        
        /* ãã®ä»–ä½œæ¥­ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .other-work-tab {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .other-work-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
            font-weight: 600;
        }
        
        .other-work-tab:hover {
            color: #3498db;
        }
        
        .other-work-form {
            animation: fadeIn 0.3s;
        }

        /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
        #estimateMonthButtons2,
        #actualMemberButtons2,
        #actualMonthButtons2,
        #reportMonthButtons2 {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f1f5f9;
        }

        #estimateMonthButtons2::-webkit-scrollbar,
        #actualMemberButtons2::-webkit-scrollbar,
        #actualMonthButtons2::-webkit-scrollbar,
        #reportMonthButtons2::-webkit-scrollbar {
            height: 6px;
        }

        #estimateMonthButtons2::-webkit-scrollbar-track,
        #actualMemberButtons2::-webkit-scrollbar-track,
        #actualMonthButtons2::-webkit-scrollbar-track,
        #reportMonthButtons2::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        #estimateMonthButtons2::-webkit-scrollbar-thumb,
        #actualMemberButtons2::-webkit-scrollbar-thumb,
        #actualMonthButtons2::-webkit-scrollbar-thumb,
        #reportMonthButtons2::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        #estimateMonthButtons2::-webkit-scrollbar-thumb:hover,
        #actualMemberButtons2::-webkit-scrollbar-thumb:hover,
        #actualMonthButtons2::-webkit-scrollbar-thumb:hover,
        #reportMonthButtons2::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å·¥æ•°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <div class="header-buttons">
                <button class="btn btn-success" onclick="exportBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                <button class="btn btn-primary" onclick="importBackup()">å¾©å…ƒ</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active tab-theme-purple" onclick="showTab('quick')">ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›</button>
            <button class="tab" onclick="showTab('estimate')">è¦‹ç©ä¸€è¦§</button>
            <button class="tab" onclick="showTab('actual')">å®Ÿç¸¾ä¸€è¦§</button>
            <button class="tab" onclick="showTab('report')">ãƒ¬ãƒãƒ¼ãƒˆ</button>
            <button class="tab" onclick="showTab('settings')">âš™ï¸ è¨­å®š</button>
        </div>

        <div class="content">
            <div id="quick" class="tab-content active">
                <div class="quick-input theme-bg theme-purple">
                    <h2 id="quickModeTitle">ä»Šæ—¥ã®å®Ÿç¸¾ã‚’å…¥åŠ›</h2>

                    <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã‚’å³å´ã«é…ç½® -->
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                        <div style="display: inline-flex; border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; overflow: hidden; background: rgba(255,255,255,0.1);">
                            <button id="quickActualModeBtn" onclick="switchQuickInputMode('actual')" style="padding: 6px 16px; border: none; background: rgba(255,255,255,0.9); color: rgba(0,0,0,0.85); cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">å®Ÿç¸¾å…¥åŠ›</button>
                            <button id="quickEstimateModeBtn" onclick="switchQuickInputMode('estimate')" style="padding: 6px 16px; border: none; background: transparent; color: rgba(255,255,255,0.85); cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">è¦‹ç©ç™»éŒ²</button>
                            <button id="quickVacationModeBtn" onclick="switchQuickInputMode('vacation')" style="padding: 6px 16px; border: none; background: transparent; color: rgba(255,255,255,0.85); cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">ä¼‘æš‡ç™»éŒ²</button>
                        </div>
                    </div>

                    <!-- å®Ÿç¸¾å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <div id="quickActualForm" class="quick-form">
                        <div class="form-group">
                            <label>å¯¾å¿œæ¤œç´¢ãƒ»é¸æŠ</label>
                            <div style="position: relative;">
                                <input 
                                    type="text" 
                                    id="quickTaskSearch" 
                                    placeholder="ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¯¾å¿œã‚’é¸æŠ..." 
                                    autocomplete="off"
                                    oninput="filterQuickTaskList()"
                                    onclick="showQuickTaskDropdown()"
                                    style="padding-right: 35px;">
                                <button 
                                    id="quickTaskClearBtn"
                                    onclick="clearQuickTaskSelection()"
                                    style="display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #999; cursor: pointer; font-size: 18px; padding: 4px 8px; line-height: 1;"
                                    title="ã‚¯ãƒªã‚¢">Ã—</button>
                                <div id="quickTaskDropdown" class="custom-dropdown" style="display: none;">
                                    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="form-group">
                                <label>æ‹…å½“</label>
                                <select id="quickMemberSelect" onchange="handleMemberChange()">
                                    <option value="">ï¼ˆè‡ªå‹•ï¼‰</option>
                                </select>
                                <small style="color: #999; font-size: 11px;">é€šå¸¸ã¯è‡ªå‹•ã€å¿…è¦æ™‚ã®ã¿å¤‰æ›´</small>
                            </div>
                            <div class="form-group">
                                <label>å®Ÿç¸¾å·¥æ•° (h)</label>
                                <input type="number" id="quickHours" step="0.5" min="0">
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="quickAddActual()" style="flex: 2;">è¿½åŠ </button>
                            <button class="btn" onclick="openOtherWorkModal()" style="flex: 1; background: rgba(255,255,255,0.2); color: white;">ãã®ä»–</button>
                        </div>
                    </div>

                    <!-- è¦‹ç©ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <div id="quickEstimateForm" class="quick-form" style="display: none;">
                        <div class="form-group">
                            <label>ç‰ˆæ•°</label>
                            <select id="quickEstVersion" onchange="handleVersionChange('quickEstVersion')">
                                <option value="">-- ç‰ˆæ•°ã‚’é¸æŠ --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å¸³ç¥¨å</label>
                            <input type="text" id="quickEstFormName" list="quickEstFormNameList" placeholder="å¸³ç¥¨A" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white;">
                            <datalist id="quickEstFormNameList">
                            </datalist>
                            <small style="color: rgba(255,255,255,0.7); display: block; margin-top: 5px; font-size: 11px;">æ—¢å­˜ã®å¸³ç¥¨åã‚’é¸æŠã€ã¾ãŸã¯æ–°è¦å…¥åŠ›ã§ãã¾ã™</small>
                        </div>
                        <div class="form-group">
                            <label>å¯¾å¿œå</label>
                            <input type="text" id="quickEstTask" placeholder="Xå¯¾å¿œ" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white;">
                        </div>
                        <div class="form-group">
                            <label>ä½œæ¥­æœˆ</label>
                            <div style="display: flex; gap: 12px; margin-bottom: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="quickEstMonthType" value="single" checked onchange="switchQuickEstMonthType()" style="width: auto; margin-right: 4px;">
                                    <span style="color: rgba(255,255,255,0.75); font-size: 11px;">å˜ä¸€æœˆ</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="quickEstMonthType" value="multi" onchange="switchQuickEstMonthType()" style="width: auto; margin-right: 4px;">
                                    <span style="color: rgba(255,255,255,0.75); font-size: 11px;">è¤‡æ•°æœˆ</span>
                                </label>
                            </div>
                            <div id="quickEstMonthInputs">
                                <div id="quickEstSingleMonthInput" style="display: block;">
                                    <select id="quickEstStartMonth" onchange="updateQuickEstWorkMonthUI()"></select>
                                </div>
                                <div id="quickEstMultiMonthInput" style="display: none;">
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <select id="quickEstStartMonthMulti" onchange="updateQuickEstWorkMonthUI()"></select>
                                        <span>ã€œ</span>
                                        <select id="quickEstEndMonth" onchange="updateQuickEstWorkMonthUI()"></select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <h4 style="margin-bottom: 10px; color: rgba(255,255,255,0.9);">å„å·¥ç¨‹ã®è¦‹ç©</h4>
                        <div class="estimate-table-wrapper">
                            <table class="estimate-table" id="quickEstimateTable" style="width: 100%; margin: 0;">
                                <thead>
                                    <tr>
                                        <th style="width: 60px; padding: 8px; text-align: center;">å·¥ç¨‹</th>
                                        <th style="width: 120px; padding: 8px;">æ‹…å½“</th>
                                        <th style="width: 100px; padding: 8px;">æ™‚é–“</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span class="badge badge-ui">UI</span></td>
                                        <td><select id="quickEstUI_member" style="margin: 0;"></select></td>
                                        <td><input type="number" id="quickEstUI" placeholder="h" step="0.5" style="margin: 0;" oninput="updateQuickEstimateTotals()"></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span class="badge badge-pg">PG</span></td>
                                        <td><select id="quickEstPG_member" style="margin: 0;"></select></td>
                                        <td><input type="number" id="quickEstPG" placeholder="h" step="0.5" style="margin: 0;" oninput="updateQuickEstimateTotals()"></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span class="badge badge-pt">PT</span></td>
                                        <td><select id="quickEstPT_member" style="margin: 0;"></select></td>
                                        <td><input type="number" id="quickEstPT" placeholder="h" step="0.5" style="margin: 0;" oninput="updateQuickEstimateTotals()"></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span class="badge badge-it">IT</span></td>
                                        <td><select id="quickEstIT_member" style="margin: 0;"></select></td>
                                        <td><input type="number" id="quickEstIT" placeholder="h" step="0.5" style="margin: 0;" oninput="updateQuickEstimateTotals()"></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span class="badge badge-st">ST</span></td>
                                        <td><select id="quickEstST_member" style="margin: 0;"></select></td>
                                        <td><input type="number" id="quickEstST" placeholder="h" step="0.5" style="margin: 0;" oninput="updateQuickEstimateTotals()"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- åˆè¨ˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                        <div id="quickEstimateTotals" style="background: rgba(25, 118, 210, 0.15); padding: 12px 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #1976d2;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <span style="font-weight: 600; color: rgba(255,255,255,0.9);">å¯¾å¿œåˆè¨ˆ:</span>
                                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                    <span style="color: rgba(255,255,255,0.95);"><strong id="quickEstTotalHours">0.0</strong> h</span>
                                    <span style="color: rgba(255,255,255,0.8);">(<span id="quickEstTotalDays">0.0</span> äººæ—¥)</span>
                                    <span style="color: rgba(255,255,255,0.8);">(<span id="quickEstTotalMonths">0.00</span> äººæœˆ)</span>
                                </div>
                            </div>
                        </div>

                        <!-- æœˆåˆ†å‰²ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ -->
                        <div style="background: rgba(251, 146, 60, 0.15); padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #fb923c;">
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="quickEnableMonthSplit" onchange="toggleQuickMonthSplit()" style="width: auto; margin-right: 10px;">
                                    <span style="font-weight: 600; color: #ea580c;">ğŸ“… è¤‡æ•°æœˆã«åˆ†å‰²ã—ã¦ç™»éŒ²</span>
                                </label>
                                <small style="color: rgba(255,255,255,0.8); display: block; margin-top: 5px;">
                                    ä¸€ã¤ã®å·¥ç¨‹ã‚’è¤‡æ•°æœˆã§ä½œæ¥­ã™ã‚‹å ´åˆã«ã€æœˆåˆ¥ã®å·¥æ•°ã‚’è¨­å®šã§ãã¾ã™
                                </small>
                            </div>

                            <div id="quickMonthSplitPanel" style="display: none; margin-top: 15px;">
                                <div class="form-group">
                                    <label>åˆ†å‰²ã™ã‚‹å·¥ç¨‹ã‚’é¸æŠ</label>
                                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="quickSplitUI" class="quick-split-process-checkbox" style="width: auto; margin-right: 5px;">
                                            <span>UI</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="quickSplitPG" class="quick-split-process-checkbox" style="width: auto; margin-right: 5px;">
                                            <span>PG</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="quickSplitPT" class="quick-split-process-checkbox" style="width: auto; margin-right: 5px;">
                                            <span>PT</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="quickSplitIT" class="quick-split-process-checkbox" style="width: auto; margin-right: 5px;">
                                            <span>IT</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="quickSplitST" class="quick-split-process-checkbox" style="width: auto; margin-right: 5px;">
                                            <span>ST</span>
                                        </label>
                                    </div>
                                    <small style="color: rgba(255,255,255,0.7); display: block; margin-top: 5px;">
                                        ãƒã‚§ãƒƒã‚¯ã—ãŸå·¥ç¨‹ã®ã¿ãŒæœˆåˆ†å‰²ã•ã‚Œã¾ã™ã€‚ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ãªã„å·¥ç¨‹ã¯é€šå¸¸é€šã‚Šç™»éŒ²ã•ã‚Œã¾ã™ã€‚
                                    </small>
                                </div>

                                <div class="form-group">
                                    <label>ç·å·¥æ•°</label>
                                    <input type="number" id="quickTotalHours" step="0.1" min="0" placeholder="ä¾‹: 80" oninput="updateQuickMonthPreview()">
                                    <span style="margin-left: 5px;">æ™‚é–“</span>
                                </div>

                                <div class="form-group">
                                    <label>ä½œæ¥­æœŸé–“</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <select id="quickStartMonth" onchange="updateQuickMonthPreview()"></select>
                                        <span>ã€œ</span>
                                        <select id="quickEndMonth" onchange="updateQuickMonthPreview()"></select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>åˆ†å‰²æ–¹æ³•</label>
                                    <div style="display: flex; gap: 20px;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="radio" name="quickSplitMethod" value="equal" checked onchange="updateQuickMonthPreview()" style="width: auto; margin-right: 5px;">
                                            <span>å‡ç­‰åˆ†å‰²</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="radio" name="quickSplitMethod" value="manual" onchange="updateQuickMonthPreview()" style="width: auto; margin-right: 5px;">
                                            <span>æ‰‹å‹•è¨­å®š</span>
                                        </label>
                                    </div>
                                </div>

                                <div id="quickMonthPreview" style="margin-top: 15px;"></div>
                            </div>
                        </div>

                        <button class="btn" onclick="addQuickEstimate()" style="margin-top: 15px; background: rgba(255,255,255,0.9); color: #7b3ff2; font-weight: 600;">ç™»éŒ²</button>
                    </div>

                    <!-- ä¼‘æš‡ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <div id="quickVacationForm" class="quick-form" style="display: none;">
                        <div class="form-group">
                            <label>æ‹…å½“è€…</label>
                            <select id="quickVacationMember">
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ—¥ä»˜</label>
                            <input type="date" id="quickVacationDate" style="max-width: 200px;">
                        </div>
                        <div class="form-group">
                            <label>ä¼‘æš‡ã‚¿ã‚¤ãƒ—</label>
                            <select id="quickVacationType" onchange="handleVacationTypeChange()">
                                <option value="æœ‰ä¼‘">æœ‰çµ¦ä¼‘æš‡ï¼ˆæœ‰ä¼‘ï¼‰</option>
                                <option value="ç‰¹ä¼‘">ç‰¹åˆ¥ä¼‘æš‡ï¼ˆç‰¹ä¼‘ï¼‰</option>
                                <option value="ä»£ä¼‘">ä»£ä¼‘ï¼ˆä»£ä¼‘ï¼‰</option>
                                <option value="æŒ¯ä¼‘">æŒ¯æ›¿ä¼‘æ—¥ï¼ˆæŒ¯ä¼‘ï¼‰</option>
                                <option value="æ™‚é–“ä¼‘">æ™‚é–“ä¼‘</option>
                            </select>
                        </div>
                        <div class="form-group" id="quickVacationHoursGroup">
                            <label>æ™‚é–“æ•° (h)</label>
                            <input type="number" id="quickVacationHours" step="1" min="1" placeholder="1" value="8">
                            <small style="color: rgba(255,255,255,0.8); display: block; margin-top: 5px;">
                                æ™‚é–“ä¼‘ã¯1hå˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚å…¨æ—¥ä¼‘æš‡ã¯8hã§ã™ã€‚
                            </small>
                        </div>
                        <button class="btn" onclick="addQuickVacation()" style="background: rgba(255,255,255,0.9); color: #7b3ff2; font-weight: 600;">ç™»éŒ²</button>
                    </div>
                </div>

                <h3 id="quickBottomTitle">ä»Šæ—¥ã®å…¥åŠ›æ¸ˆã¿å®Ÿç¸¾</h3>
                <div id="todayActuals"></div>
            </div>

            <div id="estimate" class="tab-content">
                <h2>è¦‹ç©ä¸€è¦§</h2>

                <!-- åˆè¨ˆå·¥æ•°è¡¨ç¤º -->
                <div id="estimateTotalCard" style="color: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">åˆè¨ˆå·¥æ•°</div>
                            <div style="font-size: 28px; font-weight: bold;" id="estimateTotalHours">0h</div>
                        </div>
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">äººæ—¥ / äººæœˆ</div>
                            <div style="font-size: 18px; font-weight: 600;" id="estimateTotalManpower">0äººæ—¥ / 0äººæœˆ</div>
                        </div>
                    </div>
                </div>

                <!-- æ‹…å½“è€…åˆ¥åˆè¨ˆè¡¨ç¤º -->
                <div id="estimateMemberSummary" style="background: #f8f9fa; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none;">
                    <div style="font-size: 14px; font-weight: 600; color: #495057; margin-bottom: 10px;">æ‹…å½“è€…åˆ¥åˆè¨ˆ</div>
                    <div id="estimateMemberSummaryContent" style="display: flex; flex-wrap: wrap; gap: 12px;">
                    </div>
                </div>

                <!-- æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³ -->
                <button class="btn btn-primary" onclick="openAddEstimateModal()" style="margin-bottom: 15px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                    <span style="font-size: 16px;">+</span> æ–°è¦ç™»éŒ²
                </button>

                <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³1: æ¨ªä¸¦ã³ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
                <div id="estimateFiltersCompact" style="margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 6px;">
                    <div style="display: flex; flex-wrap: nowrap; gap: 10px; align-items: center; overflow-x: auto;">
                        <div style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                            <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">è¡¨ç¤ºå½¢å¼:</label>
                            <select id="estimateViewType" onchange="renderEstimateList()" style="padding: 3px 6px; font-size: 12px;">
                                <option value="grouped">ã‚°ãƒ«ãƒ¼ãƒ—</option>
                                <option value="matrix">ãƒãƒˆãƒªã‚¯ã‚¹</option>
                                <option value="list">ãƒªã‚¹ãƒˆ</option>
                            </select>
                        </div>

                        <div style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                            <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">è¡¨ç¤ºæœˆ:</label>
                            <select id="estimateMonthFilter" onchange="renderEstimateList()" style="padding: 3px 6px; font-size: 12px;">
                                <option value="all">å…¨æœŸé–“</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; cursor: pointer; user-select: none; font-size: 12px; font-weight: 500; white-space: nowrap;">
                            <input type="checkbox" id="workMonthSelectionMode" onchange="toggleWorkMonthSelectionMode()" style="width: auto; margin-right: 5px;">
                            <span>ä½œæ¥­æœˆå‰²ã‚Šå½“ã¦</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; user-select: none; font-size: 12px; font-weight: 500; white-space: nowrap;">
                            <input type="checkbox" id="estimateEditMode" onchange="toggleEstimateEditMode()" style="width: auto; margin-right: 5px;">
                            <span>ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</span>
                        </label>
                    </div>
                </div>

                <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³2: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆåˆ‡ã‚Šæ›¿ãˆç”¨ï¼‰ -->
                <div id="estimateFiltersSegmented" style="display: none; margin-bottom: 20px; background: #f8f9fa; padding: 12px; border-radius: 6px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">è¡¨ç¤ºå½¢å¼:</label>
                            <div style="display: inline-flex; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden; background: white;">
                                <button id="btnEstimateGrouped" onclick="setEstimateViewType('grouped')" style="padding: 6px 14px; border: none; background: white; cursor: pointer; font-size: 13px; transition: all 0.2s;">ã‚°ãƒ«ãƒ¼ãƒ—</button>
                                <button id="btnEstimateMatrix" onclick="setEstimateViewType('matrix')" style="padding: 6px 14px; border: none; border-left: 1px solid #dee2e6; background: white; cursor: pointer; font-size: 13px; transition: all 0.2s;">ãƒãƒˆãƒªã‚¯ã‚¹</button>
                                <button id="btnEstimateList" onclick="setEstimateViewType('list')" style="padding: 6px 14px; border: none; border-left: 1px solid #dee2e6; background: white; cursor: pointer; font-size: 13px; transition: all 0.2s;">ãƒªã‚¹ãƒˆ</button>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">è¡¨ç¤ºæœˆ:</label>
                            <div id="estimateMonthButtons2" style="display: inline-flex; border: 1px solid #dee2e6; border-radius: 4px; overflow-x: auto; background: white; max-width: 600px;">
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer; user-select: none; font-size: 13px; font-weight: 500; white-space: nowrap;">
                            <input type="checkbox" id="workMonthSelectionMode2" onchange="toggleWorkMonthSelectionMode()" style="width: auto; margin-right: 5px;">
                            <span>ä½œæ¥­æœˆå‰²ã‚Šå½“ã¦</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; user-select: none; font-size: 13px; font-weight: 500; white-space: nowrap;">
                            <input type="checkbox" id="estimateEditMode2" onchange="toggleEstimateEditMode()" style="width: auto; margin-right: 5px;">
                            <span>ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</span>
                        </label>
                    </div>
                </div>
                
                <!-- ä½œæ¥­æœˆå‰²ã‚Šå½“ã¦ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ãƒ­ãƒ¼ãƒˆè¡¨ç¤ºï¼‰ -->
                <div id="workMonthAssignmentMode" style="display: none; background: linear-gradient(135deg, #fff3cd 0%, #ffe5a0 100%); padding: 18px; border-radius: 8px; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.2); border-left: 4px solid #ffc107; max-width: 90vw;">
                    <!-- ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ« -->
                    <div id="dragHandle" style="position: absolute; top: 0; left: 0; right: 0; height: 8px; background: rgba(0,0,0,0.1); border-radius: 8px 8px 0 0; cursor: ns-resize; display: flex; align-items: center; justify-content: center; z-index: 1;">
                        <div style="width: 40px; height: 4px; background: rgba(0,0,0,0.3); border-radius: 2px;"></div>
                    </div>

                    <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
                    <button onclick="closeWorkMonthAssignmentMode()" style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 2px solid #856404; font-size: 20px; font-weight: bold; color: #856404; cursor: pointer; padding: 0; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.2); line-height: 1;" onmouseover="this.style.background='#856404'; this.style.color='white';" onmouseout="this.style.background='rgba(255,255,255,0.9)'; this.style.color='#856404';">&times;</button>

                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-top: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: 600; color: #856404;">å‰²ã‚Šå½“ã¦å…ˆ:</label>
                            <select id="assignWorkMonth" style="padding: 8px 12px; border: 2px solid #ffc107; border-radius: 6px; font-weight: 500; font-size: 14px; background: white;">
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="executeWorkMonthAssignment()" style="margin: 0; font-weight: 600; padding: 8px 20px;">
                            âœ“ å‰²ã‚Šå½“ã¦å®Ÿè¡Œ
                        </button>
                        <button class="btn" onclick="cancelWorkMonthSelection()" style="margin: 0; background: #6c757d; color: white; padding: 8px 16px;">
                            é¸æŠè§£é™¤
                        </button>
                        <div id="selectedWorkHours" style="margin-left: auto; font-weight: 700; font-size: 18px; color: #1976d2; white-space: nowrap;">
                            é¸æŠä¸­: 0h (0äººæ—¥ / 0äººæœˆ)
                        </div>
                    </div>
                </div>
                
                <div id="estimateList"></div>
            </div>

            <div id="actual" class="tab-content">
                <h2>å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</h2>

                <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³1: æ¨ªä¸¦ã³ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
                <div id="actualFiltersCompact" style="display: flex; flex-wrap: nowrap; gap: 10px; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 6px; overflow-x: auto;">
                    <div style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰:</label>
                        <select id="actualViewMode" onchange="renderActualList()" style="padding: 3px 6px; font-size: 12px;">
                            <option value="all">å…¨æ‹…å½“è€…</option>
                            <option value="member">æ‹…å½“è€…åˆ¥</option>
                        </select>
                    </div>

                    <div id="memberSelectGroup" style="display: none; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">æ‹…å½“è€…:</label>
                        <select id="actualMemberSelect" onchange="renderActualList()" style="padding: 3px 6px; font-size: 12px;">
                        </select>
                    </div>

                    <div style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">è¡¨ç¤ºå½¢å¼:</label>
                        <select id="actualViewType" onchange="renderActualList()" style="padding: 3px 6px; font-size: 12px;">
                            <option value="matrix">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</option>
                            <option value="list">ãƒªã‚¹ãƒˆ</option>
                        </select>
                    </div>

                    <div style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">è¡¨ç¤ºæœŸé–“:</label>
                        <select id="actualMonthFilter" onchange="renderActualList()" style="padding: 3px 6px; font-size: 12px;">
                            <option value="all">å…¨æœŸé–“</option>
                        </select>
                    </div>
                </div>

                <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³2: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆåˆ‡ã‚Šæ›¿ãˆç”¨ï¼‰ -->
                <div id="actualFiltersSegmented" style="display: none; margin-bottom: 20px; background: #f8f9fa; padding: 12px; border-radius: 6px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰:</label>
                            <select id="actualViewMode2" onchange="document.getElementById('actualViewMode').value = this.value; renderActualList()" style="padding: 4px 8px; font-size: 13px;">
                                <option value="all">å…¨æ‹…å½“è€…</option>
                                <option value="member">æ‹…å½“è€…åˆ¥</option>
                            </select>
                        </div>

                        <div id="memberSelectGroup2" style="display: none; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">æ‹…å½“è€…:</label>
                            <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ç‰ˆ -->
                            <div id="actualMemberButtons2" style="display: inline-flex; border: 1px solid #dee2e6; border-radius: 4px; overflow-x: auto; background: white; max-width: 600px;">
                            </div>
                            <!-- Selectç‰ˆï¼ˆè¦ç´ æ•°ãŒå¤šã„å ´åˆï¼‰ -->
                            <select id="actualMemberSelect2" onchange="document.getElementById('actualMemberSelect').value = this.value; renderActualList()" style="padding: 4px 8px; font-size: 13px; display: none;">
                            </select>
                        </div>

                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">è¡¨ç¤ºå½¢å¼:</label>
                            <div style="display: inline-flex; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden; background: white;">
                                <button onclick="setActualViewType('matrix')" id="btnActualMatrix" style="padding: 4px 12px; font-size: 12px; border: none; background: white; color: #333; cursor: pointer; transition: all 0.2s;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
                                <button onclick="setActualViewType('list')" id="btnActualList" style="padding: 4px 12px; font-size: 12px; border: none; background: white; color: #333; cursor: pointer; border-left: 1px solid #dee2e6; transition: all 0.2s;">ãƒªã‚¹ãƒˆ</button>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">è¡¨ç¤ºæœŸé–“:</label>
                            <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ç‰ˆ -->
                            <div id="actualMonthButtons2" style="display: inline-flex; border: 1px solid #dee2e6; border-radius: 4px; overflow-x: auto; background: white; max-width: 800px;">
                            </div>
                            <!-- Selectç‰ˆï¼ˆè¦ç´ æ•°ãŒå¤šã„å ´åˆï¼‰ -->
                            <select id="actualMonthFilter2" onchange="document.getElementById('actualMonthFilter').value = this.value; renderActualList()" style="padding: 4px 8px; font-size: 13px; display: none;">
                                <option value="all">å…¨æœŸé–“</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="actualList"></div>
            </div>

            <div id="report" class="tab-content">
                <h2>å·¥æ•°ãƒ¬ãƒãƒ¼ãƒˆ</h2>

                <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³1: æ¨ªä¸¦ã³ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
                <div id="reportFiltersCompact" style="display: flex; flex-wrap: nowrap; gap: 10px; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 6px; overflow-x: auto;">
                    <div style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">ãƒ•ã‚£ãƒ«ã‚¿:</label>
                        <select id="reportFilterType" onchange="handleReportFilterTypeChange()" style="padding: 3px 6px; font-size: 12px;">
                            <option value="month">æœˆåˆ¥</option>
                            <option value="version">ç‰ˆæ•°åˆ¥</option>
                        </select>
                    </div>
                    <div id="reportMonthFilterCompact" style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">è¡¨ç¤ºæœˆ:</label>
                        <select id="reportMonth" onchange="updateReport()" style="padding: 3px 6px; font-size: 12px;">
                            <option value="all">å…¨æœŸé–“</option>
                        </select>
                    </div>
                    <div id="reportVersionFilterCompact" style="display: none; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">ç‰ˆæ•°:</label>
                        <select id="reportVersion" onchange="updateReport()" style="padding: 3px 6px; font-size: 12px;">
                            <option value="all">å…¨ç‰ˆæ•°</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">è¡¨ç¤ºå½¢å¼:</label>
                        <select id="reportViewType" onchange="updateReport()" style="padding: 3px 6px; font-size: 12px;">
                            <option value="summary">ã‚µãƒãƒªãƒ¼</option>
                            <option value="grouped" selected>ã‚°ãƒ«ãƒ¼ãƒ—</option>
                            <option value="matrix">ãƒãƒˆãƒªã‚¯ã‚¹</option>
                        </select>
                    </div>
                </div>

                <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³2: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆåˆ‡ã‚Šæ›¿ãˆç”¨ï¼‰ -->
                <div id="reportFiltersSegmented" style="display: none; margin-bottom: 20px; background: #f8f9fa; padding: 12px; border-radius: 6px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">ãƒ•ã‚£ãƒ«ã‚¿:</label>
                            <div style="display: inline-flex; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden; background: white;">
                                <button onclick="setReportFilterType('month')" id="btnFilterMonth" style="padding: 4px 10px; font-size: 12px; border: none; background: white; color: #333; cursor: pointer; transition: all 0.2s;">æœˆåˆ¥</button>
                                <button onclick="setReportFilterType('version')" id="btnFilterVersion" style="padding: 4px 10px; font-size: 12px; border: none; background: white; color: #333; cursor: pointer; border-left: 1px solid #dee2e6; transition: all 0.2s;">ç‰ˆæ•°åˆ¥</button>
                            </div>
                        </div>
                        <div id="reportMonthFilterSegmented" style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">è¡¨ç¤ºæœˆ:</label>
                            <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ç‰ˆ -->
                            <div id="reportMonthButtons2" style="display: inline-flex; border: 1px solid #dee2e6; border-radius: 4px; overflow-x: auto; background: white; max-width: 800px;">
                            </div>
                            <!-- Selectç‰ˆï¼ˆè¦ç´ æ•°ãŒå¤šã„å ´åˆï¼‰ -->
                            <select id="reportMonth2" onchange="document.getElementById('reportMonth').value = this.value; updateReport()" style="padding: 4px 8px; font-size: 13px; display: none;">
                                <option value="all">å…¨æœŸé–“</option>
                            </select>
                        </div>
                        <div id="reportVersionFilterSegmented" style="display: none; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">ç‰ˆæ•°:</label>
                            <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ç‰ˆ -->
                            <div id="reportVersionButtons2" style="display: inline-flex; border: 1px solid #dee2e6; border-radius: 4px; overflow-x: auto; background: white; max-width: 800px;">
                            </div>
                            <!-- Selectç‰ˆï¼ˆè¦ç´ æ•°ãŒå¤šã„å ´åˆï¼‰ -->
                            <select id="reportVersion2" onchange="document.getElementById('reportVersion').value = this.value; updateReport()" style="padding: 4px 8px; font-size: 13px; display: none;">
                                <option value="all">å…¨ç‰ˆæ•°</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">è¡¨ç¤ºå½¢å¼:</label>
                            <div style="display: inline-flex; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden; background: white;">
                                <button onclick="setReportViewType('summary')" id="btnReportSummary" style="padding: 4px 10px; font-size: 12px; border: none; background: white; color: #333; cursor: pointer; transition: all 0.2s;">ã‚µãƒãƒªãƒ¼</button>
                                <button onclick="setReportViewType('grouped')" id="btnReportGrouped" style="padding: 4px 10px; font-size: 12px; border: none; background: white; color: #333; cursor: pointer; border-left: 1px solid #dee2e6; transition: all 0.2s;">ã‚°ãƒ«ãƒ¼ãƒ—</button>
                                <button onclick="setReportViewType('matrix')" id="btnReportMatrix" style="padding: 4px 10px; font-size: 12px; border: none; background: white; color: #333; cursor: pointer; border-left: 1px solid #dee2e6; transition: all 0.2s;">ãƒãƒˆãƒªã‚¯ã‚¹</button>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 id="reportPeriodTitle">å…¨æœŸé–“ã®é›†è¨ˆ</h3>

                <div class="stats-grid">
                    <div class="stat-card theme-bg theme-purple">
                        <h3>ç·è¦‹ç©å·¥æ•°</h3>
                        <div class="value" id="totalEstimate">0h</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 5px;" id="totalEstimateManpower"></div>
                    </div>
                    <div class="stat-card theme-bg theme-purple">
                        <h3>ç·å®Ÿç¸¾å·¥æ•°</h3>
                        <div class="value" id="totalActual">0h</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 5px;" id="totalActualManpower"></div>
                    </div>
                    <div class="stat-card theme-bg theme-purple">
                        <h3>å·®ç•°</h3>
                        <div class="value" id="totalDiff">0h</div>
                    </div>
                    <div class="stat-card theme-bg theme-purple">
                        <h3>å®Ÿç¸¾ç‡</h3>
                        <div class="value" id="actualRate">0%</div>
                    </div>
                </div>

                <div id="reportDetailView"></div>

                <h3>æ‹…å½“è€…åˆ¥å·¥æ•°</h3>
                <div id="memberReport"></div>

                <h3 style="margin-top: 20px;">ç‰ˆæ•°åˆ¥é€²æ—</h3>
                <div id="versionReport"></div>

                <!-- é€²æ—ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3>é€²æ—ç®¡ç†ï¼ˆè¦‹è¾¼æ®‹å­˜æ™‚é–“ãƒ™ãƒ¼ã‚¹ï¼‰</h3>
                    <p style="color: #666; margin-bottom: 15px; font-size: 13px;">
                        è¦‹è¾¼æ®‹å­˜æ™‚é–“ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã‚ˆã‚Šæ­£ç¢ºãªé€²æ—ç‡ã¨äºˆæ¸¬ç·å·¥æ•°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                    </p>

                    <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
                        <select id="progressVersionFilter" onchange="updateProgressReport()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="all">å…¨ç‰ˆæ•°</option>
                        </select>
                        <select id="progressStatusFilter" onchange="updateProgressReport()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="all">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                            <option value="completed">å®Œäº†</option>
                            <option value="ontrack">é †èª¿</option>
                            <option value="warning">æ³¨æ„</option>
                            <option value="exceeded">è¶…é</option>
                        </select>
                        <button class="btn btn-primary" onclick="openBulkRemainingModal()" style="padding: 8px 16px; font-size: 13px;">
                            ä¸€æ‹¬ç·¨é›†
                        </button>
                    </div>

                    <!-- é€²æ—ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
                    <div class="stats-grid" id="progressSummaryCards">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>

                    <!-- è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
                    <div id="progressDetailTable" style="margin-top: 20px;">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- Excelå‡ºåŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 30px 0;">
                    <h3>ğŸ“Š Excelå‡ºåŠ›</h3>
                    <p style="color: #666; margin-bottom: 15px;">å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã¨è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‚’Excelå½¢å¼ã§å‡ºåŠ›ã—ã¾ã™ã€‚</p>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin-bottom: 8px; font-size: 14px;">å‡ºåŠ›å†…å®¹:</h4>
                        <ul style="color: #666; font-size: 13px; margin-left: 20px;">
                            <li><strong>å®Ÿç¸¾ã‚·ãƒ¼ãƒˆï¼ˆæ‹…å½“è€…åˆ¥ï¼‰:</strong> æ—¥ä»˜ã€æ›œæ—¥ã€å‚™è€ƒã€ä½œæ¥­ã€æ™‚é–“</li>
                            <li><strong>è¦‹ç©ã‚·ãƒ¼ãƒˆ:</strong> ç‰ˆæ•°ã€ä½œæ¥­æœˆã€å¯¾å¿œåã€å·¥ç¨‹ã€æ‹…å½“ã€è¦‹ç©å·¥æ•°</li>
                        </ul>
                    </div>
                    
                    <button class="btn btn-success" onclick="exportToExcel()" style="font-weight: 600;">
                        ğŸ“¥ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <h2>âš™ï¸ è¨­å®š</h2>
                
                <!-- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼è¨­å®š -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>ğŸ¨ ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</h3>
                    <p style="color: #666; margin-bottom: 15px;">ã‚¢ãƒ—ãƒªã®é…è‰²ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã‚¨ãƒªã‚¢ã€ãƒ¬ãƒãƒ¼ãƒˆé›†è¨ˆã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚</p>
                    
                    <div class="form-group">
                        <label>è‰²</label>
                        <select id="themeColor" onchange="applyTheme()">
                            <option value="purple">ç´«ï¼ˆç¾åœ¨ï¼‰</option>
                            <option value="deep-blue">ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ–ãƒ«ãƒ¼</option>
                            <option value="teal">ãƒ†ã‚£ãƒ¼ãƒ«</option>
                            <option value="cyan">ã‚·ã‚¢ãƒ³</option>
                            <option value="ocean">ã‚ªãƒ¼ã‚·ãƒ£ãƒ³</option>
                            <option value="sky">ã‚¹ã‚«ã‚¤ãƒ–ãƒ«ãƒ¼</option>
                            <option value="indigo">ã‚¤ãƒ³ãƒ‡ã‚£ã‚´</option>
                            <option value="navy">ãƒã‚¤ãƒ“ãƒ¼</option>
                            <option value="slate">ã‚¹ãƒ¬ãƒ¼ãƒˆ</option>
                            <option value="green">ã‚°ãƒªãƒ¼ãƒ³</option>
                            <option value="emerald">ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ãƒ‡ã‚¶ã‚¤ãƒ³</label>
                        <select id="themePattern" onchange="applyTheme()">
                            <option value="none">ã‚·ãƒ³ãƒ—ãƒ«ï¼ˆæ¨¡æ§˜ãªã—ï¼‰</option>
                            <option value="wave">æ³¢æ¨¡æ§˜</option>
                            <option value="stripe">å³ã‚¹ãƒˆãƒ©ã‚¤ãƒ—</option>
                            <option value="glow">ã‚°ãƒ­ãƒ¼åŠ¹æœ</option>
                            <option value="corner">ã‚³ãƒ¼ãƒŠãƒ¼ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ</option>
                            <option value="dot">ãƒ‰ãƒƒãƒˆ</option>
                            <option value="dots">è¤‡æ•°ãƒ‰ãƒƒãƒˆ</option>
                            <option value="diagonal">æ–œç·šãƒ‘ã‚¿ãƒ¼ãƒ³</option>
                            <option value="circle">ã‚µãƒ¼ã‚¯ãƒ«</option>
                            <option value="layer">ãƒ¬ã‚¤ãƒ¤ãƒ¼</option>
                            <option value="line">ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ³</option>
                            <option value="bar">å·¦ãƒãƒ¼</option>
                            <option value="border">ä¸Šéƒ¨ãƒœãƒ¼ãƒ€ãƒ¼</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ã‚¿ãƒ–ã®è‰²</label>
                        <select id="themeTabColor" onchange="applyTheme()">
                            <option value="same">ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ã¨åŒã˜</option>
                            <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆé’ï¼‰</option>
                            <option value="purple">ç´«</option>
                            <option value="deep-blue">ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ–ãƒ«ãƒ¼</option>
                            <option value="teal">ãƒ†ã‚£ãƒ¼ãƒ«</option>
                            <option value="cyan">ã‚·ã‚¢ãƒ³</option>
                            <option value="ocean">ã‚ªãƒ¼ã‚·ãƒ£ãƒ³</option>
                            <option value="sky">ã‚¹ã‚«ã‚¤ãƒ–ãƒ«ãƒ¼</option>
                            <option value="indigo">ã‚¤ãƒ³ãƒ‡ã‚£ã‚´</option>
                            <option value="navy">ãƒã‚¤ãƒ“ãƒ¼</option>
                            <option value="slate">ã‚¹ãƒ¬ãƒ¼ãƒˆ</option>
                            <option value="green">ã‚°ãƒªãƒ¼ãƒ³</option>
                            <option value="emerald">ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ã‚¿ãƒ–ã®è‰²ã‚’å€‹åˆ¥ã«è¨­å®šã§ãã¾ã™
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>èƒŒæ™¯è‰²</label>
                        <select id="themeBackgroundColor" onchange="applyTheme()">
                            <option value="same">ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ã¨åŒã˜</option>
                            <option value="purple">ç´«</option>
                            <option value="deep-blue">ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ–ãƒ«ãƒ¼</option>
                            <option value="teal">ãƒ†ã‚£ãƒ¼ãƒ«</option>
                            <option value="cyan">ã‚·ã‚¢ãƒ³</option>
                            <option value="ocean">ã‚ªãƒ¼ã‚·ãƒ£ãƒ³</option>
                            <option value="sky">ã‚¹ã‚«ã‚¤ãƒ–ãƒ«ãƒ¼</option>
                            <option value="indigo">ã‚¤ãƒ³ãƒ‡ã‚£ã‚´</option>
                            <option value="navy">ãƒã‚¤ãƒ“ãƒ¼</option>
                            <option value="slate">ã‚¹ãƒ¬ãƒ¼ãƒˆ</option>
                            <option value="green">ã‚°ãƒªãƒ¼ãƒ³</option>
                            <option value="emerald">ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ãƒšãƒ¼ã‚¸å…¨ä½“ã®èƒŒæ™¯è‰²ã‚’å€‹åˆ¥ã«è¨­å®šã§ãã¾ã™
                        </small>
                    </div>
                    
                    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
                        <div id="themePreview" style="padding: 20px; border-radius: 8px; color: white; position: relative; overflow: hidden;">
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">ã‚¯ã‚¤ãƒƒã‚¯å®Ÿç¸¾å…¥åŠ›</div>
                            <div style="font-size: 14px;">ãƒ¬ãƒãƒ¼ãƒˆé›†è¨ˆã‚«ãƒ¼ãƒ‰ãƒ»ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã«ã‚‚é©ç”¨ã•ã‚Œã¾ã™</div>
                        </div>
                    </div>
                    
                    <small style="color: #666; display: block; margin-top: 10px;">
                        ãƒ»è¨­å®šã¯è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã¾ã™<br>
                        ãƒ»ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚è¨­å®šã¯ä¿æŒã•ã‚Œã¾ã™
                    </small>
                </div>

                <!-- ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ç¤ºã®æœˆè‰²åˆ†ã‘è¨­å®š -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>ğŸ“Š ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º</h3>
                    <p style="color: #666; margin-bottom: 15px;">è¦‹ç©ä¸€è¦§ãƒ»ãƒ¬ãƒãƒ¼ãƒˆã®ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ç¤ºã«é–¢ã™ã‚‹è¨­å®šã§ã™ã€‚</p>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="showMonthColorsCheckbox" onchange="toggleMonthColorsSetting()" style="width: auto; margin-right: 10px;" checked>
                            <span>å…¨æœŸé–“è¡¨ç¤ºã§æœˆã”ã¨ã«è‰²åˆ†ã‘ã™ã‚‹</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ãƒ»ã‚ªãƒ³: å…¨æœŸé–“è¡¨ç¤ºæ™‚ã«å·¥ç¨‹ã®å‰²å½“æœˆã«å¿œã˜ã¦ã‚»ãƒ«ã‚’è‰²åˆ†ã‘ã—ã¾ã™<br>
                            ãƒ»ã‚ªãƒ•: è‰²åˆ†ã‘ã‚’ç„¡åŠ¹ã«ã—ã¾ã™
                        </small>
                    </div>
                </div>

                <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºå½¢å¼è¨­å®š -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>ğŸ“‹ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºå½¢å¼</h3>
                    <p style="color: #666; margin-bottom: 15px;">è¦‹ç©ä¸€è¦§ã¨ãƒ¬ãƒãƒ¼ãƒˆã‚’é–‹ã„ãŸã¨ãã«è¡¨ç¤ºã•ã‚Œã‚‹åˆæœŸè¡¨ç¤ºå½¢å¼ã‚’è¨­å®šã§ãã¾ã™ã€‚</p>

                    <div class="form-group">
                        <label>è¦‹ç©ä¸€è¦§ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º</label>
                        <select id="defaultEstimateViewType" onchange="saveDefaultViewTypeSetting()">
                            <option value="grouped">ã‚°ãƒ«ãƒ¼ãƒ—</option>
                            <option value="matrix">ãƒãƒˆãƒªã‚¯ã‚¹</option>
                            <option value="list">ãƒªã‚¹ãƒˆ</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            è¦‹ç©ä¸€è¦§ã‚¿ãƒ–ã‚’é–‹ã„ãŸã¨ãã€ã¾ãŸã¯ç”»é¢ã‚’èª­ã¿è¾¼ã‚“ã ã¨ãã®åˆæœŸè¡¨ç¤ºå½¢å¼ã§ã™ã€‚
                        </small>
                    </div>

                    <div class="form-group">
                        <label>ãƒ¬ãƒãƒ¼ãƒˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º</label>
                        <select id="defaultReportViewType" onchange="saveDefaultViewTypeSetting()">
                            <option value="summary">ã‚µãƒãƒªãƒ¼</option>
                            <option value="grouped">ã‚°ãƒ«ãƒ¼ãƒ—</option>
                            <option value="matrix">ãƒãƒˆãƒªã‚¯ã‚¹</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ–ã‚’é–‹ã„ãŸã¨ãã€ã¾ãŸã¯ç”»é¢ã‚’èª­ã¿è¾¼ã‚“ã ã¨ãã®åˆæœŸè¡¨ç¤ºå½¢å¼ã§ã™ã€‚
                        </small>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
                    <p style="color: #666; margin-bottom: 15px;">ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ™‚ã«è‡ªå‹•çš„ã«JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="autoBackupEnabled" onchange="saveAutoBackupSetting()" style="width: auto; margin-right: 10px;">
                            <span>è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ãƒ»ã‚ªãƒ³ã«ã™ã‚‹ã¨ã€å®Ÿç¸¾ã‚„è¦‹ç©ã®ç™»éŒ²ãƒ»ç·¨é›†æ™‚ã«è‡ªå‹•ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™<br>
                            ãƒ»ã‚ªãƒ•ã«ã—ã¦ã‚‚ã€æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ã¯ä½¿ç”¨ã§ãã¾ã™
                        </small>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</h3>
                    <p style="color: #666; margin-bottom: 15px;">ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã‚¿ãƒ–ã®å®Ÿç¸¾å…¥åŠ›/è¦‹ç©ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã®å‹•ä½œã‚’è¨­å®šã§ãã¾ã™ã€‚</p>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="rememberQuickInputMode" onchange="saveQuickInputModeSetting()" style="width: auto; margin-right: 10px;">
                            <span>å‰å›ã®ãƒ¢ãƒ¼ãƒ‰ï¼ˆå®Ÿç¸¾/è¦‹ç©ï¼‰ã‚’è¨˜æ†¶ã™ã‚‹</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ãƒ»ã‚ªãƒ•ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰: å¸¸ã«å®Ÿç¸¾å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹ã—ã¾ã™<br>
                            ãƒ»ã‚ªãƒ³: å‰å›ä½¿ç”¨ã—ãŸãƒ¢ãƒ¼ãƒ‰ï¼ˆå®Ÿç¸¾å…¥åŠ› or è¦‹ç©ç™»éŒ²ï¼‰ã‚’è¨˜æ†¶ã—ã€æ¬¡å›ã‚‚åŒã˜ãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹ã—ã¾ã™
                        </small>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>æ‹…å½“è€…è¡¨ç¤ºé †</h3>
                    <p style="color: #666; margin-bottom: 15px;">æ‹…å½“è€…ã®è¡¨ç¤ºé †åºã‚’æŒ‡å®šã§ãã¾ã™ã€‚ã“ã®é †åºã¯å®Ÿç¸¾ä¸€è¦§ã€ãƒ¬ãƒãƒ¼ãƒˆã€å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ãªã©å…¨ã¦ã®ç”»é¢ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚</p>
                    
                    <div class="form-group">
                        <label>è¡¨ç¤ºé †åº <button onclick="showMemberOrderHelp()" style="border: none; background: none; cursor: pointer; color: #3498db; font-size: 18px;">â„¹ï¸</button></label>
                        <input type="text" id="memberOrder" placeholder="ä¾‹: A,B,C,D ã¾ãŸã¯ å±±ç”°,ä½è—¤,ç”°ä¸­" onchange="updateAllDisplays()">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ãƒ»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„<br>
                            ãƒ»æŒ‡å®šã—ãŸé †ç•ªã§è¡¨ç¤ºã•ã‚Œã¾ã™<br>
                            ãƒ»æŒ‡å®šã—ã¦ã„ãªã„æ‹…å½“è€…ã¯å¾Œã‚ã«ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã§è¡¨ç¤ºã•ã‚Œã¾ã™<br>
                            ãƒ»è¨­å®šã¯è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã¾ã™
                        </small>
                    </div>
                    
                    <button class="btn btn-primary" onclick="updateAllDisplays()" style="margin-top: 10px;">è¨­å®šã‚’é©ç”¨</button>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>ğŸ“ è¡¨ç¤ºå½¢å¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</h3>
                    <p style="color: #666; margin-bottom: 15px;">è¦‹ç©ä¸€è¦§ã€å®Ÿç¸¾ä¸€è¦§ã€ãƒ¬ãƒãƒ¼ãƒˆã®è¡¨ç¤ºå½¢å¼é¸æŠUIã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å¤‰æ›´ã§ãã¾ã™ã€‚</p>

                    <div class="form-group">
                        <label>è¦‹ç©ä¸€è¦§ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</label>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <button onclick="toggleFilterLayout('estimate', 'compact')" class="layout-toggle-btn" style="padding: 6px 14px; font-size: 13px; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer;">æ¨ªä¸¦ã³</button>
                            <button onclick="toggleFilterLayout('estimate', 'segmented')" class="layout-toggle-btn" style="padding: 6px 14px; font-size: 13px; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer;">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            æ¨ªä¸¦ã³: ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªæ¨ªä¸¦ã³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ<br>
                            ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã‚’ä½¿ã£ãŸè¦‹ã‚„ã™ã„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
                        </small>
                    </div>

                    <div class="form-group">
                        <label>å®Ÿç¸¾ä¸€è¦§ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</label>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <button onclick="toggleFilterLayout('actual', 'compact')" class="layout-toggle-btn" style="padding: 6px 14px; font-size: 13px; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer;">æ¨ªä¸¦ã³</button>
                            <button onclick="toggleFilterLayout('actual', 'segmented')" class="layout-toggle-btn" style="padding: 6px 14px; font-size: 13px; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer;">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            æ¨ªä¸¦ã³: ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªæ¨ªä¸¦ã³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ<br>
                            ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã‚’ä½¿ã£ãŸè¦‹ã‚„ã™ã„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
                        </small>
                    </div>

                    <div class="form-group">
                        <label>ãƒ¬ãƒãƒ¼ãƒˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</label>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <button onclick="toggleFilterLayout('report', 'compact')" class="layout-toggle-btn" style="padding: 6px 14px; font-size: 13px; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer;">æ¨ªä¸¦ã³</button>
                            <button onclick="toggleFilterLayout('report', 'segmented')" class="layout-toggle-btn" style="padding: 6px 14px; font-size: 13px; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer;">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</button>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            æ¨ªä¸¦ã³: ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªæ¨ªä¸¦ã³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ<br>
                            ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã‚’ä½¿ã£ãŸè¦‹ã‚„ã™ã„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
                        </small>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆåˆ†ææ©Ÿèƒ½</h3>
                    <p style="color: #666; margin-bottom: 15px;">ãƒ¬ãƒãƒ¼ãƒˆã«è¡¨ç¤ºã™ã‚‹åˆ†ææ©Ÿèƒ½ã‚’é¸æŠã§ãã¾ã™ã€‚</p>

                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">Phase 1: å³åŠ¹æ€§ã®é«˜ã„æ”¹å–„</label>

                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="reportAccuracyEnabled" onchange="saveReportSettings(); updateReport();" style="width: auto; margin-right: 10px;" checked>
                            <span>è¦‹ç©ç²¾åº¦ã®%è¡¨ç¤ºï¼ˆå·¥ç¨‹åˆ¥ã€ç‰ˆæ•°åˆ¥ï¼‰</span>
                        </label>

                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="reportAnomalyEnabled" onchange="saveReportSettings(); updateReport();" style="width: auto; margin-right: 10px;" checked>
                            <span>ç•°å¸¸å€¤ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºï¼ˆ50%è¶…éã‚’å¼·èª¿ï¼‰</span>
                        </label>

                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="reportWarningTasksEnabled" onchange="saveReportSettings(); updateReport();" style="width: auto; margin-right: 10px;" checked>
                            <span>è¦æ³¨æ„ã‚¿ã‚¹ã‚¯ã®ãƒªã‚¹ãƒˆè¡¨ç¤º</span>
                        </label>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">Phase 2: è¦–è¦šåŒ–ã®å¼·åŒ–</label>

                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="reportChartEnabled" onchange="saveReportSettings(); updateReport();" style="width: auto; margin-right: 10px;" checked>
                            <span>æ£’ã‚°ãƒ©ãƒ•è¡¨ç¤ºï¼ˆç‰ˆæ•°åˆ¥ã€å·¥ç¨‹åˆ¥ï¼‰</span>
                        </label>

                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="reportTrendEnabled" onchange="saveReportSettings(); updateReport();" style="width: auto; margin-right: 10px;" checked>
                            <span>æœˆåˆ¥æ¨ç§»ã®è¡¨ç¤º</span>
                        </label>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">Phase 3: é«˜åº¦ãªåˆ†æ</label>

                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="reportMemberAnalysisEnabled" onchange="saveReportSettings(); updateReport();" style="width: auto; margin-right: 10px;" checked>
                            <span>æ‹…å½“è€…åˆ¥ã®è©³ç´°åˆ†æ</span>
                        </label>

                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="reportInsightsEnabled" onchange="saveReportSettings(); updateReport();" style="width: auto; margin-right: 10px;" checked>
                            <span>ã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒ»æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º</span>
                        </label>
                    </div>

                    <small style="color: #666; display: block; margin-top: 10px;">
                        ãƒ»è¨­å®šã¯è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã¾ã™<br>
                        ãƒ»ä¸è¦ãªæ©Ÿèƒ½ã‚’ã‚ªãƒ•ã«ã™ã‚‹ã“ã¨ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤ºã«ã§ãã¾ã™
                    </small>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>ğŸ¢ ä¼šç¤¾ä¼‘æ—¥è¨­å®š</h3>
                    <p style="color: #666; margin-bottom: 15px;">ä¼šç¤¾ã®å¤å­£ä¼‘æš‡ã€å¹´æœ«å¹´å§‹ä¼‘æš‡ãªã©ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚å®Ÿåƒæ—¥æ•°ã®è¨ˆç®—ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</p>

                    <div class="form-group">
                        <label>ä¼‘æ—¥å</label>
                        <input type="text" id="companyHolidayName" placeholder="ä¾‹: å¤å­£ä¼‘æš‡">
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <div class="form-group" style="flex: 1; margin: 0;">
                            <label>é–‹å§‹æ—¥</label>
                            <input type="date" id="companyHolidayStartDate">
                        </div>
                        <div class="form-group" style="flex: 1; margin: 0;">
                            <label>çµ‚äº†æ—¥</label>
                            <input type="date" id="companyHolidayEndDate">
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="addCompanyHoliday()" style="margin-bottom: 20px;">ä¼‘æ—¥ã‚’è¿½åŠ </button>

                    <div id="companyHolidayList"></div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json,.xlsx,.xls" style="display: none;" onchange="handleFileImport(event)">

    <!-- ä½œæ¥­è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="workModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ä½œæ¥­è©³ç´°</h3>
                <button class="modal-close" onclick="closeWorkModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>

    <!-- å®Ÿç¸¾ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editActualModal" class="modal" onclick="closeEditActualModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†</h3>
                <button class="modal-close" onclick="closeEditActualModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editActualId">
                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <input type="date" id="editActualDate" style="max-width: 200px;">
                </div>
                <div class="form-group">
                    <label>ç‰ˆæ•°</label>
                    <select id="editActualVersion" onchange="handleVersionChange('editActualVersion')">
                        <option value="">-- ç‰ˆæ•°ã‚’é¸æŠ --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¯¾å¿œå</label>
                    <select id="editActualTaskSelect" onchange="handleActualTaskSelect()" style="margin-bottom: 10px;">
                        <option value="">-- å¯¾å¿œã‚’é¸æŠ --</option>
                    </select>
                    <input type="text" id="editActualTaskSearch" placeholder="å¯¾å¿œåã‚’å…¥åŠ›" style="display: none;">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        â†‘ æœªå®Œäº†ã®å¯¾å¿œã‚’é¸æŠã€ã¾ãŸã¯ã€Œæ–°è¦å…¥åŠ›ã€ã§æ–°ã—ã„å¯¾å¿œã‚’è¿½åŠ 
                    </small>
                </div>
                <div class="form-group">
                    <label>å·¥ç¨‹</label>
                    <select id="editActualProcess">
                        <option value="UI">UI</option>
                        <option value="PG">PG</option>
                        <option value="PT">PT</option>
                        <option value="IT">IT</option>
                        <option value="ST">ST</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ‹…å½“</label>
                    <select id="editActualMember" onchange="handleEditActualMemberChange()">
                    </select>
                    <span id="editActualMemberDisplay" style="display: none; padding: 10px; background: #f5f5f5; border-radius: 6px; font-weight: 600;"></span>
                </div>
                <div class="form-group">
                    <label>å®Ÿç¸¾å·¥æ•°</label>
                    <input type="number" id="editActualHours" step="0.5" min="0" placeholder="8">
                </div>
                <div class="form-group" id="remainingHoursGroup">
                    <label>è¦‹è¾¼æ®‹å­˜æ™‚é–“</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="editActualRemainingHours" step="0.5" min="0" placeholder="0" style="flex: 1; max-width: 120px;">
                        <span style="color: #666; font-size: 13px;">æ™‚é–“</span>
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">ã“ã®å¯¾å¿œã«ã‚ã¨ä½•æ™‚é–“ã§å®Œäº†äºˆå®šã‹å…¥åŠ›ï¼ˆ0=å®Œäº†ï¼‰</small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="saveActualEdit()">ä¿å­˜</button>
                    <button class="btn" id="editActualOtherBtn" onclick="openOtherWorkFromCalendar()" style="background: #9b59b6; color: white; display: none;">ãã®ä»–ä½œæ¥­</button>
                    <button class="btn" id="editActualVacationBtn" onclick="openVacationFromCalendar()" style="background: #27ae60; color: white; display: none;">ä¼‘æš‡ç™»éŒ²</button>
                    <button class="btn" onclick="closeEditActualModal()" style="background: #95a5a6; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¦‹è¾¼æ®‹å­˜æ™‚é–“ä¸€æ‹¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="bulkRemainingModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 85vh;">
            <div class="modal-header">
                <h3>è¦‹è¾¼æ®‹å­˜æ™‚é–“ã®ä¸€æ‹¬ç·¨é›†</h3>
                <button class="modal-close" onclick="closeBulkRemainingModal()">&times;</button>
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: calc(85vh - 120px);">
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                    <label>ç‰ˆæ•°ãƒ•ã‚£ãƒ«ã‚¿:</label>
                    <select id="bulkRemainingVersionFilter" onchange="renderBulkRemainingTable()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="all">å…¨ç‰ˆæ•°</option>
                    </select>
                </div>
                <div class="table-wrapper" style="overflow-x: auto;">
                    <table id="bulkRemainingTable" style="width: 100%; border-collapse: collapse; min-width: 800px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">ç‰ˆæ•°</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">å¯¾å¿œå</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">å·¥ç¨‹</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">æ‹…å½“</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">è¦‹ç©</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">å®Ÿç¸¾</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">æ®‹å­˜</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">äºˆæ¸¬ç·å·¥æ•°</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">çŠ¶æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="bulkRemainingTableBody">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                    <button class="btn btn-primary" onclick="saveBulkRemaining()">ä¿å­˜</button>
                    <button class="btn" onclick="closeBulkRemainingModal()" style="background: #95a5a6; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¼‘æš‡ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="vacationModal" class="modal" onclick="closeVacationModal()">
        <div class="modal-content" style="max-width: 400px;" onclick="event.stopPropagation()">
            <div class="modal-header" style="background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);">
                <h3 style="color: white;">ä¼‘æš‡ã‚’ç™»éŒ²</h3>
                <button class="modal-close" onclick="closeVacationModal()" style="color: white;">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="vacationModalMember">
                <input type="hidden" id="vacationModalDate">
                <div class="form-group">
                    <label>æ‹…å½“è€…</label>
                    <div id="vacationModalMemberDisplay" style="padding: 10px; background: #f5f5f5; border-radius: 6px; font-weight: 600;"></div>
                </div>
                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <div id="vacationModalDateDisplay" style="padding: 10px; background: #f5f5f5; border-radius: 6px; font-weight: 600;"></div>
                </div>
                <div class="form-group">
                    <label>ä¼‘æš‡ã‚¿ã‚¤ãƒ—</label>
                    <select id="vacationModalType" onchange="handleVacationModalTypeChange()">
                        <option value="æœ‰ä¼‘">æœ‰çµ¦ä¼‘æš‡ï¼ˆæœ‰ä¼‘ï¼‰</option>
                        <option value="ç‰¹ä¼‘">ç‰¹åˆ¥ä¼‘æš‡ï¼ˆç‰¹ä¼‘ï¼‰</option>
                        <option value="ä»£ä¼‘">ä»£ä¼‘ï¼ˆä»£ä¼‘ï¼‰</option>
                        <option value="æŒ¯ä¼‘">æŒ¯æ›¿ä¼‘æ—¥ï¼ˆæŒ¯ä¼‘ï¼‰</option>
                        <option value="æ™‚é–“ä¼‘">æ™‚é–“ä¼‘</option>
                    </select>
                </div>
                <div class="form-group" id="vacationModalHoursGroup">
                    <label>æ™‚é–“æ•° (h)</label>
                    <input type="number" id="vacationModalHours" step="1" min="1" max="8" value="8">
                    <small style="color: #666; display: block; margin-top: 5px;">æ™‚é–“ä¼‘ã¯1hå˜ä½ã§å…¥åŠ›ã€‚å…¨æ—¥ä¼‘æš‡ã¯8hã€‚</small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveVacationFromModal()" style="background: #f57c00;">ç™»éŒ²</button>
                    <button class="btn" onclick="closeVacationModal()" style="background: #95a5a6; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¦‹ç©ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editEstimateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†</h3>
                <button class="modal-close" onclick="closeEditEstimateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editEstimateId">
                <div class="form-group">
                    <label>ç‰ˆæ•°</label>
                    <select id="editEstimateVersion" onchange="handleVersionChange('editEstimateVersion')">
                        <option value="">-- ç‰ˆæ•°ã‚’é¸æŠ --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¯¾å¿œå</label>
                    <input type="text" id="editEstimateTaskSearch" placeholder="æ¤œç´¢ã¾ãŸã¯æ–°è¦å…¥åŠ›" list="editEstimateTaskList" oninput="handleEstimateTaskInput()">
                    <datalist id="editEstimateTaskList">
                    </datalist>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        â†‘ æ—¢å­˜ã®å¯¾å¿œåã‚’é¸æŠã€ã¾ãŸã¯æ–°ã—ã„åå‰ã‚’å…¥åŠ›
                    </small>
                </div>
                <div class="form-group">
                    <label>å·¥ç¨‹</label>
                    <select id="editEstimateProcess">
                        <option value="UI">UI</option>
                        <option value="PG">PG</option>
                        <option value="PT">PT</option>
                        <option value="IT">IT</option>
                        <option value="ST">ST</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ‹…å½“</label>
                    <select id="editEstimateMember">
                    </select>
                </div>
                <div class="form-group">
                    <label>è¦‹ç©å·¥æ•°</label>
                    <input type="number" id="editEstimateHours" step="0.5" min="0" placeholder="8">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveEstimateEdit()">ä¿å­˜</button>
                    <button class="btn" onclick="closeEditEstimateModal()" style="background: #95a5a6; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¦‹ç©ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="addEstimateModal" class="modal" onclick="handleAddModalClick(event)">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>ğŸ“ è¦‹ç©ç™»éŒ²</h3>
                <button class="modal-close" onclick="closeAddEstimateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ç‰ˆæ•°</label>
                    <select id="addEstVersion" onchange="handleVersionChange('addEstVersion')">
                        <option value="">-- ç‰ˆæ•°ã‚’é¸æŠ --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¸³ç¥¨å</label>
                    <input type="text" id="addEstFormName" list="addEstFormNameList" placeholder="å¸³ç¥¨A">
                    <datalist id="addEstFormNameList">
                    </datalist>
                    <small style="color: #666; display: block; margin-top: 5px;">æ—¢å­˜ã®å¸³ç¥¨åã‚’é¸æŠã€ã¾ãŸã¯æ–°è¦å…¥åŠ›ã§ãã¾ã™</small>
                </div>
                <div class="form-group">
                    <label>å¯¾å¿œå</label>
                    <input type="text" id="addEstTask" placeholder="Xå¯¾å¿œ">
                </div>
                <div class="form-group">
                    <label>ä½œæ¥­æœˆ</label>
                    <div style="display: flex; gap: 12px; margin-bottom: 8px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="addEstMonthType" value="single" checked onchange="switchAddEstMonthType()" style="width: auto; margin-right: 4px;">
                            <span style="font-size: 14px;">å˜ä¸€æœˆ</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="addEstMonthType" value="multi" onchange="switchAddEstMonthType()" style="width: auto; margin-right: 4px;">
                            <span style="font-size: 14px;">è¤‡æ•°æœˆ</span>
                        </label>
                    </div>
                    <div id="addEstMonthInputs">
                        <div id="addEstSingleMonthInput" style="display: block;">
                            <select id="addEstStartMonth"></select>
                        </div>
                        <div id="addEstMultiMonthInput" style="display: none;">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="addEstStartMonthMulti"></select>
                                <span>ã€œ</span>
                                <select id="addEstEndMonth"></select>
                            </div>
                        </div>
                    </div>
                </div>
                <h4 style="margin-bottom: 10px; margin-top: 20px;">å„å·¥ç¨‹ã®è¦‹ç©</h4>
                <div class="estimate-table-wrapper">
                    <table class="estimate-table" id="addEstimateTable" style="width: 100%; margin: 0;">
                        <thead>
                            <tr>
                                <th style="width: 60px; padding: 8px; text-align: center;">å·¥ç¨‹</th>
                                <th style="width: 120px; padding: 8px;">æ‹…å½“</th>
                                <th style="width: 100px; padding: 8px;">æ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="text-align: center; font-weight: 600;"><span class="badge badge-ui">UI</span></td>
                                <td><select id="addEstUI_member" style="margin: 0;"></select></td>
                                <td><input type="number" id="addEstUI" placeholder="h" step="0.5" style="margin: 0;" oninput="updateAddEstimateTotals()"></td>
                            </tr>
                            <tr>
                                <td style="text-align: center; font-weight: 600;"><span class="badge badge-pg">PG</span></td>
                                <td><select id="addEstPG_member" style="margin: 0;"></select></td>
                                <td><input type="number" id="addEstPG" placeholder="h" step="0.5" style="margin: 0;" oninput="updateAddEstimateTotals()"></td>
                            </tr>
                            <tr>
                                <td style="text-align: center; font-weight: 600;"><span class="badge badge-pt">PT</span></td>
                                <td><select id="addEstPT_member" style="margin: 0;"></select></td>
                                <td><input type="number" id="addEstPT" placeholder="h" step="0.5" style="margin: 0;" oninput="updateAddEstimateTotals()"></td>
                            </tr>
                            <tr>
                                <td style="text-align: center; font-weight: 600;"><span class="badge badge-it">IT</span></td>
                                <td><select id="addEstIT_member" style="margin: 0;"></select></td>
                                <td><input type="number" id="addEstIT" placeholder="h" step="0.5" style="margin: 0;" oninput="updateAddEstimateTotals()"></td>
                            </tr>
                            <tr>
                                <td style="text-align: center; font-weight: 600;"><span class="badge badge-st">ST</span></td>
                                <td><select id="addEstST_member" style="margin: 0;"></select></td>
                                <td><input type="number" id="addEstST" placeholder="h" step="0.5" style="margin: 0;" oninput="updateAddEstimateTotals()"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- åˆè¨ˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="addEstimateTotals" style="background: #e3f2fd; padding: 12px 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #1976d2;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <span style="font-weight: 600; color: #1565c0;">å¯¾å¿œåˆè¨ˆ:</span>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <span style="color: #1565c0;"><strong id="addEstTotalHours">0.0</strong> h</span>
                            <span style="color: #1976d2;">(<span id="addEstTotalDays">0.0</span> äººæ—¥)</span>
                            <span style="color: #1976d2;">(<span id="addEstTotalMonths">0.00</span> äººæœˆ)</span>
                        </div>
                    </div>
                </div>

                <!-- æœˆåˆ†å‰²ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ -->
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #fb8c00;">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="addEnableMonthSplit" onchange="toggleAddMonthSplit()" style="width: auto; margin-right: 10px;">
                            <span style="font-weight: 600; color: #e65100;">ğŸ“… è¤‡æ•°æœˆã«åˆ†å‰²ã—ã¦ç™»éŒ²</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ä¸€ã¤ã®å·¥ç¨‹ã‚’è¤‡æ•°æœˆã§ä½œæ¥­ã™ã‚‹å ´åˆã«ã€æœˆåˆ¥ã®å·¥æ•°ã‚’è¨­å®šã§ãã¾ã™
                        </small>
                    </div>

                    <div id="addMonthSplitPanel" style="display: none; margin-top: 15px;">
                        <div class="form-group">
                            <label>åˆ†å‰²ã™ã‚‹å·¥ç¨‹ã‚’é¸æŠ</label>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="addSplitUI" class="add-split-process-checkbox" style="width: auto; margin-right: 5px;">
                                    <span>UI</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="addSplitPG" class="add-split-process-checkbox" style="width: auto; margin-right: 5px;">
                                    <span>PG</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="addSplitPT" class="add-split-process-checkbox" style="width: auto; margin-right: 5px;">
                                    <span>PT</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="addSplitIT" class="add-split-process-checkbox" style="width: auto; margin-right: 5px;">
                                    <span>IT</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="addSplitST" class="add-split-process-checkbox" style="width: auto; margin-right: 5px;">
                                    <span>ST</span>
                                </label>
                            </div>
                            <small style="color: #666; display: block; margin-top: 5px;">
                                ãƒã‚§ãƒƒã‚¯ã—ãŸå·¥ç¨‹ã®ã¿ãŒæœˆåˆ†å‰²ã•ã‚Œã¾ã™ã€‚ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ãªã„å·¥ç¨‹ã¯é€šå¸¸é€šã‚Šç™»éŒ²ã•ã‚Œã¾ã™ã€‚
                            </small>
                        </div>

                        <div class="form-group">
                            <label>ç·å·¥æ•°</label>
                            <input type="number" id="addTotalHours" step="0.1" min="0" placeholder="ä¾‹: 80" oninput="updateAddMonthPreview()">
                            <span style="margin-left: 5px;">æ™‚é–“</span>
                        </div>

                        <div class="form-group">
                            <label>ä½œæ¥­æœŸé–“</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="addStartMonth" onchange="updateAddMonthPreview()"></select>
                                <span>ã€œ</span>
                                <select id="addEndMonth" onchange="updateAddMonthPreview()"></select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>åˆ†å‰²æ–¹æ³•</label>
                            <div style="display: flex; gap: 20px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="addSplitMethod" value="equal" checked onchange="updateAddMonthPreview()" style="width: auto; margin-right: 5px;">
                                    <span>å‡ç­‰åˆ†å‰²</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="addSplitMethod" value="manual" onchange="updateAddMonthPreview()" style="width: auto; margin-right: 5px;">
                                    <span>æ‰‹å‹•è¨­å®š</span>
                                </label>
                            </div>
                        </div>

                        <div id="addMonthPreview" style="margin-top: 15px;"></div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="addEstimateFromModal()">ç™»éŒ²</button>
                    <button class="btn" onclick="closeAddEstimateModal()" style="background: #95a5a6; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ—¢å­˜è¦‹ç©ã®æœˆåˆ†å‰²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="splitEstimateModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>ğŸ“… è¦‹ç©ã‚’è¤‡æ•°æœˆã«åˆ†å‰²</h3>
                <button class="modal-close" onclick="closeSplitEstimateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="splitEstimateId">
                
                <div style="background: #f0f0f0; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <strong>å¯¾è±¡è¦‹ç©:</strong><br>
                    <div id="splitEstimateInfo" style="margin-top: 5px; color: #666;"></div>
                </div>
                
                <div class="form-group">
                    <label>ç·å·¥æ•°</label>
                    <input type="number" id="splitTotalHours" step="0.1" min="0" readonly style="background: #f0f0f0;">
                    <span style="margin-left: 5px;">æ™‚é–“</span>
                </div>
                
                <div class="form-group">
                    <label>ä½œæ¥­æœŸé–“</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="splitStartMonth" onchange="updateSplitPreview()"></select>
                        <span>ã€œ</span>
                        <select id="splitEndMonth" onchange="updateSplitPreview()"></select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>åˆ†å‰²æ–¹æ³•</label>
                    <div style="display: flex; gap: 20px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="splitMethodModal" value="equal" checked onchange="updateSplitPreview()" style="width: auto; margin-right: 5px;">
                            <span>å‡ç­‰åˆ†å‰²</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="splitMethodModal" value="manual" onchange="updateSplitPreview()" style="width: auto; margin-right: 5px;">
                            <span>æ‰‹å‹•è¨­å®š</span>
                        </label>
                    </div>
                </div>
                
                <div id="splitPreview" style="margin-top: 15px;"></div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="executeSplitEstimate()">åˆ†å‰²ã‚’é©ç”¨</button>
                    <button class="btn" onclick="closeSplitEstimateModal()" style="background: #95a5a6; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãã®ä»–ä½œæ¥­ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="otherWorkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ãã®ä»–ä½œæ¥­ã®ç™»éŒ²</h3>
                <button class="modal-close" onclick="closeOtherWorkModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                    <button id="meetingTab" class="other-work-tab active" onclick="switchOtherWorkTab('meeting')">æ‰“ã¡åˆã‚ã›</button>
                    <button id="customTab" class="other-work-tab" onclick="switchOtherWorkTab('custom')">ä»»æ„ä½œæ¥­</button>
                </div>
                
                <!-- æ‰“ã¡åˆã‚ã›ã‚¿ãƒ– -->
                <div id="meetingForm" class="other-work-form">
                    <p style="color: #666; margin-bottom: 15px;">å…¨æ‹…å½“è€…ã«åŒã˜å·¥æ•°ã§ç™»éŒ²ã•ã‚Œã¾ã™ã€‚</p>
                    <div class="form-group">
                        <label>å·¥æ•° (h)</label>
                        <input type="number" id="meetingHours" step="0.5" min="0" placeholder="ä¾‹: 2">
                    </div>
                    <button class="btn btn-success" onclick="addMeeting()">å…¨å“¡åˆ†è¿½åŠ </button>
                </div>
                
                <!-- ä»»æ„ä½œæ¥­ã‚¿ãƒ– -->
                <div id="customForm" class="other-work-form" style="display: none;">
                    <div class="form-group">
                        <label>ä½œæ¥­å</label>
                        <input type="text" id="otherWorkName" placeholder="ä¾‹: ç’°å¢ƒæ§‹ç¯‰ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ">
                    </div>
                    <div class="form-group">
                        <label>æ‹…å½“</label>
                        <select id="otherWorkMember">
                            <option value="">é¸æŠ...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å·¥æ•° (h)</label>
                        <input type="number" id="otherWorkHours" step="0.5" min="0" placeholder="ä¾‹: 4">
                    </div>
                    <button class="btn btn-success" onclick="addOtherWork()">è¿½åŠ </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let estimates = [];
        let actuals = [];
        let companyHolidays = []; // ä¼šç¤¾ä¼‘æ—¥ãƒ‡ãƒ¼ã‚¿
        let vacations = []; // å€‹äººä¼‘æš‡ãƒ‡ãƒ¼ã‚¿
        let remainingEstimates = []; // è¦‹è¾¼æ®‹å­˜æ™‚é–“ãƒ‡ãƒ¼ã‚¿
        let nextCompanyHolidayId = 1;
        let nextVacationId = 1;

        // ãƒ¬ãƒãƒ¼ãƒˆåˆ†ææ©Ÿèƒ½ã®è¨­å®š
        let reportSettings = {
            accuracyEnabled: true,
            anomalyEnabled: true,
            warningTasksEnabled: true,
            chartEnabled: true,
            trendEnabled: true,
            memberAnalysisEnabled: true,
            insightsEnabled: true
        };

        // Phaseã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æŠ˜ã‚Šç•³ã¿çŠ¶æ…‹
        let phaseCollapsed = {
            phase1: false,
            phase2: false,
            phase3: false
        };

        function togglePhaseCollapse(phaseId) {
            phaseCollapsed[phaseId] = !phaseCollapsed[phaseId];
            const content = document.getElementById(phaseId + '-content');
            const arrow = document.getElementById(phaseId + '-arrow');
            if (content) {
                content.style.display = phaseCollapsed[phaseId] ? 'none' : 'block';
            }
            if (arrow) {
                arrow.textContent = phaseCollapsed[phaseId] ? 'â–¶' : 'â–¼';
            }
        }

        let autoBackupEnabled = false; // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è¨­å®š

        // ãƒ†ãƒ¼ãƒè¨­å®š
        let currentThemeColor = 'purple';
        let currentThemePattern = 'none';
        let currentTabColor = 'same'; // ã‚¿ãƒ–ã®è‰²ï¼ˆ'same'=ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ã¨åŒã˜ã€'default'=é’ã€ã¾ãŸã¯è‰²åï¼‰

        // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š
        let estimateLayout = 'compact'; // è¦‹ç©ä¸€è¦§ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆ'compact' or 'segmented'ï¼‰
        let actualLayout = 'compact'; // å®Ÿç¸¾ä¸€è¦§ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆ'compact' or 'segmented'ï¼‰
        let reportLayout = 'compact'; // ãƒ¬ãƒãƒ¼ãƒˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆ'compact' or 'segmented'ï¼‰

        // ã‚¿ãƒ–ã®åˆå›è¡¨ç¤ºãƒ•ãƒ©ã‚°
        let isEstimateTabFirstView = true;
        let isReportTabFirstView = true;

        // ä¼šç¤¾ä¼‘æ—¥ç®¡ç†é–¢æ•°
        function addCompanyHoliday() {
            const name = document.getElementById('companyHolidayName').value.trim();
            const startDate = document.getElementById('companyHolidayStartDate').value;
            const endDate = document.getElementById('companyHolidayEndDate').value;

            if (!name || !startDate || !endDate) {
                alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (startDate > endDate) {
                alert('çµ‚äº†æ—¥ã¯é–‹å§‹æ—¥ä»¥é™ã®æ—¥ä»˜ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
                return;
            }

            const holiday = {
                id: nextCompanyHolidayId++,
                name: name,
                startDate: startDate,
                endDate: endDate
            };

            companyHolidays.push(holiday);
            saveData();
            renderCompanyHolidayList();

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('companyHolidayName').value = '';
            document.getElementById('companyHolidayStartDate').value = '';
            document.getElementById('companyHolidayEndDate').value = '';
        }

        function deleteCompanyHoliday(id) {
            if (!confirm('ã“ã®ä¼šç¤¾ä¼‘æ—¥ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            companyHolidays = companyHolidays.filter(h => h.id !== id);
            saveData();
            renderCompanyHolidayList();
            updateAllDisplays();
        }

        function renderCompanyHolidayList() {
            const container = document.getElementById('companyHolidayList');
            if (companyHolidays.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">ä¼šç¤¾ä¼‘æ—¥ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }

            let html = '<div class="table-wrapper"><table style="min-width: 0;">';
            html += '<tr><th>ä¼‘æ—¥å</th><th>æœŸé–“</th><th>æ“ä½œ</th></tr>';

            companyHolidays.forEach(h => {
                html += `
                    <tr>
                        <td>${h.name}</td>
                        <td>${h.startDate} ï½ ${h.endDate}</td>
                        <td>
                            <button class="btn btn-danger btn-small" onclick="deleteCompanyHoliday(${h.id})">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
            });

            html += '</table></div>';
            container.innerHTML = html;
        }

        // ä¼‘æš‡ã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©
        function handleVacationTypeChange() {
            const vacationType = document.getElementById('quickVacationType').value;
            const hoursInput = document.getElementById('quickVacationHours');

            if (vacationType === 'æ™‚é–“ä¼‘') {
                hoursInput.value = 1;
                hoursInput.max = 8;
            } else {
                hoursInput.value = 8;
                hoursInput.removeAttribute('max');
            }
        }

        // å€‹äººä¼‘æš‡ç®¡ç†é–¢æ•°
        function addQuickVacation() {
            const member = document.getElementById('quickVacationMember').value;
            const date = document.getElementById('quickVacationDate').value;
            const vacationType = document.getElementById('quickVacationType').value;
            const hours = parseFloat(document.getElementById('quickVacationHours').value);

            if (!member || !date || !vacationType || !hours) {
                alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (hours <= 0 || hours > 8) {
                alert('æ™‚é–“æ•°ã¯1ï½8ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const vacation = {
                id: nextVacationId++,
                member: member,
                date: date,
                vacationType: vacationType,
                hours: hours
            };

            vacations.push(vacation);
            saveData();
            renderActualList();
            alert('ä¼‘æš‡ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('quickVacationHours').value = 8;
        }

        function deleteVacation(id) {
            if (!confirm('ã“ã®ä¼‘æš‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            vacations = vacations.filter(v => v.id !== id);
            saveData();
            renderActualList();
        }

        function deleteVacationFromModal(id, member, date) {
            if (!confirm('ã“ã®ä¼‘æš‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            vacations = vacations.filter(v => v.id !== id);
            saveData();
            renderActualList();
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤º
            showWorkDetail(member, date);
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ä¼‘æš‡ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function addVacationFromCalendar(member, date) {
            document.getElementById('vacationModalMember').value = member;
            document.getElementById('vacationModalDate').value = date;
            document.getElementById('vacationModalMemberDisplay').textContent = member;

            const [year, month, day] = date.split('-');
            const dateObj = new Date(date);
            const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][dateObj.getDay()];
            document.getElementById('vacationModalDateDisplay').textContent = `${year}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥(${dayOfWeek})`;

            document.getElementById('vacationModalType').value = 'æœ‰ä¼‘';
            document.getElementById('vacationModalHours').value = 8;
            handleVacationModalTypeChange();

            document.getElementById('vacationModal').style.display = 'flex';
        }

        function closeVacationModal() {
            document.getElementById('vacationModal').style.display = 'none';
        }

        function handleVacationModalTypeChange() {
            const type = document.getElementById('vacationModalType').value;
            const hoursInput = document.getElementById('vacationModalHours');
            if (type === 'æ™‚é–“ä¼‘') {
                hoursInput.value = 1;
            } else {
                hoursInput.value = 8;
            }
        }

        function saveVacationFromModal() {
            const member = document.getElementById('vacationModalMember').value;
            const date = document.getElementById('vacationModalDate').value;
            const vacationType = document.getElementById('vacationModalType').value;
            const hours = parseFloat(document.getElementById('vacationModalHours').value);

            if (!member || !date || !vacationType || !hours) {
                alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (hours <= 0 || hours > 8) {
                alert('æ™‚é–“æ•°ã¯1ï½8ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const vacation = {
                id: nextVacationId++,
                member: member,
                date: date,
                vacationType: vacationType,
                hours: hours
            };

            vacations.push(vacation);
            saveData();
            closeVacationModal();
            renderActualList();
            alert('ä¼‘æš‡ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
        }

        // æŒ‡å®šæ—¥ãŒä¼šç¤¾ä¼‘æ—¥ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        function isCompanyHoliday(dateStr) {
            return companyHolidays.some(h => dateStr >= h.startDate && dateStr <= h.endDate);
        }

        // æŒ‡å®šæ—¥ã®ä¼šç¤¾ä¼‘æ—¥åã‚’å–å¾—
        function getCompanyHolidayName(dateStr) {
            const holiday = companyHolidays.find(h => dateStr >= h.startDate && dateStr <= h.endDate);
            return holiday ? holiday.name : null;
        }

        // æŒ‡å®šæ—¥ã®ä¼‘æš‡æƒ…å ±ã‚’å–å¾—
        function getVacation(member, dateStr) {
            return vacations.filter(v => v.member === member && v.date === dateStr);
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadAutoBackupSetting(); // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šã‚’èª­ã¿è¾¼ã¿
            loadThemeSettings(); // ãƒ†ãƒ¼ãƒè¨­å®šã‚’èª­ã¿è¾¼ã¿
            loadReportSettings(); // ãƒ¬ãƒãƒ¼ãƒˆåˆ†æè¨­å®šã‚’èª­ã¿è¾¼ã¿
            updateMonthOptions();
            updateEstimateMonthOptions(); // è¦‹ç©ä¸€è¦§ã®æœˆé¸æŠè‚¢ã‚’æ›´æ–°
            updateActualMonthOptions();
            updateMemberOptions();
            updateVersionOptions(); // ç‰ˆæ•°é¸æŠè‚¢ã‚’æ›´æ–°
            updateFormNameOptions(); // å¸³ç¥¨åãƒªã‚¹ãƒˆã‚’æ›´æ–°
            updateQuickTaskList();
            updateWorkMonthOptions(); // ä½œæ¥­æœˆé¸æŠè‚¢ã‚’æ›´æ–°

            // ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã®è¦‹ç©ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’åˆæœŸåŒ–
            initQuickEstimateForm();

            // å„ã‚¿ãƒ–ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœˆã‚’è¨­å®š
            setDefaultEstimateMonth(); // è¦‹ç©ã‚¿ãƒ–
            setDefaultActualMonth(); // å®Ÿç¸¾ã‚¿ãƒ–
            setDefaultReportMonth(); // ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ–

            renderEstimateList();
            renderActualList();
            renderTodayActuals();
            updateReport();
            renderCompanyHolidayList();

            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã®åˆæœŸè‰²ã‚’ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«è¨­å®š
            initSegmentButtonColors();

            // ãƒ¢ãƒã‚¤ãƒ«ã§ã‚¿ãƒ–ã®ã‚¹ãƒ¯ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã‚’è¿½åŠ 
            initTabSwipe();
        });

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã®åˆæœŸè‰²ã‚’ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«è¨­å®š
        function initSegmentButtonColors() {
            try {
                const themeColor = getThemeColor();

                // ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ã‚¿ã‚¤ãƒ—ãƒœã‚¿ãƒ³ï¼ˆæœˆåˆ¥ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠï¼‰
                const btnFilterMonth = document.getElementById('btnFilterMonth');
                if (btnFilterMonth) {
                    btnFilterMonth.style.background = themeColor;
                    btnFilterMonth.style.color = 'white';
                }

                // ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤ºå½¢å¼ãƒœã‚¿ãƒ³ï¼ˆç¾åœ¨ã®é¸æŠã«å¿œã˜ã¦ï¼‰
                const reportViewType = document.getElementById('reportViewType');
                const btnReportSummary = document.getElementById('btnReportSummary');
                const btnReportGrouped = document.getElementById('btnReportGrouped');
                const btnReportMatrix = document.getElementById('btnReportMatrix');
                if (reportViewType && btnReportSummary && btnReportGrouped && btnReportMatrix) {
                    const type = reportViewType.value;
                    btnReportSummary.style.background = type === 'summary' ? themeColor : 'white';
                    btnReportSummary.style.color = type === 'summary' ? 'white' : '#333';
                    btnReportGrouped.style.background = type === 'grouped' ? themeColor : 'white';
                    btnReportGrouped.style.color = type === 'grouped' ? 'white' : '#333';
                    btnReportMatrix.style.background = type === 'matrix' ? themeColor : 'white';
                    btnReportMatrix.style.color = type === 'matrix' ? 'white' : '#333';
                }

                // å®Ÿç¸¾ä¸€è¦§è¡¨ç¤ºå½¢å¼ãƒœã‚¿ãƒ³ï¼ˆç¾åœ¨ã®é¸æŠã«å¿œã˜ã¦ï¼‰
                const actualViewType = document.getElementById('actualViewType');
                const btnActualMatrix = document.getElementById('btnActualMatrix');
                const btnActualList = document.getElementById('btnActualList');
                if (actualViewType && btnActualMatrix && btnActualList) {
                    const type = actualViewType.value;
                    btnActualMatrix.style.background = type === 'matrix' ? themeColor : 'white';
                    btnActualMatrix.style.color = type === 'matrix' ? 'white' : '#333';
                    btnActualList.style.background = type === 'list' ? themeColor : 'white';
                    btnActualList.style.color = type === 'list' ? 'white' : '#333';
                }

                // è¦‹ç©ä¸€è¦§è¡¨ç¤ºå½¢å¼ãƒœã‚¿ãƒ³ï¼ˆç¾åœ¨ã®é¸æŠã«å¿œã˜ã¦ï¼‰
                const estimateViewType = document.getElementById('estimateViewType');
                const btnEstimateGrouped = document.getElementById('btnEstimateGrouped');
                const btnEstimateMatrix = document.getElementById('btnEstimateMatrix');
                const btnEstimateList = document.getElementById('btnEstimateList');
                if (estimateViewType && btnEstimateGrouped && btnEstimateMatrix && btnEstimateList) {
                    const type = estimateViewType.value;
                    btnEstimateGrouped.style.background = type === 'grouped' ? themeColor : 'white';
                    btnEstimateGrouped.style.color = type === 'grouped' ? 'white' : '#333';
                    btnEstimateMatrix.style.background = type === 'matrix' ? themeColor : 'white';
                    btnEstimateMatrix.style.color = type === 'matrix' ? 'white' : '#333';
                    btnEstimateList.style.background = type === 'list' ? themeColor : 'white';
                    btnEstimateList.style.color = type === 'list' ? 'white' : '#333';
                }
            } catch (e) {
                console.error('initSegmentButtonColors error:', e);
            }
        }

        // ã‚¿ãƒ–ã®ã‚¹ãƒ¯ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã‚’åˆæœŸåŒ–
        function initTabSwipe() {
            const content = document.querySelector('.content');
            if (!content) return;

            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            let touchStartTarget = null;

            const minSwipeDistance = 100; // æœ€å°ã‚¹ãƒ¯ã‚¤ãƒ—è·é›¢ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
            const maxVerticalDistance = 50; // ç¸¦æ–¹å‘ã®æœ€å¤§ç§»å‹•è·é›¢ï¼ˆã“ã‚Œä»¥ä¸Šå‹•ãã¨ã‚¹ãƒ¯ã‚¤ãƒ—ã¨åˆ¤å®šã—ãªã„ï¼‰

            // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ç„¡åŠ¹ã«ã™ã¹ãè¦ç´ ã‹ã©ã†ã‹ã‚’åˆ¤å®š
            function shouldDisableSwipe(target) {
                if (!target) return false;

                // å…¥åŠ›è¦ç´ ç³»ã§ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã¯ç„¡åŠ¹
                const tagName = target.tagName;
                if (tagName === 'INPUT' || tagName === 'TEXTAREA' || tagName === 'SELECT') {
                    return true;
                }

                // ç‰¹å®šã®ã‚¯ãƒ©ã‚¹ã‚„ãã®è¦ªè¦ç´ ã§ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã¯ç„¡åŠ¹
                const element = target.closest('.table-wrapper, .estimate-table-wrapper, .modal.active, .custom-dropdown, #dragHandle, #workMonthAssignmentMode');
                return element !== null;
            }

            content.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
                touchStartTarget = e.target;
            }, { passive: true });

            content.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipe();
            }, { passive: true });

            function handleSwipe() {
                // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ç„¡åŠ¹ã«ã™ã¹ãè¦ç´ ã§ã‚¿ãƒƒãƒãŒé–‹å§‹ã•ã‚ŒãŸå ´åˆã¯å‡¦ç†ã—ãªã„
                if (shouldDisableSwipe(touchStartTarget)) {
                    return;
                }

                const diffX = touchEndX - touchStartX;
                const diffY = Math.abs(touchEndY - touchStartY);
                const absDiffX = Math.abs(diffX);

                // ç¸¦æ–¹å‘ã®ç§»å‹•ãŒå¤§ãã„å ´åˆã¯ã‚¹ãƒ¯ã‚¤ãƒ—ã¨åˆ¤å®šã—ãªã„ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨åˆ¤æ–­ï¼‰
                if (diffY > maxVerticalDistance) {
                    return;
                }

                // ç¸¦æ–¹å‘ã®ç§»å‹•ãŒæ¨ªæ–¹å‘ã®ç§»å‹•ã‚ˆã‚Šå¤§ãã„å ´åˆã¯ã‚¹ãƒ¯ã‚¤ãƒ—ã¨åˆ¤å®šã—ãªã„
                if (diffY > absDiffX) {
                    return;
                }

                // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆæ¬¡ã®ã‚¿ãƒ–ã¸ï¼‰
                if (diffX < -minSwipeDistance) {
                    nextTab();
                }
                // å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå‰ã®ã‚¿ãƒ–ã¸ï¼‰
                else if (diffX > minSwipeDistance) {
                    prevTab();
                }
            }
        }

        function loadAutoBackupSetting() {
            const saved = localStorage.getItem('autoBackupEnabled');
            autoBackupEnabled = saved === 'true';
            document.getElementById('autoBackupEnabled').checked = autoBackupEnabled;
        }

        function saveAutoBackupSetting() {
            autoBackupEnabled = document.getElementById('autoBackupEnabled').checked;
            localStorage.setItem('autoBackupEnabled', autoBackupEnabled);
        }

        function saveQuickInputModeSetting() {
            rememberQuickInputMode = document.getElementById('rememberQuickInputMode').checked;
            localStorage.setItem('rememberQuickInputMode', rememberQuickInputMode);
        }

        function loadReportSettings() {
            const saved = localStorage.getItem('reportSettings');
            if (saved) {
                reportSettings = JSON.parse(saved);
            }
            // UIã«åæ˜ 
            document.getElementById('reportAccuracyEnabled').checked = reportSettings.accuracyEnabled;
            document.getElementById('reportAnomalyEnabled').checked = reportSettings.anomalyEnabled;
            document.getElementById('reportWarningTasksEnabled').checked = reportSettings.warningTasksEnabled;
            document.getElementById('reportChartEnabled').checked = reportSettings.chartEnabled;
            document.getElementById('reportTrendEnabled').checked = reportSettings.trendEnabled;
            document.getElementById('reportMemberAnalysisEnabled').checked = reportSettings.memberAnalysisEnabled;
            document.getElementById('reportInsightsEnabled').checked = reportSettings.insightsEnabled;
        }

        function saveReportSettings() {
            reportSettings.accuracyEnabled = document.getElementById('reportAccuracyEnabled').checked;
            reportSettings.anomalyEnabled = document.getElementById('reportAnomalyEnabled').checked;
            reportSettings.warningTasksEnabled = document.getElementById('reportWarningTasksEnabled').checked;
            reportSettings.chartEnabled = document.getElementById('reportChartEnabled').checked;
            reportSettings.trendEnabled = document.getElementById('reportTrendEnabled').checked;
            reportSettings.memberAnalysisEnabled = document.getElementById('reportMemberAnalysisEnabled').checked;
            reportSettings.insightsEnabled = document.getElementById('reportInsightsEnabled').checked;
            localStorage.setItem('reportSettings', JSON.stringify(reportSettings));
        }

        function saveData(skipAutoBackup = false) {
            const data = {
                estimates: estimates,
                actuals: actuals,
                companyHolidays: companyHolidays,
                vacations: vacations,
                settings: {
                    memberOrder: document.getElementById('memberOrder').value.trim(),
                    themeColor: currentThemeColor,
                    themePattern: currentThemePattern,
                    themeTabColor: currentTabColor,
                    autoBackup: autoBackupEnabled,
                    estimateLayout: estimateLayout,
                    actualLayout: actualLayout,
                    reportLayout: reportLayout,
                    showMonthColors: showMonthColorsSetting,
                    defaultEstimateViewType: document.getElementById('defaultEstimateViewType') ? document.getElementById('defaultEstimateViewType').value : 'grouped',
                    defaultReportViewType: document.getElementById('defaultReportViewType') ? document.getElementById('defaultReportViewType').value : 'grouped'
                }
            };

            localStorage.setItem('manhour_estimates', JSON.stringify(estimates));
            localStorage.setItem('manhour_actuals', JSON.stringify(actuals));
            localStorage.setItem('manhour_companyHolidays', JSON.stringify(companyHolidays));
            localStorage.setItem('manhour_vacations', JSON.stringify(vacations));
            localStorage.setItem('manhour_remainingEstimates', JSON.stringify(remainingEstimates));
            localStorage.setItem('manhour_settings', JSON.stringify(data.settings));

            // ä½œæ¥­æœˆé¸æŠè‚¢ã‚’æ›´æ–°
            updateWorkMonthOptions();

            // ç‰ˆæ•°é¸æŠè‚¢ã‚’æ›´æ–°
            updateVersionOptions();

            // å¸³ç¥¨åãƒªã‚¹ãƒˆã‚’æ›´æ–°
            updateFormNameOptions();

            // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿å®Ÿè¡Œ
            if (!skipAutoBackup && autoBackupEnabled) {
                autoBackup();
            }
        }

        function updateMemberOptions() {
            // è¦‹ç©ã¨å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ‹…å½“è€…ã‚’æŠ½å‡º
            const members = new Set();
            estimates.forEach(e => members.add(e.member));
            actuals.forEach(a => members.add(a.member));
            
            // è¡¨ç¤ºé †ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
            let sortedMembers;
            const memberOrderInput = document.getElementById('memberOrder').value.trim();
            if (memberOrderInput) {
                const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
                const orderedMembers = [];
                const unorderedMembers = [];
                
                orderList.forEach(name => {
                    if (members.has(name)) {
                        orderedMembers.push(name);
                    }
                });
                
                Array.from(members).forEach(m => {
                    if (!orderedMembers.includes(m)) {
                        unorderedMembers.push(m);
                    }
                });
                
                sortedMembers = [...orderedMembers, ...unorderedMembers.sort()];
            } else {
                sortedMembers = Array.from(members).sort();
            }
            
            // å„å·¥ç¨‹ã®æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°ï¼ˆè¦‹ç©ç®¡ç†ã‚¿ãƒ–ã¨ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã‚¿ãƒ–ï¼‰
            const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
            processes.forEach(process => {
                // è¦‹ç©ç®¡ç†ã‚¿ãƒ–ï¼ˆå‰Šé™¤æ¸ˆã¿ï¼‰ã® estXX_member ã¯ä¸è¦ã ãŒã€å¿µã®ãŸã‚æ®‹ã™
                const select = document.getElementById(`est${process}_member`);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-</option>';

                    sortedMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member;
                        option.textContent = member;
                        select.appendChild(option);
                    });

                    // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
                    if (currentValue && sortedMembers.includes(currentValue)) {
                        select.value = currentValue;
                    }
                }

                // ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã®è¦‹ç©ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
                const quickEstSelect = document.getElementById(`quickEst${process}_member`);
                if (quickEstSelect) {
                    const currentValue = quickEstSelect.value;
                    quickEstSelect.innerHTML = '<option value="">-</option>';

                    sortedMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member;
                        option.textContent = member;
                        quickEstSelect.appendChild(option);
                    });

                    // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
                    if (currentValue && sortedMembers.includes(currentValue)) {
                        quickEstSelect.value = currentValue;
                    }
                }

                // è¦‹ç©ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ‹…å½“è€…é¸æŠè‚¢ã‚‚æ›´æ–°
                const addEstSelect = document.getElementById(`addEst${process}_member`);
                if (addEstSelect) {
                    const currentValue = addEstSelect.value;
                    addEstSelect.innerHTML = '<option value="">-</option>';

                    sortedMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member;
                        option.textContent = member;
                        addEstSelect.appendChild(option);
                    });

                    // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
                    if (currentValue && sortedMembers.includes(currentValue)) {
                        addEstSelect.value = currentValue;
                    }
                }
            });
            
            // ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã®æ‹…å½“è€…é¸æŠè‚¢ã‚‚æ›´æ–°
            const quickMemberSelect = document.getElementById('quickMember');
            if (quickMemberSelect) {
                const currentValue = quickMemberSelect.value;
                quickMemberSelect.innerHTML = '';
                
                sortedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    quickMemberSelect.appendChild(option);
                });
                
                // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
                if (currentValue && sortedMembers.includes(currentValue)) {
                    quickMemberSelect.value = currentValue;
                } else if (sortedMembers.length > 0) {
                    quickMemberSelect.value = sortedMembers[0];
                }
            }
            
            // ãã®ä»–ä½œæ¥­ã®æ‹…å½“è€…é¸æŠè‚¢ã‚‚æ›´æ–°
            const otherWorkMemberSelect = document.getElementById('otherWorkMember');
            if (otherWorkMemberSelect) {
                const currentValue = otherWorkMemberSelect.value;
                otherWorkMemberSelect.innerHTML = '<option value="">é¸æŠ...</option>';

                sortedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    otherWorkMemberSelect.appendChild(option);
                });

                // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
                if (currentValue && sortedMembers.includes(currentValue)) {
                    otherWorkMemberSelect.value = currentValue;
                }
            }

            // å®Ÿç¸¾ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
            const editActualMemberSelect = document.getElementById('editActualMember');
            if (editActualMemberSelect) {
                const currentValue = editActualMemberSelect.value;
                editActualMemberSelect.innerHTML = '';

                sortedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    editActualMemberSelect.appendChild(option);
                });

                // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
                if (currentValue && sortedMembers.includes(currentValue)) {
                    editActualMemberSelect.value = currentValue;
                }
            }

            // ä¼‘æš‡ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
            const quickVacationMemberSelect = document.getElementById('quickVacationMember');
            if (quickVacationMemberSelect) {
                const currentValue = quickVacationMemberSelect.value;
                quickVacationMemberSelect.innerHTML = '';

                sortedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    quickVacationMemberSelect.appendChild(option);
                });

                // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒã€ã¾ãŸã¯æœ€åˆã®æ‹…å½“è€…ã‚’é¸æŠ
                if (currentValue && sortedMembers.includes(currentValue)) {
                    quickVacationMemberSelect.value = currentValue;
                } else if (sortedMembers.length > 0) {
                    quickVacationMemberSelect.value = sortedMembers[0];
                }
            }

            // è¦‹ç©ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
            const editEstimateMemberSelect = document.getElementById('editEstimateMember');
            if (editEstimateMemberSelect) {
                const currentValue = editEstimateMemberSelect.value;
                editEstimateMemberSelect.innerHTML = '';

                sortedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    editEstimateMemberSelect.appendChild(option);
                });

                // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
                if (currentValue && sortedMembers.includes(currentValue)) {
                    editEstimateMemberSelect.value = currentValue;
                }
            }
        }

        // ç‰ˆæ•°é¸æŠè‚¢ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateVersionOptions() {
            try {
                // è¦‹ç©ã¨å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç‰ˆæ•°ã‚’æŠ½å‡º
                const versions = new Set();
                estimates.forEach(e => {
                    if (e.version) versions.add(e.version);
                });
                actuals.forEach(a => {
                    if (a.version) versions.add(a.version);
                });

                // ç‰ˆæ•°ã‚’ã‚½ãƒ¼ãƒˆï¼ˆæ˜‡é †ï¼šç‰ˆæ•°åé †ã€æœ€æ–°ãŒæœ€å¾Œï¼‰
                const sortedVersions = Array.from(versions).sort();

                // å„ç‰ˆæ•°ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
                const versionSelects = [
                    'estVersion',           // æ–°è¦è¦‹ç©ç™»éŒ²ï¼ˆå‰Šé™¤æ¸ˆã¿ã ãŒå¿µã®ãŸã‚æ®‹ã™ï¼‰
                    'quickEstVersion',      // ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã®è¦‹ç©ç™»éŒ²
                    'editActualVersion',    // å®Ÿç¸¾ç·¨é›†/æ–°è¦ãƒ¢ãƒ¼ãƒ€ãƒ«
                    'editEstimateVersion',  // è¦‹ç©ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
                    'addEstVersion'         // è¦‹ç©ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«
                ];

                versionSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">-- ç‰ˆæ•°ã‚’é¸æŠ --</option>';

                        // ã€Œæ–°è¦è¿½åŠ ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                        const newOption = document.createElement('option');
                        newOption.value = '__new__';
                        newOption.textContent = '+ æ–°ã—ã„ç‰ˆæ•°ã‚’è¿½åŠ ...';
                        select.appendChild(newOption);

                        // æ—¢å­˜ã®ç‰ˆæ•°
                        sortedVersions.forEach(version => {
                            const option = document.createElement('option');
                            option.value = version;
                            option.textContent = version;
                            select.appendChild(option);
                        });

                        // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒã€ãªã‘ã‚Œã°æœ€æ–°ç‰ˆæ•°ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
                        if (currentValue && currentValue !== '__new__') {
                            select.value = currentValue;
                        } else if (sortedVersions.length > 0 && selectId === 'addEstVersion') {
                            // è¦‹ç©ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯æœ€æ–°ç‰ˆæ•°ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
                            select.value = sortedVersions[sortedVersions.length - 1];
                        }
                    }
                });

                // ãƒ¬ãƒãƒ¼ãƒˆç”¨ã®ç‰ˆæ•°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°
                updateReportVersionOptions(sortedVersions);
            } catch (e) {
                console.error('updateVersionOptions error:', e);
            }
        }

        // å¸³ç¥¨åãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆè¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æŠ½å‡ºï¼‰
        function updateFormNameOptions() {
            try {
                // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¸³ç¥¨åã‚’æŠ½å‡ºï¼ˆã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã®å·¦å´ï¼‰
                const formNames = new Set();
                estimates.forEach(e => {
                    if (e.task && e.task.includes('_')) {
                        const formName = e.task.split('_')[0];
                        if (formName.trim()) {
                            formNames.add(formName.trim());
                        }
                    }
                });

                // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ã‚½ãƒ¼ãƒˆ
                const sortedFormNames = Array.from(formNames).sort();

                // datalistã‚’æ›´æ–°
                const datalistIds = ['quickEstFormNameList', 'addEstFormNameList'];
                datalistIds.forEach(listId => {
                    const datalist = document.getElementById(listId);
                    if (datalist) {
                        datalist.innerHTML = '';
                        sortedFormNames.forEach(formName => {
                            const option = document.createElement('option');
                            option.value = formName;
                            datalist.appendChild(option);
                        });
                    }
                });
            } catch (e) {
                console.error('updateFormNameOptions error:', e);
            }
        }

        // ãƒ¬ãƒãƒ¼ãƒˆç”¨ã®ç‰ˆæ•°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateReportVersionOptions(sortedVersions) {
            try {
                // sortedVersionsãŒæ¸¡ã•ã‚Œãªã„å ´åˆã¯å†è¨ˆç®—
                if (!sortedVersions) {
                    const versions = new Set();
                    estimates.forEach(e => {
                        if (e.version && e.version.trim() !== '') {
                            versions.add(e.version);
                        }
                    });
                    actuals.forEach(a => {
                        if (a.version && a.version.trim() !== '') {
                            versions.add(a.version);
                        }
                    });
                    // æ˜‡é †ã§ã‚½ãƒ¼ãƒˆï¼ˆç‰ˆæ•°åé †ï¼‰
                    sortedVersions = Array.from(versions).sort();
                } else {
                    // æ¸¡ã•ã‚ŒãŸé…åˆ—ã‚’æ˜‡é †ã«ã‚½ãƒ¼ãƒˆã—ç›´ã™
                    sortedVersions = sortedVersions.slice().sort();
                }

                const select = document.getElementById('reportVersion');
                const select2 = document.getElementById('reportVersion2');

                if (!select) return;

                // åˆå›è¡¨ç¤ºæ™‚ã¯æœ€å¾Œã®ç‰ˆæ•°ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠã€ãã‚Œä»¥å¤–ã¯ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
                const isFirstLoad = !select.dataset.initialized;
                const lastVersion = sortedVersions.length > 0 ? sortedVersions[sortedVersions.length - 1] : 'all';
                const currentValue = isFirstLoad ? lastVersion : (select.value || 'all');

                // é¸æŠè‚¢ã‚’ç”Ÿæˆ
                select.innerHTML = '<option value="all">å…¨ç‰ˆæ•°</option>';
                if (select2) select2.innerHTML = '<option value="all">å…¨ç‰ˆæ•°</option>';

                sortedVersions.forEach(version => {
                    const option = document.createElement('option');
                    option.value = version;
                    option.textContent = version;
                    select.appendChild(option);

                    if (select2) {
                        const option2 = document.createElement('option');
                        option2.value = version;
                        option2.textContent = version;
                        select2.appendChild(option2);
                    }
                });

                // é¸æŠã‚’è¨­å®š
                select.value = currentValue;
                if (select2) select2.value = currentValue;
                select.dataset.initialized = 'true';

                // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ç‰ˆã‚’ç”Ÿæˆ
                const items = [
                    { value: 'all', label: 'å…¨ç‰ˆæ•°' },
                    ...sortedVersions.map(version => ({
                        value: version,
                        label: version
                    }))
                ];
                createSegmentButtons(
                    'reportVersionButtons2',
                    'reportVersion2',
                    items,
                    currentValue,
                    8,
                    handleReportVersionChange
                );
            } catch (e) {
                console.error('updateReportVersionOptions error:', e);
            }
        }

        // ç‰ˆæ•°é¸æŠæ™‚ã®å‡¦ç†ï¼ˆæ–°è¦è¿½åŠ å¯¾å¿œï¼‰
        function handleVersionChange(selectId) {
            const select = document.getElementById(selectId);
            if (select.value === '__new__') {
                const newVersion = prompt('æ–°ã—ã„ç‰ˆæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: ç¬¬2025.12ç‰ˆï¼‰');
                if (newVersion && newVersion.trim()) {
                    // æ–°ã—ã„ç‰ˆæ•°ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
                    const option = document.createElement('option');
                    option.value = newVersion.trim();
                    option.textContent = newVersion.trim();
                    select.insertBefore(option, select.options[2]); // ã€Œæ–°è¦è¿½åŠ ã€ã®æ¬¡ã«æŒ¿å…¥
                    select.value = newVersion.trim();
                } else {
                    select.value = '';
                }
            }

            // å®Ÿç¸¾ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ç‰ˆæ•°ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€å¯¾å¿œåãƒªã‚¹ãƒˆã‚’æ›´æ–°
            if (selectId === 'editActualVersion') {
                const modal = document.getElementById('editActualModal');
                const memberSelect = document.getElementById('editActualMember');
                let member = memberSelect ? memberSelect.value : null;

                // æ‹…å½“è€…ãŒå–å¾—ã§ããªã„å ´åˆã¯ã€datasetã‹ã‚‰å–å¾—ï¼ˆæ–°è¦ç™»éŒ²æ™‚ï¼‰
                if (!member && modal && modal.dataset.calendarMember) {
                    member = modal.dataset.calendarMember;
                }

                if (member) {
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆeditActualIdã«å€¤ãŒã‚ã‚Œã°ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼‰
                    const editIdInput = document.getElementById('editActualId');
                    const isEditMode = editIdInput && editIdInput.value !== '';
                    updateEditActualTaskList(member, isEditMode, select.value);
                }
            }
        }

        // å®Ÿç¸¾ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ‹…å½“è€…é¸æŠæ™‚ã®å‡¦ç†
        function handleEditActualMemberChange() {
            const memberSelect = document.getElementById('editActualMember');
            const versionSelect = document.getElementById('editActualVersion');
            const member = memberSelect ? memberSelect.value : null;
            const version = versionSelect ? versionSelect.value : null;

            if (member) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆeditActualIdã«å€¤ãŒã‚ã‚Œã°ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼‰
                const editIdInput = document.getElementById('editActualId');
                const isEditMode = editIdInput && editIdInput.value !== '';
                updateEditActualTaskList(member, isEditMode, version);
            }
        }

        function loadData() {
            const savedEstimates = localStorage.getItem('manhour_estimates');
            const savedActuals = localStorage.getItem('manhour_actuals');
            const savedCompanyHolidays = localStorage.getItem('manhour_companyHolidays');
            const savedVacations = localStorage.getItem('manhour_vacations');
            const savedRemainingEstimates = localStorage.getItem('manhour_remainingEstimates');
            const savedSettings = localStorage.getItem('manhour_settings');

            if (savedEstimates) estimates = JSON.parse(savedEstimates);
            if (savedActuals) actuals = JSON.parse(savedActuals);
            if (savedCompanyHolidays) companyHolidays = JSON.parse(savedCompanyHolidays);
            if (savedVacations) vacations = JSON.parse(savedVacations);
            if (savedRemainingEstimates) remainingEstimates = JSON.parse(savedRemainingEstimates);

            // æ¬¡ã®IDã‚’è¨­å®š
            if (companyHolidays.length > 0) {
                nextCompanyHolidayId = Math.max(...companyHolidays.map(h => h.id)) + 1;
            }
            if (vacations.length > 0) {
                nextVacationId = Math.max(...vacations.map(v => v.id)) + 1;
            }

            // è¨­å®šã‚’èª­ã¿è¾¼ã¿
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                if (settings.memberOrder) {
                    document.getElementById('memberOrder').value = settings.memberOrder;
                }
                if (settings.themeColor) currentThemeColor = settings.themeColor;
                if (settings.themePattern) currentThemePattern = settings.themePattern;
                if (settings.themeTabColor) currentTabColor = settings.themeTabColor;
                if (settings.autoBackup !== undefined) autoBackupEnabled = settings.autoBackup;
                if (settings.estimateLayout) estimateLayout = settings.estimateLayout;
                if (settings.actualLayout) actualLayout = settings.actualLayout;
                if (settings.reportLayout) reportLayout = settings.reportLayout;
                if (settings.showMonthColors !== undefined) {
                    showMonthColorsSetting = settings.showMonthColors;
                    const checkbox = document.getElementById('showMonthColorsCheckbox');
                    if (checkbox) checkbox.checked = showMonthColorsSetting;
                }
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºå½¢å¼ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿
                if (settings.defaultEstimateViewType) {
                    const estimateViewTypeSelect = document.getElementById('defaultEstimateViewType');
                    if (estimateViewTypeSelect) {
                        estimateViewTypeSelect.value = settings.defaultEstimateViewType;
                    }
                }
                if (settings.defaultReportViewType) {
                    const reportViewTypeSelect = document.getElementById('defaultReportViewType');
                    if (reportViewTypeSelect) {
                        reportViewTypeSelect.value = settings.defaultReportViewType;
                    }
                }
            } else {
                // æ—§å½¢å¼ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
                const savedMemberOrder = localStorage.getItem('manhour_memberOrder');
                if (savedMemberOrder) {
                    document.getElementById('memberOrder').value = savedMemberOrder;
                }
            }

            // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®šã‚’é©ç”¨
            applyLayoutSettings();
        }

        function updateMonthOptions() {
            const select = document.getElementById('reportMonth');
            const select2 = document.getElementById('reportMonth2');
            const months = new Set();

            // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æœˆã‚’æŠ½å‡º
            actuals.forEach(a => {
                if (a.date) {
                    const month = a.date.substring(0, 7); // YYYY-MMå½¢å¼
                    months.add(month);
                }
            });

            // æœˆã‚’æ˜‡é †ã§ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„æœˆâ†’æ–°ã—ã„æœˆï¼‰
            const sortedMonths = Array.from(months).sort();

            // é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆä¸¡æ–¹ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ï¼‰
            select.innerHTML = '<option value="all">å…¨æœŸé–“</option>';
            if (select2) select2.innerHTML = '<option value="all">å…¨æœŸé–“</option>';

            sortedMonths.forEach(month => {
                const [year, monthNum] = month.split('-');
                const option = document.createElement('option');
                option.value = month;
                option.textContent = `${year}å¹´${parseInt(monthNum)}æœˆ`;
                select.appendChild(option);

                if (select2) {
                    const option2 = document.createElement('option');
                    option2.value = month;
                    option2.textContent = `${year}å¹´${parseInt(monthNum)}æœˆ`;
                    select2.appendChild(option2);
                }
            });

            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ç‰ˆã‚’ç”Ÿæˆï¼ˆãƒ¬ãƒãƒ¼ãƒˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ï¼‰
            const items = [
                { value: 'all', label: 'å…¨æœŸé–“' },
                ...sortedMonths.slice().map(month => {
                    const [year, monthNum] = month.split('-');
                    return {
                        value: month,
                        label: `${year}/${parseInt(monthNum)}`
                    };
                })
            ];
            const currentValue = select.value || 'all';
            createSegmentButtons(
                'reportMonthButtons2',
                'reportMonth2',
                items,
                currentValue,
                8, // æœ€å¤§8å€‹ã¾ã§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³è¡¨ç¤º
                handleReportMonthChange
            );
        }

        function updateEstimateMonthOptions() {
            const select = document.getElementById('estimateMonthFilter');
            if (!select) return;

            const months = new Set();

            // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä½œæ¥­äºˆå®šæœˆã‚’æŠ½å‡º
            estimates.forEach(e => {
                const est = normalizeEstimate(e);
                est.workMonths.forEach(month => {
                    if (month && month !== 'unassigned') {
                        months.add(month);
                    }
                });
            });

            // æœˆã‚’é™é †ã§ã‚½ãƒ¼ãƒˆï¼ˆæœ€æ–°ãŒä¸Šï¼‰
            const sortedMonths = Array.from(months).sort().reverse();

            // é¸æŠè‚¢ã‚’ç”Ÿæˆ
            select.innerHTML = '<option value="all">å…¨æœŸé–“</option>';

            sortedMonths.forEach(month => {
                const [year, monthNum] = month.split('-');
                const option = document.createElement('option');
                option.value = month;
                option.textContent = `${year}å¹´${parseInt(monthNum)}æœˆ`;
                select.appendChild(option);
            });

            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ç‰ˆã‚’ç”Ÿæˆ
            const items = [
                { value: 'all', label: 'å…¨æœŸé–“' },
                ...sortedMonths.slice().reverse().map(month => {
                    const [year, monthNum] = month.split('-');
                    return {
                        value: month,
                        label: `${year}/${parseInt(monthNum)}`
                    };
                })
            ];
            const currentValue = select.value || 'all';
            createSegmentButtons(
                'estimateMonthButtons2',
                'estimateMonthFilter',
                items,
                currentValue,
                8, // æœ€å¤§8å€‹ã¾ã§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³è¡¨ç¤º
                handleEstimateMonthChange
            );
        }

        function updateActualMonthOptions() {
            const select = document.getElementById('actualMonthFilter');
            const select2 = document.getElementById('actualMonthFilter2');

            // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿å­˜ï¼ˆå†æ§‹ç¯‰å‰ã«å–å¾—ï¼‰
            const currentValue = select ? select.value : 'all';

            const months = new Set();

            // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æœˆã‚’æŠ½å‡º
            actuals.forEach(a => {
                if (a.date) {
                    const month = a.date.substring(0, 7); // YYYY-MMå½¢å¼
                    months.add(month);
                }
            });

            // æœˆã‚’é™é †ã§ã‚½ãƒ¼ãƒˆï¼ˆæœ€æ–°ãŒä¸Šï¼‰
            const sortedMonths = Array.from(months).sort().reverse();

            // é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆä¸¡æ–¹ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ï¼‰
            select.innerHTML = '<option value="all">å…¨æœŸé–“</option>';
            if (select2) select2.innerHTML = '<option value="all">å…¨æœŸé–“</option>';

            sortedMonths.forEach(month => {
                const [year, monthNum] = month.split('-');
                const option = document.createElement('option');
                option.value = month;
                option.textContent = `${year}å¹´${parseInt(monthNum)}æœˆ`;
                select.appendChild(option);

                if (select2) {
                    const option2 = document.createElement('option');
                    option2.value = month;
                    option2.textContent = `${year}å¹´${parseInt(monthNum)}æœˆ`;
                    select2.appendChild(option2);
                }
            });

            // ä¿å­˜ã—ã¦ã„ãŸé¸æŠå€¤ã‚’å¾©å…ƒï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«å­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
            const validValue = sortedMonths.includes(currentValue) || currentValue === 'all' ? currentValue : 'all';
            select.value = validValue;
            if (select2) select2.value = validValue;

            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ç‰ˆã‚’ç”Ÿæˆï¼ˆå®Ÿç¸¾ä¸€è¦§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ï¼‰
            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã¯æ˜‡é †ã§è¡¨ç¤ºï¼ˆå¤ã„â†’æ–°ã—ã„ï¼‰
            const items = [
                { value: 'all', label: 'å…¨æœŸé–“' },
                ...sortedMonths.slice().reverse().map(month => {
                    const [year, monthNum] = month.split('-');
                    return {
                        value: month,
                        label: `${year}/${parseInt(monthNum)}`
                    };
                })
            ];
            createSegmentButtons(
                'actualMonthButtons2',
                'actualMonthFilter2',
                items,
                validValue,
                8, // æœ€å¤§8å€‹ã¾ã§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³è¡¨ç¤º
                handleActualMonthChange
            );
        }

        // æœ€æ–°ã®ç™»éŒ²æœˆã‚’å–å¾—ã™ã‚‹æ±ç”¨é–¢æ•°
        function getDefaultMonth(selectElement) {
            // selectElementã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
            const options = Array.from(selectElement.options);

            // 'all'ä»¥å¤–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
            const monthOptions = options.filter(opt => opt.value !== 'all');

            if (monthOptions.length > 0) {
                // æœˆã®å€¤ã‚’æ¯”è¼ƒã—ã¦æœ€æ–°æœˆï¼ˆæœ€ã‚‚å¤§ãã„å€¤ï¼‰ã‚’è¿”ã™
                // ã‚½ãƒ¼ãƒˆé †ã«ä¾å­˜ã›ãšã€å®Ÿéš›ã®æœ€æ–°æœˆã‚’å–å¾—
                const latestMonth = monthOptions.reduce((latest, opt) => {
                    return opt.value > latest ? opt.value : latest;
                }, monthOptions[0].value);
                return latestMonth;
            }

            return 'all'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å…¨æœŸé–“
        }

        function setDefaultActualMonth() {
            const select = document.getElementById('actualMonthFilter');
            if (!select) return;

            const select2 = document.getElementById('actualMonthFilter2');

            const defaultMonth = getDefaultMonth(select);
            select.value = defaultMonth;
            if (select2) select2.value = defaultMonth;
        }

        function setDefaultReportMonth() {
            const select = document.getElementById('reportMonth');
            if (!select) return;

            const select2 = document.getElementById('reportMonth2');

            const defaultMonth = getDefaultMonth(select);
            select.value = defaultMonth;
            if (select2) select2.value = defaultMonth;
        }

        function setDefaultEstimateMonth() {
            const select = document.getElementById('estimateMonthFilter');
            if (!select) return;

            const defaultMonth = getDefaultMonth(select);
            select.value = defaultMonth;
        }

        function autoBackup() {
            const data = {
                estimates: estimates,
                actuals: actuals,
                companyHolidays: companyHolidays,
                vacations: vacations,
                remainingEstimates: remainingEstimates,
                memberOrder: document.getElementById('memberOrder').value.trim(),
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            const second = String(now.getSeconds()).padStart(2, '0');
            const timestamp = `${year}-${month}-${day}_${hour}-${minute}-${second}`;
            
            a.href = url;
            a.download = `å·¥æ•°ç®¡ç†_ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—_${timestamp}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ã‚¿ãƒ–ã®é †åºã‚’å®šç¾©
        const TAB_ORDER = ['quick', 'estimate', 'actual', 'report', 'settings'];

        function showTab(tabName) {
            // å…¨ã‚¿ãƒ–ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã¨ãƒ†ãƒ¼ãƒã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
                // ãƒ†ãƒ¼ãƒã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                const classes = Array.from(t.classList);
                classes.forEach(cls => {
                    if (cls.startsWith('theme-') || cls.startsWith('pattern-') || cls.startsWith('tab-theme-')) {
                        t.classList.remove(cls);
                    }
                });
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // å¯¾è±¡ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’è¦‹ã¤ã‘ã¦activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            const tabButtons = document.querySelectorAll('.tab');
            const tabIndex = TAB_ORDER.indexOf(tabName);
            if (tabIndex !== -1 && tabButtons[tabIndex]) {
                tabButtons[tabIndex].classList.add('active');
            }

            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã«ãƒ†ãƒ¼ãƒã‚’é©ç”¨
            updateThemeElements();

            // è¦‹ç©ä¸€è¦§ã‚¿ãƒ–ã¾ãŸã¯ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ–ã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºå½¢å¼ã‚’é©ç”¨
            if (tabName === 'estimate') {
                applyDefaultEstimateViewType();
            } else if (tabName === 'report') {
                applyDefaultReportViewType();
            }
        }

        // æ¬¡ã®ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
        function nextTab() {
            const currentIndex = TAB_ORDER.findIndex(tab =>
                document.getElementById(tab).classList.contains('active')
            );
            if (currentIndex !== -1 && currentIndex < TAB_ORDER.length - 1) {
                showTab(TAB_ORDER[currentIndex + 1]);
            }
        }

        // å‰ã®ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
        function prevTab() {
            const currentIndex = TAB_ORDER.findIndex(tab =>
                document.getElementById(tab).classList.contains('active')
            );
            if (currentIndex > 0) {
                showTab(TAB_ORDER[currentIndex - 1]);
            }
        }

        function addEstimate() {
            const version = document.getElementById('estVersion').value;
            const task = document.getElementById('estTask').value;
            
            if (!version || !task) {
                alert('ç‰ˆæ•°ã¨å¯¾å¿œåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
            const monthSplitEnabled = document.getElementById('enableMonthSplit').checked;
            
            if (monthSplitEnabled) {
                // ã©ã®å·¥ç¨‹ã‚’åˆ†å‰²ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const splitProcesses = [];
                processes.forEach(proc => {
                    if (document.getElementById(`split${proc}`).checked) {
                        splitProcesses.push(proc);
                    }
                });
                
                if (splitProcesses.length === 0) {
                    alert('åˆ†å‰²ã™ã‚‹å·¥ç¨‹ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                
                // æœˆåˆ†å‰²ãƒ¢ãƒ¼ãƒ‰
                addEstimateWithMonthSplit(version, task, processes, splitProcesses);
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
                processes.forEach(proc => {
                    const hours = parseFloat(document.getElementById(`est${proc}`).value);
                    const member = document.getElementById(`est${proc}_member`).value;
                    
                    if (hours > 0 && member) {
                        estimates.push({
                            id: Date.now() + Math.random(),
                            version: version,
                            task: task,
                            process: proc,
                            member: member,
                            hours: hours,
                            workMonth: '',
                            workMonths: [],
                            monthlyHours: {},
                            createdAt: new Date().toISOString()
                        });
                    }
                });
            }

            saveData();
            clearEstimateForm();
            updateMemberOptions();
            renderEstimateList();
            updateQuickTaskList();
            updateReport();
            alert('è¦‹ç©ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
        }

        function addEstimateWithMonthSplit(version, task, processes, splitProcesses) {
            const totalHours = parseFloat(document.getElementById('totalHours').value) || 0;
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            const method = document.querySelector('input[name="splitMethod"]:checked').value;
            
            if (totalHours <= 0 || !startMonth || !endMonth) {
                alert('ç·å·¥æ•°ã¨ä½œæ¥­æœŸé–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const months = generateMonthRange(startMonth, endMonth);
            
            // æœˆåˆ¥å·¥æ•°ã‚’è¨ˆç®—
            const monthlyHours = {};
            
            if (method === 'equal') {
                const hoursPerMonth = totalHours / months.length;
                months.forEach(month => {
                    monthlyHours[month] = hoursPerMonth;
                });
            } else {
                // æ‰‹å‹•è¨­å®šã®å ´åˆ
                let total = 0;
                months.forEach((month, index) => {
                    const input = document.getElementById(`monthHours_${index}`);
                    const hours = input ? parseFloat(input.value) || 0 : 0;
                    monthlyHours[month] = hours;
                    total += hours;
                });
                
                // åˆè¨ˆãƒã‚§ãƒƒã‚¯
                if (Math.abs(total - totalHours) > 0.01) {
                    alert(`æœˆåˆ¥å·¥æ•°ã®åˆè¨ˆ(${total.toFixed(1)}h)ãŒç·å·¥æ•°(${totalHours}h)ã¨ä¸€è‡´ã—ã¾ã›ã‚“`);
                    return;
                }
            }
            
            // å·¥ç¨‹ã”ã¨ã«è¦‹ç©ã‚’ä½œæˆ
            processes.forEach(proc => {
                const member = document.getElementById(`est${proc}_member`).value;
                const hours = parseFloat(document.getElementById(`est${proc}`).value);
                
                if (!member) return;
                
                // ã“ã®å·¥ç¨‹ãŒåˆ†å‰²å¯¾è±¡ã‹ãƒã‚§ãƒƒã‚¯
                if (splitProcesses.includes(proc)) {
                    // æœˆåˆ†å‰²è¦‹ç©ã‚’ä½œæˆ
                    estimates.push({
                        id: Date.now() + Math.random(),
                        version: version,
                        task: task,
                        process: proc,
                        member: member,
                        hours: totalHours,
                        workMonth: startMonth,
                        workMonths: months,
                        monthlyHours: monthlyHours,
                        createdAt: new Date().toISOString()
                    });
                } else {
                    // é€šå¸¸ã®è¦‹ç©ã‚’ä½œæˆï¼ˆå·¥æ•°å…¥åŠ›ãŒã‚ã‚Œã°ï¼‰
                    if (hours > 0) {
                        estimates.push({
                            id: Date.now() + Math.random(),
                            version: version,
                            task: task,
                            process: proc,
                            member: member,
                            hours: hours,
                            workMonth: '',
                            workMonths: [],
                            monthlyHours: {},
                            createdAt: new Date().toISOString()
                        });
                    }
                }
            });
        }

        function toggleMonthSplit() {
            const enabled = document.getElementById('enableMonthSplit').checked;
            const panel = document.getElementById('monthSplitPanel');
            
            if (enabled) {
                panel.style.display = 'block';
                
                // æœˆé¸æŠè‚¢ã‚’åˆæœŸåŒ–
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                generateMonthOptions('startMonth', currentMonth);
                generateMonthOptions('endMonth', currentMonth);
                
                // é€šå¸¸ã®å·¥æ•°å…¥åŠ›ã¯æœ‰åŠ¹ã®ã¾ã¾ï¼ˆåˆ†å‰²ã—ãªã„å·¥ç¨‹ç”¨ï¼‰
                
                updateMonthPreview();
            } else {
                panel.style.display = 'none';
            }
        }

        function updateMonthPreview() {
            const totalHours = parseFloat(document.getElementById('totalHours').value) || 0;
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            const method = document.querySelector('input[name="splitMethod"]:checked').value;
            const preview = document.getElementById('monthPreview');
            
            if (!startMonth || !endMonth || totalHours <= 0) {
                preview.innerHTML = '<p style="color: #999; font-size: 14px;">ç·å·¥æ•°ã¨ä½œæ¥­æœŸé–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>';
                return;
            }
            
            if (startMonth > endMonth) {
                preview.innerHTML = '<p style="color: #e74c3c; font-size: 14px;">âš ï¸ é–‹å§‹æœˆã¯çµ‚äº†æœˆã‚ˆã‚Šå‰ã«ã—ã¦ãã ã•ã„</p>';
                return;
            }
            
            const months = generateMonthRange(startMonth, endMonth);
            let html = '<div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #2196f3;">';
            html += '<strong style="color: #1976d2;">ğŸ“‹ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</strong><br>';
            html += '<div style="margin-top: 10px;">';
            
            if (method === 'equal') {
                const hoursPerMonth = (totalHours / months.length).toFixed(1);
                months.forEach(month => {
                    const [y, m] = month.split('-');
                    html += `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">`;
                    html += `${y}å¹´${parseInt(m)}æœˆ: <strong>${hoursPerMonth}h</strong>`;
                    html += `</div>`;
                });
                html += `<div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #2196f3; font-weight: 600;">`;
                html += `åˆè¨ˆ: ${totalHours}h (${months.length}ãƒ¶æœˆ)`;
                html += `</div>`;
            } else {
                // æ‰‹å‹•è¨­å®šUI
                let manualTotal = 0;
                months.forEach((month, index) => {
                    const [y, m] = month.split('-');
                    html += `<div style="padding: 5px 0; display: flex; align-items: center; gap: 10px;">`;
                    html += `<label style="flex: 1;">${y}å¹´${parseInt(m)}æœˆ:</label>`;
                    html += `<input type="number" id="monthHours_${index}" value="0" step="0.1" min="0" `;
                    html += `onchange="updateManualTotal()" style="width: 100px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;"> h`;
                    html += `</div>`;
                });
                html += `<div id="manualTotal" style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #2196f3; font-weight: 600;">`;
                html += `åˆè¨ˆ: 0h / ç›®æ¨™: ${totalHours}h`;
                html += `</div>`;
            }
            
            html += '</div></div>';
            preview.innerHTML = html;
        }

        function updateManualTotal() {
            const totalHours = parseFloat(document.getElementById('totalHours').value) || 0;
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            if (!startMonth || !endMonth) return;
            
            const months = generateMonthRange(startMonth, endMonth);
            let total = 0;
            
            months.forEach((month, index) => {
                const input = document.getElementById(`monthHours_${index}`);
                if (input) {
                    total += parseFloat(input.value) || 0;
                }
            });
            
            const manualTotalDiv = document.getElementById('manualTotal');
            if (manualTotalDiv) {
                const diff = total - totalHours;
                const color = Math.abs(diff) < 0.01 ? '#27ae60' : (diff > 0 ? '#e74c3c' : '#f39c12');
                manualTotalDiv.innerHTML = `åˆè¨ˆ: <span style="color: ${color};">${total.toFixed(1)}h</span> / ç›®æ¨™: ${totalHours}h`;
                
                if (Math.abs(diff) < 0.01) {
                    manualTotalDiv.innerHTML += ' <span style="color: #27ae60;">âœ“</span>';
                } else if (diff > 0) {
                    manualTotalDiv.innerHTML += ` <span style="color: #e74c3c;">(+${diff.toFixed(1)}h è¶…é)</span>`;
                } else {
                    manualTotalDiv.innerHTML += ` <span style="color: #f39c12;">(${diff.toFixed(1)}h ä¸è¶³)</span>`;
                }
            }
        }

        // æ—¢å­˜è¦‹ç©ã®æœˆåˆ†å‰²æ©Ÿèƒ½
        function openSplitEstimateModal(id) {
            const estimate = estimates.find(e => e.id === id);
            if (!estimate) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const est = normalizeEstimate(estimate);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æƒ…å ±ã‚’è¨­å®š
            document.getElementById('splitEstimateId').value = id;
            document.getElementById('splitEstimateInfo').innerHTML = `
                <strong>${est.version}</strong> - ${est.task} [${est.process}] (${est.member})<br>
                ç¾åœ¨ã®å·¥æ•°: ${est.hours.toFixed(1)}h
            `;
            document.getElementById('splitTotalHours').value = est.hours;
            
            // æœˆé¸æŠè‚¢ã‚’åˆæœŸåŒ–
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            // æ—¢å­˜ã®ä½œæ¥­æœˆãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
            let defaultStart = currentMonth;
            let defaultEnd = currentMonth;
            
            if (est.workMonths.length > 0) {
                defaultStart = est.workMonths[0];
                defaultEnd = est.workMonths[est.workMonths.length - 1];
            }
            
            generateMonthOptions('splitStartMonth', defaultStart);
            generateMonthOptions('splitEndMonth', defaultEnd);
            
            // åˆ†å‰²æ–¹æ³•ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelector('input[name="splitMethodModal"][value="equal"]').checked = true;
            
            updateSplitPreview();
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('splitEstimateModal').style.display = 'flex';
        }

        function closeSplitEstimateModal() {
            document.getElementById('splitEstimateModal').style.display = 'none';
        }

        function updateSplitPreview() {
            const totalHours = parseFloat(document.getElementById('splitTotalHours').value) || 0;
            const startMonth = document.getElementById('splitStartMonth').value;
            const endMonth = document.getElementById('splitEndMonth').value;
            const method = document.querySelector('input[name="splitMethodModal"]:checked').value;
            const preview = document.getElementById('splitPreview');
            
            if (!startMonth || !endMonth || totalHours <= 0) {
                preview.innerHTML = '<p style="color: #999; font-size: 14px;">ä½œæ¥­æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
                return;
            }
            
            if (startMonth > endMonth) {
                preview.innerHTML = '<p style="color: #e74c3c; font-size: 14px;">âš ï¸ é–‹å§‹æœˆã¯çµ‚äº†æœˆã‚ˆã‚Šå‰ã«ã—ã¦ãã ã•ã„</p>';
                return;
            }
            
            const months = generateMonthRange(startMonth, endMonth);
            let html = '<div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #3498db;">';
            html += '<strong style="color: #2c3e50;">ğŸ“‹ åˆ†å‰²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</strong><br>';
            html += '<div style="margin-top: 10px;">';
            
            if (method === 'equal') {
                const hoursPerMonth = (totalHours / months.length).toFixed(1);
                months.forEach(month => {
                    const [y, m] = month.split('-');
                    html += `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">`;
                    html += `${y}å¹´${parseInt(m)}æœˆ: <strong>${hoursPerMonth}h</strong>`;
                    html += `</div>`;
                });
                html += `<div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #3498db; font-weight: 600;">`;
                html += `åˆè¨ˆ: ${totalHours}h (${months.length}ãƒ¶æœˆ)`;
                html += `</div>`;
            } else {
                // æ‰‹å‹•è¨­å®šUI
                months.forEach((month, index) => {
                    const [y, m] = month.split('-');
                    html += `<div style="padding: 5px 0; display: flex; align-items: center; gap: 10px;">`;
                    html += `<label style="flex: 1;">${y}å¹´${parseInt(m)}æœˆ:</label>`;
                    html += `<input type="number" id="splitMonthHours_${index}" value="0" step="0.1" min="0" `;
                    html += `onchange="updateSplitManualTotal()" style="width: 100px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;"> h`;
                    html += `</div>`;
                });
                html += `<div id="splitManualTotal" style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #3498db; font-weight: 600;">`;
                html += `åˆè¨ˆ: 0h / ç›®æ¨™: ${totalHours}h`;
                html += `</div>`;
            }
            
            html += '</div></div>';
            preview.innerHTML = html;
        }

        function updateSplitManualTotal() {
            const totalHours = parseFloat(document.getElementById('splitTotalHours').value) || 0;
            const startMonth = document.getElementById('splitStartMonth').value;
            const endMonth = document.getElementById('splitEndMonth').value;
            
            if (!startMonth || !endMonth) return;
            
            const months = generateMonthRange(startMonth, endMonth);
            let total = 0;
            
            months.forEach((month, index) => {
                const input = document.getElementById(`splitMonthHours_${index}`);
                if (input) {
                    total += parseFloat(input.value) || 0;
                }
            });
            
            const manualTotalDiv = document.getElementById('splitManualTotal');
            if (manualTotalDiv) {
                const diff = total - totalHours;
                const color = Math.abs(diff) < 0.01 ? '#27ae60' : (diff > 0 ? '#e74c3c' : '#f39c12');
                manualTotalDiv.innerHTML = `åˆè¨ˆ: <span style="color: ${color};">${total.toFixed(1)}h</span> / ç›®æ¨™: ${totalHours}h`;
                
                if (Math.abs(diff) < 0.01) {
                    manualTotalDiv.innerHTML += ' <span style="color: #27ae60;">âœ“</span>';
                } else if (diff > 0) {
                    manualTotalDiv.innerHTML += ` <span style="color: #e74c3c;">(+${diff.toFixed(1)}h è¶…é)</span>`;
                } else {
                    manualTotalDiv.innerHTML += ` <span style="color: #f39c12;">(${diff.toFixed(1)}h ä¸è¶³)</span>`;
                }
            }
        }

        function executeSplitEstimate() {
            const id = parseFloat(document.getElementById('splitEstimateId').value);
            const totalHours = parseFloat(document.getElementById('splitTotalHours').value) || 0;
            const startMonth = document.getElementById('splitStartMonth').value;
            const endMonth = document.getElementById('splitEndMonth').value;
            const method = document.querySelector('input[name="splitMethodModal"]:checked').value;
            
            if (!startMonth || !endMonth || totalHours <= 0) {
                alert('ä½œæ¥­æœŸé–“ã‚’æ­£ã—ãè¨­å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            if (startMonth > endMonth) {
                alert('é–‹å§‹æœˆã¯çµ‚äº†æœˆã‚ˆã‚Šå‰ã«ã—ã¦ãã ã•ã„');
                return;
            }
            
            const months = generateMonthRange(startMonth, endMonth);
            const monthlyHours = {};
            
            if (method === 'equal') {
                const hoursPerMonth = totalHours / months.length;
                months.forEach(month => {
                    monthlyHours[month] = hoursPerMonth;
                });
            } else {
                // æ‰‹å‹•è¨­å®šã®å ´åˆ
                let total = 0;
                months.forEach((month, index) => {
                    const input = document.getElementById(`splitMonthHours_${index}`);
                    const hours = input ? parseFloat(input.value) || 0 : 0;
                    monthlyHours[month] = hours;
                    total += hours;
                });
                
                // åˆè¨ˆãƒã‚§ãƒƒã‚¯
                if (Math.abs(total - totalHours) > 0.01) {
                    alert(`æœˆåˆ¥å·¥æ•°ã®åˆè¨ˆ(${total.toFixed(1)}h)ãŒç·å·¥æ•°(${totalHours}h)ã¨ä¸€è‡´ã—ã¾ã›ã‚“`);
                    return;
                }
            }
            
            // è¦‹ç©ã‚’æ›´æ–°
            const estimateIndex = estimates.findIndex(e => e.id === id);
            if (estimateIndex !== -1) {
                estimates[estimateIndex] = {
                    ...estimates[estimateIndex],
                    workMonth: startMonth,
                    workMonths: months,
                    monthlyHours: monthlyHours
                };
                
                saveData();
                closeSplitEstimateModal();
                renderEstimateList();
                updateReport();
                
                alert('è¦‹ç©ã‚’æœˆåˆ¥ã«åˆ†å‰²ã—ã¾ã—ãŸ');
            } else {
                alert('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function clearEstimateForm() {
            document.getElementById('estVersion').value = '';
            document.getElementById('estTask').value = '';
            ['UI', 'PG', 'PT', 'IT', 'ST'].forEach(proc => {
                document.getElementById(`est${proc}`).value = '';
                document.getElementById(`est${proc}_member`).value = '';
                // å·¥ç¨‹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚‚ã‚¯ãƒªã‚¢
                const checkbox = document.getElementById(`split${proc}`);
                if (checkbox) {
                    checkbox.checked = false;
                }
            });
            
            // æœˆåˆ†å‰²ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢
            document.getElementById('enableMonthSplit').checked = false;
            toggleMonthSplit();
        }

        // ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ç”¨ã®å¤‰æ•°
        let allQuickTasks = [];
        let selectedQuickTask = null;
        let selectedMemberFilter = null; // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿
        let quickInputMode = 'actual'; // 'actual' or 'estimate'
        let rememberQuickInputMode = false; // å‰å›ãƒ¢ãƒ¼ãƒ‰ã‚’è¨˜æ†¶ã™ã‚‹ã‹ã©ã†ã‹

        // ä½œæ¥­æœˆå‰²ã‚Šå½“ã¦ç”¨ã®å¤‰æ•°
        let workMonthSelectionMode = false;
        let selectedEstimateIds = new Set(); // é¸æŠã•ã‚ŒãŸè¦‹ç©IDã®ã‚»ãƒƒãƒˆ

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ç”¨ã®å¤‰æ•°
        let estimateEditMode = false;

        // æœˆåˆ†å‰²ãƒ¢ãƒ¼ãƒ‰ç”¨ã®å¤‰æ•°
        let monthSplitEnabled = false;

        // æœˆåˆ¥ã‚«ãƒ©ãƒ¼ãƒãƒƒãƒ—ï¼ˆå­£ç¯€ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«åˆã‚ã›ãŸè‰²ï¼‰
        const monthColors = {
            '01': { bg: 'rgba(200, 220, 240, 0.25)', rgb: '200, 220, 240', name: '1æœˆ', label: '1æœˆ' },   // é›ªãƒ»å†¬ç©º
            '02': { bg: 'rgba(180, 140, 180, 0.20)', rgb: '180, 140, 180', name: '2æœˆ', label: '2æœˆ' },   // æ¢…
            '03': { bg: 'rgba(255, 180, 200, 0.20)', rgb: '255, 180, 200', name: '3æœˆ', label: '3æœˆ' },   // æ¡ƒãƒ»æ—©å’²ãæ¡œ
            '04': { bg: 'rgba(255, 200, 210, 0.20)', rgb: '255, 200, 210', name: '4æœˆ', label: '4æœˆ' },   // æ¡œ
            '05': { bg: 'rgba(120, 200, 120, 0.20)', rgb: '120, 200, 120', name: '5æœˆ', label: '5æœˆ' },   // æ–°ç·‘
            '06': { bg: 'rgba(130, 160, 210, 0.20)', rgb: '130, 160, 210', name: '6æœˆ', label: '6æœˆ' },   // ç´«é™½èŠ±ãƒ»æ¢…é›¨
            '07': { bg: 'rgba(100, 180, 220, 0.20)', rgb: '100, 180, 220', name: '7æœˆ', label: '7æœˆ' },   // æµ·ãƒ»ç©º
            '08': { bg: 'rgba(255, 180, 80, 0.20)', rgb: '255, 180, 80', name: '8æœˆ', label: '8æœˆ' },     // å‘æ—¥è‘µãƒ»å¤ªé™½
            '09': { bg: 'rgba(210, 160, 130, 0.20)', rgb: '210, 160, 130', name: '9æœˆ', label: '9æœˆ' },   // ç§‹ã®å§‹ã¾ã‚Š
            '10': { bg: 'rgba(230, 120, 80, 0.20)', rgb: '230, 120, 80', name: '10æœˆ', label: '10æœˆ' },   // ç´…è‘‰
            '11': { bg: 'rgba(180, 120, 80, 0.20)', rgb: '180, 120, 80', name: '11æœˆ', label: '11æœˆ' },   // æ¯è‘‰
            '12': { bg: 'rgba(160, 180, 210, 0.22)', rgb: '160, 180, 210', name: '12æœˆ', label: '12æœˆ' }  // å†¬ãƒ»ã‚¯ãƒªã‚¹ãƒã‚¹
        };

        // æœˆåˆ¥è‰²ä»˜ã‘è¨­å®š
        let showMonthColorsSetting = true;

        // æœˆåˆ¥è‰²ä»˜ã‘è¨­å®šã®ãƒˆã‚°ãƒ«
        function toggleMonthColorsSetting() {
            showMonthColorsSetting = document.getElementById('showMonthColorsCheckbox').checked;
            saveData(true);
            renderEstimates();
            updateReportMatrix();
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºå½¢å¼è¨­å®šã®ä¿å­˜
        function saveDefaultViewTypeSetting() {
            saveData(true);
        }

        // è¦‹ç©ä¸€è¦§ã‚¿ãƒ–ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºå½¢å¼ã‚’é©ç”¨
        function applyDefaultEstimateViewType() {
            if (!isEstimateTabFirstView) {
                return; // åˆå›è¡¨ç¤ºä»¥å¤–ã¯ä½•ã‚‚ã—ãªã„
            }
            isEstimateTabFirstView = false;

            const savedSettings = localStorage.getItem('manhour_settings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                const defaultViewType = settings.defaultEstimateViewType || 'grouped';
                const estimateViewTypeElement = document.getElementById('estimateViewType');
                if (estimateViewTypeElement && estimateViewTypeElement.value !== defaultViewType) {
                    estimateViewTypeElement.value = defaultViewType;
                    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚‚æ›´æ–°
                    setEstimateViewType(defaultViewType);
                }
            }
        }

        // ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ–ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºå½¢å¼ã‚’é©ç”¨
        function applyDefaultReportViewType() {
            if (!isReportTabFirstView) {
                return; // åˆå›è¡¨ç¤ºä»¥å¤–ã¯ä½•ã‚‚ã—ãªã„
            }
            isReportTabFirstView = false;

            const savedSettings = localStorage.getItem('manhour_settings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                const defaultViewType = settings.defaultReportViewType || 'grouped';
                const reportViewTypeElement = document.getElementById('reportViewType');
                if (reportViewTypeElement && reportViewTypeElement.value !== defaultViewType) {
                    reportViewTypeElement.value = defaultViewType;
                    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚‚æ›´æ–°
                    setReportViewType(defaultViewType);
                }
            }
        }

        // æœˆã‹ã‚‰èƒŒæ™¯è‰²ã‚’å–å¾—
        function getMonthColor(workMonths) {
            if (!workMonths || workMonths.length === 0) {
                return { bg: 'rgba(150, 150, 150, 0.15)', tooltip: 'æœªè¨­å®š', isMultiple: false };
            }

            if (workMonths.length === 1) {
                const month = workMonths[0].split('-')[1];
                const [year, m] = workMonths[0].split('-');
                const color = monthColors[month] || { bg: 'rgba(200, 200, 200, 0.3)', name: month + 'æœˆ' };
                return {
                    bg: color.bg,
                    tooltip: `${year}å¹´${parseInt(m)}æœˆ`,
                    isMultiple: false
                };
            }

            // è¤‡æ•°æœˆã®å ´åˆ - é€†æ–œç·šã‚¹ãƒˆãƒ©ã‚¤ãƒ—ã§é–‹å§‹æœˆã¨çµ‚äº†æœˆã®è‰²ã‚’ä½¿ç”¨
            const firstMonth = workMonths[0].split('-')[1];
            const lastMonth = workMonths[workMonths.length - 1].split('-')[1];
            const [y1, m1] = workMonths[0].split('-');
            const [y2, m2] = workMonths[workMonths.length - 1].split('-');

            const color1 = monthColors[firstMonth]?.rgb || '150, 150, 150';
            const color2 = monthColors[lastMonth]?.rgb || '150, 150, 150';

            return {
                bg: `repeating-linear-gradient(-45deg, rgba(${color1}, 0.20) 0px, rgba(${color1}, 0.20) 6px, rgba(${color2}, 0.20) 6px, rgba(${color2}, 0.20) 12px)`,
                tooltip: `${y1}å¹´${parseInt(m1)}æœˆã€œ${y2}å¹´${parseInt(m2)}æœˆ`,
                isMultiple: true
            };
        }

        // æœˆã‚«ãƒ©ãƒ¼å‡¡ä¾‹ã‚’ç”Ÿæˆ
        function generateMonthColorLegend(usedMonths) {
            if (!usedMonths || usedMonths.size === 0) return '';

            let html = '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 12px;">';
            html += '<span style="font-weight: 600; color: #666; margin-right: 5px;">æœˆåˆ¥:</span>';

            // ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æœˆã®ã¿è¡¨ç¤ºï¼ˆã‚½ãƒ¼ãƒˆã—ã¦ï¼‰
            const sortedMonths = Array.from(usedMonths).sort();
            sortedMonths.forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const color = monthColors[month];
                if (color) {
                    html += `<span style="display: inline-flex; align-items: center; gap: 4px;">
                        <span style="width: 16px; height: 16px; background: ${color.bg}; border: 1px solid rgba(0,0,0,0.1); border-radius: 3px;"></span>
                        <span style="color: #555;">${year}/${parseInt(month)}</span>
                    </span>`;
                }
            });

            // è¤‡æ•°æœˆã®å‡¡ä¾‹ï¼ˆä¾‹ã¨ã—ã¦1æœˆã¨3æœˆã®è‰²ã‚’ä½¿ç”¨ï¼‰
            html += `<span style="display: inline-flex; align-items: center; gap: 4px; margin-left: 10px;">
                <span style="width: 16px; height: 16px; background: repeating-linear-gradient(-45deg, rgba(70, 130, 200, 0.35) 0px, rgba(70, 130, 200, 0.35) 3px, rgba(50, 180, 140, 0.35) 3px, rgba(50, 180, 140, 0.35) 6px); border: 1px solid rgba(0,0,0,0.1); border-radius: 3px;"></span>
                <span style="color: #666;">è¤‡æ•°æœˆ</span>
            </span>`;

            // æœªè¨­å®šã®å‡¡ä¾‹
            html += `<span style="display: inline-flex; align-items: center; gap: 4px; margin-left: 5px;">
                <span style="width: 16px; height: 16px; background: rgba(150, 150, 150, 0.15); border: 1px solid rgba(0,0,0,0.1); border-radius: 3px;"></span>
                <span style="color: #999;">æœªè¨­å®š</span>
            </span>`;

            html += '</div>';
            return html;
        }

        // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã®æ­£è¦åŒ–ï¼ˆæ—§å½¢å¼â†’æ–°å½¢å¼ï¼‰
        function normalizeEstimate(e) {
            // æ–°å½¢å¼ãŒã™ã§ã«ã‚ã‚‹å ´åˆ
            if (e.workMonths && e.monthlyHours) {
                return e;
            }
            
            // æ—§å½¢å¼ï¼ˆworkMonthã®ã¿ï¼‰ã‚’æ–°å½¢å¼ã«å¤‰æ›
            if (e.workMonth && !e.workMonths) {
                return {
                    ...e,
                    workMonths: [e.workMonth],
                    monthlyHours: { [e.workMonth]: e.hours }
                };
            }
            
            // workMonthã‚‚workMonthsã‚‚ãªã„å ´åˆï¼ˆæœªè¨­å®šï¼‰
            if (!e.workMonth && !e.workMonths) {
                return {
                    ...e,
                    workMonths: [],
                    monthlyHours: {}
                };
            }
            
            return e;
        }

        // æœˆã®ç¯„å›²ã‚’ç”Ÿæˆï¼ˆYYYY-MMå½¢å¼ï¼‰
        function generateMonthRange(startMonth, endMonth) {
            const months = [];
            let current = startMonth;
            
            while (current <= endMonth) {
                months.push(current);
                const [y, m] = current.split('-').map(Number);
                const nextDate = new Date(y, m, 1); // æ¬¡ã®æœˆã®1æ—¥
                const nextYear = nextDate.getFullYear();
                const nextMonth = nextDate.getMonth() + 1;
                current = `${nextYear}-${String(nextMonth).padStart(2, '0')}`;
            }
            
            return months;
        }

        // æœˆé¸æŠè‚¢ã‚’ç”Ÿæˆ
        function generateMonthOptions(selectId, selectedValue = '', minValue = null) {
            const select = document.getElementById(selectId);
            if (!select) return;

            select.innerHTML = '';

            // éå»1å¹´ã‹ã‚‰æœªæ¥2å¹´ã¾ã§
            const now = new Date();
            const startDate = new Date(now.getFullYear() - 1, 0, 1);
            const endDate = new Date(now.getFullYear() + 2, 11, 31);

            const months = [];
            let current = new Date(startDate);

            while (current <= endDate) {
                const year = current.getFullYear();
                const month = current.getMonth() + 1;
                const value = `${year}-${String(month).padStart(2, '0')}`;
                // minValueãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã‚Œã‚ˆã‚Šå¾Œã®æœˆã®ã¿ã‚’å«ã‚ã‚‹
                if (!minValue || value > minValue) {
                    months.push({ value, label: `${year}å¹´${month}æœˆ` });
                }
                current.setMonth(current.getMonth() + 1);
            }

            months.forEach(m => {
                const option = document.createElement('option');
                option.value = m.value;
                option.textContent = m.label;
                if (m.value === selectedValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function updateQuickTaskList() {
            // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä¸€æ„ã®ã‚¿ã‚¹ã‚¯ã‚’æŠ½å‡ºï¼ˆæ‹…å½“è€…æƒ…å ±ã‚‚å«ã‚€ï¼‰
            const taskMap = new Map();
            estimates.forEach(e => {
                const key = `${e.version}|${e.task}|${e.process}|${e.member}`;
                if (!taskMap.has(key)) {
                    taskMap.set(key, {
                        version: e.version,
                        task: e.task,
                        process: e.process,
                        member: e.member,
                        display: `${e.version} - ${e.task} [${e.process}] (${e.member})`
                    });
                }
            });
            
            allQuickTasks = Array.from(taskMap.values());
            
            // æ‹…å½“è€…ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            updateQuickMemberSelect();
        }

        function updateQuickMemberSelect() {
            const select = document.getElementById('quickMemberSelect');
            const members = new Set();
            
            // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ‹…å½“è€…ã‚’æŠ½å‡º
            estimates.forEach(e => members.add(e.member));
            
            // è¡¨ç¤ºé †ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
            let sortedMembers;
            const memberOrderInput = document.getElementById('memberOrder').value.trim();
            if (memberOrderInput) {
                const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
                const orderedMembers = orderList.filter(m => members.has(m));
                const unorderedMembers = Array.from(members).filter(m => !orderedMembers.includes(m)).sort();
                sortedMembers = [...orderedMembers, ...unorderedMembers];
            } else {
                sortedMembers = Array.from(members).sort();
            }
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
            const currentValue = select.value;
            select.innerHTML = '<option value="">ï¼ˆè‡ªå‹•ï¼‰</option>';
            sortedMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                select.appendChild(option);
            });
            
            // å‰å›é¸æŠã—ã¦ã„ãŸå€¤ã‚’å¾©å…ƒ
            if (currentValue && sortedMembers.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        function handleMemberChange() {
            const selectedMember = document.getElementById('quickMemberSelect').value;
            selectedMemberFilter = selectedMember || null;
            
            // å¯¾å¿œãŒæ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
            if (selectedQuickTask) {
                // ä½•ã‚‚ã—ãªã„ï¼ˆæ‹…å½“è€…å¤‰æ›´ã¨ã—ã¦æ‰±ã†ï¼‰
                return;
            }
            
            // å¯¾å¿œãŒæœªé¸æŠã®å ´åˆã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            const searchInput = document.getElementById('quickTaskSearch');
            if (searchInput.value) {
                filterQuickTaskList();
            }
        }

        function showQuickTaskDropdown() {
            filterQuickTaskList();
        }

        function hideQuickTaskDropdown() {
            document.getElementById('quickTaskDropdown').style.display = 'none';
        }

        function clearQuickTaskSelection() {
            document.getElementById('quickTaskSearch').value = '';
            document.getElementById('quickTaskClearBtn').style.display = 'none';
            selectedQuickTask = null;
            // æ‹…å½“è€…ã‚‚ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('quickMemberSelect').value = '';
            selectedMemberFilter = null;
            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’éè¡¨ç¤º
            hideQuickTaskDropdown();
        }

        function filterQuickTaskList() {
            const searchText = document.getElementById('quickTaskSearch').value.toLowerCase();
            const dropdown = document.getElementById('quickTaskDropdown');
            
            // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯çµã‚Šè¾¼ã‚€
            let filtered = allQuickTasks;
            if (selectedMemberFilter) {
                filtered = filtered.filter(taskInfo => taskInfo.member === selectedMemberFilter);
            }
            
            // æ¤œç´¢ãƒ†ã‚­ã‚¹ãƒˆã§çµã‚Šè¾¼ã‚€
            if (searchText) {
                filtered = filtered.filter(taskInfo => 
                    taskInfo.display.toLowerCase().includes(searchText)
                );
            }
            
            if (filtered.length === 0) {
                const msg = selectedMemberFilter 
                    ? `${selectedMemberFilter}ã•ã‚“ã®å¯¾å¿œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“` 
                    : 'è©²å½“ã™ã‚‹å¯¾å¿œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                dropdown.innerHTML = `<div class="custom-dropdown-empty">${msg}</div>`;
            } else {
                dropdown.innerHTML = filtered.map(taskInfo => {
                    const value = `${taskInfo.version}|${taskInfo.task}|${taskInfo.process}|${taskInfo.member}`;
                    return `<div class="custom-dropdown-item" onmousedown="selectQuickTask('${value.replace(/'/g, "\\'")}', '${taskInfo.display.replace(/'/g, "\\'")}')">${taskInfo.display}</div>`;
                }).join('');
            }
            
            dropdown.style.display = 'block';
        }

        function selectQuickTask(value, display) {
            selectedQuickTask = value;
            const [version, task, process, member] = value.split('|');
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('quickTaskSearch').value = `${version} - ${task} [${process}]`;
            
            // Ã—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('quickTaskClearBtn').style.display = 'block';
            
            // æ‹…å½“è€…ã‚»ãƒ¬ã‚¯ãƒˆã‚’æ›´æ–°
            const memberSelect = document.getElementById('quickMemberSelect');
            
            // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ãŒæœªè¨­å®šã®å ´åˆã€è¦‹ç©ã®æ‹…å½“è€…ã‚’è‡ªå‹•è¨­å®š
            if (!selectedMemberFilter) {
                memberSelect.value = member;
            }
            // æ‹…å½“è€…ãƒ•ã‚£ãƒ«ã‚¿ãŒè¨­å®šã•ã‚Œã¦ã„ã¦ã€è¦‹ç©ã®æ‹…å½“è€…ã¨ç•°ãªã‚‹å ´åˆã¯å¤‰æ›´ã¨ã—ã¦æ‰±ã†
            // ï¼ˆä½•ã‚‚ã—ãªã„ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸ã‚“ã æ‹…å½“è€…ã‚’ç¶­æŒï¼‰
            
            document.getElementById('quickTaskDropdown').style.display = 'none';
        }

        // å¤–éƒ¨ã‚¯ãƒªãƒƒã‚¯ã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('quickTaskDropdown');
            const searchInput = document.getElementById('quickTaskSearch');
            
            if (dropdown && searchInput) {
                // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ãŒãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã¾ãŸã¯æ¤œç´¢å…¥åŠ›æ¬„ã§ãªã„å ´åˆ
                if (!dropdown.contains(event.target) && event.target !== searchInput) {
                    hideQuickTaskDropdown();
                }
            }
        });

        function quickAddActual() {
            const hours = parseFloat(document.getElementById('quickHours').value);
            const memberOverride = document.getElementById('quickMemberSelect').value;
            
            if (!selectedQuickTask || !hours) {
                alert('å¯¾å¿œã¨å®Ÿç¸¾å·¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const [version, task, process, originalMember] = selectedQuickTask.split('|');
            
            // æ‹…å½“è€…ã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯:
            // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã«é¸æŠã—ãŸæ‹…å½“è€…ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
            // 2. ãªã‘ã‚Œã°è¦‹ç©ã®æ‹…å½“è€…ã‚’ä½¿ç”¨
            const finalMember = memberOverride || originalMember;

            actuals.push({
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                version: version,
                task: task,
                process: process,
                member: finalMember,
                hours: hours,
                createdAt: new Date().toISOString()
            });

            saveData();
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('quickTaskSearch').value = '';
            document.getElementById('quickHours').value = '';
            document.getElementById('quickTaskClearBtn').style.display = 'none';
            // æ‹…å½“è€…é¸æŠã¯ãƒªã‚»ãƒƒãƒˆï¼ˆæ¬¡ã®å…¥åŠ›ã«å‚™ãˆã‚‹ï¼‰
            document.getElementById('quickMemberSelect').value = '';
            selectedQuickTask = null;
            selectedMemberFilter = null;
            
            updateMonthOptions();
            updateActualMonthOptions();
            updateMemberOptions();
            renderTodayActuals();
            renderActualList();
            updateReport();
            alert('å®Ÿç¸¾ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }

        function renderTodayActuals() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = actuals.filter(a => a.date === today);
            
            const container = document.getElementById('todayActuals');
            
            if (todayData.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">ã¾ã å®Ÿç¸¾ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }

            let html = '<div class="table-wrapper"><table><tr><th>æ™‚åˆ»</th><th>ç‰ˆæ•°</th><th>å¯¾å¿œå</th><th>å·¥ç¨‹</th><th>æ‹…å½“</th><th>å·¥æ•°</th><th>æ“ä½œ</th></tr>';
            
            todayData.forEach(a => {
                const time = new Date(a.createdAt).toLocaleTimeString('ja-JP');
                html += `
                    <tr>
                        <td>${time}</td>
                        <td>${a.version}</td>
                        <td>${a.task}</td>
                        <td><span class="badge badge-${a.process.toLowerCase()}">${a.process}</span></td>
                        <td>${a.member}</td>
                        <td>${a.hours}h</td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="editActual(${a.id})" style="margin-right: 5px;">ç·¨é›†</button>
                            <button class="btn btn-danger btn-small" onclick="deleteActual(${a.id})">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</table></div>';
            container.innerHTML = html;
        }

        // ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function switchQuickInputMode(mode) {
            quickInputMode = mode;

            const actualForm = document.getElementById('quickActualForm');
            const estimateForm = document.getElementById('quickEstimateForm');
            const vacationForm = document.getElementById('quickVacationForm');
            const modeTitle = document.getElementById('quickModeTitle');
            const bottomTitle = document.getElementById('quickBottomTitle');
            const actualBtn = document.getElementById('quickActualModeBtn');
            const estimateBtn = document.getElementById('quickEstimateModeBtn');
            const vacationBtn = document.getElementById('quickVacationModeBtn');

            // å…¨ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            actualForm.style.display = 'none';
            estimateForm.style.display = 'none';
            vacationForm.style.display = 'none';
            actualBtn.style.background = 'transparent';
            actualBtn.style.color = 'rgba(255,255,255,0.85)';
            estimateBtn.style.background = 'transparent';
            estimateBtn.style.color = 'rgba(255,255,255,0.85)';
            vacationBtn.style.background = 'transparent';
            vacationBtn.style.color = 'rgba(255,255,255,0.85)';

            if (mode === 'actual') {
                actualForm.style.display = 'block';
                modeTitle.textContent = 'ä»Šæ—¥ã®å®Ÿç¸¾ã‚’å…¥åŠ›';
                bottomTitle.textContent = 'ä»Šæ—¥ã®å…¥åŠ›æ¸ˆã¿å®Ÿç¸¾';
                bottomTitle.style.display = 'block';
                document.getElementById('todayActuals').style.display = 'block';
                actualBtn.style.background = 'rgba(255,255,255,0.9)';
                actualBtn.style.color = 'rgba(0,0,0,0.85)';
            } else if (mode === 'estimate') {
                estimateForm.style.display = 'block';
                modeTitle.textContent = 'æ–°è¦è¦‹ç©ç™»éŒ²';
                bottomTitle.style.display = 'none';
                document.getElementById('todayActuals').style.display = 'none';
                estimateBtn.style.background = 'rgba(255,255,255,0.9)';
                estimateBtn.style.color = 'rgba(0,0,0,0.85)';
            } else if (mode === 'vacation') {
                vacationForm.style.display = 'block';
                modeTitle.textContent = 'ä¼‘æš‡ç™»éŒ²';
                bottomTitle.style.display = 'none';
                document.getElementById('todayActuals').style.display = 'none';
                vacationBtn.style.background = 'rgba(255,255,255,0.9)';
                vacationBtn.style.color = 'rgba(0,0,0,0.85)';

                // ä¼‘æš‡ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®æ—¥ä»˜ã‚’ä»Šæ—¥ã«è¨­å®š
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('quickVacationDate').value = today;
            }

            // è¨­å®šã§è¨˜æ†¶ãŒæœ‰åŠ¹ãªå ´åˆã€localStorageã«ä¿å­˜
            if (rememberQuickInputMode) {
                localStorage.setItem('quickInputMode', mode);
            }
        }

        // ä½œæ¥­æœˆã‚¿ã‚¤ãƒ—ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆå˜ä¸€æœˆ/è¤‡æ•°æœˆï¼‰
        function switchQuickEstMonthType() {
            const monthType = document.querySelector('input[name="quickEstMonthType"]:checked').value;
            const singleMonthInput = document.getElementById('quickEstSingleMonthInput');
            const multiMonthInput = document.getElementById('quickEstMultiMonthInput');

            if (monthType === 'single') {
                singleMonthInput.style.display = 'block';
                multiMonthInput.style.display = 'none';
                updateQuickEstimateTableHeader(false);
            } else {
                singleMonthInput.style.display = 'none';
                multiMonthInput.style.display = 'block';
                updateQuickEstimateTableHeader(true);

                // è¤‡æ•°æœˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€é–‹å§‹æœˆã¨çµ‚äº†æœˆã‚’åŒæœŸ
                const startMonth = document.getElementById('quickEstStartMonth').value;
                const startMonthMulti = document.getElementById('quickEstStartMonthMulti');
                const endMonth = document.getElementById('quickEstEndMonth');

                if (startMonth && startMonthMulti) {
                    startMonthMulti.value = startMonth;
                    if (endMonth && !endMonth.value) {
                        endMonth.value = startMonth;
                    }
                }
                updateDefaultProcessMonths(startMonthMulti.value, endMonth.value);
            }
        }

        // ä½œæ¥­æœˆUIã®æ›´æ–°ï¼ˆå˜ä¸€æœˆ/è¤‡æ•°æœˆã®åˆ‡ã‚Šæ›¿ãˆï¼‰
        function updateQuickEstWorkMonthUI() {
            const monthType = document.querySelector('input[name="quickEstMonthType"]:checked')?.value || 'single';

            if (monthType === 'single') {
                // å˜ä¸€æœˆãƒ¢ãƒ¼ãƒ‰ã§ã¯ä½•ã‚‚ã—ãªã„
                return;
            }

            // è¤‡æ•°æœˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿å‡¦ç†
            const startMonthMulti = document.getElementById('quickEstStartMonthMulti');
            const endMonth = document.getElementById('quickEstEndMonth');

            if (!startMonthMulti || !endMonth) return;
            if (!startMonthMulti.value) return;

            // å·¥ç¨‹åˆ¥ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½œæ¥­æœˆã‚’æ›´æ–°
            if (endMonth.value && startMonthMulti.value !== endMonth.value) {
                updateDefaultProcessMonths(startMonthMulti.value, endMonth.value);
            }
        }

        // å·¥ç¨‹è¡¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ä½œæ¥­æœˆåˆ—ã‚’æ›´æ–°
        function updateQuickEstimateTableHeader(showWorkMonthColumn) {
            const table = document.getElementById('quickEstimateTable');
            const headerRow = table.querySelector('thead tr');
            const bodyRows = table.querySelectorAll('tbody tr');

            if (showWorkMonthColumn) {
                // ä½œæ¥­æœˆåˆ—ã‚’è¿½åŠ 
                if (headerRow.children.length === 3) {
                    const th = document.createElement('th');
                    th.style.width = '150px';
                    th.style.padding = '8px';
                    th.textContent = 'ä½œæ¥­æœˆ';
                    headerRow.appendChild(th);
                }

                bodyRows.forEach((row, index) => {
                    if (row.children.length === 3) {
                        const td = document.createElement('td');
                        const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
                        const processName = processes[index];
                        td.innerHTML = `
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <select id="quickEst${processName}_startMonth" style="margin: 0; flex: 1;"></select>
                                <span>ã€œ</span>
                                <select id="quickEst${processName}_endMonth" style="margin: 0; flex: 1;"></select>
                            </div>
                        `;
                        row.appendChild(td);
                    }
                });
            } else {
                // ä½œæ¥­æœˆåˆ—ã‚’å‰Šé™¤
                if (headerRow.children.length === 4) {
                    headerRow.removeChild(headerRow.lastChild);
                }

                bodyRows.forEach(row => {
                    if (row.children.length === 4) {
                        row.removeChild(row.lastChild);
                    }
                });
            }
        }

        // ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«æ–¹å¼ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä½œæ¥­æœˆã‚’è¨ˆç®—
        function calculateDefaultWorkMonths(startMonth, endMonth) {
            if (!startMonth || !endMonth) return [];

            const months = generateMonthRange(startMonth, endMonth);
            const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
            const result = [];

            processes.forEach((process, index) => {
                const monthIndex = Math.floor(index * months.length / processes.length);
                const assignedMonth = months[monthIndex];
                result.push({
                    process: process,
                    startMonth: assignedMonth,
                    endMonth: assignedMonth
                });
            });

            return result;
        }

        // å„å·¥ç¨‹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½œæ¥­æœˆã‚’è¨­å®š
        function updateDefaultProcessMonths(startMonth, endMonth) {
            const defaults = calculateDefaultWorkMonths(startMonth, endMonth);
            const months = generateMonthRange(startMonth, endMonth);

            defaults.forEach(item => {
                const startSelect = document.getElementById(`quickEst${item.process}_startMonth`);
                const endSelect = document.getElementById(`quickEst${item.process}_endMonth`);

                if (startSelect && endSelect) {
                    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«é¸æŠè‚¢ã‚’è¨­å®š
                    startSelect.innerHTML = '';
                    endSelect.innerHTML = '';
                    months.forEach(month => {
                        startSelect.innerHTML += `<option value="${month}">${month.substring(0, 4)}å¹´${parseInt(month.substring(5))}æœˆ</option>`;
                        endSelect.innerHTML += `<option value="${month}">${month.substring(0, 4)}å¹´${parseInt(month.substring(5))}æœˆ</option>`;
                    });

                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                    startSelect.value = item.startMonth;
                    endSelect.value = item.endMonth;
                }
            });
        }

        // è¦‹ç©ç™»éŒ²é–¢æ•°ï¼ˆã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã‚¿ãƒ–ç”¨ï¼‰
        function addQuickEstimate() {
            const version = document.getElementById('quickEstVersion').value;
            const formName = document.getElementById('quickEstFormName').value.trim();
            const taskName = document.getElementById('quickEstTask').value.trim();

            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®é¸æŠã«å¿œã˜ã¦é©åˆ‡ãªã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰å€¤ã‚’å–å¾—
            const monthType = document.querySelector('input[name="quickEstMonthType"]:checked').value;
            let startMonth, endMonth;

            if (monthType === 'single') {
                startMonth = document.getElementById('quickEstStartMonth').value;
                endMonth = null;
            } else {
                startMonth = document.getElementById('quickEstStartMonthMulti').value;
                endMonth = document.getElementById('quickEstEndMonth');
            }

            if (!version || version === 'æ–°è¦è¿½åŠ ') {
                alert('ç‰ˆæ•°ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!formName) {
                alert('å¸³ç¥¨åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!taskName) {
                alert('å¯¾å¿œåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // å¸³ç¥¨åã¨å¯¾å¿œåã‚’çµåˆ
            const task = `${formName}_${taskName}`;

            if (!startMonth) {
                alert('ä½œæ¥­æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
            const monthSplitEnabled = document.getElementById('quickEnableMonthSplit').checked;

            if (monthSplitEnabled) {
                // æœˆåˆ†å‰²ãƒ¢ãƒ¼ãƒ‰
                const splitProcesses = [];
                processes.forEach(proc => {
                    if (document.getElementById(`quickSplit${proc}`).checked) {
                        splitProcesses.push(proc);
                    }
                });

                if (splitProcesses.length === 0) {
                    alert('åˆ†å‰²ã™ã‚‹å·¥ç¨‹ã‚’å°‘ãªãã¨ã‚‚ä¸€ã¤é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }

                addQuickEstimateWithMonthSplit(version, task, processes, splitProcesses);
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
                addQuickEstimateNormal(version, task, processes, startMonth, endMonth);
            }
        }

        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§è¦‹ç©ç™»éŒ²
        function addQuickEstimateNormal(version, task, processes, startMonth, endMonthSelect) {
            const isSingleMonth = !endMonthSelect || endMonthSelect.style.display === 'none' || !endMonthSelect.value || startMonth === endMonthSelect.value;

            processes.forEach(proc => {
                const member = document.getElementById(`quickEst${proc}_member`).value;
                const hours = parseFloat(document.getElementById(`quickEst${proc}`).value) || 0;

                if (hours > 0) {
                    let workMonths, monthlyHours, workMonth;

                    if (isSingleMonth) {
                        // å˜ä¸€æœˆãƒ¢ãƒ¼ãƒ‰
                        workMonth = startMonth;
                        workMonths = [startMonth];
                        monthlyHours = { [startMonth]: hours };
                    } else {
                        // è¤‡æ•°æœˆãƒ¢ãƒ¼ãƒ‰: å„å·¥ç¨‹ã®ä½œæ¥­æœˆã‚’å–å¾—
                        const procStartMonth = document.getElementById(`quickEst${proc}_startMonth`).value;
                        const procEndMonth = document.getElementById(`quickEst${proc}_endMonth`).value;

                        if (procStartMonth === procEndMonth) {
                            workMonth = procStartMonth;
                            workMonths = [procStartMonth];
                            monthlyHours = { [procStartMonth]: hours };
                        } else {
                            const months = generateMonthRange(procStartMonth, procEndMonth);
                            workMonth = procStartMonth;
                            workMonths = months;
                            const hoursPerMonth = hours / months.length;
                            monthlyHours = {};
                            months.forEach(m => {
                                monthlyHours[m] = hoursPerMonth;
                            });
                        }
                    }

                    estimates.push({
                        id: Date.now() + Math.random(),
                        version: version,
                        task: task,
                        process: proc,
                        member: member,
                        hours: hours,
                        workMonth: workMonth,
                        workMonths: workMonths,
                        monthlyHours: monthlyHours,
                        createdAt: new Date().toISOString()
                    });
                }
            });

            saveData();
            clearQuickEstimateForm();
            updateMonthOptions();
            updateQuickTaskList();
            updateMemberOptions();
            renderEstimateList();
            updateReport();
            alert('è¦‹ç©ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
        }

        // æœˆåˆ†å‰²ãƒ¢ãƒ¼ãƒ‰ã§è¦‹ç©ç™»éŒ²
        function addQuickEstimateWithMonthSplit(version, task, processes, splitProcesses) {
            const totalHours = parseFloat(document.getElementById('quickTotalHours').value) || 0;
            const startMonth = document.getElementById('quickStartMonth').value;
            const endMonth = document.getElementById('quickEndMonth').value;
            const method = document.querySelector('input[name="quickSplitMethod"]:checked').value;

            if (totalHours === 0) {
                alert('ç·å·¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!startMonth || !endMonth) {
                alert('ä½œæ¥­æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const months = generateMonthRange(startMonth, endMonth);
            const monthlyHours = {};

            if (method === 'equal') {
                const hoursPerMonth = totalHours / months.length;
                months.forEach(month => {
                    monthlyHours[month] = hoursPerMonth;
                });
            } else {
                let total = 0;
                months.forEach((month, index) => {
                    const input = document.getElementById(`quickMonthHours_${index}`);
                    const hours = input ? parseFloat(input.value) || 0 : 0;
                    monthlyHours[month] = hours;
                    total += hours;
                });

                if (Math.abs(total - totalHours) > 0.01) {
                    alert(`æœˆåˆ¥å·¥æ•°ã®åˆè¨ˆï¼ˆ${total}hï¼‰ãŒç·å·¥æ•°ï¼ˆ${totalHours}hï¼‰ã¨ä¸€è‡´ã—ã¾ã›ã‚“`);
                    return;
                }
            }

            processes.forEach(proc => {
                const member = document.getElementById(`quickEst${proc}_member`).value;
                const hours = parseFloat(document.getElementById(`quickEst${proc}`).value) || 0;

                if (hours > 0) {
                    const est = {
                        id: Date.now() + Math.random(),
                        version: version,
                        task: task,
                        process: proc,
                        member: member,
                        hours: totalHours,
                        workMonth: startMonth,
                        workMonths: months,
                        monthlyHours: monthlyHours,
                        createdAt: new Date().toISOString()
                    };

                    if (splitProcesses.includes(proc)) {
                        estimates.push(est);
                    } else {
                        estimates.push({
                            id: Date.now() + Math.random(),
                            version: version,
                            task: task,
                            process: proc,
                            member: member,
                            hours: hours,
                            workMonth: '',
                            workMonths: [],
                            monthlyHours: {},
                            createdAt: new Date().toISOString()
                        });
                    }
                }
            });

            saveData();
            clearQuickEstimateForm();
            updateMonthOptions();
            updateQuickTaskList();
            updateMemberOptions();
            renderEstimateList();
            updateReport();
            alert('è¦‹ç©ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆæœˆåˆ†å‰²ï¼‰');
        }

        // è¦‹ç©ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¯ãƒªã‚¢
        function clearQuickEstimateForm() {
            document.getElementById('quickEstFormName').value = '';
            document.getElementById('quickEstTask').value = '';

            const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
            processes.forEach(proc => {
                document.getElementById(`quickEst${proc}`).value = '';
            });

            // æœˆåˆ†å‰²ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢
            document.getElementById('quickEnableMonthSplit').checked = false;
            toggleQuickMonthSplit();

            // åˆè¨ˆè¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            updateQuickEstimateTotals();
        }

        // æœˆåˆ†å‰²ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleQuickMonthSplit() {
            const enabled = document.getElementById('quickEnableMonthSplit').checked;
            const panel = document.getElementById('quickMonthSplitPanel');

            if (enabled) {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // æœˆåˆ†å‰²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°
        function updateQuickMonthPreview() {
            const totalHours = parseFloat(document.getElementById('quickTotalHours').value) || 0;
            const startMonth = document.getElementById('quickStartMonth').value;
            const endMonth = document.getElementById('quickEndMonth').value;
            const method = document.querySelector('input[name="quickSplitMethod"]:checked').value;
            const preview = document.getElementById('quickMonthPreview');

            if (!startMonth || !endMonth || totalHours === 0) {
                preview.innerHTML = '';
                return;
            }

            const months = generateMonthRange(startMonth, endMonth);

            let html = '<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 4px;">';
            html += '<div style="font-weight: 600; margin-bottom: 8px; color: rgba(255,255,255,0.9);">æœˆåˆ¥å·¥æ•°è¨­å®š</div>';

            if (method === 'equal') {
                const hoursPerMonth = totalHours / months.length;
                months.forEach(month => {
                    const [y, m] = month.split('-');
                    html += `<div style="margin-bottom: 4px; color: rgba(255,255,255,0.8);">${y}å¹´${parseInt(m)}æœˆ: ${hoursPerMonth.toFixed(1)}h</div>`;
                });
            } else {
                months.forEach((month, index) => {
                    const [y, m] = month.split('-');
                    html += `<div style="margin-bottom: 6px;">
                        <label style="display: inline-block; width: 100px; color: rgba(255,255,255,0.9);">${y}å¹´${parseInt(m)}æœˆ:</label>
                        <input type="number" id="quickMonthHours_${index}" step="0.1" min="0" placeholder="h" style="width: 80px; margin: 0;" oninput="updateQuickMonthPreview()">
                        <span style="margin-left: 5px;">h</span>
                    </div>`;
                });

                let total = 0;
                months.forEach((month, index) => {
                    const input = document.getElementById(`quickMonthHours_${index}`);
                    if (input) total += parseFloat(input.value) || 0;
                });

                html += `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.9);">
                    åˆè¨ˆ: ${total.toFixed(1)}h / ç›®æ¨™: ${totalHours}h
                    ${Math.abs(total - totalHours) > 0.01 ? '<span style="color: #ff6b6b; margin-left: 10px;">âš  åˆè¨ˆãŒä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“</span>' : '<span style="color: #51cf66; margin-left: 10px;">âœ“ OK</span>'}
                </div>`;
            }

            html += '</div>';
            preview.innerHTML = html;
        }

        // è¦‹ç©ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®åˆè¨ˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆç®—
        function updateQuickEstimateTotals() {
            const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
            let totalHours = 0;

            processes.forEach(proc => {
                const input = document.getElementById(`quickEst${proc}`);
                if (input && input.value) {
                    totalHours += parseFloat(input.value) || 0;
                }
            });

            // äººæ—¥ãƒ»äººæœˆã‚’è¨ˆç®—ï¼ˆ1äººæ—¥=8hã€1äººæœˆ=20äººæ—¥ï¼‰
            const workingDaysPerMonth = 20;
            const totalDays = totalHours / 8;
            const totalMonths = totalDays / workingDaysPerMonth;

            // è¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('quickEstTotalHours').textContent = totalHours.toFixed(1);
            document.getElementById('quickEstTotalDays').textContent = totalDays.toFixed(1);
            document.getElementById('quickEstTotalMonths').textContent = totalMonths.toFixed(2);
        }

        // ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã®è¦‹ç©ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–
        function initQuickEstimateForm() {
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            // ä½œæ¥­æœˆã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®åˆæœŸåŒ–
            generateMonthOptions('quickEstStartMonth', currentMonth);
            generateMonthOptions('quickEstStartMonthMulti', currentMonth);
            generateMonthOptions('quickEstEndMonth', currentMonth);
            generateMonthOptions('quickStartMonth', currentMonth);
            generateMonthOptions('quickEndMonth', currentMonth);

            // å‰å›ãƒ¢ãƒ¼ãƒ‰ã‚’è¨˜æ†¶ã™ã‚‹è¨­å®šã®èª­ã¿è¾¼ã¿
            const savedRememberMode = localStorage.getItem('rememberQuickInputMode');
            rememberQuickInputMode = savedRememberMode === 'true';

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®UIã«åæ˜ 
            const rememberCheckbox = document.getElementById('rememberQuickInputMode');
            if (rememberCheckbox) {
                rememberCheckbox.checked = rememberQuickInputMode;
            }

            // å‰å›ãƒ¢ãƒ¼ãƒ‰ã®å¾©å…ƒ
            if (rememberQuickInputMode) {
                const savedMode = localStorage.getItem('quickInputMode');
                if (savedMode && (savedMode === 'actual' || savedMode === 'estimate')) {
                    quickInputMode = savedMode;
                    switchQuickInputMode(savedMode);
                }
            }
        }

        // ========== è¦‹ç©ã‚‚ã‚Šæ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£é–¢æ•° ==========

        function openAddEstimateModal() {
            initAddEstimateForm();
            document.getElementById('addEstimateModal').style.display = 'flex';
        }

        function closeAddEstimateModal() {
            document.getElementById('addEstimateModal').style.display = 'none';
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('addEstVersion').value = '';
            document.getElementById('addEstFormName').value = '';
            document.getElementById('addEstTask').value = '';
            document.querySelector('input[name="addEstMonthType"][value="single"]').checked = true;
            switchAddEstMonthType();

            const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
            processes.forEach(proc => {
                document.getElementById(`addEst${proc}_member`).value = '';
                document.getElementById(`addEst${proc}`).value = '';
            });

            document.getElementById('addEnableMonthSplit').checked = false;
            toggleAddMonthSplit();
            updateAddEstimateTotals();
        }

        function initAddEstimateForm() {
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            // ç‰ˆæ•°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆï¼ˆupdateVersionOptionsã§å…¨ã¦ã®ã‚»ãƒ¬ã‚¯ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹ï¼‰
            updateVersionOptions();

            // æ‹…å½“è€…ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆï¼ˆupdateMemberOptionsã§å…¨ã¦ã®ã‚»ãƒ¬ã‚¯ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹ï¼‰
            updateMemberOptions();

            // ä½œæ¥­æœˆã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®åˆæœŸåŒ–
            generateMonthOptions('addEstStartMonth', currentMonth);
            generateMonthOptions('addEstStartMonthMulti', currentMonth);
            generateMonthOptions('addEstEndMonth', currentMonth);
            generateMonthOptions('addStartMonth', currentMonth);
            generateMonthOptions('addEndMonth', currentMonth);

            // è¤‡æ•°æœˆé¸æŠã®æœŸé–“å¤‰æ›´æ™‚ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
            const startMonthMulti = document.getElementById('addEstStartMonthMulti');
            const endMonth = document.getElementById('addEstEndMonth');
            if (startMonthMulti) {
                startMonthMulti.addEventListener('change', function() {
                    // é–‹å§‹æœˆãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã€çµ‚äº†æœˆã®é¸æŠè‚¢ã‚’æ›´æ–°ï¼ˆé–‹å§‹æœˆã‚ˆã‚Šå¾Œã®æœˆã®ã¿ï¼‰
                    const currentEndValue = endMonth.value;
                    generateMonthOptions('addEstEndMonth', currentEndValue, startMonthMulti.value);
                    updateAddEstWorkMonthUI();
                });
            }
            if (endMonth) {
                endMonth.addEventListener('change', updateAddEstWorkMonthUI);
            }
        }

        // ä½œæ¥­æœˆUIã®æ›´æ–°ï¼ˆè¦‹ç©ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ï¼‰
        function updateAddEstWorkMonthUI() {
            const monthType = document.querySelector('input[name="addEstMonthType"]:checked')?.value || 'single';

            if (monthType === 'single') {
                // å˜ä¸€æœˆãƒ¢ãƒ¼ãƒ‰ã§ã¯ä½•ã‚‚ã—ãªã„
                return;
            }

            // è¤‡æ•°æœˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿å‡¦ç†
            const startMonthMulti = document.getElementById('addEstStartMonthMulti');
            const endMonth = document.getElementById('addEstEndMonth');

            if (!startMonthMulti || !endMonth) return;
            if (!startMonthMulti.value) return;

            // å·¥ç¨‹åˆ¥ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½œæ¥­æœˆã‚’æ›´æ–°
            if (endMonth.value && startMonthMulti.value !== endMonth.value) {
                updateDefaultAddProcessMonths(startMonthMulti.value, endMonth.value);
            } else if (endMonth.value === startMonthMulti.value) {
                // é–‹å§‹æœˆã¨çµ‚äº†æœˆãŒåŒã˜å ´åˆã‚‚æ›´æ–°
                updateDefaultAddProcessMonths(startMonthMulti.value, endMonth.value);
            }
        }

        function switchAddEstMonthType() {
            const monthType = document.querySelector('input[name="addEstMonthType"]:checked').value;
            const singleMonthInput = document.getElementById('addEstSingleMonthInput');
            const multiMonthInput = document.getElementById('addEstMultiMonthInput');

            if (monthType === 'single') {
                singleMonthInput.style.display = 'block';
                multiMonthInput.style.display = 'none';
                updateAddEstimateTableHeader(false);
            } else {
                singleMonthInput.style.display = 'none';
                multiMonthInput.style.display = 'block';

                // è¤‡æ•°æœˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€é–‹å§‹æœˆã¨çµ‚äº†æœˆã‚’åŒæœŸ
                const startMonth = document.getElementById('addEstStartMonth').value;
                const startMonthMulti = document.getElementById('addEstStartMonthMulti');
                const endMonth = document.getElementById('addEstEndMonth');

                if (startMonth && startMonthMulti) {
                    startMonthMulti.value = startMonth;
                    // çµ‚äº†æœˆã®é¸æŠè‚¢ã‚’é–‹å§‹æœˆã‚ˆã‚Šå¾Œã®æœˆã®ã¿ã«æ›´æ–°
                    const currentEndValue = endMonth ? endMonth.value : '';
                    generateMonthOptions('addEstEndMonth', currentEndValue, startMonth);
                    if (endMonth && !endMonth.value) {
                        endMonth.value = startMonth;
                    }
                }

                // ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä½œæ¥­æœˆåˆ—ã‚’è¿½åŠ ï¼ˆå†…éƒ¨ã§é¸æŠè‚¢ã‚‚è¨­å®šã•ã‚Œã‚‹ï¼‰
                updateAddEstimateTableHeader(true);
            }
        }

        // å·¥ç¨‹è¡¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ä½œæ¥­æœˆåˆ—ã‚’æ›´æ–°ï¼ˆè¦‹ç©ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ï¼‰
        function updateAddEstimateTableHeader(showWorkMonthColumn) {
            const table = document.getElementById('addEstimateTable');
            if (!table) return;

            const headerRow = table.querySelector('thead tr');
            const bodyRows = table.querySelectorAll('tbody tr');

            if (showWorkMonthColumn) {
                // ä½œæ¥­æœˆåˆ—ã‚’è¿½åŠ 
                if (headerRow.children.length === 3) {
                    const th = document.createElement('th');
                    th.style.width = '150px';
                    th.style.padding = '8px';
                    th.textContent = 'ä½œæ¥­æœˆ';
                    headerRow.appendChild(th);
                }

                bodyRows.forEach((row, index) => {
                    if (row.children.length === 3) {
                        const td = document.createElement('td');
                        const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
                        const processName = processes[index];
                        td.innerHTML = `
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <select id="addEst${processName}_startMonth" style="margin: 0; flex: 1;"></select>
                                <span>ã€œ</span>
                                <select id="addEst${processName}_endMonth" style="margin: 0; flex: 1;"></select>
                            </div>
                        `;
                        row.appendChild(td);
                    }
                });

                // DOMæ›´æ–°å¾Œã«é¸æŠè‚¢ã‚’è¨­å®š
                setTimeout(() => {
                    const startMonthMulti = document.getElementById('addEstStartMonthMulti');
                    const endMonth = document.getElementById('addEstEndMonth');
                    if (startMonthMulti && endMonth && startMonthMulti.value && endMonth.value) {
                        updateDefaultAddProcessMonths(startMonthMulti.value, endMonth.value);
                    }
                }, 0);
            } else {
                // ä½œæ¥­æœˆåˆ—ã‚’å‰Šé™¤
                if (headerRow.children.length === 4) {
                    headerRow.removeChild(headerRow.lastChild);
                }

                bodyRows.forEach(row => {
                    if (row.children.length === 4) {
                        row.removeChild(row.lastChild);
                    }
                });
            }
        }

        // å„å·¥ç¨‹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½œæ¥­æœˆã‚’è¨­å®šï¼ˆè¦‹ç©ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ï¼‰
        function updateDefaultAddProcessMonths(startMonth, endMonth) {
            const defaults = calculateDefaultWorkMonths(startMonth, endMonth);
            const months = generateMonthRange(startMonth, endMonth);

            defaults.forEach(item => {
                const startSelect = document.getElementById(`addEst${item.process}_startMonth`);
                const endSelect = document.getElementById(`addEst${item.process}_endMonth`);

                if (startSelect && endSelect) {
                    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«é¸æŠè‚¢ã‚’è¨­å®šï¼ˆå¹´ãªã—è¡¨ç¤ºï¼‰
                    startSelect.innerHTML = '';
                    endSelect.innerHTML = '';
                    months.forEach(month => {
                        startSelect.innerHTML += `<option value="${month}">${parseInt(month.substring(5))}æœˆ</option>`;
                        endSelect.innerHTML += `<option value="${month}">${parseInt(month.substring(5))}æœˆ</option>`;
                    });

                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                    startSelect.value = item.startMonth;
                    endSelect.value = item.endMonth;
                }
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        function handleAddModalClick(event) {
            if (event.target.id === 'addEstimateModal') {
                closeAddEstimateModal();
            }
        }

        function toggleAddMonthSplit() {
            const enabled = document.getElementById('addEnableMonthSplit').checked;
            const panel = document.getElementById('addMonthSplitPanel');

            if (enabled) {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        function updateAddEstimateTotals() {
            const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
            let totalHours = 0;

            processes.forEach(proc => {
                const hours = parseFloat(document.getElementById(`addEst${proc}`).value) || 0;
                totalHours += hours;
            });

            const totalDays = (totalHours / 8).toFixed(1);
            const totalMonths = (totalHours / 160).toFixed(2);

            document.getElementById('addEstTotalHours').textContent = totalHours.toFixed(1);
            document.getElementById('addEstTotalDays').textContent = totalDays;
            document.getElementById('addEstTotalMonths').textContent = totalMonths;
        }

        function updateAddMonthPreview() {
            const startMonth = document.getElementById('addStartMonth').value;
            const endMonth = document.getElementById('addEndMonth').value;
            const totalHours = parseFloat(document.getElementById('addTotalHours').value) || 0;
            const method = document.querySelector('input[name="addSplitMethod"]:checked').value;
            const preview = document.getElementById('addMonthPreview');

            if (!startMonth || !endMonth || totalHours <= 0) {
                preview.innerHTML = '';
                return;
            }

            const months = generateMonthRange(startMonth, endMonth);
            let html = '<div style="background: #f0f0f0; padding: 10px; border-radius: 5px;">';
            html += '<strong>åˆ†å‰²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong><br>';

            if (method === 'equal') {
                const hoursPerMonth = (totalHours / months.length).toFixed(1);
                months.forEach(month => {
                    html += `<div style="margin-top: 5px;">${month}: ${hoursPerMonth}h</div>`;
                });
            } else {
                months.forEach(month => {
                    html += `<div style="margin-top: 5px; display: flex; align-items: center; gap: 10px;">`;
                    html += `<span style="min-width: 100px;">${month}:</span>`;
                    html += `<input type="number" id="addMonthHours_${month}" step="0.1" min="0" placeholder="0" style="width: 80px; padding: 4px;" oninput="checkAddMonthTotal()"> h`;
                    html += `</div>`;
                });
            }

            html += '</div>';
            preview.innerHTML = html;
        }

        function checkAddMonthTotal() {
            const startMonth = document.getElementById('addStartMonth').value;
            const endMonth = document.getElementById('addEndMonth').value;
            const totalHours = parseFloat(document.getElementById('addTotalHours').value) || 0;

            if (!startMonth || !endMonth) return;

            const months = generateMonthRange(startMonth, endMonth);
            let sum = 0;

            months.forEach(month => {
                const input = document.getElementById(`addMonthHours_${month}`);
                if (input) {
                    sum += parseFloat(input.value) || 0;
                }
            });

            const preview = document.getElementById('addMonthPreview');
            const existingWarning = preview.querySelector('.total-warning');
            if (existingWarning) {
                existingWarning.remove();
            }

            if (Math.abs(sum - totalHours) > 0.01) {
                const warning = document.createElement('div');
                warning.className = 'total-warning';
                warning.style.cssText = 'color: #d32f2f; margin-top: 10px; font-weight: 600;';
                warning.textContent = `âš ï¸ åˆè¨ˆ: ${sum.toFixed(1)}hï¼ˆç·å·¥æ•°: ${totalHours.toFixed(1)}hï¼‰`;
                preview.appendChild(warning);
            }
        }

        function addEstimateFromModal() {
            const version = document.getElementById('addEstVersion').value;
            const formName = document.getElementById('addEstFormName').value.trim();
            const taskName = document.getElementById('addEstTask').value.trim();

            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®é¸æŠã«å¿œã˜ã¦é©åˆ‡ãªã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰å€¤ã‚’å–å¾—
            const monthType = document.querySelector('input[name="addEstMonthType"]:checked').value;
            let startMonth, endMonth;

            if (monthType === 'single') {
                startMonth = document.getElementById('addEstStartMonth').value;
                endMonth = null;
            } else {
                startMonth = document.getElementById('addEstStartMonthMulti').value;
                endMonth = document.getElementById('addEstEndMonth').value;
            }

            if (!version || version === 'æ–°è¦è¿½åŠ ') {
                alert('ç‰ˆæ•°ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!formName) {
                alert('å¸³ç¥¨åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!taskName) {
                alert('å¯¾å¿œåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // å¸³ç¥¨åã¨å¯¾å¿œåã‚’çµåˆ
            const task = `${formName}_${taskName}`;

            if (!startMonth) {
                alert('ä½œæ¥­æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
            const monthSplitEnabled = document.getElementById('addEnableMonthSplit').checked;

            if (monthSplitEnabled) {
                // æœˆåˆ†å‰²ãƒ¢ãƒ¼ãƒ‰
                const splitProcesses = [];
                processes.forEach(proc => {
                    if (document.getElementById(`addSplit${proc}`).checked) {
                        splitProcesses.push(proc);
                    }
                });

                if (splitProcesses.length === 0) {
                    alert('åˆ†å‰²ã™ã‚‹å·¥ç¨‹ã‚’å°‘ãªãã¨ã‚‚ä¸€ã¤é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }

                addEstimateFromModalWithMonthSplit(version, task, processes, splitProcesses);
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
                addEstimateFromModalNormal(version, task, processes, startMonth, endMonth);
            }
        }

        function addEstimateFromModalNormal(version, task, processes, startMonth, endMonth) {
            const isSingleMonth = !endMonth || startMonth === endMonth;

            processes.forEach(proc => {
                const member = document.getElementById(`addEst${proc}_member`).value;
                const hours = parseFloat(document.getElementById(`addEst${proc}`).value) || 0;

                if (hours > 0) {
                    let workMonths, monthlyHours, workMonth;

                    if (isSingleMonth) {
                        // å˜ä¸€æœˆãƒ¢ãƒ¼ãƒ‰
                        workMonth = startMonth;
                        workMonths = [startMonth];
                        monthlyHours = { [startMonth]: hours };
                    } else {
                        // è¤‡æ•°æœˆãƒ¢ãƒ¼ãƒ‰: å„å·¥ç¨‹ã®ä½œæ¥­æœˆã‚’å–å¾—
                        const procStartMonth = document.getElementById(`addEst${proc}_startMonth`)?.value;
                        const procEndMonth = document.getElementById(`addEst${proc}_endMonth`)?.value;

                        if (procStartMonth && procEndMonth) {
                            if (procStartMonth === procEndMonth) {
                                workMonth = procStartMonth;
                                workMonths = [procStartMonth];
                                monthlyHours = { [procStartMonth]: hours };
                            } else {
                                const months = generateMonthRange(procStartMonth, procEndMonth);
                                workMonth = procStartMonth;
                                workMonths = months;
                                monthlyHours = {};
                                months.forEach(m => {
                                    monthlyHours[m] = hours / months.length;
                                });
                            }
                        } else {
                            // å·¥ç¨‹åˆ¥ä½œæ¥­æœˆãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯å…¨æœŸé–“
                            const months = generateMonthRange(startMonth, endMonth);
                            workMonth = startMonth;
                            workMonths = months;
                            monthlyHours = {};
                            months.forEach(m => {
                                monthlyHours[m] = hours / months.length;
                            });
                        }
                    }

                    const est = {
                        id: Date.now() + Math.random(),
                        version: version,
                        task: task,
                        process: proc,
                        member: member,
                        hours: hours,
                        workMonth: workMonth,
                        workMonths: workMonths,
                        monthlyHours: monthlyHours,
                        createdAt: new Date().toISOString()
                    };

                    estimates.push(est);
                }
            });

            saveData();
            renderEstimateList();
            updateReport();
            closeAddEstimateModal();
            alert('è¦‹ç©ç™»éŒ²ã—ã¾ã—ãŸ');
        }

        function addEstimateFromModalWithMonthSplit(version, task, processes, splitProcesses) {
            const startMonth = document.getElementById('addStartMonth').value;
            const endMonth = document.getElementById('addEndMonth').value;
            const totalHours = parseFloat(document.getElementById('addTotalHours').value) || 0;
            const method = document.querySelector('input[name="addSplitMethod"]:checked').value;

            if (!startMonth || !endMonth) {
                alert('ä½œæ¥­æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (totalHours <= 0) {
                alert('ç·å·¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const months = generateMonthRange(startMonth, endMonth);

            if (months.length === 0) {
                alert('æœ‰åŠ¹ãªä½œæ¥­æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            let monthlyHours = {};

            if (method === 'equal') {
                const hoursPerMonth = totalHours / months.length;
                months.forEach(month => {
                    monthlyHours[month] = hoursPerMonth;
                });
            } else {
                let total = 0;
                months.forEach(month => {
                    const input = document.getElementById(`addMonthHours_${month}`);
                    const hours = parseFloat(input.value) || 0;
                    monthlyHours[month] = hours;
                    total += hours;
                });

                if (Math.abs(total - totalHours) > 0.01) {
                    alert(`æœˆåˆ¥å·¥æ•°ã®åˆè¨ˆï¼ˆ${total}hï¼‰ãŒç·å·¥æ•°ï¼ˆ${totalHours}hï¼‰ã¨ä¸€è‡´ã—ã¾ã›ã‚“`);
                    return;
                }
            }

            processes.forEach(proc => {
                const member = document.getElementById(`addEst${proc}_member`).value;
                const hours = parseFloat(document.getElementById(`addEst${proc}`).value) || 0;

                if (hours > 0) {
                    const est = {
                        id: Date.now() + Math.random(),
                        version: version,
                        task: task,
                        process: proc,
                        member: member,
                        hours: totalHours,
                        workMonth: startMonth,
                        workMonths: months,
                        monthlyHours: monthlyHours,
                        createdAt: new Date().toISOString()
                    };

                    if (splitProcesses.includes(proc)) {
                        estimates.push(est);
                    } else {
                        // åˆ†å‰²å¯¾è±¡å¤–ã®å·¥ç¨‹ã¯é€šå¸¸é€šã‚Šç™»éŒ²
                        est.hours = hours;
                        est.monthlyHours = { [startMonth]: hours };
                        est.workMonths = [startMonth];
                        estimates.push(est);
                    }
                }
            });

            saveData();
            renderEstimateList();
            updateReport();
            closeAddEstimateModal();
            alert('è¦‹ç©ç™»éŒ²ã—ã¾ã—ãŸ');
        }

        // ========== ã“ã“ã¾ã§è¦‹ç©ã‚‚ã‚Šæ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£é–¢æ•° ==========

        function renderEstimateList() {
            const container = document.getElementById('estimateList');
            if (!container) return;

            const viewTypeElement = document.getElementById('estimateViewType');
            const monthFilterElement = document.getElementById('estimateMonthFilter');

            if (!viewTypeElement || !monthFilterElement) return;

            const viewType = viewTypeElement.value;
            const monthFilter = monthFilterElement.value;

            if (estimates.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">è¦‹ç©ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                // åˆè¨ˆã‚’0ã«ãƒªã‚»ãƒƒãƒˆ
                const totalHoursElement = document.getElementById('estimateTotalHours');
                const totalManpowerElement = document.getElementById('estimateTotalManpower');
                if (totalHoursElement) totalHoursElement.textContent = '0h';
                if (totalManpowerElement) totalManpowerElement.textContent = '0äººæ—¥ / 0äººæœˆ';
                // æ‹…å½“è€…åˆ¥åˆè¨ˆã‚’éè¡¨ç¤º
                const memberSummaryContainer = document.getElementById('estimateMemberSummary');
                if (memberSummaryContainer) memberSummaryContainer.style.display = 'none';
                return;
            }

            // æœˆãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
            let filteredEstimates = estimates;
            if (monthFilter !== 'all') {
                filteredEstimates = estimates.filter(e => {
                    const est = normalizeEstimate(e);
                    // workMonthsãŒç©ºã¾ãŸã¯æœªå®šç¾©ã®å ´åˆã¯å…¨æœŸé–“è¡¨ç¤ºï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                    if (!est.workMonths || est.workMonths.length === 0) {
                        return true;
                    }
                    return est.workMonths.includes(monthFilter);
                });
            }

            // ãƒ•ã‚£ãƒ«ã‚¿å¾Œã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
            if (filteredEstimates.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">é¸æŠã—ãŸæœŸé–“ã«è¦‹ç©ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                // åˆè¨ˆã‚’0ã«ãƒªã‚»ãƒƒãƒˆ
                const totalHoursElement = document.getElementById('estimateTotalHours');
                const totalManpowerElement = document.getElementById('estimateTotalManpower');
                if (totalHoursElement) totalHoursElement.textContent = '0h';
                if (totalManpowerElement) totalManpowerElement.textContent = '0äººæ—¥ / 0äººæœˆ';
                // æ‹…å½“è€…åˆ¥åˆè¨ˆã‚’éè¡¨ç¤º
                const memberSummaryContainer = document.getElementById('estimateMemberSummary');
                if (memberSummaryContainer) memberSummaryContainer.style.display = 'none';
                return;
            }

            // åˆè¨ˆå·¥æ•°ã‚’è¨ˆç®—
            let totalHours = 0;
            if (monthFilter === 'all') {
                totalHours = filteredEstimates.reduce((sum, e) => sum + e.hours, 0);
            } else {
                filteredEstimates.forEach(e => {
                    const est = normalizeEstimate(e);
                    // æœˆåˆ¥å·¥æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                    if (est.monthlyHours && est.monthlyHours[monthFilter]) {
                        totalHours += est.monthlyHours[monthFilter];
                    }
                    // workMonthsãŒç©ºï¼ˆä½œæ¥­æœˆæœªè¨­å®šï¼‰ã®å ´åˆã¯å…¨å·¥æ•°ã‚’å«ã‚ã‚‹
                    else if (!est.workMonths || est.workMonths.length === 0) {
                        totalHours += est.hours;
                    }
                });
            }

            // äººæ—¥ãƒ»äººæœˆã‚’è¨ˆç®—
            let workingDaysPerMonth = 20; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            if (monthFilter !== 'all') {
                const [year, month] = monthFilter.split('-');
                const calculatedDays = getWorkingDays(parseInt(year), parseInt(month));
                // 0ã§å‰²ã‚‹ã®ã‚’é˜²ããŸã‚ã€æœ€å°å€¤ã‚’1ã«è¨­å®š
                workingDaysPerMonth = calculatedDays > 0 ? calculatedDays : 20;
            }
            const totalManDays = (totalHours / 8).toFixed(1);
            const totalManMonths = (totalHours / 8 / workingDaysPerMonth).toFixed(2);

            // åˆè¨ˆã‚’è¡¨ç¤º
            const totalHoursElement = document.getElementById('estimateTotalHours');
            const totalManpowerElement = document.getElementById('estimateTotalManpower');
            if (totalHoursElement) totalHoursElement.textContent = totalHours.toFixed(1) + 'h';
            if (totalManpowerElement) totalManpowerElement.textContent = `${totalManDays}äººæ—¥ / ${totalManMonths}äººæœˆ`;

            // åˆè¨ˆã‚«ãƒ¼ãƒ‰ã«ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
            const totalCard = document.getElementById('estimateTotalCard');
            if (totalCard) {
                const gradients = {
                    'purple': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'deep-blue': 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)',
                    'teal': 'linear-gradient(135deg, #0f766e 0%, #0d9488 100%)',
                    'cyan': 'linear-gradient(135deg, #0891b2 0%, #06b6d4 100%)',
                    'ocean': 'linear-gradient(135deg, #0c4a6e 0%, #075985 100%)',
                    'sky': 'linear-gradient(135deg, #0369a1 0%, #0284c7 100%)',
                    'indigo': 'linear-gradient(135deg, #4338ca 0%, #6366f1 100%)',
                    'navy': 'linear-gradient(135deg, #1e40af 0%, #3b82f6 100%)',
                    'slate': 'linear-gradient(135deg, #334155 0%, #475569 100%)',
                    'green': 'linear-gradient(135deg, #047857 0%, #059669 100%)',
                    'emerald': 'linear-gradient(135deg, #059669 0%, #10b981 100%)'
                };
                totalCard.style.background = gradients[currentThemeColor] || gradients['purple'];
            }

            // æ‹…å½“è€…åˆ¥ã®åˆè¨ˆã‚’é›†è¨ˆ
            const memberSummary = {};
            filteredEstimates.forEach(e => {
                const est = normalizeEstimate(e);
                const member = est.member || 'æœªè¨­å®š';

                if (!memberSummary[member]) {
                    memberSummary[member] = 0;
                }

                // æœˆãƒ•ã‚£ãƒ«ã‚¿ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯åˆ†å‰²å¾Œã®å·¥æ•°ã‚’ä½¿ç”¨
                if (monthFilter === 'all') {
                    memberSummary[member] += est.hours;
                } else if (est.monthlyHours && est.monthlyHours[monthFilter]) {
                    memberSummary[member] += est.monthlyHours[monthFilter];
                }
                // workMonthsãŒç©ºï¼ˆä½œæ¥­æœˆæœªè¨­å®šï¼‰ã®å ´åˆã¯å…¨å·¥æ•°ã‚’å«ã‚ã‚‹
                else if (!est.workMonths || est.workMonths.length === 0) {
                    memberSummary[member] += est.hours;
                }
            });

            // æ‹…å½“è€…åˆ¥åˆè¨ˆã‚’è¡¨ç¤º
            const memberSummaryContainer = document.getElementById('estimateMemberSummary');
            const memberSummaryContent = document.getElementById('estimateMemberSummaryContent');
            if (memberSummaryContainer && memberSummaryContent) {
                // memberOrderã®é †åºã«å¾“ã£ã¦ã‚½ãƒ¼ãƒˆ
                const memberSet = new Set(Object.keys(memberSummary));
                let sortedMembers = [];
                const memberOrderElement = document.getElementById('memberOrder');
                const memberOrderInput = memberOrderElement ? memberOrderElement.value.trim() : '';

                if (memberOrderInput) {
                    const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
                    const orderedMembers = orderList.filter(m => memberSet.has(m));
                    const unorderedMembers = Array.from(memberSet).filter(m => !orderedMembers.includes(m)).sort();
                    sortedMembers = [...orderedMembers, ...unorderedMembers];
                } else {
                    sortedMembers = Array.from(memberSet).sort();
                }

                if (sortedMembers.length > 0) {
                    memberSummaryContainer.style.display = 'block';
                    // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’å–å¾—
                    const themeColors = {
                        'purple': '#667eea',
                        'deep-blue': '#1e3c72',
                        'teal': '#0f766e',
                        'cyan': '#0891b2',
                        'ocean': '#0c4a6e',
                        'sky': '#0369a1',
                        'indigo': '#4338ca',
                        'navy': '#1e40af',
                        'slate': '#334155',
                        'green': '#047857',
                        'emerald': '#059669'
                    };
                    const borderColor = themeColors[currentThemeColor] || '#667eea';

                    let memberHtml = '';
                    sortedMembers.forEach(member => {
                        const hours = memberSummary[member];
                        const days = (hours / 8).toFixed(1);
                        const months = (hours / 8 / workingDaysPerMonth).toFixed(2);
                        memberHtml += `
                            <div style="background: white; padding: 10px 15px; border-radius: 6px; border-left: 4px solid ${borderColor}; min-width: 150px;">
                                <div style="font-size: 13px; color: #666; margin-bottom: 3px;">${member}</div>
                                <div style="font-size: 18px; font-weight: 700; color: #333;">${hours.toFixed(1)}h</div>
                                <div style="font-size: 12px; color: #666; font-weight: 500;">${days}äººæ—¥ / ${months}äººæœˆ</div>
                            </div>
                        `;
                    });
                    memberSummaryContent.innerHTML = memberHtml;
                } else {
                    memberSummaryContainer.style.display = 'none';
                }
            }

            if (viewType === 'grouped') {
                renderEstimateGrouped();
            } else if (viewType === 'matrix') {
                renderEstimateMatrix();
            } else {
                renderEstimateDetailList();
            }
        }

        // æœˆã®å®Ÿåƒæ—¥æ•°ã‚’è¨ˆç®—ï¼ˆåœŸæ—¥ç¥æ—¥ãƒ»ä¼šç¤¾ä¼‘æ—¥ã‚’é™¤ãï¼‰
        function getWorkingDays(year, month) {
            const lastDay = new Date(year, month, 0).getDate();
            let workingDays = 0;

            for (let day = 1; day <= lastDay; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const date = new Date(year, month - 1, day);
                const dayOfWeek = date.getDay();
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6); // æ—¥æ›œoråœŸæ›œ
                const holiday = getHoliday(dateStr);
                const companyHol = isCompanyHoliday(dateStr);

                if (!isWeekend && !holiday && !companyHol) {
                    workingDays++;
                }
            }

            return workingDays;
        }
        
        // ç¾åœ¨ã®å¹´æœˆã®å®Ÿåƒæ—¥æ•°ã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ä½¿ç”¨ï¼‰
        function getCurrentMonthWorkingDays() {
            const now = new Date();
            return getWorkingDays(now.getFullYear(), now.getMonth() + 1);
        }

        // å®Ÿç¸¾ã¾ãŸã¯è¦‹ç©ãŒã€Œãã®ä»–ä»˜éšä½œæ¥­ã€ã‹ã©ã†ã‹ã‚’åˆ¤å®š
        function isOtherWork(item) {
            const hasVersion = item.version && item.version.trim() !== '';
            const hasTask = item.task && item.task.trim() !== '';
            return !hasVersion || !hasTask;
        }

        // æ•°å€¤ã‚’æ•´æ•°è¡¨ç¤ºï¼ˆå°æ•°ç‚¹ä»¥ä¸‹ãŒ0ã®å ´åˆï¼‰ã¾ãŸã¯å°æ•°è¡¨ç¤º
        function formatNumber(num, decimals = 1) {
            const rounded = parseFloat(num.toFixed(decimals));
            return rounded % 1 === 0 ? rounded.toFixed(0) : rounded.toFixed(decimals);
        }

        function renderEstimateGrouped() {
            const container = document.getElementById('estimateList');

            // å¯¾å¿œå…¨ä½“ã®ä½œæ¥­æœˆã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
            function getTaskWorkMonths(version, task) {
                // ã“ã®å¯¾å¿œã®å…¨å·¥ç¨‹ã‚’å–å¾—
                const taskEstimates = estimates.filter(e => e.version === version && e.task === task);

                // å…¨å·¥ç¨‹ã®ä½œæ¥­æœˆã‚’åé›†ï¼ˆé‡è¤‡ãªã—ï¼‰
                const allMonths = new Set();
                taskEstimates.forEach(e => {
                    const est = normalizeEstimate(e);
                    if (est.workMonths && est.workMonths.length > 0) {
                        est.workMonths.forEach(month => allMonths.add(month));
                    }
                });

                return Array.from(allMonths).sort();
            }

            // ä½œæ¥­äºˆå®šæœˆãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
            const monthFilterElement = document.getElementById('estimateMonthFilter');
            const workMonthFilter = monthFilterElement ? monthFilterElement.value : 'all';

            // å®Ÿåƒæ—¥æ•°ã‚’å–å¾—ï¼ˆäººæœˆè¨ˆç®—ç”¨ï¼‰
            let workingDaysPerMonth = 20; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            if (workMonthFilter !== 'all') {
                const [year, month] = workMonthFilter.split('-');
                const calculatedDays = getWorkingDays(parseInt(year), parseInt(month));
                // 0ã§å‰²ã‚‹ã®ã‚’é˜²ããŸã‚ã€æœ€å°å€¤ã‚’1ã«è¨­å®š
                workingDaysPerMonth = calculatedDays > 0 ? calculatedDays : 20;
            }

            let filteredEstimates = estimates;

            if (workMonthFilter !== 'all') {
                // ç‰¹å®šæœˆ: ãã®æœˆã«å‰²ã‚Šå½“ãŸã£ã¦ã„ã‚‹å·¥ç¨‹ã®ã¿è¡¨ç¤º
                filteredEstimates = estimates.filter(e => {
                    const est = normalizeEstimate(e);
                    // workMonthsãŒç©ºã¾ãŸã¯æœªå®šç¾©ã®å ´åˆã¯å…¨æœŸé–“è¡¨ç¤ºï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                    if (!est.workMonths || est.workMonths.length === 0) {
                        return true;
                    }
                    return est.workMonths.includes(workMonthFilter);
                });
            }

            // ãƒ•ã‚£ãƒ«ã‚¿å†…ã®å·¥ç¨‹ãŒãªã„å ´åˆ
            if (filteredEstimates.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">è©²å½“ã™ã‚‹è¦‹ç©ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // è¡¨ç¤ºã™ã‚‹å…¨ã¦ã®è¦‹ç©
            const allDisplayEstimates = filteredEstimates;

            // ç‰ˆæ•°ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const versionGroups = {};
            allDisplayEstimates.forEach(e => {
                if (!versionGroups[e.version]) {
                    versionGroups[e.version] = {};
                }
                const taskKey = e.task;
                if (!versionGroups[e.version][taskKey]) {
                    versionGroups[e.version][taskKey] = {
                        task: e.task,
                        processes: []
                    };
                }

                // æœˆãƒ•ã‚£ãƒ«ã‚¿ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯åˆ†å‰²å¾Œã®å·¥æ•°ã‚’ä½¿ç”¨
                const est = normalizeEstimate(e);
                let displayHours = e.hours;
                if (workMonthFilter !== 'all' && est.monthlyHours && est.monthlyHours[workMonthFilter]) {
                    displayHours = est.monthlyHours[workMonthFilter];
                }

                versionGroups[e.version][taskKey].processes.push({
                    process: e.process,
                    member: e.member,
                    hours: displayHours,
                    id: e.id
                });
            });

            let html = '<div style="margin-bottom: 30px;">';

            // æ›ç®—åŸºæº–ã®è¡¨ç¤ºã‚’ç”Ÿæˆ
            let workDaysLabel = 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ20æ—¥';
            if (workMonthFilter !== 'all' && workMonthFilter !== 'unassigned') {
                const [year, month] = workMonthFilter.split('-');
                workDaysLabel = `${year}å¹´${parseInt(month)}æœˆã®å–¶æ¥­æ—¥æ•°ï¼ˆ${workingDaysPerMonth}æ—¥ï¼‰`;
            }

            html += `<div style="background: #e3f2fd; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; color: #1565c0;">
                <strong>æ›ç®—åŸºæº–:</strong> 1äººæ—¥ = 8hã€1äººæœˆ = ${workingDaysPerMonth}äººæ—¥ï¼ˆ${workDaysLabel}ï¼‰
            </div>`;

            // ç‰ˆæ•°ã”ã¨ã«è¡¨ç¤º
            Object.keys(versionGroups).sort().forEach(version => {
                html += `<div style="margin-bottom: 30px;">`;
                html += `<h3 class="version-header theme-bg theme-${currentThemeColor}" style="color: white; padding: 12px 20px; border-radius: 8px; margin: 0 0 15px 0; font-size: 18px;">${version}</h3>`;
                html += '<div class="table-wrapper"><table class="estimate-grouped">';

                // é¸æŠãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€é¸æŠåˆ—ã‚’è¿½åŠ 
                if (workMonthSelectionMode) {
                    if (estimateEditMode) {
                        html += '<tr><th style="min-width: 50px;">é¸æŠ</th><th style="min-width: 200px;">å¯¾å¿œå</th><th style="min-width: 80px;">å·¥ç¨‹</th><th style="min-width: 80px;">æ‹…å½“</th><th style="min-width: 80px;">å·¥æ•°</th><th style="min-width: 150px;">å¯¾å¿œåˆè¨ˆ</th><th style="min-width: 100px;">æ“ä½œ</th></tr>';
                    } else {
                        html += '<tr><th style="min-width: 50px;">é¸æŠ</th><th style="min-width: 200px;">å¯¾å¿œå</th><th style="min-width: 80px;">å·¥ç¨‹</th><th style="min-width: 80px;">æ‹…å½“</th><th style="min-width: 80px;">å·¥æ•°</th><th style="min-width: 150px;">å¯¾å¿œåˆè¨ˆ</th></tr>';
                    }
                } else {
                    if (estimateEditMode) {
                        html += '<tr><th style="min-width: 200px;">å¯¾å¿œå</th><th style="min-width: 80px;">å·¥ç¨‹</th><th style="min-width: 80px;">æ‹…å½“</th><th style="min-width: 80px;">å·¥æ•°</th><th style="min-width: 150px;">å¯¾å¿œåˆè¨ˆ</th><th style="min-width: 100px;">æ“ä½œ</th></tr>';
                    } else {
                        html += '<tr><th style="min-width: 200px;">å¯¾å¿œå</th><th style="min-width: 80px;">å·¥ç¨‹</th><th style="min-width: 80px;">æ‹…å½“</th><th style="min-width: 80px;">å·¥æ•°</th><th style="min-width: 150px;">å¯¾å¿œåˆè¨ˆ</th></tr>';
                    }
                }
                
                Object.values(versionGroups[version]).forEach(taskGroup => {
                    const total = taskGroup.processes.reduce((sum, p) => sum + p.hours, 0);
                    const days = total / 8;
                    const months = total / 8 / workingDaysPerMonth;
                    
                    const processOrder = ['UI', 'PG', 'PT', 'IT', 'ST'];
                    const sortedProcesses = taskGroup.processes.sort((a, b) => 
                        processOrder.indexOf(a.process) - processOrder.indexOf(b.process)
                    );
                    
                    // å¯¾å¿œå…¨ä½“ã®ä½œæ¥­æœˆã‚’è¨ˆç®—
                    const taskWorkMonths = getTaskWorkMonths(version, taskGroup.task);

                    // ä½œæ¥­æœˆãƒãƒƒã‚¸ã®ç”Ÿæˆï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼‰
                    let workMonthBadgeInline = ''; // åºƒã„ç”»é¢ç”¨ï¼ˆ1è¡Œè¡¨ç¤ºï¼‰
                    let workMonthBadgeBlock = ''; // ç‹­ã„ç”»é¢ç”¨ï¼ˆæ”¹è¡Œè¡¨ç¤ºï¼‰

                    if (taskWorkMonths.length === 0) {
                        workMonthBadgeInline = ' <span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: normal; white-space: nowrap;">æœªè¨­å®š</span>';
                        workMonthBadgeBlock = '<div style="margin-top: 4px;"><span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: normal; white-space: nowrap;">æœªè¨­å®š</span></div>';
                    } else if (taskWorkMonths.length === 1) {
                        const [y, m] = taskWorkMonths[0].split('-');
                        workMonthBadgeInline = ` <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: normal; white-space: nowrap;">${y}å¹´${parseInt(m)}æœˆ</span>`;
                        workMonthBadgeBlock = `<div style="margin-top: 4px;"><span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: normal; white-space: nowrap;">${y}å¹´${parseInt(m)}æœˆ</span></div>`;
                    } else {
                        // è¤‡æ•°æœˆã®å ´åˆ
                        const [y1, m1] = taskWorkMonths[0].split('-');
                        const [y2, m2] = taskWorkMonths[taskWorkMonths.length - 1].split('-');
                        // åºƒã„ç”»é¢ç”¨: 1è¡Œè¡¨ç¤º
                        workMonthBadgeInline = ` <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: normal; white-space: nowrap;">${y1}å¹´${parseInt(m1)}æœˆã€œ${y2}å¹´${parseInt(m2)}æœˆ</span>`;
                        // ç‹­ã„ç”»é¢ç”¨: ã€œã®å‰ã§æ”¹è¡Œå¯èƒ½ã«ã™ã‚‹ãŸã‚2ã¤ã®ãƒãƒƒã‚¸ã«åˆ†å‰²
                        workMonthBadgeBlock = `<div style="margin-top: 4px;"><span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: normal; white-space: nowrap;">${y1}å¹´${parseInt(m1)}æœˆ</span> <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: normal; white-space: nowrap;">ã€œ${y2}å¹´${parseInt(m2)}æœˆ</span></div>`;
                    }
                    
                    // å¯¾å¿œåã‚’ã€Œ:ã€ã¾ãŸã¯ã€Œï¼šã€ã§åˆ†å‰²ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¡¨ç¤ºï¼ˆç¥æ—¥ã¨åŒã˜æ–¹å¼ï¼‰
                    let taskDisplayHtml = taskGroup.task;
                    if (taskGroup.task.includes(':') || taskGroup.task.includes('ï¼š')) {
                        // åŠè§’ã¨å…¨è§’ã®ä¸¡æ–¹ã«å¯¾å¿œ
                        let separator = ':';
                        let parts;
                        
                        if (taskGroup.task.includes(':')) {
                            parts = taskGroup.task.split(':');
                        } else {
                            separator = 'ï¼š';
                            parts = taskGroup.task.split('ï¼š');
                        }
                        
                        const restPart = parts.slice(1).join(separator);
                        // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: ã‚³ãƒ­ãƒ³ã‚ã‚Šã€ãƒ¢ãƒã‚¤ãƒ«: ã‚³ãƒ­ãƒ³ãªã—
                        taskDisplayHtml = `${parts[0]}<span class="task-separator-inline">${separator} ${restPart}</span><span class="task-separator-break"><br><span style="font-size: 13px; font-weight: normal;">${restPart}</span></span>`;
                    }
                    
                    // ä½œæ¥­æœˆãƒãƒƒã‚¸ã‚’è¿½åŠ ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼‰
                    taskDisplayHtml += `<span class="work-month-inline">${workMonthBadgeInline}</span><span class="work-month-block">${workMonthBadgeBlock}</span>`;
                    
                    // å¯¾å¿œã®å…¨å·¥ç¨‹ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const taskIds = taskGroup.processes.map(p => p.id);
                    const allSelected = taskIds.every(id => selectedEstimateIds.has(id));
                    
                    sortedProcesses.forEach((proc, index) => {
                        // ã“ã®å·¥ç¨‹ã®è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                        const estimate = estimates.find(e => e.id === proc.id);
                        const est = normalizeEstimate(estimate);
                        
                        // ãƒ•ã‚£ãƒ«ã‚¿å¤–ã‹ã©ã†ã‹
                        const isOutOfFilter = proc.isOutOfFilter || false;
                        const grayStyle = isOutOfFilter ? 'opacity: 0.4;' : '';
                        const grayPrefix = isOutOfFilter ? 'â—‹ ' : '';
                        
                        // ä½œæ¥­æœˆã®è¡¨ç¤ºã‚’ç”Ÿæˆï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼‰
                        let processWorkMonthInline = ''; // åºƒã„ç”»é¢ç”¨ï¼ˆ1è¡Œè¡¨ç¤ºï¼‰
                        let processWorkMonthBlock = ''; // ç‹­ã„ç”»é¢ç”¨ï¼ˆ2è¡Œè¡¨ç¤ºï¼‰
                        
                        if (est.workMonths.length > 0) {
                            if (est.workMonths.length === 1) {
                                const [y, m] = est.workMonths[0].split('-');
                                processWorkMonthInline = `<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px; white-space: nowrap;">${y}å¹´${parseInt(m)}æœˆ</span>`;
                                processWorkMonthBlock = `<div style="margin-top: 4px;"><span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; white-space: nowrap;">${y}å¹´${parseInt(m)}æœˆ</span></div>`;
                            } else {
                                const [y1, m1] = est.workMonths[0].split('-');
                                const [y2, m2] = est.workMonths[est.workMonths.length - 1].split('-');
                                processWorkMonthInline = `<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px; white-space: nowrap;">${y1}å¹´${parseInt(m1)}æœˆã€œ${y2}å¹´${parseInt(m2)}æœˆ</span>`;
                                processWorkMonthBlock = `<div style="margin-top: 4px;"><span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; white-space: nowrap;">${y1}å¹´${parseInt(m1)}æœˆã€œ${y2}å¹´${parseInt(m2)}æœˆ</span></div>`;
                            }
                        } else {
                            processWorkMonthInline = `<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 5px; white-space: nowrap;">æœªè¨­å®š</span>`;
                            processWorkMonthBlock = `<div style="margin-top: 4px;"><span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; white-space: nowrap;">æœªè¨­å®š</span></div>`;
                        }
                        
                        html += '<tr>';
                        
                        // é¸æŠãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
                        if (workMonthSelectionMode) {
                            if (index === 0) {
                                // å¯¾å¿œåã®è¡Œ: å¯¾å¿œå…¨ä½“ã®é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆã‚°ãƒ¬ãƒ¼ãªã—ï¼‰
                                html += `<td rowspan="${sortedProcesses.length}" style="vertical-align: top; padding-top: 12px; text-align: center; cursor: pointer;" onclick="selectTaskEstimates('${version}', '${taskGroup.task.replace(/'/g, "\\'")}', event)">
                                    <input type="checkbox" ${allSelected ? 'checked' : ''} style="width: auto; cursor: pointer;" onclick="selectTaskEstimates('${version}', '${taskGroup.task.replace(/'/g, "\\'")}', event)">
                                </td>`;
                            }
                        }
                        
                        if (index === 0) {
                            // å¯¾å¿œåï¼ˆã‚°ãƒ¬ãƒ¼ãªã—ï¼‰
                            html += `<td rowspan="${sortedProcesses.length}" style="vertical-align: top; padding-top: 12px; font-weight: 600;">${taskDisplayHtml}</td>`;
                        }
                        
                        // é¸æŠãƒ¢ãƒ¼ãƒ‰ã§ã¯ãªã„ã¨ãã¯é€šå¸¸ã®å·¥ç¨‹ãƒãƒƒã‚¸
                        // é¸æŠãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã¯å€‹åˆ¥é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
                        if (workMonthSelectionMode) {
                            const isSelected = selectedEstimateIds.has(proc.id);
                            // å·¥ç¨‹ã‚»ãƒ«ï¼ˆã‚°ãƒ¬ãƒ¼é©ç”¨ï¼‰
                            html += `<td style="cursor: pointer; ${grayStyle}" onclick="toggleEstimateSelection(${proc.id}, event)">
                                <input type="checkbox" ${isSelected ? 'checked' : ''} style="width: auto; margin-right: 6px; cursor: pointer;" onclick="toggleEstimateSelection(${proc.id}, event)">
                                <div>
                                    <span>${grayPrefix}</span><span class="badge badge-${proc.process.toLowerCase()}">${proc.process}</span>
                                    <span class="work-month-inline">${processWorkMonthInline}</span>
                                </div>
                                <div class="work-month-block">${processWorkMonthBlock}</div>
                            </td>`;
                        } else {
                            // å·¥ç¨‹ã‚»ãƒ«ï¼ˆã‚°ãƒ¬ãƒ¼é©ç”¨ï¼‰
                            html += `<td style="${grayStyle}"><span>${grayPrefix}</span><span class="badge badge-${proc.process.toLowerCase()}">${proc.process}</span></td>`;
                        }
                        
                        // æ‹…å½“ã‚»ãƒ«ï¼ˆã‚°ãƒ¬ãƒ¼é©ç”¨ï¼‰
                        html += `<td style="${grayStyle}">${proc.member}</td>`;
                        // å·¥æ•°ã‚»ãƒ«ï¼ˆã‚°ãƒ¬ãƒ¼é©ç”¨ï¼‰
                        html += `<td style="text-align: right; ${grayStyle}">${proc.hours}h</td>`;
                        
                        if (index === 0) {
                            // å¯¾å¿œåˆè¨ˆï¼ˆã‚°ãƒ¬ãƒ¼ãªã—ï¼‰
                            html += `<td rowspan="${sortedProcesses.length}" style="vertical-align: top; padding-top: 12px; text-align: right;">
                                <div style="font-weight: 700; color: #1976d2; font-size: 16px; margin-bottom: 4px;">${formatNumber(total, 1)}h</div>
                                <div class="manpower-display" style="font-size: 13px; color: #666;">${formatNumber(days, 1)}äººæ—¥ / ${formatNumber(months, 2)}äººæœˆ</div>
                            </td>`;
                        }

                        // æ“ä½œãƒœã‚¿ãƒ³ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤ºï¼‰
                        if (estimateEditMode) {
                            html += `<td style="text-align: center;">
                                <span onclick="editEstimate(${proc.id})" style="cursor: pointer; font-size: 18px; margin-right: 10px;" title="ç·¨é›†">âœï¸</span>
                                <span onclick="deleteEstimate(${proc.id})" style="cursor: pointer; font-size: 18px; color: #dc3545;" title="å‰Šé™¤">ğŸ—‘ï¸</span>
                            </td>`;
                        }
                        html += '</tr>';
                    });
                });
                
                // ç‰ˆæ•°ã®åˆè¨ˆ
                const versionTotal = Object.values(versionGroups[version])
                    .reduce((sum, taskGroup) => sum + taskGroup.processes.reduce((s, p) => s + p.hours, 0), 0);
                const versionDays = versionTotal / 8;
                const versionMonths = versionTotal / 8 / workingDaysPerMonth;
                
                html += `<tr style="background: #f5f5f5; font-weight: 700;">`;
                if (workMonthSelectionMode) {
                    html += `<td></td>`;
                }
                html += `<td style="text-align: right; padding-right: 20px;">${version} åˆè¨ˆ</td>`;
                html += `<td colspan="2"></td>`;
                html += `<td style="text-align: right;">${formatNumber(versionTotal, 1)}h</td>`;
                html += `<td style="text-align: right;">
                    <div style="font-size: 15px; margin-bottom: 3px;">${formatNumber(versionDays, 1)}äººæ—¥ / ${formatNumber(versionMonths, 2)}äººæœˆ</div>
                </td>`;
                if (estimateEditMode) {
                    html += `<td></td>`;
                }
                html += `</tr>`;
                
                html += '</table></div>';
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function renderEstimateMatrix() {
            const container = document.getElementById('estimateList');

            // æœˆãƒ•ã‚£ãƒ«ã‚¿ã‚’å–å¾—
            const monthFilterElement = document.getElementById('estimateMonthFilter');
            const workMonthFilter = monthFilterElement ? monthFilterElement.value : 'all';

            // ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
            let filteredEstimates = estimates;
            if (workMonthFilter !== 'all') {
                filteredEstimates = estimates.filter(e => {
                    const est = normalizeEstimate(e);
                    // workMonthsãŒç©ºã¾ãŸã¯æœªå®šç¾©ã®å ´åˆã¯å…¨æœŸé–“è¡¨ç¤ºï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                    if (!est.workMonths || est.workMonths.length === 0) {
                        return true;
                    }
                    return est.workMonths.includes(workMonthFilter);
                });
            }

            // ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æœˆã‚’åé›†ï¼ˆå‡¡ä¾‹ç”¨ï¼‰
            const usedMonths = new Set();

            // ç‰ˆæ•°ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const versionGroups = {};
            filteredEstimates.forEach(e => {
                if (!versionGroups[e.version]) {
                    versionGroups[e.version] = {};
                }
                const taskKey = e.task;
                if (!versionGroups[e.version][taskKey]) {
                    versionGroups[e.version][taskKey] = {
                        task: e.task,
                        processes: {}
                    };
                }

                // æœˆãƒ•ã‚£ãƒ«ã‚¿ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯åˆ†å‰²å¾Œã®å·¥æ•°ã‚’ä½¿ç”¨
                const est = normalizeEstimate(e);
                let displayHours = e.hours;
                if (workMonthFilter !== 'all' && est.monthlyHours && est.monthlyHours[workMonthFilter]) {
                    displayHours = est.monthlyHours[workMonthFilter];
                }

                // ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æœˆã‚’åé›†
                if (est.workMonths && est.workMonths.length > 0) {
                    est.workMonths.forEach(m => usedMonths.add(m));
                }

                versionGroups[e.version][taskKey].processes[e.process] = {
                    member: e.member,
                    hours: displayHours,
                    id: e.id,
                    workMonths: est.workMonths || []
                };
            });

            const processOrder = ['UI', 'PG', 'PT', 'IT', 'ST'];

            // å…¨æœŸé–“ã‹ã¤è¨­å®šãŒã‚ªãƒ³ã®æ™‚ã®ã¿è‰²ä»˜ã‘ã™ã‚‹
            const showMonthColors = workMonthFilter === 'all' && showMonthColorsSetting;

            let html = '<div style="margin-bottom: 30px;">';

            // æœˆã‚«ãƒ©ãƒ¼å‡¡ä¾‹ã‚’è¿½åŠ ï¼ˆå…¨æœŸé–“ã‹ã¤è¨­å®šãŒã‚ªãƒ³ã®æ™‚ã®ã¿ï¼‰
            if (showMonthColors) {
                html += generateMonthColorLegend(usedMonths);
            }

            // ç‰ˆæ•°ã”ã¨ã«è¡¨ç¤º
            Object.keys(versionGroups).sort().forEach(version => {
                html += `<div style="margin-bottom: 30px;">`;
                html += `<h3 class="version-header theme-bg theme-${currentThemeColor}" style="color: white; padding: 12px 20px; border-radius: 8px; margin: 0 0 15px 0; font-size: 18px;">${version}</h3>`;
                html += '<div class="table-wrapper"><table class="estimate-matrix">';
                html += '<tr><th style="min-width: 200px;">å¯¾å¿œå</th>';
                processOrder.forEach(proc => {
                    html += `<th style="min-width: 100px; text-align: center;">${proc}</th>`;
                });
                html += '<th style="min-width: 80px; text-align: center;">åˆè¨ˆ</th></tr>';

                Object.values(versionGroups[version]).forEach(group => {
                    // å¯¾å¿œåã‚’ã€Œï¼šã€ï¼ˆå…¨è§’ã‚³ãƒ­ãƒ³ï¼‰ã§åˆ†å‰²ã—ã¦2è¡Œè¡¨ç¤º
                    let taskDisplayHtml = group.task;
                    if (group.task.includes('ï¼š')) {
                        const parts = group.task.split('ï¼š');
                        const restPart = parts.slice(1).join('ï¼š');
                        taskDisplayHtml = `${parts[0]}<br><span style="font-size: 13px; font-weight: normal;">${restPart}</span>`;
                    }

                    html += '<tr>';
                    html += `<td style="font-weight: 600;">${taskDisplayHtml}</td>`;

                    let total = 0;
                    processOrder.forEach(proc => {
                        if (group.processes[proc]) {
                            const p = group.processes[proc];
                            total += p.hours;

                            // å…¨æœŸé–“ã®æ™‚ã®ã¿æœˆã«åŸºã¥ãèƒŒæ™¯è‰²ã‚’é©ç”¨
                            const monthColor = showMonthColors ? getMonthColor(p.workMonths) : { bg: '', tooltip: '' };
                            const bgStyle = showMonthColors ? `background: ${monthColor.bg};` : '';

                            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªã‚»ãƒ«ã«ã™ã‚‹
                            if (estimateEditMode) {
                                html += `<td style="text-align: center; cursor: pointer; transition: background 0.2s; ${bgStyle}"
                                    onclick="editEstimate(${p.id})"
                                    ${showMonthColors ? `title="${monthColor.tooltip}"` : ''}
                                    onmouseover="this.style.background='#e3f2fd'"
                                    onmouseout="this.style.background='${showMonthColors ? monthColor.bg : ''}'">
                                    <div style="font-weight: 600;">${p.hours.toFixed(1)}h</div>
                                    <div style="font-size: 12px; color: #666;">(${p.member})</div>
                                    <div style="font-size: 10px; color: #1976d2; margin-top: 2px;">âœï¸ ç·¨é›†</div>
                                </td>`;
                            } else {
                                html += `<td style="text-align: center; ${bgStyle}" ${showMonthColors ? `title="${monthColor.tooltip}"` : ''}>
                                    <div style="font-weight: 600;">${p.hours.toFixed(1)}h</div>
                                    <div style="font-size: 12px; color: #666;">(${p.member})</div>
                                </td>`;
                            }
                        } else {
                            html += `<td style="text-align: center; color: #ccc;">-</td>`;
                        }
                    });

                    // äººæ—¥ãƒ»äººæœˆã‚’è¨ˆç®—
                    const totalDays = total / 8;
                    const totalMonths = totalDays / 20;

                    html += `<td style="text-align: center;">
                        <div style="font-weight: 700; color: #1976d2;">${total.toFixed(1)}h</div>
                        <div style="font-size: 11px; color: #666;">${totalDays.toFixed(1)}äººæ—¥</div>
                        <div style="font-size: 11px; color: #666;">${totalMonths.toFixed(2)}äººæœˆ</div>
                    </td>`;
                    html += '</tr>';
                });

                html += '</table></div>';
                html += '</div>';
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function renderEstimateDetailList() {
            const container = document.getElementById('estimateList');

            // æœˆãƒ•ã‚£ãƒ«ã‚¿ã‚’å–å¾—
            const monthFilterElement = document.getElementById('estimateMonthFilter');
            const workMonthFilter = monthFilterElement ? monthFilterElement.value : 'all';

            // ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
            let filteredEstimates = estimates;
            if (workMonthFilter !== 'all') {
                filteredEstimates = estimates.filter(e => {
                    const est = normalizeEstimate(e);
                    // workMonthsãŒç©ºã¾ãŸã¯æœªå®šç¾©ã®å ´åˆã¯å…¨æœŸé–“è¡¨ç¤ºï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                    if (!est.workMonths || est.workMonths.length === 0) {
                        return true;
                    }
                    return est.workMonths.includes(workMonthFilter);
                });
            }

            let html = '<div class="table-wrapper"><table><tr><th>ç‰ˆæ•°</th><th>å¯¾å¿œå</th><th>å·¥ç¨‹</th><th>æ‹…å½“</th><th>è¦‹ç©å·¥æ•°</th><th>ä½œæ¥­äºˆå®šæœˆ</th><th>æ“ä½œ</th></tr>';

            filteredEstimates.forEach(e => {
                const est = normalizeEstimate(e);

                // æœˆãƒ•ã‚£ãƒ«ã‚¿ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯åˆ†å‰²å¾Œã®å·¥æ•°ã‚’è¡¨ç¤º
                let displayHours = est.hours;
                if (workMonthFilter !== 'all' && est.monthlyHours[workMonthFilter]) {
                    displayHours = est.monthlyHours[workMonthFilter];
                }
                
                // ä½œæ¥­äºˆå®šæœˆã®è¡¨ç¤º
                let workMonthDisplay = '-';
                if (est.workMonths.length > 0) {
                    if (est.workMonths.length === 1) {
                        const [y, m] = est.workMonths[0].split('-');
                        workMonthDisplay = `${y}å¹´${parseInt(m)}æœˆ`;
                    } else {
                        const [y1, m1] = est.workMonths[0].split('-');
                        const [y2, m2] = est.workMonths[est.workMonths.length - 1].split('-');
                        workMonthDisplay = `${y1}å¹´${parseInt(m1)}æœˆã€œ${y2}å¹´${parseInt(m2)}æœˆ`;
                        // æœˆåˆ¥å†…è¨³ã‚’è¡¨ç¤º
                        workMonthDisplay += '<br><small style="color: #666;">';
                        est.workMonths.forEach((month, idx) => {
                            const [y, m] = month.split('-');
                            const hours = est.monthlyHours[month] || 0;
                            if (idx > 0) workMonthDisplay += ', ';
                            workMonthDisplay += `${y}å¹´${parseInt(m)}æœˆ:${hours.toFixed(1)}h`;
                        });
                        workMonthDisplay += '</small>';
                    }
                }
                
                html += `
                    <tr>
                        <td>${est.version}</td>
                        <td>${est.task}</td>
                        <td><span class="badge badge-${est.process.toLowerCase()}">${est.process}</span></td>
                        <td>${est.member}</td>
                        <td>${displayHours.toFixed(1)}h</td>
                        <td>${workMonthDisplay}</td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="editEstimate(${est.id})" style="margin-right: 5px;">ç·¨é›†</button>
                            <button class="btn btn-small" onclick="openSplitEstimateModal(${est.id})" style="margin-right: 5px; background: #3498db; color: white;">åˆ†å‰²</button>
                            <button class="btn btn-danger btn-small" onclick="deleteEstimate(${est.id})">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</table></div>';
            container.innerHTML = html;
        }

        function renderActualList() {
            const container = document.getElementById('actualList');
            const viewType = document.getElementById('actualViewType').value;
            const viewMode = document.getElementById('actualViewMode').value;

            // æ‹…å½“è€…åˆ¥ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯æ‹…å½“è€…é¸æŠã‚’è¡¨ç¤ºï¼ˆä¸¡æ–¹ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’åŒæœŸï¼‰
            const memberSelectGroup = document.getElementById('memberSelectGroup');
            const memberSelectGroup2 = document.getElementById('memberSelectGroup2');
            if (viewMode === 'member') {
                memberSelectGroup.style.display = 'flex';
                if (memberSelectGroup2) memberSelectGroup2.style.display = 'flex';
                updateMemberSelectOptions();
            } else {
                memberSelectGroup.style.display = 'none';
                if (memberSelectGroup2) memberSelectGroup2.style.display = 'none';
            }
            
            if (actuals.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            if (viewType === 'matrix') {
                if (viewMode === 'member') {
                    renderMemberCalendar();
                } else {
                    renderActualMatrix();
                }
            } else {
                renderActualListView();
            }
        }

        function updateMemberSelectOptions() {
            const select = document.getElementById('actualMemberSelect');
            const select2 = document.getElementById('actualMemberSelect2');
            const currentValue = select.value;

            // æ‹…å½“è€…ã‚’æŠ½å‡º
            const allMembers = new Set();
            actuals.forEach(a => allMembers.add(a.member));
            estimates.forEach(e => allMembers.add(e.member));

            // è¡¨ç¤ºé †ã§ã‚½ãƒ¼ãƒˆ
            let sortedMembers;
            const memberOrderInput = document.getElementById('memberOrder').value.trim();
            if (memberOrderInput) {
                const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
                const orderedMembers = [];
                const unorderedMembers = [];

                orderList.forEach(name => {
                    if (allMembers.has(name)) {
                        orderedMembers.push(name);
                    }
                });

                Array.from(allMembers).forEach(m => {
                    if (!orderedMembers.includes(m)) {
                        unorderedMembers.push(m);
                    }
                });

                sortedMembers = [...orderedMembers, ...unorderedMembers.sort()];
            } else {
                sortedMembers = Array.from(allMembers).sort();
            }

            // ä¸¡æ–¹ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            select.innerHTML = '';
            if (select2) select2.innerHTML = '';

            sortedMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                select.appendChild(option);

                if (select2) {
                    const option2 = document.createElement('option');
                    option2.value = member;
                    option2.textContent = member;
                    select2.appendChild(option2);
                }
            });

            // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
            if (currentValue && sortedMembers.includes(currentValue)) {
                select.value = currentValue;
                if (select2) select2.value = currentValue;
            } else if (sortedMembers.length > 0) {
                select.value = sortedMembers[0];
                if (select2) select2.value = sortedMembers[0];
            }

            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ç‰ˆã‚’ç”Ÿæˆï¼ˆå®Ÿç¸¾ä¸€è¦§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ï¼‰
            const items = sortedMembers.map(member => ({
                value: member,
                label: member
            }));
            const selectedValue = select.value;
            createSegmentButtons(
                'actualMemberButtons2',
                'actualMemberSelect2',
                items,
                selectedValue,
                6, // æœ€å¤§6å€‹ã¾ã§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³è¡¨ç¤º
                handleActualMemberChange
            );
        }

        function renderMemberCalendar() {
            const container = document.getElementById('actualList');
            const selectedMonth = document.getElementById('actualMonthFilter').value;
            const selectedMember = document.getElementById('actualMemberSelect').value;
            
            if (!selectedMember) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
                return;
            }
            
            // æ‹…å½“è€…ã¨æœˆã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredActuals = actuals.filter(a => a.member === selectedMember);
            if (selectedMonth !== 'all') {
                filteredActuals = filteredActuals.filter(a => a.date && a.date.startsWith(selectedMonth));
            }
            
            if (filteredActuals.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">é¸æŠã—ãŸæœŸé–“ã«å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // æ—¥ä»˜ç¯„å›²ã‚’è¨ˆç®—
            const dates = filteredActuals.map(a => a.date).sort();
            let startDate, endDate;
            
            if (selectedMonth !== 'all') {
                const [year, month] = selectedMonth.split('-');
                const yearNum = parseInt(year);
                const monthNum = parseInt(month);
                
                startDate = `${year}-${month}-01`;
                const lastDay = new Date(yearNum, monthNum, 0).getDate();
                endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
            } else {
                const [minYear, minMonth] = dates[0].split('-');
                const [maxYear, maxMonth] = dates[dates.length - 1].split('-');
                
                startDate = `${minYear}-${minMonth}-01`;
                const lastDay = new Date(parseInt(maxYear), parseInt(maxMonth), 0).getDate();
                endDate = `${maxYear}-${maxMonth}-${String(lastDay).padStart(2, '0')}`;
            }
            
            // æ—¥ä»˜ãƒªã‚¹ãƒˆç”Ÿæˆ
            const allDates = [];
            let currentDateStr = startDate;
            while (currentDateStr <= endDate) {
                allDates.push(currentDateStr);
                const [y, m, d] = currentDateStr.split('-').map(Number);
                const nextDate = new Date(y, m - 1, d + 1);
                currentDateStr = `${nextDate.getFullYear()}-${String(nextDate.getMonth() + 1).padStart(2, '0')}-${String(nextDate.getDate()).padStart(2, '0')}`;
            }
            
            // åˆè¨ˆæƒ…å ±
            const totalHours = filteredActuals.reduce((sum, a) => sum + a.hours, 0);
            const workedDays = new Set(filteredActuals.map(a => a.date)).size;
            
            let html = `<h3 style="margin-bottom: 10px;">${selectedMember}ã®å®Ÿç¸¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>`;
            
            if (selectedMonth !== 'all') {
                const [year, month] = selectedMonth.split('-');
                html += `<div style="margin-bottom: 15px;">
                    <p style="margin: 0 0 5px 0; font-weight: 600;">${year}å¹´${parseInt(month)}æœˆã®åˆè¨ˆ</p>
                    <p style="margin: 0; color: #666; font-size: 14px;">ç¨¼åƒæ—¥æ•°: ${workedDays}æ—¥ / åˆè¨ˆå·¥æ•°: ${totalHours.toFixed(1)}h</p>
                </div>`;
            }
            
            html += '<div id="calendarTableWrapper" class="table-wrapper" style="overflow-x: auto;"><table style="min-width: 100%;">';
            html += '<tr><th style="min-width: 120px;">æ—¥ä»˜</th><th style="min-width: 300px;">ä½œæ¥­å†…å®¹</th><th style="min-width: 80px;">å·¥æ•°</th></tr>';
            
            allDates.forEach(date => {
                const dateObj = new Date(date);
                const dayOfWeek = getDayOfWeek(date);
                const holiday = getHoliday(date);
                const isWeekend = dayOfWeek === 'åœŸ' || dayOfWeek === 'æ—¥';
                const isHoliday = holiday !== null;
                
                const dayActuals = filteredActuals.filter(a => a.date === date);
                const dayTotal = dayActuals.reduce((sum, a) => sum + a.hours, 0);
                
                const bgColor = (isWeekend || isHoliday) ? '#ffebee' : 'white';
                const dateColor = (isWeekend || isHoliday) ? 'color: #c62828;' : '';
                
                const [year, m, day] = date.split('-');
                // ç¥æ—¥ã®å ´åˆã€ã‚¯ãƒ©ã‚¹ã§åˆ¶å¾¡ã—ã¦ç”»é¢å¹…ã«å¿œã˜ã¦è¡¨ç¤ºã‚’å¤‰ãˆã‚‹
                const dateDisplay = isHoliday 
                    ? `${parseInt(m)}/${parseInt(day)} (${dayOfWeek})<span class="holiday-inline"> ${holiday}</span><span class="holiday-break"><br><span style="font-size: 11px; font-weight: normal;">${holiday}</span></span>`
                    : `${parseInt(m)}/${parseInt(day)} (${dayOfWeek})`;
                
                if (dayActuals.length === 0) {
                    html += `<tr style="background: ${bgColor};">`;
                    html += `<td style="font-weight: 500; ${dateColor}">${dateDisplay}</td>`;
                    html += `<td style="color: #999;">-</td>`;
                    html += `<td style="text-align: center; color: #999;">-</td>`;
                    html += `</tr>`;
                } else {
                    dayActuals.forEach((actual, index) => {
                        if (index === 0) {
                            html += `<tr style="background: ${bgColor};">`;
                            html += `<td rowspan="${dayActuals.length}" style="font-weight: 500; ${dateColor} vertical-align: top; padding-top: 12px;">${dateDisplay}</td>`;
                        } else {
                            html += `<tr style="background: ${bgColor};">`;
                        }
                        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
                        const escapeHtml = (str) => {
                            const div = document.createElement('div');
                            div.textContent = str;
                            return div.innerHTML;
                        };
                        html += `<td style="font-size: 14px;">${escapeHtml(actual.version)} - ${escapeHtml(actual.task)} [${actual.process}]</td>`;
                        html += `<td style="text-align: center; font-weight: 600;">${actual.hours}h</td>`;
                        html += `</tr>`;
                    });
                }
            });
            
            // ç·åˆè¨ˆè¡Œ
            html += `<tr style="background: #1565c0; color: white; font-weight: 700;">`;
            html += `<td>ç·åˆè¨ˆ</td>`;
            html += `<td style="text-align: right;">${workedDays}æ—¥ç¨¼åƒ</td>`;
            html += `<td style="text-align: center;">${totalHours.toFixed(1)}h</td>`;
            html += `</tr>`;
            
            html += '</table></div>';
            container.innerHTML = html;

            // ã‚¹ãƒ¯ã‚¤ãƒ—ã§æœˆåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã‚’è¨­å®š
            setupCalendarSwipe();
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupCalendarSwipe() {
            const wrapper = document.getElementById('calendarTableWrapper');
            if (!wrapper) return;

            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;

            wrapper.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            wrapper.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleCalendarSwipe();
            }, { passive: true });

            function handleCalendarSwipe() {
                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;

                // æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ãŒç¸¦ã‚¹ãƒ¯ã‚¤ãƒ—ã‚ˆã‚Šå¤§ããã€ã‹ã¤50pxä»¥ä¸Šã®å ´åˆã®ã¿åå¿œ
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    const monthSelect = document.getElementById('actualMonthFilter');
                    const currentIndex = monthSelect.selectedIndex;

                    if (diffX > 0) {
                        // å³ã‚¹ãƒ¯ã‚¤ãƒ— â†’ å‰ã®æœˆã¸
                        if (currentIndex > 0) {
                            monthSelect.selectedIndex = currentIndex - 1;
                            monthSelect.dispatchEvent(new Event('change'));
                        }
                    } else {
                        // å·¦ã‚¹ãƒ¯ã‚¤ãƒ— â†’ æ¬¡ã®æœˆã¸
                        if (currentIndex < monthSelect.options.length - 1) {
                            monthSelect.selectedIndex = currentIndex + 1;
                            monthSelect.dispatchEvent(new Event('change'));
                        }
                    }
                }
            }
        }

        function renderActualMatrix() {
            const container = document.getElementById('actualList');
            const selectedMonth = document.getElementById('actualMonthFilter').value;
            const memberOrderInput = document.getElementById('memberOrder').value.trim();
            
            // æœˆã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredActuals = actuals;
            if (selectedMonth !== 'all') {
                filteredActuals = actuals.filter(a => a.date && a.date.startsWith(selectedMonth));
            }
            
            if (filteredActuals.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">é¸æŠã—ãŸæœŸé–“ã«å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // æ‹…å½“è€…ã‚’æŠ½å‡ºã—ã¦ä¸¦ã³æ›¿ãˆ
            let members = [...new Set(filteredActuals.map(a => a.member))];
            
            // è¡¨ç¤ºé †ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
            if (memberOrderInput) {
                const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
                const orderedMembers = [];
                const unorderedMembers = [];
                
                // æŒ‡å®šã•ã‚ŒãŸé †åºã§è¿½åŠ 
                orderList.forEach(name => {
                    if (members.includes(name)) {
                        orderedMembers.push(name);
                    }
                });
                
                // æŒ‡å®šã•ã‚Œã¦ã„ãªã„æ‹…å½“è€…ã‚’å¾Œã‚ã«è¿½åŠ 
                members.forEach(m => {
                    if (!orderedMembers.includes(m)) {
                        unorderedMembers.push(m);
                    }
                });
                
                members = [...orderedMembers, ...unorderedMembers.sort()];
            } else {
                members.sort();
            }
            
            // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã®æ—¥ä»˜ç¯„å›²ã‚’å–å¾—
            const dates = filteredActuals.map(a => a.date).sort();
            
            // è¡¨ç¤ºç¯„å›²ã‚’æ±ºå®š
            let startDate, endDate;
            if (selectedMonth !== 'all') {
                // é¸æŠã—ãŸæœˆã®ã¿ï¼ˆæœˆåˆã‹ã‚‰æœˆæœ«ã¾ã§æ­£ç¢ºã«ï¼‰
                const [year, month] = selectedMonth.split('-');
                const yearNum = parseInt(year);
                const monthNum = parseInt(month);
                
                // æœˆã®æœ€åˆã®æ—¥
                startDate = `${year}-${month}-01`;
                
                // æœˆã®æœ€å¾Œã®æ—¥ã‚’è¨ˆç®—
                const lastDay = new Date(yearNum, monthNum, 0).getDate();
                endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
            } else {
                // å…¨æœŸé–“ï¼ˆæœ€å°æ—¥ä»˜ã®æœˆåˆã‹ã‚‰æœ€å¤§æ—¥ä»˜ã®æœˆæœ«ã¾ã§ï¼‰
                const minDate = dates[0];
                const maxDate = dates[dates.length - 1];
                
                const [minYear, minMonth] = minDate.split('-');
                const [maxYear, maxMonth] = maxDate.split('-');
                
                startDate = `${minYear}-${minMonth}-01`;
                
                const lastDay = new Date(parseInt(maxYear), parseInt(maxMonth), 0).getDate();
                endDate = `${maxYear}-${maxMonth}-${String(lastDay).padStart(2, '0')}`;
            }
            
            // æ—¥ä»˜ç¯„å›²ã‚’ç”Ÿæˆ
            const allDates = [];
            let currentDateStr = startDate;
            while (currentDateStr <= endDate) {
                allDates.push(currentDateStr);
                
                // æ¬¡ã®æ—¥ä»˜ã‚’è¨ˆç®—
                const [y, m, d] = currentDateStr.split('-').map(Number);
                const nextDate = new Date(y, m - 1, d + 1);
                currentDateStr = `${nextDate.getFullYear()}-${String(nextDate.getMonth() + 1).padStart(2, '0')}-${String(nextDate.getDate()).padStart(2, '0')}`;
            }
            
            let html = '';
            
            // æœˆã®åˆè¨ˆã‚’æœ€ä¸Šéƒ¨ã«è¡¨ç¤ºï¼ˆæœˆé¸æŠæ™‚ã®ã¿ï¼‰
            if (selectedMonth !== 'all') {
                const [year, month] = selectedMonth.split('-');
                
                // ç¨¼åƒæ—¥æ•°ã‚’è¨ˆç®—ï¼ˆå®Ÿç¸¾ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹æ—¥æ•°ï¼‰
                const workedDays = new Set(filteredActuals.map(a => a.date)).size;
                
                html += `<div style="margin-bottom: 15px;">
                    <h3 style="margin: 0 0 5px 0;">${year}å¹´${parseInt(month)}æœˆã®åˆè¨ˆ</h3>
                    <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">ç¨¼åƒæ—¥æ•°: ${workedDays}æ—¥</p>
                </div>`;
                
                // åŒã˜table-wrapperå†…ã«åˆè¨ˆè¡¨ã‚’é…ç½®
                html += '<div class="table-wrapper"><table class="actual-matrix">';

                // åˆè¨ˆè¡Œï¼ˆæ¿ƒã„é’è‰²ï¼‰
                html += '<tr style="background: #1565c0; color: white; font-weight: 700;"><th style="min-width: 100px;">ç·åˆè¨ˆ</th>';
                
                let monthGrandTotal = 0;
                members.forEach(member => {
                    const memberTotal = filteredActuals.filter(a => a.member === member).reduce((sum, a) => sum + a.hours, 0);
                    monthGrandTotal += memberTotal;
                    html += `<th style="text-align: center; min-width: 80px;">${memberTotal.toFixed(1)}h</th>`;
                });
                
                html += `<th class="daily-total" style="background: #ff9800; text-align: center; min-width: 80px;">${monthGrandTotal.toFixed(1)}h</th>`;
                html += '</tr>';
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆé€šå¸¸ã®è‰²ï¼‰
                html += '<tr><th style="min-width: 100px;">æ—¥ä»˜</th>';
                
                // æ‹…å½“è€…ãƒ˜ãƒƒãƒ€ãƒ¼
                members.forEach(member => {
                    html += `<th style="min-width: 80px; text-align: center;">${member}</th>`;
                });
                html += '<th class="daily-total" style="min-width: 80px; text-align: center;">æ—¥åˆ¥åˆè¨ˆ</th></tr>';
            } else {
                // å…¨æœŸé–“è¡¨ç¤ºã®å ´åˆã¯é€šå¸¸é€šã‚Šãƒ˜ãƒƒãƒ€ãƒ¼ã®ã¿
                html += '<div class="table-wrapper"><table class="actual-matrix">';
                html += '<tr><th style="min-width: 100px;">æ—¥ä»˜</th>';
                
                // æ‹…å½“è€…ãƒ˜ãƒƒãƒ€ãƒ¼
                members.forEach(member => {
                    html += `<th style="min-width: 80px; text-align: center;">${member}</th>`;
                });
                html += '<th class="daily-total" style="min-width: 80px; text-align: center;">æ—¥åˆ¥åˆè¨ˆ</th></tr>';
            }
            
            let currentMonth = '';
            let monthTotals = {};
            members.forEach(m => monthTotals[m] = 0);
            let monthTotal = 0;
            
            // æ—¥ä»˜ã”ã¨ã®è¡Œ
            allDates.forEach(date => {
                const dateObj = new Date(date);
                const month = `${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ`;
                const dayOfWeek = getDayOfWeek(date);
                const isWeekend = dayOfWeek === 'åœŸ' || dayOfWeek === 'æ—¥';
                
                // ç¥æ—¥åˆ¤å®š
                const holiday = getHoliday(date);
                const isHoliday = holiday !== null;
                
                // æœˆãŒå¤‰ã‚ã£ãŸã‚‰æœˆæ¬¡å°è¨ˆè¡Œã‚’æŒ¿å…¥ï¼ˆå…¨æœŸé–“è¡¨ç¤ºæ™‚ã®ã¿ï¼‰
                if (selectedMonth === 'all' && currentMonth && currentMonth !== month) {
                    html += '<tr style="background: #fff3cd; font-weight: 600;">';
                    html += `<td>${currentMonth} å°è¨ˆ</td>`;
                    members.forEach(member => {
                        html += `<td style="text-align: center;">${monthTotals[member].toFixed(1)}h</td>`;
                    });
                    html += `<td class="daily-total" style="background: #ffc107; color: white; text-align: center;">${monthTotal.toFixed(1)}h</td>`;
                    html += '</tr>';
                    
                    // ãƒªã‚»ãƒƒãƒˆ
                    members.forEach(m => monthTotals[m] = 0);
                    monthTotal = 0;
                }
                
                currentMonth = month;

                // ä¼šç¤¾ä¼‘æ—¥åˆ¤å®š
                const companyHolidayName = getCompanyHolidayName(date);
                const isCompanyHol = companyHolidayName !== null;

                // æ—¥ä»˜è¡Œï¼ˆç¥æ—¥ãƒ»ä¼šç¤¾ä¼‘æ—¥ãƒ»é€±æœ«ï¼‰
                let bgColor = 'white';
                if (isWeekend || isHoliday) {
                    bgColor = '#ffebee';
                } else if (isCompanyHol) {
                    bgColor = '#fff9c4';
                }
                html += `<tr style="background: ${bgColor};">`;

                // æ—¥ä»˜ã‚»ãƒ«
                const [year, m, day] = date.split('-');
                let dateColor = '';
                let dateDisplay = '';

                if (isHoliday) {
                    dateColor = 'color: #c62828;';
                    dateDisplay = `${parseInt(m)}/${parseInt(day)} (${dayOfWeek})<span class="holiday-inline"> ${holiday}</span><span class="holiday-break"><br><span style="font-size: 11px; font-weight: normal;">${holiday}</span></span>`;
                } else if (isCompanyHol) {
                    dateColor = 'color: #f57c00;';
                    dateDisplay = `${parseInt(m)}/${parseInt(day)} (${dayOfWeek})<span class="holiday-inline"> ${companyHolidayName}</span><span class="holiday-break"><br><span style="font-size: 11px; font-weight: normal;">${companyHolidayName}</span></span>`;
                } else if (isWeekend) {
                    dateColor = 'color: #c62828;';
                    dateDisplay = `${parseInt(m)}/${parseInt(day)} (${dayOfWeek})`;
                } else {
                    dateDisplay = `${parseInt(m)}/${parseInt(day)} (${dayOfWeek})`;
                }

                html += `<td style="font-weight: 500; ${dateColor}">
                    ${dateDisplay}
                </td>`;
                
                let dayTotal = 0;
                
                // æ‹…å½“è€…ã”ã¨ã®ã‚»ãƒ«
                members.forEach(member => {
                    const dayActuals = filteredActuals.filter(a => a.member === member && a.date === date);
                    const memberDayTotal = dayActuals.reduce((sum, a) => sum + a.hours, 0);
                    const memberVacations = getVacation(member, date);

                    dayTotal += memberDayTotal;
                    monthTotals[member] += memberDayTotal;

                    let cellContent = '';
                    let bgColor = '#fafafa';
                    let onclick = `addActualFromCalendar('${member}', '${date}')`;
                    let title = 'å®Ÿç¸¾ã‚’ç™»éŒ²';

                    if (memberDayTotal > 0) {
                        bgColor = '#e3f2fd';
                        onclick = `showWorkDetail('${member}', '${date}')`;
                        cellContent = `<strong>${memberDayTotal.toFixed(1)}</strong>`;
                        title = '';
                    } else if (memberVacations.length > 0) {
                        bgColor = '#fff3e0';
                        onclick = `showWorkDetail('${member}', '${date}')`;
                        const vacationLabels = memberVacations.map(v => v.vacationType).join(',');
                        const totalVacationHours = memberVacations.reduce((sum, v) => sum + v.hours, 0);
                        cellContent = `<span style="color: #f57c00; font-weight: 600;">${vacationLabels}</span>`;
                        if (totalVacationHours < 8) {
                            cellContent += `<br><span style="font-size: 10px; color: #666;">${totalVacationHours}h</span>`;
                        }
                        title = 'ä¼‘æš‡';
                    } else {
                        cellContent = '<span style="color: #ccc;">-</span>';
                    }

                    html += `<td style="background: ${bgColor}; text-align: center; cursor: pointer;"
                                onclick="${onclick}" title="${title}">
                        ${cellContent}
                    </td>`;
                });
                
                monthTotal += dayTotal;
                
                // æ—¥åˆ¥åˆè¨ˆ
                if (dayTotal > 0) {
                    html += `<td class="daily-total" style="font-weight: 700; background: #fff3cd; text-align: center;">${dayTotal.toFixed(1)}h</td>`;
                } else {
                    html += `<td class="daily-total" style="background: #fafafa; text-align: center; color: #ccc;">-</td>`;
                }
                
                html += '</tr>';
            });
            
            // æœ€å¾Œã®æœˆã®å°è¨ˆï¼ˆå…¨æœŸé–“è¡¨ç¤ºæ™‚ã®ã¿ï¼‰
            if (selectedMonth === 'all' && currentMonth) {
                html += '<tr style="background: #fff3cd; font-weight: 600;">';
                html += `<td>${currentMonth} å°è¨ˆ</td>`;
                members.forEach(member => {
                    html += `<td style="text-align: center;">${monthTotals[member].toFixed(1)}h</td>`;
                });
                html += `<td style="background: #ffc107; color: white; text-align: center;">${monthTotal.toFixed(1)}h</td>`;
                html += '</tr>';
            }
            
            // å…¨æœŸé–“ã®åˆè¨ˆè¡Œ
            html += '<tr style="background: #2c3e50; color: white; font-weight: 700;">';
            html += '<td>ç·åˆè¨ˆ</td>';
            let grandTotal = 0;
            
            members.forEach(member => {
                const memberTotal = filteredActuals.filter(a => a.member === member).reduce((sum, a) => sum + a.hours, 0);
                grandTotal += memberTotal;
                html += `<td style="text-align: center;">${memberTotal.toFixed(1)}h</td>`;
            });
            
            html += `<td class="daily-total" style="background: #ffc107; text-align: center;">${grandTotal.toFixed(1)}h</td>`;
            html += '</tr>';
            
            html += '</table></div>';

            container.innerHTML = html;
        }


        function renderActualListView() {
            const container = document.getElementById('actualList');
            const viewMode = document.getElementById('actualViewMode').value;
            const selectedMonth = document.getElementById('actualMonthFilter').value;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†
            let filteredActuals = actuals;
            
            // æ‹…å½“è€…åˆ¥ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
            if (viewMode === 'member') {
                const selectedMember = document.getElementById('actualMemberSelect').value;
                if (selectedMember) {
                    filteredActuals = filteredActuals.filter(a => a.member === selectedMember);
                }
            }
            
            // æœˆã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            if (selectedMonth !== 'all') {
                filteredActuals = filteredActuals.filter(a => a.date && a.date.startsWith(selectedMonth));
            }
            
            let html = '<div class="table-wrapper"><table><tr><th>æ—¥ä»˜</th><th>ç‰ˆæ•°</th><th>å¯¾å¿œå</th><th>å·¥ç¨‹</th><th>æ‹…å½“</th><th>å®Ÿç¸¾å·¥æ•°</th><th>æ“ä½œ</th></tr>';
            
            const sortedActuals = [...filteredActuals].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (sortedActuals.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">é¸æŠã—ãŸæ¡ä»¶ã«è©²å½“ã™ã‚‹å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            sortedActuals.forEach(a => {
                html += `
                    <tr>
                        <td>${a.date}</td>
                        <td>${a.version}</td>
                        <td>${a.task}</td>
                        <td><span class="badge badge-${a.process.toLowerCase()}">${a.process}</span></td>
                        <td>${a.member}</td>
                        <td>${a.hours}h</td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="editActual(${a.id})" style="margin-right: 5px;">ç·¨é›†</button>
                            <button class="btn btn-danger btn-small" onclick="deleteActual(${a.id})">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</table></div>';
            container.innerHTML = html;
        }

        function getDayOfWeek(dateStr) {
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const date = new Date(dateStr);
            return days[date.getDay()];
        }

        function getHoliday(dateStr) {
            // @holiday-jp/holiday_jp ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨
            if (typeof holiday_jp !== 'undefined' && typeof holiday_jp.isHoliday === 'function') {
                try {
                    const date = new Date(dateStr + 'T00:00:00');
                    const holiday = holiday_jp.isHoliday(date);
                    if (holiday) {
                        // holiday.name ãŒç¥æ—¥å
                        return holiday.name || holiday;
                    }
                } catch (error) {
                    console.error('Holiday check error:', error);
                }
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ä¸»è¦ãªç¥æ—¥ã®ã¿å¯¾å¿œï¼ˆ2025-2030å¹´ï¼‰
            const holidays = {
                // 2025å¹´
                '2025-01-01': 'å…ƒæ—¥',
                '2025-01-13': 'æˆäººã®æ—¥',
                '2025-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
                '2025-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                '2025-02-24': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2025-03-20': 'æ˜¥åˆ†ã®æ—¥',
                '2025-04-29': 'æ˜­å’Œã®æ—¥',
                '2025-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
                '2025-05-04': 'ã¿ã©ã‚Šã®æ—¥',
                '2025-05-05': 'ã“ã©ã‚‚ã®æ—¥',
                '2025-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2025-07-21': 'æµ·ã®æ—¥',
                '2025-08-11': 'å±±ã®æ—¥',
                '2025-09-15': 'æ•¬è€ã®æ—¥',
                '2025-09-23': 'ç§‹åˆ†ã®æ—¥',
                '2025-10-13': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
                '2025-11-03': 'æ–‡åŒ–ã®æ—¥',
                '2025-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
                '2025-11-24': 'æŒ¯æ›¿ä¼‘æ—¥',
                // 2026å¹´
                '2026-01-01': 'å…ƒæ—¥',
                '2026-01-12': 'æˆäººã®æ—¥',
                '2026-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
                '2026-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                '2026-03-20': 'æ˜¥åˆ†ã®æ—¥',
                '2026-04-29': 'æ˜­å’Œã®æ—¥',
                '2026-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
                '2026-05-04': 'ã¿ã©ã‚Šã®æ—¥',
                '2026-05-05': 'ã“ã©ã‚‚ã®æ—¥',
                '2026-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2026-07-20': 'æµ·ã®æ—¥',
                '2026-08-11': 'å±±ã®æ—¥',
                '2026-09-21': 'æ•¬è€ã®æ—¥',
                '2026-09-22': 'ç§‹åˆ†ã®æ—¥',
                '2026-10-12': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
                '2026-11-03': 'æ–‡åŒ–ã®æ—¥',
                '2026-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
                '2026-12-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                // 2027å¹´
                '2027-01-01': 'å…ƒæ—¥',
                '2027-01-11': 'æˆäººã®æ—¥',
                '2027-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
                '2027-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                '2027-03-21': 'æ˜¥åˆ†ã®æ—¥',
                '2027-03-22': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2027-04-29': 'æ˜­å’Œã®æ—¥',
                '2027-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
                '2027-05-04': 'ã¿ã©ã‚Šã®æ—¥',
                '2027-05-05': 'ã“ã©ã‚‚ã®æ—¥',
                '2027-07-19': 'æµ·ã®æ—¥',
                '2027-08-11': 'å±±ã®æ—¥',
                '2027-09-20': 'æ•¬è€ã®æ—¥',
                '2027-09-23': 'ç§‹åˆ†ã®æ—¥',
                '2027-10-11': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
                '2027-11-03': 'æ–‡åŒ–ã®æ—¥',
                '2027-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
                '2027-12-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                // 2028å¹´
                '2028-01-01': 'å…ƒæ—¥',
                '2028-01-10': 'æˆäººã®æ—¥',
                '2028-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
                '2028-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                '2028-03-20': 'æ˜¥åˆ†ã®æ—¥',
                '2028-04-29': 'æ˜­å’Œã®æ—¥',
                '2028-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
                '2028-05-04': 'ã¿ã©ã‚Šã®æ—¥',
                '2028-05-05': 'ã“ã©ã‚‚ã®æ—¥',
                '2028-07-17': 'æµ·ã®æ—¥',
                '2028-08-11': 'å±±ã®æ—¥',
                '2028-09-18': 'æ•¬è€ã®æ—¥',
                '2028-09-22': 'ç§‹åˆ†ã®æ—¥',
                '2028-10-09': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
                '2028-11-03': 'æ–‡åŒ–ã®æ—¥',
                '2028-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
                '2028-12-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                // 2029å¹´
                '2029-01-01': 'å…ƒæ—¥',
                '2029-01-08': 'æˆäººã®æ—¥',
                '2029-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
                '2029-02-12': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2029-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                '2029-03-20': 'æ˜¥åˆ†ã®æ—¥',
                '2029-04-29': 'æ˜­å’Œã®æ—¥',
                '2029-04-30': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2029-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
                '2029-05-04': 'ã¿ã©ã‚Šã®æ—¥',
                '2029-05-05': 'ã“ã©ã‚‚ã®æ—¥',
                '2029-07-16': 'æµ·ã®æ—¥',
                '2029-08-11': 'å±±ã®æ—¥',
                '2029-09-17': 'æ•¬è€ã®æ—¥',
                '2029-09-23': 'ç§‹åˆ†ã®æ—¥',
                '2029-09-24': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2029-10-08': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
                '2029-11-03': 'æ–‡åŒ–ã®æ—¥',
                '2029-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
                '2029-12-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                '2029-12-24': 'æŒ¯æ›¿ä¼‘æ—¥',
                // 2030å¹´
                '2030-01-01': 'å…ƒæ—¥',
                '2030-01-14': 'æˆäººã®æ—¥',
                '2030-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
                '2030-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
                '2030-03-20': 'æ˜¥åˆ†ã®æ—¥',
                '2030-04-29': 'æ˜­å’Œã®æ—¥',
                '2030-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
                '2030-05-04': 'ã¿ã©ã‚Šã®æ—¥',
                '2030-05-05': 'ã“ã©ã‚‚ã®æ—¥',
                '2030-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2030-07-15': 'æµ·ã®æ—¥',
                '2030-08-11': 'å±±ã®æ—¥',
                '2030-08-12': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2030-09-16': 'æ•¬è€ã®æ—¥',
                '2030-09-23': 'ç§‹åˆ†ã®æ—¥',
                '2030-10-14': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
                '2030-11-03': 'æ–‡åŒ–ã®æ—¥',
                '2030-11-04': 'æŒ¯æ›¿ä¼‘æ—¥',
                '2030-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
                '2030-12-23': 'å¤©çš‡èª•ç”Ÿæ—¥'
            };
            
            return holidays[dateStr] || null;
        }

        function showWorkDetail(member, date) {
            const dayActuals = actuals.filter(a => a.member === member && a.date === date);
            const memberVacations = getVacation(member, date);

            if (dayActuals.length === 0 && memberVacations.length === 0) return;

            const dateObj = new Date(date);
            const [year, month, day] = date.split('-');
            const dayOfWeek = getDayOfWeek(date);

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«
            document.getElementById('modalTitle').textContent =
                `${member}ã•ã‚“ã®ä½œæ¥­ - ${year}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥(${dayOfWeek})`;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬æ–‡
            let html = '';
            const totalHours = dayActuals.reduce((sum, a) => sum + a.hours, 0);

            // ä¼‘æš‡æƒ…å ±ã‚’è¡¨ç¤º
            if (memberVacations.length > 0) {
                html += '<div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f57c00;">';
                html += '<div style="font-weight: 600; color: #f57c00; margin-bottom: 10px;">ğŸ–ï¸ ä¼‘æš‡</div>';
                memberVacations.forEach(vacation => {
                    html += `
                        <div style="margin-bottom: 8px; padding: 10px; background: white; border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${vacation.vacationType}</strong>
                                    <span style="color: #666; font-size: 14px; margin-left: 10px;">${vacation.hours}h</span>
                                </div>
                                <button onclick="deleteVacationFromModal(${vacation.id}, '${member}', '${date}')" style="background: none; border: none; color: #95a5a6; cursor: pointer; font-size: 12px; padding: 4px 8px; text-decoration: underline;">å‰Šé™¤</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            dayActuals.forEach(actual => {
                html += `
                    <div class="work-item">
                        <div class="work-item-header">
                            <div class="work-item-title">${actual.task}</div>
                            <div class="work-item-hours">${actual.hours}h</div>
                        </div>
                        <div class="work-item-details">
                            <span><strong>ç‰ˆæ•°:</strong> ${actual.version || '(ãªã—)'}</span>
                            <span><strong>å·¥ç¨‹:</strong> ${actual.process ? `<span class="badge badge-${actual.process.toLowerCase()}">${actual.process}</span>` : '(ãªã—)'}</span>
                        </div>
                        <div style="margin-top: 8px; text-align: right;">
                            <button onclick="editActualFromModal(${actual.id})" style="background: none; border: none; color: #3498db; cursor: pointer; font-size: 12px; padding: 4px 8px; text-decoration: underline;">ç·¨é›†</button>
                            <button onclick="deleteActualFromModal(${actual.id}, '${member}', '${date}')" style="background: none; border: none; color: #95a5a6; cursor: pointer; font-size: 12px; padding: 4px 8px; text-decoration: underline;">å‰Šé™¤</button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #eee; text-align: right;">
                    <strong style="font-size: 16px;">åˆè¨ˆ: ${totalHours.toFixed(1)}æ™‚é–“</strong>
                    <span style="color: #666; font-size: 14px; margin-left: 10px;">(${dayActuals.length}ä»¶)</span>
                </div>
                <div style="margin-top: 15px; text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="addActualFromCalendar('${member}', '${date}'); closeWorkModal();"
                            style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        + æ–°ã—ã„å®Ÿç¸¾ã‚’è¿½åŠ 
                    </button>
                    <button onclick="addVacationFromCalendar('${member}', '${date}'); closeWorkModal();"
                            style="padding: 10px 20px; background: #f57c00; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        + ä¼‘æš‡ã‚’è¿½åŠ 
                    </button>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('workModal').style.display = 'flex';
        }

        function closeWorkModal() {
            document.getElementById('workModal').style.display = 'none';
        }
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰å®Ÿç¸¾ã‚’æ–°è¦ç™»éŒ²
        function addActualFromCalendar(member, date) {
            // å®Ÿç¸¾ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆæ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ï¼‰
            document.getElementById('editActualId').value = '';
            document.getElementById('editActualDate').value = date;

            // ç‰ˆæ•°ã‚’æœ€æ–°ã®ã‚‚ã®ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
            const versionSelect = document.getElementById('editActualVersion');
            // æœ€å¾Œã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæœ€æ–°ã®ç‰ˆæ•°ï¼‰ã‚’é¸æŠ
            // options[0]="-- ç‰ˆæ•°ã‚’é¸æŠ --", options[1]="+ æ–°ã—ã„ç‰ˆæ•°ã‚’è¿½åŠ ...", ä»¥é™ãŒå®Ÿéš›ã®ç‰ˆæ•°
            if (versionSelect.options.length > 2) {
                versionSelect.value = versionSelect.options[versionSelect.options.length - 1].value;
            } else {
                versionSelect.value = '';
            }

            // å¯¾å¿œåã®select/inputã‚’åˆæœŸåŒ–
            document.getElementById('editActualTaskSelect').style.display = 'block';
            document.getElementById('editActualTaskSelect').value = '';
            document.getElementById('editActualTaskSearch').style.display = 'none';
            document.getElementById('editActualTaskSearch').value = '';
            document.getElementById('editActualProcess').value = 'UI';
            
            // æ‹…å½“è€…ã‚’è¨­å®šï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã®å ´åˆã¯è¡¨ç¤ºã®ã¿ï¼‰
            const memberSelect = document.getElementById('editActualMember');
            const memberDisplay = document.getElementById('editActualMemberDisplay');

            // optionã‚’è¿½åŠ ã—ã¦ã‹ã‚‰å€¤ã‚’è¨­å®š
            memberSelect.innerHTML = '';
            const option = document.createElement('option');
            option.value = member;
            option.textContent = member;
            memberSelect.appendChild(option);
            memberSelect.value = member;

            memberSelect.style.display = 'none';
            memberDisplay.style.display = 'block';
            memberDisplay.textContent = member;

            document.getElementById('editActualHours').value = '';
            document.getElementById('editActualRemainingHours').value = '';

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´
            const modalTitle = document.querySelector('#editActualModal .modal-header h3');
            const [year, month, day] = date.split('-');
            modalTitle.textContent = `å®Ÿç¸¾ã‚’æ–°è¦ç™»éŒ² - ${member} (${year}/${parseInt(month)}/${parseInt(day)})`;

            // ã“ã®æ‹…å½“è€…ã®æœªå®Œäº†å¯¾å¿œã‚’å–å¾—ã—ã¦datalistã«è¨­å®š
            // æ–°è¦ç™»éŒ²æ™‚ãªã®ã§isEditMode=falseã€é¸æŠã—ãŸç‰ˆæ•°ã‚’æ¸¡ã™
            updateEditActualTaskList(member, false, versionSelect.value);

            // ã€Œãã®ä»–ä½œæ¥­ã€ã€Œä¼‘æš‡ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
            document.getElementById('editActualOtherBtn').style.display = 'block';
            document.getElementById('editActualVacationBtn').style.display = 'block';
            document.getElementById('editActualModal').dataset.calendarMember = member;
            document.getElementById('editActualModal').dataset.calendarDate = date;

            document.getElementById('editActualModal').style.display = 'flex';
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ãã®ä»–ä½œæ¥­ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openOtherWorkFromCalendar() {
            const modal = document.getElementById('editActualModal');
            const member = modal.dataset.calendarMember;
            const date = modal.dataset.calendarDate;

            // å®Ÿç¸¾ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            closeEditActualModal();

            // ãã®ä»–ä½œæ¥­ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€æ‹…å½“è€…ã¨æ—¥ä»˜ã‚’è¨­å®š
            openOtherWorkModalWithContext(member, date);
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ä¼‘æš‡ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openVacationFromCalendar() {
            const modal = document.getElementById('editActualModal');
            const member = modal.dataset.calendarMember;
            const date = modal.dataset.calendarDate;

            // å®Ÿç¸¾ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            closeEditActualModal();

            // ä¼‘æš‡ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            addVacationFromCalendar(member, date);
        }

        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä»˜ãã§ãã®ä»–ä½œæ¥­ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openOtherWorkModalWithContext(member, date) {
            // æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
            const otherWorkMemberSelect = document.getElementById('otherWorkMember');
            if (otherWorkMemberSelect) {
                const allMembers = new Set();
                estimates.forEach(e => allMembers.add(e.member));
                actuals.forEach(a => allMembers.add(a.member));

                let sortedMembers;
                const memberOrderInput = document.getElementById('memberOrder').value.trim();
                if (memberOrderInput) {
                    const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
                    const orderedMembers = orderList.filter(name => allMembers.has(name));
                    const unorderedMembers = Array.from(allMembers).filter(m => !orderedMembers.includes(m)).sort();
                    sortedMembers = [...orderedMembers, ...unorderedMembers];
                } else {
                    sortedMembers = Array.from(allMembers).sort();
                }

                otherWorkMemberSelect.innerHTML = '<option value="">é¸æŠ...</option>';
                sortedMembers.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    option.textContent = m;
                    otherWorkMemberSelect.appendChild(option);
                });

                // æ‹…å½“è€…ã‚’é¸æŠ
                otherWorkMemberSelect.value = member;
            }

            // æ—¥ä»˜ã‚’ä¿æŒï¼ˆä¿å­˜æ™‚ã«ä½¿ç”¨ï¼‰
            document.getElementById('otherWorkModal').dataset.calendarDate = date;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            const [year, month, day] = date.split('-');
            document.querySelector('#otherWorkModal .modal-header h3').textContent =
                `ãã®ä»–ä½œæ¥­ã‚’ç™»éŒ² - ${member} (${year}/${parseInt(month)}/${parseInt(day)})`;

            document.getElementById('otherWorkModal').style.display = 'flex';
        }
        
        // å®Ÿç¸¾ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¯¾å¿œåãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆæ‹…å½“è€…ã¨ç‰ˆæ•°ã«å¿œã˜ãŸå¯¾å¿œï¼‰
        function updateEditActualTaskList(member, isEditMode = false, selectedVersion = null) {
            const select = document.getElementById('editActualTaskSelect');

            // ç‰ˆæ•°ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€editActualVersionã‹ã‚‰å–å¾—
            if (!selectedVersion) {
                const versionSelect = document.getElementById('editActualVersion');
                selectedVersion = versionSelect ? versionSelect.value : null;
            }

            // ã“ã®æ‹…å½“è€…ã®è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            let memberEstimates = estimates.filter(e => e.member === member);

            // ç‰ˆæ•°ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã®ç‰ˆæ•°ã®ä½œæ¥­ã®ã¿ã«çµã‚‹
            if (selectedVersion && selectedVersion !== '') {
                memberEstimates = memberEstimates.filter(e => e.version === selectedVersion);
            }

            // å®Ÿç¸¾å·¥æ•°ã‚’é›†è¨ˆ
            const actualTotals = {};
            actuals.forEach(a => {
                const key = `${a.version}_${a.task}_${a.process}`;
                actualTotals[key] = (actualTotals[key] || 0) + a.hours;
            });

            // å¯¾å¿œã‚’æŠ½å‡º
            const tasks = [];
            memberEstimates.forEach(est => {
                const key = `${est.version}_${est.task}_${est.process}`;
                const actualHours = actualTotals[key] || 0;
                const remaining = est.hours - actualHours;

                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã™ã¹ã¦ã®å¯¾å¿œã‚’å«ã‚ã‚‹
                // æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯æœªå®Œäº†ã®ã¿
                if (isEditMode || actualHours < est.hours) {
                    let displayText;
                    if (remaining > 0) {
                        displayText = `${est.task} [${est.process}] (æ®‹: ${remaining.toFixed(1)}h)`;
                    } else if (remaining < 0) {
                        displayText = `${est.task} [${est.process}] (è¶…é: ${Math.abs(remaining).toFixed(1)}h)`;
                    } else {
                        displayText = `${est.task} [${est.process}] (å®Œäº†)`;
                    }

                    tasks.push({
                        version: est.version,
                        task: est.task,
                        process: est.process,
                        remaining: remaining,
                        display: displayText
                    });
                }
            });

            // selectã‚’æ›´æ–°
            select.innerHTML = '<option value="">-- å¯¾å¿œã‚’é¸æŠ --</option>';
            tasks.forEach(task => {
                const option = document.createElement('option');
                option.value = task.task;
                option.setAttribute('data-version', task.version);
                option.setAttribute('data-process', task.process);
                option.textContent = task.display;
                select.appendChild(option);
            });

            // ã€Œæ–°è¦å…¥åŠ›ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            const newOption = document.createElement('option');
            newOption.value = '__NEW__';
            newOption.textContent = 'æ–°è¦å…¥åŠ›...';
            select.appendChild(newOption);
        }
        
        // ä½œæ¥­è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ç·¨é›†
        function editActualFromModal(id) {
            closeWorkModal();
            editActual(id);
        }
        
        // ä½œæ¥­è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰å‰Šé™¤
        function deleteActualFromModal(id, member, date) {
            if (confirm('ã“ã®å®Ÿç¸¾ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                actuals = actuals.filter(a => a.id !== id);
                saveData();
                renderActualList();
                renderTodayActuals();
                updateReport();
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æ›´æ–°ï¼ˆã¾ã ä»–ã®ä½œæ¥­ãŒã‚ã‚‹å ´åˆï¼‰
                const remainingActuals = actuals.filter(a => a.member === member && a.date === date);
                if (remainingActuals.length > 0) {
                    showWorkDetail(member, date);
                } else {
                    closeWorkModal();
                }
            }
        }

        function editActual(id) {
            const actual = actuals.find(a => a.id === id);
            if (!actual) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            document.getElementById('editActualId').value = id;
            document.getElementById('editActualDate').value = actual.date;
            document.getElementById('editActualVersion').value = actual.version;

            // ç·¨é›†æ™‚ã¯ã™ã¹ã¦ã®å¯¾å¿œï¼ˆå®Œäº†æ¸ˆã¿å«ã‚€ï¼‰ã®ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¦é¸æŠã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            // é¸æŠã—ãŸç‰ˆæ•°ã®ä½œæ¥­ã®ã¿ã‚’è¡¨ç¤º
            updateEditActualTaskList(actual.member, true, actual.version);

            // å¯¾å¿œåã‚’ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã§é¸æŠã§ãã‚‹ã‚ˆã†ã«
            const taskSelect = document.getElementById('editActualTaskSelect');
            const taskInput = document.getElementById('editActualTaskSearch');

            // æ—¢å­˜ã®å¯¾å¿œåã¨ä¸€è‡´ã™ã‚‹optionãŒã‚ã‚Œã°é¸æŠã€ãªã‘ã‚Œã°ã€Œæ–°è¦å…¥åŠ›ã€ã‚’é¸æŠã—ã¦å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
            let foundMatch = false;
            for (let i = 0; i < taskSelect.options.length; i++) {
                if (taskSelect.options[i].value === actual.task) {
                    taskSelect.value = actual.task;
                    foundMatch = true;
                    break;
                }
            }

            if (foundMatch) {
                taskSelect.style.display = 'block';
                taskInput.style.display = 'none';
            } else {
                // ä¸€è‡´ã™ã‚‹å¯¾å¿œåãŒãªã„å ´åˆã¯æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰
                taskSelect.value = '__NEW__';
                taskSelect.style.display = 'none';
                taskInput.style.display = 'block';
                taskInput.value = actual.task;
            }

            document.getElementById('editActualProcess').value = actual.process;
            document.getElementById('editActualHours').value = actual.hours;

            // è¦‹è¾¼æ®‹å­˜æ™‚é–“ã‚’èª­ã¿è¾¼ã¿
            const existingRemaining = getRemainingEstimate(actual.version, actual.task, actual.process, actual.member);
            document.getElementById('editActualRemainingHours').value = existingRemaining ? existingRemaining.remainingHours : '';

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            const modalTitle = document.querySelector('#editActualModal .modal-header h3');
            const [year, month, day] = actual.date.split('-');
            modalTitle.textContent = `å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›† - ${actual.member} (${year}/${parseInt(month)}/${parseInt(day)})`;
            
            // æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
            const memberSelect = document.getElementById('editActualMember');
            const allMembers = new Set();
            estimates.forEach(e => allMembers.add(e.member));
            actuals.forEach(a => allMembers.add(a.member));
            
            let sortedMembers;
            const memberOrderInput = document.getElementById('memberOrder').value.trim();
            if (memberOrderInput) {
                const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
                const orderedMembers = [];
                const unorderedMembers = [];
                
                orderList.forEach(name => {
                    if (allMembers.has(name)) {
                        orderedMembers.push(name);
                    }
                });
                
                Array.from(allMembers).forEach(m => {
                    if (!orderedMembers.includes(m)) {
                        unorderedMembers.push(m);
                    }
                });
                
                sortedMembers = [...orderedMembers, ...unorderedMembers.sort()];
            } else {
                sortedMembers = Array.from(allMembers).sort();
            }
            
            memberSelect.innerHTML = '';
            sortedMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                memberSelect.appendChild(option);
            });

            memberSelect.value = actual.member;

            // ç·¨é›†æ™‚ã¯ã‚»ãƒ¬ã‚¯ãƒˆã‚’è¡¨ç¤ºã€è¡¨ç¤ºç”¨spanã‚’éè¡¨ç¤º
            memberSelect.style.display = 'block';
            document.getElementById('editActualMemberDisplay').style.display = 'none';

            // ç·¨é›†æ™‚ã¯ã€Œãã®ä»–ä½œæ¥­ã€ã€Œä¼‘æš‡ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            document.getElementById('editActualOtherBtn').style.display = 'none';
            document.getElementById('editActualVacationBtn').style.display = 'none';

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('editActualModal').style.display = 'flex';
        }

        function closeEditActualModal() {
            document.getElementById('editActualModal').style.display = 'none';
        }

        function saveActualEdit() {
            const id = parseFloat(document.getElementById('editActualId').value);
            const date = document.getElementById('editActualDate').value;
            const version = document.getElementById('editActualVersion').value;

            // selectã¾ãŸã¯inputã‹ã‚‰å¯¾å¿œåã‚’å–å¾—
            const taskSelect = document.getElementById('editActualTaskSelect');
            const taskInput = document.getElementById('editActualTaskSearch');
            const task = taskSelect.style.display !== 'none' && taskSelect.value && taskSelect.value !== '__NEW__'
                ? taskSelect.value
                : taskInput.value;

            const process = document.getElementById('editActualProcess').value;
            const member = document.getElementById('editActualMember').value;
            const hours = parseFloat(document.getElementById('editActualHours').value);
            const remainingHoursInput = document.getElementById('editActualRemainingHours');
            const remainingHours = remainingHoursInput.value !== '' ? parseFloat(remainingHoursInput.value) : null;

            if (!date || !version || !task || !process || !member || !hours) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // æ–°è¦ç™»éŒ²ã‹æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã‹ã‚’åˆ¤å®š
            if (id && !isNaN(id)) {
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
                const actualIndex = actuals.findIndex(a => a.id === id);
                if (actualIndex !== -1) {
                    actuals[actualIndex] = {
                        ...actuals[actualIndex],
                        date: date,
                        version: version,
                        task: task,
                        process: process,
                        member: member,
                        hours: hours
                    };

                    // è¦‹è¾¼æ®‹å­˜æ™‚é–“ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚Œã°ä¿å­˜
                    if (remainingHours !== null && !isNaN(remainingHours)) {
                        saveRemainingEstimate(version, task, process, member, remainingHours);
                    }

                    saveData();
                    closeEditActualModal();

                    updateMonthOptions();
                    updateActualMonthOptions();
                    updateMemberOptions();
                    updateQuickTaskList();
                    renderTodayActuals();
                    renderActualList();
                    updateReport();

                    alert('å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                } else {
                    alert('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } else {
                // æ–°è¦ç™»éŒ²
                const newActual = {
                    id: Date.now() + Math.random(),
                    date: date,
                    version: version,
                    task: task,
                    process: process,
                    member: member,
                    hours: hours
                };

                actuals.push(newActual);

                // è¦‹è¾¼æ®‹å­˜æ™‚é–“ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚Œã°ä¿å­˜
                if (remainingHours !== null && !isNaN(remainingHours)) {
                    saveRemainingEstimate(version, task, process, member, remainingHours);
                }

                saveData();
                closeEditActualModal();

                updateMonthOptions();
                updateActualMonthOptions();
                updateMemberOptions();
                updateQuickTaskList();
                renderTodayActuals();
                renderActualList();
                updateReport();

                alert('å®Ÿç¸¾ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
            }
        }

        // è¦‹è¾¼æ®‹å­˜æ™‚é–“ã‚’ä¿å­˜/æ›´æ–°ã™ã‚‹é–¢æ•°
        function saveRemainingEstimate(version, task, process, member, remainingHours) {
            const existingIndex = remainingEstimates.findIndex(r =>
                r.version === version &&
                r.task === task &&
                r.process === process &&
                r.member === member
            );

            const record = {
                id: existingIndex >= 0 ? remainingEstimates[existingIndex].id : Date.now() + Math.random(),
                version: version,
                task: task,
                process: process,
                member: member,
                remainingHours: remainingHours,
                updatedAt: new Date().toISOString(),
                note: ''
            };

            if (existingIndex >= 0) {
                remainingEstimates[existingIndex] = record;
            } else {
                remainingEstimates.push(record);
            }
        }

        // è¦‹è¾¼æ®‹å­˜æ™‚é–“ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        function getRemainingEstimate(version, task, process, member) {
            return remainingEstimates.find(r =>
                r.version === version &&
                r.task === task &&
                r.process === process &&
                r.member === member
            );
        }

        // å¯¾å¿œå˜ä½ã§ã®é€²æ—æƒ…å ±ã‚’è¨ˆç®—
        function calculateProgress(version, task, process = null, member = null) {
            // è¦‹ç©å·¥æ•°ã‚’é›†è¨ˆ
            let estimatedHours = estimates
                .filter(e =>
                    e.version === version &&
                    e.task === task &&
                    (process === null || e.process === process) &&
                    (member === null || e.member === member)
                )
                .reduce((sum, e) => sum + e.hours, 0);

            // å®Ÿç¸¾å·¥æ•°ã‚’é›†è¨ˆ
            let actualHours = actuals
                .filter(a =>
                    a.version === version &&
                    a.task === task &&
                    (process === null || a.process === process) &&
                    (member === null || a.member === member)
                )
                .reduce((sum, a) => sum + a.hours, 0);

            // è¦‹è¾¼æ®‹å­˜æ™‚é–“ã‚’é›†è¨ˆ
            let remainingHours = remainingEstimates
                .filter(r =>
                    r.version === version &&
                    r.task === task &&
                    (process === null || r.process === process) &&
                    (member === null || r.member === member)
                )
                .reduce((sum, r) => sum + r.remainingHours, 0);

            // äºˆæ¸¬ç·å·¥æ•° = å®Ÿç¸¾ + è¦‹è¾¼æ®‹å­˜
            const eac = actualHours + remainingHours;

            // é€²æ—ç‡ = å®Ÿç¸¾ / (å®Ÿç¸¾ + è¦‹è¾¼æ®‹å­˜) Ã— 100
            const progressRate = (actualHours + remainingHours) > 0
                ? (actualHours / (actualHours + remainingHours)) * 100
                : 0;

            // çŠ¶æ…‹åˆ¤å®š
            let status = 'unknown';
            let statusLabel = 'æœªè¨­å®š';
            let statusColor = '#999';

            if (remainingHours === 0 && actualHours > 0) {
                status = 'completed';
                statusLabel = 'å®Œäº†';
                statusColor = '#27ae60';
            } else if (estimatedHours > 0) {
                if (eac <= estimatedHours) {
                    status = 'ontrack';
                    statusLabel = 'é †èª¿';
                    statusColor = '#3498db';
                } else if (eac <= estimatedHours * 1.2) {
                    status = 'warning';
                    statusLabel = 'æ³¨æ„';
                    statusColor = '#f39c12';
                } else {
                    status = 'exceeded';
                    statusLabel = 'è¶…é';
                    statusColor = '#e74c3c';
                }
            }

            // å·®ç•°è¨ˆç®—
            const variance = eac - estimatedHours;
            const variancePercent = estimatedHours > 0
                ? ((eac - estimatedHours) / estimatedHours) * 100
                : 0;

            return {
                estimatedHours,
                actualHours,
                remainingHours,
                eac,
                progressRate: Math.round(progressRate * 10) / 10,
                status,
                statusLabel,
                statusColor,
                variance,
                variancePercent: Math.round(variancePercent * 10) / 10,
                hasRemainingData: remainingHours > 0 ||
                    remainingEstimates.some(r => r.version === version && r.task === task)
            };
        }

        // ç‰ˆæ•°å…¨ä½“ã®é€²æ—æƒ…å ±ã‚’è¨ˆç®—
        function calculateVersionProgress(version) {
            const versionEstimates = estimates.filter(e => e.version === version);
            const versionActuals = actuals.filter(a => a.version === version);
            const versionRemaining = remainingEstimates.filter(r => r.version === version);

            const estimatedHours = versionEstimates.reduce((sum, e) => sum + e.hours, 0);
            const actualHours = versionActuals.reduce((sum, a) => sum + a.hours, 0);
            const remainingHours = versionRemaining.reduce((sum, r) => sum + r.remainingHours, 0);

            const eac = actualHours + remainingHours;
            const progressRate = (actualHours + remainingHours) > 0
                ? (actualHours / (actualHours + remainingHours)) * 100
                : 0;

            // ã‚¿ã‚¹ã‚¯æ•°
            const uniqueTasks = new Set([
                ...versionEstimates.map(e => e.task),
                ...versionActuals.map(a => a.task)
            ]);
            const completedTasks = [...uniqueTasks].filter(task => {
                const progress = calculateProgress(version, task);
                return progress.status === 'completed';
            }).length;

            return {
                estimatedHours,
                actualHours,
                remainingHours,
                eac,
                progressRate: Math.round(progressRate * 10) / 10,
                totalTasks: uniqueTasks.size,
                completedTasks,
                hasRemainingData: versionRemaining.length > 0
            };
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼HTMLã‚’ç”Ÿæˆ
        function createProgressBar(progressRate, status, options = {}) {
            const {
                showLabel = true,
                height = '20px',
                showEac = false,
                eac = 0,
                estimated = 0
            } = options;

            const statusColors = {
                completed: '#27ae60',
                ontrack: '#3498db',
                warning: '#f39c12',
                exceeded: '#e74c3c',
                unknown: '#bdc3c7'
            };

            const color = statusColors[status] || statusColors.unknown;
            const clampedRate = Math.min(100, Math.max(0, progressRate));

            // è¶…éã®å ´åˆã¯è¦‹ç©å¯¾æ¯”ã§ãƒãƒ¼è¡¨ç¤º
            let barWidth = clampedRate;
            let overflowWidth = 0;

            if (status === 'exceeded' && estimated > 0 && eac > 0) {
                barWidth = (estimated / eac) * 100;
                overflowWidth = 100 - barWidth;
            }

            let html = `
                <div style="position: relative; background: #ecf0f1; border-radius: 10px; height: ${height}; overflow: hidden;">
                    <div style="
                        width: ${barWidth}%;
                        height: 100%;
                        background: ${color};
                        border-radius: 10px;
                        transition: width 0.3s ease;
                    "></div>
            `;

            // è¶…éåˆ†ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
            if (overflowWidth > 0) {
                html += `
                    <div style="
                        position: absolute;
                        right: 0;
                        top: 0;
                        width: ${overflowWidth}%;
                        height: 100%;
                        background: repeating-linear-gradient(
                            45deg,
                            ${color},
                            ${color} 5px,
                            rgba(255,255,255,0.3) 5px,
                            rgba(255,255,255,0.3) 10px
                        );
                        border-radius: 0 10px 10px 0;
                    "></div>
                `;
            }

            // ãƒ©ãƒ™ãƒ«
            if (showLabel) {
                html += `
                    <span style="
                        position: absolute;
                        left: 50%;
                        top: 50%;
                        transform: translate(-50%, -50%);
                        font-size: 11px;
                        font-weight: 600;
                        color: ${clampedRate > 50 ? 'white' : '#333'};
                        text-shadow: ${clampedRate > 50 ? '0 1px 2px rgba(0,0,0,0.2)' : 'none'};
                    ">${progressRate.toFixed(1)}%</span>
                `;
            }

            html += '</div>';

            return html;
        }

        // çŠ¶æ…‹ãƒãƒƒã‚¸HTMLã‚’ç”Ÿæˆ
        function createStatusBadge(status, statusLabel) {
            const styles = {
                completed: { bg: '#e8f5e9', color: '#27ae60', icon: String.fromCharCode(10003) },
                ontrack:   { bg: '#e3f2fd', color: '#1976d2', icon: String.fromCharCode(8594) },
                warning:   { bg: '#fff3e0', color: '#f57c00', icon: String.fromCharCode(9888) },
                exceeded:  { bg: '#fce4ec', color: '#c2185b', icon: '!' },
                unknown:   { bg: '#f5f5f5', color: '#999', icon: '?' }
            };

            const style = styles[status] || styles.unknown;

            return `
                <span style="
                    display: inline-flex;
                    align-items: center;
                    gap: 4px;
                    padding: 4px 10px;
                    border-radius: 12px;
                    font-size: 12px;
                    font-weight: 600;
                    background: ${style.bg};
                    color: ${style.color};
                ">
                    <span>${style.icon}</span>
                    <span>${statusLabel}</span>
                </span>
            `;
        }

        // é€²æ—ç®¡ç†ãƒ¬ãƒãƒ¼ãƒˆã‚’æ›´æ–°
        function updateProgressReport() {
            const versionFilter = document.getElementById('progressVersionFilter')?.value || 'all';
            const statusFilter = document.getElementById('progressStatusFilter')?.value || 'all';

            // ç‰ˆæ•°é¸æŠè‚¢ã‚’æ›´æ–°
            updateProgressVersionOptions();

            // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
            renderProgressSummaryCards(versionFilter);

            // è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
            renderProgressDetailTable(versionFilter, statusFilter);
        }

        // ç‰ˆæ•°é¸æŠè‚¢ã‚’æ›´æ–°
        function updateProgressVersionOptions() {
            const select = document.getElementById('progressVersionFilter');
            const bulkSelect = document.getElementById('bulkRemainingVersionFilter');
            if (!select) return;

            const versions = [...new Set([
                ...estimates.map(e => e.version),
                ...actuals.map(a => a.version)
            ])].filter(v => v && v.trim() !== '').sort();

            const currentValue = select.value;
            select.innerHTML = '<option value="all">å…¨ç‰ˆæ•°</option>';
            versions.forEach(v => {
                select.innerHTML += `<option value="${v}">${v}</option>`;
            });
            select.value = currentValue || 'all';

            if (bulkSelect) {
                const bulkCurrentValue = bulkSelect.value;
                bulkSelect.innerHTML = '<option value="all">å…¨ç‰ˆæ•°</option>';
                versions.forEach(v => {
                    bulkSelect.innerHTML += `<option value="${v}">${v}</option>`;
                });
                bulkSelect.value = bulkCurrentValue || 'all';
            }
        }

        // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderProgressSummaryCards(versionFilter) {
            const container = document.getElementById('progressSummaryCards');
            if (!container) return;

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let targetVersions = versionFilter === 'all'
                ? [...new Set([...estimates.map(e => e.version), ...actuals.map(a => a.version)])]
                    .filter(v => v && v.trim() !== '')
                : [versionFilter];

            // å…¨ä½“çµ±è¨ˆ
            let totalEstimated = 0, totalActual = 0, totalRemaining = 0;
            let completedTasks = 0, totalTasks = 0;

            targetVersions.forEach(version => {
                const progress = calculateVersionProgress(version);
                totalEstimated += progress.estimatedHours;
                totalActual += progress.actualHours;
                totalRemaining += progress.remainingHours;
                completedTasks += progress.completedTasks;
                totalTasks += progress.totalTasks;
            });

            const totalEac = totalActual + totalRemaining;
            const overallProgress = totalEac > 0 ? (totalActual / totalEac) * 100 : 0;
            const variance = totalEac - totalEstimated;

            // çŠ¶æ…‹åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
            let statusCounts = { completed: 0, ontrack: 0, warning: 0, exceeded: 0, unknown: 0 };
            targetVersions.forEach(version => {
                const tasks = [...new Set([
                    ...estimates.filter(e => e.version === version).map(e => e.task),
                    ...actuals.filter(a => a.version === version).map(a => a.task)
                ])];
                tasks.forEach(task => {
                    const progress = calculateProgress(version, task);
                    statusCounts[progress.status]++;
                });
            });

            container.innerHTML = `
                <div class="stat-card theme-bg theme-${currentThemeColor}">
                    <h3>å…¨ä½“é€²æ—ç‡</h3>
                    <div class="value">${overallProgress.toFixed(1)}%</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 5px;">
                        ${completedTasks}/${totalTasks} å¯¾å¿œå®Œäº†
                    </div>
                </div>
                <div class="stat-card theme-bg theme-${currentThemeColor}">
                    <h3>äºˆæ¸¬ç·å·¥æ•°</h3>
                    <div class="value">${totalEac.toFixed(1)}h</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 5px;">
                        è¦‹ç©: ${totalEstimated.toFixed(1)}h / å·®ç•°: ${variance >= 0 ? '+' : ''}${variance.toFixed(1)}h
                    </div>
                </div>
                <div class="stat-card theme-bg theme-${currentThemeColor}">
                    <h3>å®Ÿç¸¾ / æ®‹å­˜</h3>
                    <div class="value">${totalActual.toFixed(1)}h / ${totalRemaining.toFixed(1)}h</div>
                </div>
                <div class="stat-card theme-bg theme-${currentThemeColor}">
                    <h3>çŠ¶æ…‹åˆ¥</h3>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                        <span style="background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px; font-size: 12px;">
                            ${String.fromCharCode(10003)} ${statusCounts.completed}
                        </span>
                        <span style="background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px; font-size: 12px;">
                            ${String.fromCharCode(8594)} ${statusCounts.ontrack}
                        </span>
                        <span style="background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px; font-size: 12px;">
                            ${String.fromCharCode(9888)} ${statusCounts.warning}
                        </span>
                        <span style="background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px; font-size: 12px;">
                            ! ${statusCounts.exceeded}
                        </span>
                    </div>
                </div>
            `;
        }

        // è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderProgressDetailTable(versionFilter, statusFilter) {
            const container = document.getElementById('progressDetailTable');
            if (!container) return;

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let targetVersions = versionFilter === 'all'
                ? [...new Set([...estimates.map(e => e.version), ...actuals.map(a => a.version)])]
                    .filter(v => v && v.trim() !== '').sort()
                : [versionFilter];

            let html = '<div class="table-wrapper"><table style="width: 100%; border-collapse: collapse;">';
            html += `
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">ç‰ˆæ•°</th>
                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">å¯¾å¿œå</th>
                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">è¦‹ç©</th>
                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">å®Ÿç¸¾</th>
                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">æ®‹å­˜</th>
                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ddd;">äºˆæ¸¬ç·å·¥æ•°</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd; width: 150px;">é€²æ—</th>
                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">çŠ¶æ…‹</th>
                    </tr>
                </thead>
                <tbody>
            `;

            let rowCount = 0;
            targetVersions.forEach(version => {
                const tasks = [...new Set([
                    ...estimates.filter(e => e.version === version).map(e => e.task),
                    ...actuals.filter(a => a.version === version).map(a => a.task)
                ])].sort();

                tasks.forEach(task => {
                    const progress = calculateProgress(version, task);

                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
                    if (statusFilter !== 'all' && progress.status !== statusFilter) return;

                    rowCount++;
                    const borderColor = {
                        completed: '#27ae60',
                        ontrack: '#3498db',
                        warning: '#f39c12',
                        exceeded: '#e74c3c',
                        unknown: '#ccc'
                    }[progress.status] || '#ccc';

                    html += `
                        <tr style="border-left: 4px solid ${borderColor};">
                            <td style="padding: 10px; border-bottom: 1px solid #eee;"><strong>${version}</strong></td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${task}</td>
                            <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;">${progress.estimatedHours.toFixed(1)}h</td>
                            <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;">${progress.actualHours.toFixed(1)}h</td>
                            <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;">
                                ${progress.hasRemainingData
                                    ? progress.remainingHours.toFixed(1) + 'h'
                                    : '<span style="color: #999;">æœªè¨­å®š</span>'}
                            </td>
                            <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee; font-weight: 600;">
                                ${progress.eac.toFixed(1)}h
                                ${progress.variance !== 0
                                    ? `<span style="font-size: 11px; color: ${progress.variance > 0 ? '#e74c3c' : '#27ae60'};">
                                        (${progress.variance > 0 ? '+' : ''}${progress.variance.toFixed(1)})
                                       </span>`
                                    : ''}
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">
                                ${createProgressBar(progress.progressRate, progress.status, {
                                    showEac: true,
                                    eac: progress.eac,
                                    estimated: progress.estimatedHours
                                })}
                            </td>
                            <td style="padding: 10px; text-align: center; border-bottom: 1px solid #eee;">${createStatusBadge(progress.status, progress.statusLabel)}</td>
                        </tr>
                    `;
                });
            });

            if (rowCount === 0) {
                html += '<tr><td colspan="8" style="text-align: center; color: #999; padding: 40px;">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
            }

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // ä¸€æ‹¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openBulkRemainingModal() {
            updateProgressVersionOptions();
            renderBulkRemainingTable();
            document.getElementById('bulkRemainingModal').style.display = 'flex';
        }

        // ä¸€æ‹¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeBulkRemainingModal() {
            document.getElementById('bulkRemainingModal').style.display = 'none';
        }

        // ä¸€æ‹¬ç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderBulkRemainingTable() {
            const versionFilter = document.getElementById('bulkRemainingVersionFilter')?.value || 'all';
            const tbody = document.getElementById('bulkRemainingTableBody');
            if (!tbody) return;

            // ç‰ˆæ•°ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let targetVersions = versionFilter === 'all'
                ? [...new Set([...estimates.map(e => e.version), ...actuals.map(a => a.version)])]
                    .filter(v => v && v.trim() !== '').sort()
                : [versionFilter];

            let html = '';
            let rowIndex = 0;

            targetVersions.forEach(version => {
                // ã“ã®ç‰ˆæ•°ã®ã‚¿ã‚¹ã‚¯ã¨å·¥ç¨‹ã¨æ‹…å½“è€…ã®çµ„ã¿åˆã‚ã›ã‚’å–å¾—
                const combinations = new Map();

                estimates.filter(e => e.version === version).forEach(e => {
                    const key = `${e.task}|${e.process}|${e.member}`;
                    if (!combinations.has(key)) {
                        combinations.set(key, { version, task: e.task, process: e.process, member: e.member, estimatedHours: 0, actualHours: 0 });
                    }
                    combinations.get(key).estimatedHours += e.hours;
                });

                actuals.filter(a => a.version === version).forEach(a => {
                    const key = `${a.task}|${a.process}|${a.member}`;
                    if (!combinations.has(key)) {
                        combinations.set(key, { version, task: a.task, process: a.process, member: a.member, estimatedHours: 0, actualHours: 0 });
                    }
                    combinations.get(key).actualHours += a.hours;
                });

                // å„çµ„ã¿åˆã‚ã›ã«ã¤ã„ã¦è¡Œã‚’ç”Ÿæˆ
                combinations.forEach((data, key) => {
                    const existing = getRemainingEstimate(data.version, data.task, data.process, data.member);
                    const remainingHours = existing ? existing.remainingHours : '';
                    const eac = data.actualHours + (parseFloat(remainingHours) || 0);

                    // çŠ¶æ…‹åˆ¤å®š
                    let status = 'unknown';
                    let statusLabel = 'æœªè¨­å®š';
                    if (remainingHours !== '' && parseFloat(remainingHours) === 0 && data.actualHours > 0) {
                        status = 'completed';
                        statusLabel = 'å®Œäº†';
                    } else if (data.estimatedHours > 0 && remainingHours !== '') {
                        if (eac <= data.estimatedHours) {
                            status = 'ontrack';
                            statusLabel = 'é †èª¿';
                        } else if (eac <= data.estimatedHours * 1.2) {
                            status = 'warning';
                            statusLabel = 'æ³¨æ„';
                        } else {
                            status = 'exceeded';
                            statusLabel = 'è¶…é';
                        }
                    }

                    html += `
                        <tr data-row-index="${rowIndex}"
                            data-version="${data.version}"
                            data-task="${data.task}"
                            data-process="${data.process}"
                            data-member="${data.member}">
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${data.version}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${data.task}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${data.process}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${data.member}</td>
                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${data.estimatedHours.toFixed(1)}h</td>
                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${data.actualHours.toFixed(1)}h</td>
                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">
                                <input type="number"
                                       class="bulk-remaining-input"
                                       value="${remainingHours}"
                                       step="0.5"
                                       min="0"
                                       placeholder="0"
                                       onchange="updateBulkRowStatus(this)"
                                       style="width: 70px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; text-align: right;">
                            </td>
                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;" class="bulk-eac">
                                ${remainingHours !== '' ? eac.toFixed(1) + 'h' : '-'}
                            </td>
                            <td style="padding: 8px; text-align: center; border-bottom: 1px solid #eee;" class="bulk-status">
                                ${createStatusBadge(status, statusLabel)}
                            </td>
                        </tr>
                    `;
                    rowIndex++;
                });
            });

            if (rowIndex === 0) {
                html = '<tr><td colspan="9" style="text-align: center; color: #999; padding: 40px;">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
            }

            tbody.innerHTML = html;
        }

        // ä¸€æ‹¬ç·¨é›†ã®è¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        function updateBulkRowStatus(input) {
            const row = input.closest('tr');
            const version = row.dataset.version;
            const task = row.dataset.task;
            const process = row.dataset.process;
            const member = row.dataset.member;

            // è¦‹ç©ã¨å®Ÿç¸¾ã‚’å†è¨ˆç®—
            const estimatedHours = estimates
                .filter(e => e.version === version && e.task === task && e.process === process && e.member === member)
                .reduce((sum, e) => sum + e.hours, 0);
            const actualHours = actuals
                .filter(a => a.version === version && a.task === task && a.process === process && a.member === member)
                .reduce((sum, a) => sum + a.hours, 0);

            const remainingHours = parseFloat(input.value);
            const eacCell = row.querySelector('.bulk-eac');
            const statusCell = row.querySelector('.bulk-status');

            if (!isNaN(remainingHours)) {
                const eac = actualHours + remainingHours;
                eacCell.textContent = eac.toFixed(1) + 'h';

                // çŠ¶æ…‹åˆ¤å®š
                let status = 'unknown';
                let statusLabel = 'æœªè¨­å®š';
                if (remainingHours === 0 && actualHours > 0) {
                    status = 'completed';
                    statusLabel = 'å®Œäº†';
                } else if (estimatedHours > 0) {
                    if (eac <= estimatedHours) {
                        status = 'ontrack';
                        statusLabel = 'é †èª¿';
                    } else if (eac <= estimatedHours * 1.2) {
                        status = 'warning';
                        statusLabel = 'æ³¨æ„';
                    } else {
                        status = 'exceeded';
                        statusLabel = 'è¶…é';
                    }
                }
                statusCell.innerHTML = createStatusBadge(status, statusLabel);
            } else {
                eacCell.textContent = '-';
                statusCell.innerHTML = createStatusBadge('unknown', 'æœªè¨­å®š');
            }
        }

        // ä¸€æ‹¬ç·¨é›†ã‚’ä¿å­˜
        function saveBulkRemaining() {
            const rows = document.querySelectorAll('#bulkRemainingTableBody tr[data-row-index]');
            let savedCount = 0;

            rows.forEach(row => {
                const version = row.dataset.version;
                const task = row.dataset.task;
                const process = row.dataset.process;
                const member = row.dataset.member;
                const input = row.querySelector('.bulk-remaining-input');
                const value = input?.value;

                if (value !== '' && !isNaN(parseFloat(value))) {
                    saveRemainingEstimate(version, task, process, member, parseFloat(value));
                    savedCount++;
                }
            });

            saveData();
            closeBulkRemainingModal();
            updateReport();

            alert(`${savedCount}ä»¶ã®è¦‹è¾¼æ®‹å­˜æ™‚é–“ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
        }

        function editEstimate(id) {
            const estimate = estimates.find(e => e.id === id);
            if (!estimate) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            document.getElementById('editEstimateId').value = id;
            document.getElementById('editEstimateVersion').value = estimate.version;
            document.getElementById('editEstimateTaskSearch').value = estimate.task;
            document.getElementById('editEstimateProcess').value = estimate.process;
            document.getElementById('editEstimateHours').value = estimate.hours;
            
            // å¯¾å¿œåãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
            const taskDatalist = document.getElementById('editEstimateTaskList');
            taskDatalist.innerHTML = '';
            const uniqueTasks = [...new Set([...estimates.map(e => e.task), ...actuals.map(a => a.task)])];
            uniqueTasks.sort().forEach(task => {
                const option = document.createElement('option');
                option.value = task;
                taskDatalist.appendChild(option);
            });
            
            // æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
            const memberSelect = document.getElementById('editEstimateMember');
            const allMembers = new Set();
            estimates.forEach(e => allMembers.add(e.member));
            actuals.forEach(a => allMembers.add(a.member));
            
            let sortedMembers;
            const memberOrderInput = document.getElementById('memberOrder').value.trim();
            if (memberOrderInput) {
                const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
                const orderedMembers = [];
                const unorderedMembers = [];
                
                orderList.forEach(name => {
                    if (allMembers.has(name)) {
                        orderedMembers.push(name);
                    }
                });
                
                Array.from(allMembers).forEach(m => {
                    if (!orderedMembers.includes(m)) {
                        unorderedMembers.push(m);
                    }
                });
                
                sortedMembers = [...orderedMembers, ...unorderedMembers.sort()];
            } else {
                sortedMembers = Array.from(allMembers).sort();
            }
            
            memberSelect.innerHTML = '';
            sortedMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                memberSelect.appendChild(option);
            });
            
            memberSelect.value = estimate.member;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('editEstimateModal').style.display = 'flex';
        }

        function closeEditEstimateModal() {
            document.getElementById('editEstimateModal').style.display = 'none';
        }

        function saveEstimateEdit() {
            const id = parseFloat(document.getElementById('editEstimateId').value);
            const version = document.getElementById('editEstimateVersion').value;
            const task = document.getElementById('editEstimateTaskSearch').value;
            const process = document.getElementById('editEstimateProcess').value;
            const member = document.getElementById('editEstimateMember').value;
            const hours = parseFloat(document.getElementById('editEstimateHours').value);
            
            if (!version || !task || !process || !member || !hours) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            const estimateIndex = estimates.findIndex(e => e.id === id);
            if (estimateIndex !== -1) {
                const oldEstimate = estimates[estimateIndex];
                const oldHours = oldEstimate.hours;

                // æœˆåˆ†å‰²è¨­å®šãŒã‚ã‚‹å ´åˆã€æ¯”ç‡ã‚’ç¶­æŒã—ã¦å†è¨ˆç®—
                let updatedMonthlyHours = oldEstimate.monthlyHours;
                if (oldEstimate.monthlyHours && oldHours > 0 && hours !== oldHours) {
                    updatedMonthlyHours = {};
                    const ratio = hours / oldHours;
                    Object.keys(oldEstimate.monthlyHours).forEach(month => {
                        updatedMonthlyHours[month] = Math.round(oldEstimate.monthlyHours[month] * ratio * 10) / 10;
                    });
                }

                estimates[estimateIndex] = {
                    ...estimates[estimateIndex],
                    version: version,
                    task: task,
                    process: process,
                    member: member,
                    hours: hours,
                    monthlyHours: updatedMonthlyHours
                };

                saveData();
                closeEditEstimateModal();
                
                updateMemberOptions();
                updateQuickTaskList();
                renderEstimateList();
                updateReport();
                
                alert('è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            } else {
                alert('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function handleActualTaskSelect() {
            const select = document.getElementById('editActualTaskSelect');
            const input = document.getElementById('editActualTaskSearch');
            const selectedOption = select.options[select.selectedIndex];

            if (select.value === '__NEW__') {
                // æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰
                select.style.display = 'none';
                input.style.display = 'block';
                input.value = '';
                input.focus();
            } else if (select.value) {
                // æ—¢å­˜ã®å¯¾å¿œã‚’é¸æŠ
                const version = selectedOption.getAttribute('data-version');
                const process = selectedOption.getAttribute('data-process');

                if (version) {
                    document.getElementById('editActualVersion').value = version;
                }
                if (process) {
                    document.getElementById('editActualProcess').value = process;
                }
            }
        }

        function handleActualTaskInput() {
            // æ–°è¦å…¥åŠ›æ™‚ã®å‡¦ç†ï¼ˆå°†æ¥çš„ã«æ‹¡å¼µå¯èƒ½ï¼‰
        }

        function handleEstimateTaskInput() {
            // å¯¾å¿œåå…¥åŠ›æ™‚ã®å‡¦ç†ï¼ˆå°†æ¥çš„ã«æ‹¡å¼µå¯èƒ½ï¼‰
        }

        function showMemberOrderHelp() {
            alert('æ‹…å½“è€…ã®è¡¨ç¤ºé †ã‚’æŒ‡å®šã§ãã¾ã™ã€‚\n\nä¾‹:\nA,B,C,D\nå±±ç”°,ä½è—¤,ç”°ä¸­\n\nãƒ»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›\nãƒ»æŒ‡å®šã—ãŸé †ç•ªã§è¡¨ç¤ºã•ã‚Œã¾ã™\nãƒ»æŒ‡å®šã—ã¦ã„ãªã„æ‹…å½“è€…ã¯å¾Œã‚ã«ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã§è¡¨ç¤ºã•ã‚Œã¾ã™');
        }

        function updateAllDisplays() {
            saveData();
            updateMemberOptions();
            renderActualList();
            updateReport();
            alert('è¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸ');
        }
        
        // ãƒ†ãƒ¼ãƒé–¢é€£ã®é–¢æ•°
        function loadThemeSettings() {
            // ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆå„ªå…ˆï¼‰
            const savedSettings = localStorage.getItem('manhour_settings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                if (settings.themeColor) {
                    currentThemeColor = settings.themeColor;
                    document.getElementById('themeColor').value = settings.themeColor;
                }
                if (settings.themePattern) {
                    currentThemePattern = settings.themePattern;
                    document.getElementById('themePattern').value = settings.themePattern;
                }
                if (settings.themeTabColor) {
                    currentTabColor = settings.themeTabColor;
                    document.getElementById('themeTabColor').value = settings.themeTabColor;
                }
                if (settings.themeBackgroundColor) {
                    currentBackgroundColor = settings.themeBackgroundColor;
                    document.getElementById('themeBackgroundColor').value = settings.themeBackgroundColor;
                }
            } else {
                // æ—§å½¢å¼ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
                const savedColor = localStorage.getItem('manhour_themeColor');
                const savedPattern = localStorage.getItem('manhour_themePattern');
                const savedTabColor = localStorage.getItem('manhour_themeTabColor');
                
                if (savedColor) {
                    currentThemeColor = savedColor;
                    document.getElementById('themeColor').value = savedColor;
                }
                
                if (savedPattern) {
                    currentThemePattern = savedPattern;
                    document.getElementById('themePattern').value = savedPattern;
                }
                
                if (savedTabColor) {
                    currentTabColor = savedTabColor;
                    document.getElementById('themeTabColor').value = savedTabColor;
                }
            }
            
            applyTheme();
        }
        
        function applyTheme() {
            const color = document.getElementById('themeColor').value;
            const pattern = document.getElementById('themePattern').value;
            const tabColor = document.getElementById('themeTabColor').value;
            const backgroundColor = document.getElementById('themeBackgroundColor').value;
            
            currentThemeColor = color;
            currentThemePattern = pattern;
            currentTabColor = tabColor;
            currentBackgroundColor = backgroundColor;
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
            updateThemePreview();
            
            // å…¨ã¦ã®è©²å½“è¦ç´ ã«ãƒ†ãƒ¼ãƒã‚’é©ç”¨
            updateThemeElements();
            
            // ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜
            saveData(true); // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ã‚¹ã‚­ãƒƒãƒ—
        }
        
        function updateThemePreview() {
            const preview = document.getElementById('themePreview');
            const colorClass = `theme-${currentThemeColor}`;
            const patternClass = currentThemePattern !== 'none' ? `pattern-${currentThemePattern}` : '';
            
            // æ—¢å­˜ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            preview.className = '';
            preview.classList.add('theme-bg', colorClass);
            if (patternClass) {
                preview.classList.add(patternClass);
            }
        }
        
        function updateThemeElements() {
            // ãƒšãƒ¼ã‚¸å…¨ä½“ã®èƒŒæ™¯
            updateBodyBackground();

            // ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã‚¨ãƒªã‚¢
            const quickInput = document.querySelector('.quick-input');
            if (quickInput) {
                updateElementTheme(quickInput);
            }

            // ãƒ¬ãƒãƒ¼ãƒˆã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
            const summaryCards = document.querySelectorAll('.stats-grid .stat-card');
            summaryCards.forEach(card => updateElementTheme(card));

            // ç‰ˆæ•°ãƒ˜ãƒƒãƒ€ãƒ¼
            const versionHeaders = document.querySelectorAll('.version-header');
            versionHeaders.forEach(header => updateElementTheme(header));

            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                updateElementTheme(activeTab);
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼
            const modalHeaders = document.querySelectorAll('.modal-header');
            modalHeaders.forEach(header => {
                // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ†ãƒ¼ãƒã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                header.className = header.className.replace(/modal-theme-\w+/g, '').trim();
                header.classList.add('modal-header', `modal-theme-${currentThemeColor}`);
            });

            // è¨­å®šã‚¿ãƒ–ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
            updateLayoutToggleButtons();

            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã®è‰²ã‚’æ›´æ–°
            updateSegmentedButtons();

            // è¦‹ç©åˆè¨ˆã‚«ãƒ¼ãƒ‰ã®è‰²ã‚’æ›´æ–°
            const estimateTotalCard = document.getElementById('estimateTotalCard');
            if (estimateTotalCard) {
                const gradients = {
                    'purple': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'deep-blue': 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)',
                    'teal': 'linear-gradient(135deg, #0f766e 0%, #0d9488 100%)',
                    'cyan': 'linear-gradient(135deg, #0891b2 0%, #06b6d4 100%)',
                    'ocean': 'linear-gradient(135deg, #0c4a6e 0%, #075985 100%)',
                    'sky': 'linear-gradient(135deg, #0369a1 0%, #0284c7 100%)',
                    'indigo': 'linear-gradient(135deg, #4338ca 0%, #6366f1 100%)',
                    'navy': 'linear-gradient(135deg, #1e40af 0%, #3b82f6 100%)',
                    'slate': 'linear-gradient(135deg, #334155 0%, #475569 100%)',
                    'green': 'linear-gradient(135deg, #047857 0%, #059669 100%)',
                    'emerald': 'linear-gradient(135deg, #059669 0%, #10b981 100%)'
                };
                estimateTotalCard.style.background = gradients[currentThemeColor] || gradients['purple'];
            }
        }
        
        function updateBodyBackground() {
            const colorGradients = {
                'purple': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'deep-blue': 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)',
                'teal': 'linear-gradient(135deg, #0f766e 0%, #14b8a6 100%)',
                'cyan': 'linear-gradient(135deg, #0891b2 0%, #06b6d4 100%)',
                'ocean': 'linear-gradient(135deg, #0c4a6e 0%, #0284c7 100%)',
                'sky': 'linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%)',
                'indigo': 'linear-gradient(135deg, #4338ca 0%, #6366f1 100%)',
                'navy': 'linear-gradient(135deg, #1e40af 0%, #3b82f6 100%)',
                'slate': 'linear-gradient(135deg, #334155 0%, #475569 100%)',
                'green': 'linear-gradient(135deg, #047857 0%, #10b981 100%)',
                'emerald': 'linear-gradient(135deg, #059669 0%, #34d399 100%)'
            };
            
            // èƒŒæ™¯è‰²ã‚’æ±ºå®šï¼ˆå€‹åˆ¥è¨­å®šãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ï¼‰
            const bgColorToUse = (currentBackgroundColor && currentBackgroundColor !== 'same') 
                ? currentBackgroundColor 
                : currentThemeColor;
            
            const gradient = colorGradients[bgColorToUse] || colorGradients['purple'];
            document.body.style.background = gradient;
        }
        
        function updateElementTheme(element) {
            const isTab = element.classList.contains('tab');
            
            // ã‚¿ãƒ–ã®è‰²ã‚’æ±ºå®š
            let tabColorToUse = currentThemeColor;
            if (isTab) {
                if (currentTabColor === 'same') {
                    tabColorToUse = currentThemeColor;
                } else if (currentTabColor === 'default') {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²ã®å ´åˆã¯ä½•ã‚‚ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ãªã„
                    tabColorToUse = null;
                } else {
                    tabColorToUse = currentTabColor;
                }
            }
            
            const colorClass = isTab && tabColorToUse ? `tab-theme-${tabColorToUse}` : `theme-${currentThemeColor}`;
            const patternClass = !isTab && currentThemePattern !== 'none' ? `pattern-${currentThemePattern}` : '';
            
            // theme-ã§å§‹ã¾ã‚‹ã‚¯ãƒ©ã‚¹ã€tab-theme-ã§å§‹ã¾ã‚‹ã‚¯ãƒ©ã‚¹ã€pattern-ã§å§‹ã¾ã‚‹ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            const classes = Array.from(element.classList);
            classes.forEach(cls => {
                if (cls.startsWith('theme-') || cls.startsWith('pattern-') || cls.startsWith('tab-theme-')) {
                    element.classList.remove(cls);
                }
            });
            
            // æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’é©ç”¨
            if (isTab) {
                // ã‚¿ãƒ–ã®å ´åˆ
                if (tabColorToUse) {
                    // è‰²æŒ‡å®šã‚ã‚Š: tab-theme-ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                    element.classList.add(`tab-theme-${tabColorToUse}`);
                }
                // currentTabColor === 'default'ã®å ´åˆã¯ä½•ã‚‚è¿½åŠ ã—ãªã„ï¼ˆCSSã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒé©ç”¨ã•ã‚Œã‚‹ï¼‰
            } else {
                // ã‚¿ãƒ–ä»¥å¤–: theme-bgã¨è‰²ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
                element.classList.add('theme-bg', colorClass);
                if (patternClass) {
                    element.classList.add(patternClass);
                }
            }
        }

        // è¨­å®šã‚¿ãƒ–ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®è‰²ã‚’æ›´æ–°
        function updateLayoutToggleButtons() {
            const themeColor = getThemeColor();

            // è¦‹ç©ä¸€è¦§ã®ãƒœã‚¿ãƒ³
            const estimateButtons = document.querySelectorAll('#settings button[onclick*="toggleFilterLayout(\'estimate\'"]');
            if (estimateButtons.length >= 2) {
                const estimateCompact = document.getElementById('estimateFiltersCompact');
                const isCompactActive = estimateCompact && estimateCompact.style.display !== 'none';
                estimateButtons[0].style.background = isCompactActive ? themeColor : 'white';
                estimateButtons[0].style.color = isCompactActive ? 'white' : '#333';
                estimateButtons[1].style.background = !isCompactActive ? themeColor : 'white';
                estimateButtons[1].style.color = !isCompactActive ? 'white' : '#333';
            }

            // å®Ÿç¸¾ä¸€è¦§ã®ãƒœã‚¿ãƒ³
            const actualButtons = document.querySelectorAll('#settings button[onclick*="toggleFilterLayout(\'actual\'"]');
            if (actualButtons.length >= 2) {
                const actualCompact = document.getElementById('actualFiltersCompact');
                const isCompactActive = actualCompact && actualCompact.style.display !== 'none';
                actualButtons[0].style.background = isCompactActive ? themeColor : 'white';
                actualButtons[0].style.color = isCompactActive ? 'white' : '#333';
                actualButtons[1].style.background = !isCompactActive ? themeColor : 'white';
                actualButtons[1].style.color = !isCompactActive ? 'white' : '#333';
            }

            // ãƒ¬ãƒãƒ¼ãƒˆã®ãƒœã‚¿ãƒ³
            const reportButtons = document.querySelectorAll('#settings button[onclick*="toggleFilterLayout(\'report\'"]');
            if (reportButtons.length >= 2) {
                const reportCompact = document.getElementById('reportFiltersCompact');
                const isCompactActive = reportCompact && reportCompact.style.display !== 'none';
                reportButtons[0].style.background = isCompactActive ? themeColor : 'white';
                reportButtons[0].style.color = isCompactActive ? 'white' : '#333';
                reportButtons[1].style.background = !isCompactActive ? themeColor : 'white';
                reportButtons[1].style.color = !isCompactActive ? 'white' : '#333';
            }
        }

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã®è‰²ã‚’æ›´æ–°
        function updateSegmentedButtons() {
            const themeColor = getThemeColor();

            // è¦‹ç©ä¸€è¦§ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ï¼ˆè¡¨ç¤ºå½¢å¼ï¼‰
            const btnEstimateGrouped = document.getElementById('btnEstimateGrouped');
            const btnEstimateMatrix = document.getElementById('btnEstimateMatrix');
            const btnEstimateList = document.getElementById('btnEstimateList');
            if (btnEstimateGrouped && btnEstimateMatrix && btnEstimateList) {
                const estimateViewType = document.getElementById('estimateViewType').value;
                btnEstimateGrouped.style.background = estimateViewType === 'grouped' ? themeColor : 'white';
                btnEstimateGrouped.style.color = estimateViewType === 'grouped' ? 'white' : '#333';
                btnEstimateMatrix.style.background = estimateViewType === 'matrix' ? themeColor : 'white';
                btnEstimateMatrix.style.color = estimateViewType === 'matrix' ? 'white' : '#333';
                btnEstimateList.style.background = estimateViewType === 'list' ? themeColor : 'white';
                btnEstimateList.style.color = estimateViewType === 'list' ? 'white' : '#333';
            }

            // è¦‹ç©ä¸€è¦§ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ï¼ˆè¡¨ç¤ºæœˆï¼‰
            const estimateMonthButtons = document.getElementById('estimateMonthButtons2');
            if (estimateMonthButtons) {
                const estimateMonthFilter = document.getElementById('estimateMonthFilter');
                if (estimateMonthFilter) {
                    updateSegmentButtonSelection('estimateMonthButtons2', estimateMonthFilter.value);
                }
            }

            // å®Ÿç¸¾ä¸€è¦§ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ï¼ˆè¡¨ç¤ºå½¢å¼ï¼‰
            const btnActualMatrix = document.getElementById('btnActualMatrix');
            const btnActualList = document.getElementById('btnActualList');
            if (btnActualMatrix && btnActualList) {
                const actualViewType = document.getElementById('actualViewType').value;
                btnActualMatrix.style.background = actualViewType === 'matrix' ? themeColor : 'white';
                btnActualMatrix.style.color = actualViewType === 'matrix' ? 'white' : '#333';
                btnActualList.style.background = actualViewType === 'list' ? themeColor : 'white';
                btnActualList.style.color = actualViewType === 'list' ? 'white' : '#333';
            }

            // å®Ÿç¸¾ä¸€è¦§ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ï¼ˆæ‹…å½“è€…ï¼‰
            const actualMemberButtons = document.getElementById('actualMemberButtons2');
            if (actualMemberButtons) {
                const actualMemberSelect = document.getElementById('actualMemberSelect');
                if (actualMemberSelect) {
                    updateSegmentButtonSelection('actualMemberButtons2', actualMemberSelect.value);
                }
            }

            // å®Ÿç¸¾ä¸€è¦§ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ï¼ˆè¡¨ç¤ºæœŸé–“ï¼‰
            const actualMonthButtons = document.getElementById('actualMonthButtons2');
            if (actualMonthButtons) {
                const actualMonthFilter = document.getElementById('actualMonthFilter');
                if (actualMonthFilter) {
                    updateSegmentButtonSelection('actualMonthButtons2', actualMonthFilter.value);
                }
            }

            // ãƒ¬ãƒãƒ¼ãƒˆã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ï¼ˆè¡¨ç¤ºå½¢å¼ï¼‰
            const btnReportSummary = document.getElementById('btnReportSummary');
            const btnReportGrouped = document.getElementById('btnReportGrouped');
            const btnReportMatrix = document.getElementById('btnReportMatrix');
            if (btnReportSummary && btnReportGrouped && btnReportMatrix) {
                const reportViewType = document.getElementById('reportViewType').value;
                btnReportSummary.style.background = reportViewType === 'summary' ? themeColor : 'white';
                btnReportSummary.style.color = reportViewType === 'summary' ? 'white' : '#333';
                btnReportGrouped.style.background = reportViewType === 'grouped' ? themeColor : 'white';
                btnReportGrouped.style.color = reportViewType === 'grouped' ? 'white' : '#333';
                btnReportMatrix.style.background = reportViewType === 'matrix' ? themeColor : 'white';
                btnReportMatrix.style.color = reportViewType === 'matrix' ? 'white' : '#333';
            }

            // ãƒ¬ãƒãƒ¼ãƒˆã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ï¼ˆè¡¨ç¤ºæœˆï¼‰
            const reportMonthButtons = document.getElementById('reportMonthButtons2');
            if (reportMonthButtons) {
                const reportMonth = document.getElementById('reportMonth');
                if (reportMonth) {
                    updateSegmentButtonSelection('reportMonthButtons2', reportMonth.value);
                }
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
        function handleModalClose(event) {
            const workModal = document.getElementById('workModal');
            const editActualModal = document.getElementById('editActualModal');
            const editEstimateModal = document.getElementById('editEstimateModal');
            const splitEstimateModal = document.getElementById('splitEstimateModal');
            const otherWorkModal = document.getElementById('otherWorkModal');

            if (event.target === workModal) {
                event.stopPropagation();
                event.preventDefault();
                closeWorkModal();
            }
            if (event.target === editActualModal) {
                event.stopPropagation();
                event.preventDefault();
                closeEditActualModal();
            }
            if (event.target === editEstimateModal) {
                event.stopPropagation();
                event.preventDefault();
                closeEditEstimateModal();
            }
            if (event.target === splitEstimateModal) {
                event.stopPropagation();
                event.preventDefault();
                closeSplitEstimateModal();
            }
            if (event.target === otherWorkModal) {
                event.stopPropagation();
                event.preventDefault();
                closeOtherWorkModal();
            }
        }
        
        window.onclick = handleModalClose;
        window.ontouchend = handleModalClose;

        // ä½œæ¥­æœˆå‰²ã‚Šå½“ã¦ãƒ¢ãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹
        function closeWorkMonthAssignmentMode() {
            if (workMonthSelectionMode) {
                const checkbox1 = document.getElementById('workMonthSelectionMode');
                const checkbox2 = document.getElementById('workMonthSelectionMode2');
                if (checkbox1) checkbox1.checked = false;
                if (checkbox2) checkbox2.checked = false;
                toggleWorkMonthSelectionMode();
            }
        }

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆã™ã‚‹æ±ç”¨é–¢æ•°
        function createSegmentButtons(containerId, selectId, items, currentValue, maxItems, onClickHandler) {
            const container = document.getElementById(containerId);
            const select = document.getElementById(selectId);
            const themeColor = getThemeColor();

            if (!container || !select) return;

            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œï¼‰
            container.style.display = 'flex';
            container.style.overflowX = 'auto';
            container.style.gap = '0';
            select.style.display = 'none';
            container.innerHTML = '';

            items.forEach((item, index) => {
                const button = document.createElement('button');
                button.textContent = item.label;
                button.value = item.value;
                button.style.cssText = `
                    padding: 4px 12px;
                    font-size: 12px;
                    border: none;
                    cursor: pointer;
                    transition: all 0.2s;
                    white-space: nowrap;
                    flex-shrink: 0;
                    ${index > 0 ? 'border-left: 1px solid #dee2e6;' : ''}
                `;

                // é¸æŠçŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«
                if (item.value === currentValue) {
                    button.style.background = themeColor;
                    button.style.color = 'white';
                } else {
                    button.style.background = 'white';
                    button.style.color = '#333';
                }

                button.onclick = () => onClickHandler(item.value, containerId);
                container.appendChild(button);
            });
        }

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
        function updateSegmentButtonSelection(containerId, value) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const themeColor = getThemeColor();
            const buttons = container.querySelectorAll('button');
            buttons.forEach(btn => {
                if (btn.value === value) {
                    btn.style.background = themeColor;
                    btn.style.color = 'white';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#333';
                }
            });
        }

        // å®Ÿç¸¾ä¸€è¦§ã®æ‹…å½“è€…é¸æŠãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function handleActualMemberChange(value, containerId) {
            document.getElementById('actualMemberSelect').value = value;
            document.getElementById('actualMemberSelect2').value = value;
            updateSegmentButtonSelection(containerId, value);
            renderActualList();
        }

        // å®Ÿç¸¾ä¸€è¦§ã®æœˆé¸æŠãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function handleActualMonthChange(value, containerId) {
            document.getElementById('actualMonthFilter').value = value;
            document.getElementById('actualMonthFilter2').value = value;
            updateSegmentButtonSelection(containerId, value);
            renderActualList();
        }

        // è¦‹ç©ä¸€è¦§ã®æœˆé¸æŠãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function handleEstimateMonthChange(value, containerId) {
            const filterElement = document.getElementById('estimateMonthFilter');
            if (filterElement) {
                filterElement.value = value;
            }
            updateSegmentButtonSelection(containerId, value);
            renderEstimateList();
        }

        // ãƒ¬ãƒãƒ¼ãƒˆã®æœˆé¸æŠãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function handleReportMonthChange(value, containerId) {
            document.getElementById('reportMonth').value = value;
            document.getElementById('reportMonth2').value = value;
            updateSegmentButtonSelection(containerId, value);
            updateReport();
        }

        // ãƒ¬ãƒãƒ¼ãƒˆã®ç‰ˆæ•°é¸æŠãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function handleReportVersionChange(value, containerId) {
            document.getElementById('reportVersion').value = value;
            const versionSelect2 = document.getElementById('reportVersion2');
            if (versionSelect2) versionSelect2.value = value;
            updateSegmentButtonSelection(containerId, value);
            updateReport();
        }

        // ãƒ¬ãƒãƒ¼ãƒˆã®ãƒ•ã‚£ãƒ«ã‚¿ã‚¿ã‚¤ãƒ—å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆï¼‰
        function handleReportFilterTypeChange() {
            try {
                const filterTypeEl = document.getElementById('reportFilterType');
                if (!filterTypeEl) return;

                const filterType = filterTypeEl.value;
                const monthFilterCompact = document.getElementById('reportMonthFilterCompact');
                const versionFilterCompact = document.getElementById('reportVersionFilterCompact');
                const monthFilterSegmented = document.getElementById('reportMonthFilterSegmented');
                const versionFilterSegmented = document.getElementById('reportVersionFilterSegmented');

                if (filterType === 'month') {
                    if (monthFilterCompact) monthFilterCompact.style.display = 'flex';
                    if (versionFilterCompact) versionFilterCompact.style.display = 'none';
                    if (monthFilterSegmented) monthFilterSegmented.style.display = 'flex';
                    if (versionFilterSegmented) versionFilterSegmented.style.display = 'none';
                } else {
                    if (monthFilterCompact) monthFilterCompact.style.display = 'none';
                    if (versionFilterCompact) versionFilterCompact.style.display = 'flex';
                    if (monthFilterSegmented) monthFilterSegmented.style.display = 'none';
                    if (versionFilterSegmented) versionFilterSegmented.style.display = 'flex';
                }

                // ãƒ•ã‚£ãƒ«ã‚¿ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
                updateFilterTypeButtons(filterType);

                updateReport();
            } catch (e) {
                console.error('handleReportFilterTypeChange error:', e);
            }
        }

        // ãƒ¬ãƒãƒ¼ãƒˆã®ãƒ•ã‚£ãƒ«ã‚¿ã‚¿ã‚¤ãƒ—è¨­å®šï¼ˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆç‰ˆï¼‰
        function setReportFilterType(type) {
            try {
                const filterTypeEl = document.getElementById('reportFilterType');
                if (filterTypeEl) filterTypeEl.value = type;
                handleReportFilterTypeChange();
            } catch (e) {
                console.error('setReportFilterType error:', e);
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ã‚¿ã‚¤ãƒ—ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
        function updateFilterTypeButtons(type) {
            const themeColor = getThemeColor();
            const btnMonth = document.getElementById('btnFilterMonth');
            const btnVersion = document.getElementById('btnFilterVersion');

            if (btnMonth) {
                btnMonth.style.background = type === 'month' ? themeColor : 'white';
                btnMonth.style.color = type === 'month' ? 'white' : '#333';
            }
            if (btnVersion) {
                btnVersion.style.background = type === 'version' ? themeColor : 'white';
                btnVersion.style.color = type === 'version' ? 'white' : '#333';
            }
        }

        // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‹ã‚‰å®Ÿéš›ã®è‰²ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getThemeColor() {
            const themeColors = {
                'purple': '#667eea',
                'deep-blue': '#1e3c72',
                'teal': '#0f766e',
                'cyan': '#0891b2',
                'ocean': '#0c4a6e',
                'sky': '#0369a1',
                'indigo': '#4338ca',
                'navy': '#1e40af',
                'slate': '#334155',
                'green': '#047857',
                'emerald': '#059669'
            };
            return themeColors[currentThemeColor] || '#667eea';
        }

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ç”¨ã®é–¢æ•°ï¼ˆè¦‹ç©ä¸€è¦§ï¼‰
        function setEstimateViewType(type) {
            const viewTypeElement = document.getElementById('estimateViewType');
            if (viewTypeElement) {
                viewTypeElement.value = type;
            }

            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
            const themeColor = getThemeColor();
            const btnGrouped = document.getElementById('btnEstimateGrouped');
            const btnMatrix = document.getElementById('btnEstimateMatrix');
            const btnList = document.getElementById('btnEstimateList');

            if (btnGrouped) {
                btnGrouped.style.background = type === 'grouped' ? themeColor : 'white';
                btnGrouped.style.color = type === 'grouped' ? 'white' : '#333';
            }
            if (btnMatrix) {
                btnMatrix.style.background = type === 'matrix' ? themeColor : 'white';
                btnMatrix.style.color = type === 'matrix' ? 'white' : '#333';
            }
            if (btnList) {
                btnList.style.background = type === 'list' ? themeColor : 'white';
                btnList.style.color = type === 'list' ? 'white' : '#333';
            }

            renderEstimateList();
        }

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ç”¨ã®é–¢æ•°ï¼ˆå®Ÿç¸¾ä¸€è¦§ï¼‰
        function setActualViewType(type) {
            document.getElementById('actualViewType').value = type;
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
            const themeColor = getThemeColor();
            const btnMatrix = document.getElementById('btnActualMatrix');
            const btnList = document.getElementById('btnActualList');
            if (type === 'matrix') {
                btnMatrix.style.background = themeColor;
                btnMatrix.style.color = 'white';
                btnList.style.background = 'white';
                btnList.style.color = '#333';
            } else {
                btnMatrix.style.background = 'white';
                btnMatrix.style.color = '#333';
                btnList.style.background = themeColor;
                btnList.style.color = 'white';
            }
            renderActualList();
        }

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ç”¨ã®é–¢æ•°ï¼ˆãƒ¬ãƒãƒ¼ãƒˆï¼‰
        function setReportViewType(type) {
            document.getElementById('reportViewType').value = type;
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
            const themeColor = getThemeColor();
            const btnSummary = document.getElementById('btnReportSummary');
            const btnGrouped = document.getElementById('btnReportGrouped');
            const btnMatrix = document.getElementById('btnReportMatrix');
            btnSummary.style.background = type === 'summary' ? themeColor : 'white';
            btnSummary.style.color = type === 'summary' ? 'white' : '#333';
            btnGrouped.style.background = type === 'grouped' ? themeColor : 'white';
            btnGrouped.style.color = type === 'grouped' ? 'white' : '#333';
            btnMatrix.style.background = type === 'matrix' ? themeColor : 'white';
            btnMatrix.style.color = type === 'matrix' ? 'white' : '#333';
            updateReport();
        }

        // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®šã‚’é©ç”¨
        function applyLayoutSettings() {
            // è¦‹ç©ä¸€è¦§ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é©ç”¨
            const estimateCompact = document.getElementById('estimateFiltersCompact');
            const estimateSegmented = document.getElementById('estimateFiltersSegmented');
            if (estimateLayout === 'compact') {
                if (estimateCompact) estimateCompact.style.display = 'flex';
                if (estimateSegmented) estimateSegmented.style.display = 'none';
            } else {
                if (estimateCompact) estimateCompact.style.display = 'none';
                if (estimateSegmented) estimateSegmented.style.display = 'block';
            }

            // å®Ÿç¸¾ä¸€è¦§ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é©ç”¨
            const actualCompact = document.getElementById('actualFiltersCompact');
            const actualSegmented = document.getElementById('actualFiltersSegmented');
            if (actualLayout === 'compact') {
                if (actualCompact) actualCompact.style.display = 'flex';
                if (actualSegmented) actualSegmented.style.display = 'none';
            } else {
                if (actualCompact) actualCompact.style.display = 'none';
                if (actualSegmented) actualSegmented.style.display = 'block';
            }

            // ãƒ¬ãƒãƒ¼ãƒˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é©ç”¨
            const reportCompact = document.getElementById('reportFiltersCompact');
            const reportSegmented = document.getElementById('reportFiltersSegmented');
            if (reportLayout === 'compact') {
                if (reportCompact) reportCompact.style.display = 'flex';
                if (reportSegmented) reportSegmented.style.display = 'none';
            } else {
                if (reportCompact) reportCompact.style.display = 'none';
                if (reportSegmented) reportSegmented.style.display = 'block';
            }

            // è¨­å®šã‚¿ãƒ–ã®ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            updateLayoutToggleButtons();
        }

        // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡ã‚Šæ›¿ãˆé–¢æ•°ï¼ˆé–‹ç™º/æ¯”è¼ƒç”¨ï¼‰
        function toggleFilterLayout(page, version) {
            const themeColor = getThemeColor();

            if (page === 'estimate') {
                const compact = document.getElementById('estimateFiltersCompact');
                const segmented = document.getElementById('estimateFiltersSegmented');

                // è¨­å®šã‚¿ãƒ–ã®ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                const settingsButtons = document.querySelectorAll('#settings button[onclick*="toggleFilterLayout(\'estimate\'"]');
                const btnCompact = settingsButtons[0];
                const btnSegmented = settingsButtons[1];

                if (version === 'compact') {
                    compact.style.display = 'flex';
                    segmented.style.display = 'none';
                    btnCompact.style.background = themeColor;
                    btnCompact.style.color = 'white';
                    btnSegmented.style.background = 'white';
                    btnSegmented.style.color = '#333';
                    estimateLayout = 'compact';
                    renderEstimateList();
                } else {
                    const viewType = document.getElementById('estimateViewType').value;
                    setEstimateViewType(viewType);
                    compact.style.display = 'none';
                    segmented.style.display = 'block';
                    btnCompact.style.background = 'white';
                    btnCompact.style.color = '#333';
                    btnSegmented.style.background = themeColor;
                    btnSegmented.style.color = 'white';
                    estimateLayout = 'segmented';
                }
                saveData(true);
            } else if (page === 'actual') {
                const compact = document.getElementById('actualFiltersCompact');
                const segmented = document.getElementById('actualFiltersSegmented');

                // è¨­å®šã‚¿ãƒ–ã®ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                const settingsButtons = document.querySelectorAll('#settings button[onclick*="toggleFilterLayout(\'actual\'"]');
                const btnCompact = settingsButtons[0];
                const btnSegmented = settingsButtons[1];

                if (version === 'compact') {
                    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆâ†’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã¸åˆ‡ã‚Šæ›¿ãˆæ™‚ã€å€¤ã‚’åŒæœŸ
                    document.getElementById('actualViewMode').value = document.getElementById('actualViewMode2').value;
                    document.getElementById('actualMemberSelect').value = document.getElementById('actualMemberSelect2').value;
                    document.getElementById('actualMonthFilter').value = document.getElementById('actualMonthFilter2').value;
                    compact.style.display = 'flex';
                    segmented.style.display = 'none';
                    btnCompact.style.background = themeColor;
                    btnCompact.style.color = 'white';
                    btnSegmented.style.background = 'white';
                    btnSegmented.style.color = '#333';
                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
                    actualLayout = 'compact';
                    // é›†è¨ˆã‚’æ›´æ–°
                    renderActualList();
                } else {
                    // ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆâ†’ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¸åˆ‡ã‚Šæ›¿ãˆæ™‚ã€å€¤ã‚’åŒæœŸ
                    document.getElementById('actualViewMode2').value = document.getElementById('actualViewMode').value;
                    document.getElementById('actualMemberSelect2').value = document.getElementById('actualMemberSelect').value;
                    document.getElementById('actualMonthFilter2').value = document.getElementById('actualMonthFilter').value;
                    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’åŒæœŸï¼ˆsetActualViewTypeå†…ã§renderActualListãŒå‘¼ã°ã‚Œã‚‹ï¼‰
                    const viewType = document.getElementById('actualViewType').value;
                    setActualViewType(viewType);
                    compact.style.display = 'none';
                    segmented.style.display = 'block';
                    btnCompact.style.background = 'white';
                    btnCompact.style.color = '#333';
                    btnSegmented.style.background = themeColor;
                    btnSegmented.style.color = 'white';
                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
                    actualLayout = 'segmented';
                }
                // è¨­å®šã‚’ä¿å­˜
                saveData(true);
            } else if (page === 'report') {
                const compact = document.getElementById('reportFiltersCompact');
                const segmented = document.getElementById('reportFiltersSegmented');

                // è¨­å®šã‚¿ãƒ–ã®ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                const settingsButtons = document.querySelectorAll('#settings button[onclick*="toggleFilterLayout(\'report\'"]');
                const btnCompact = settingsButtons[0];
                const btnSegmented = settingsButtons[1];

                if (version === 'compact') {
                    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆâ†’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã¸åˆ‡ã‚Šæ›¿ãˆæ™‚ã€å€¤ã‚’åŒæœŸ
                    document.getElementById('reportMonth').value = document.getElementById('reportMonth2').value;
                    compact.style.display = 'flex';
                    segmented.style.display = 'none';
                    btnCompact.style.background = themeColor;
                    btnCompact.style.color = 'white';
                    btnSegmented.style.background = 'white';
                    btnSegmented.style.color = '#333';
                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
                    reportLayout = 'compact';
                    // é›†è¨ˆã‚’æ›´æ–°
                    updateReport();
                } else {
                    // ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆâ†’ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¸åˆ‡ã‚Šæ›¿ãˆæ™‚ã€å€¤ã‚’åŒæœŸ
                    document.getElementById('reportMonth2').value = document.getElementById('reportMonth').value;
                    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’åŒæœŸï¼ˆsetReportViewTypeå†…ã§updateReportãŒå‘¼ã°ã‚Œã‚‹ï¼‰
                    const viewType = document.getElementById('reportViewType').value;
                    setReportViewType(viewType);
                    compact.style.display = 'none';
                    segmented.style.display = 'block';
                    btnCompact.style.background = 'white';
                    btnCompact.style.color = '#333';
                    btnSegmented.style.background = themeColor;
                    btnSegmented.style.color = 'white';
                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
                    reportLayout = 'segmented';
                }
                // è¨­å®šã‚’ä¿å­˜
                saveData(true);
            }
        }

        function updateReport() {
            const filterType = document.getElementById('reportFilterType').value;
            const selectedMonth = document.getElementById('reportMonth').value;
            const selectedVersion = document.getElementById('reportVersion').value;
            const viewType = document.getElementById('reportViewType').value;

            let filteredActuals = actuals;
            let filteredEstimates = estimates;

            if (filterType === 'month') {
                // æœˆåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (selectedMonth !== 'all') {
                    // é¸æŠæœˆã®å®Ÿç¸¾ + ãã®æœˆã®ã€Œãã®ä»–ä»˜éšä½œæ¥­ã€ã‚’å«ã‚ã‚‹
                    filteredActuals = actuals.filter(a => {
                        // ãã®ä»–ä»˜éšä½œæ¥­ã¯æ—¥ä»˜ãŒé¸æŠæœˆã®ã‚‚ã®ã‚’å«ã‚ã‚‹
                        if (isOtherWork(a)) {
                            return a.date && a.date.startsWith(selectedMonth);
                        }
                        // é€šå¸¸ã®ä½œæ¥­ã¯æ—¥ä»˜ãŒé¸æŠæœˆã®ã‚‚ã®ã‚’å«ã‚ã‚‹
                        return a.date && a.date.startsWith(selectedMonth);
                    });

                    // è¤‡æ•°æœˆå¯¾å¿œ: workMonthsã«å«ã¾ã‚Œã‚‹è¦‹ç©ã‚’ãƒ•ã‚£ãƒ«ã‚¿
                    filteredEstimates = estimates.filter(e => {
                        const est = normalizeEstimate(e);
                        return est.workMonths.includes(selectedMonth);
                    }).map(e => {
                        // æœˆåˆ¥å·¥æ•°ã‚’ä½¿ç”¨
                        const est = normalizeEstimate(e);
                        return {
                            ...est,
                            hours: est.monthlyHours[selectedMonth] || est.hours
                        };
                    });
                } else {
                    // å…¨æœŸé–“ã®å ´åˆã¯æ­£è¦åŒ–ã®ã¿
                    filteredEstimates = estimates.map(e => normalizeEstimate(e));
                }
            } else {
                // ç‰ˆæ•°åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (selectedVersion !== 'all') {
                    filteredActuals = actuals.filter(a => a.version === selectedVersion);
                    filteredEstimates = estimates.filter(e => e.version === selectedVersion).map(e => normalizeEstimate(e));
                } else {
                    filteredEstimates = estimates.map(e => normalizeEstimate(e));
                }
            }
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ï¼‰
            if (selectedMonth !== 'all') {
                console.log('=== ãƒ¬ãƒãƒ¼ãƒˆé›†è¨ˆãƒ‡ãƒãƒƒã‚° ===');
                console.log('é¸æŠæœˆ:', selectedMonth);
                console.log('å…¨è¦‹ç©æ•°:', estimates.length);
                console.log('ãƒ•ã‚£ãƒ«ã‚¿å¾Œè¦‹ç©æ•°:', filteredEstimates.length);
                console.log('å…¨å®Ÿç¸¾æ•°:', actuals.length);
                console.log('ãƒ•ã‚£ãƒ«ã‚¿å¾Œå®Ÿç¸¾æ•°:', filteredActuals.length);
                
                // ä½œæ¥­äºˆå®šæœˆãŒæœªè¨­å®šã¾ãŸã¯ç©ºæ–‡å­—ã®è¦‹ç©ã‚’ç¢ºèª
                const noWorkMonthEstimates = estimates.filter(e => {
                    const est = normalizeEstimate(e);
                    return est.workMonths.length === 0;
                });
                if (noWorkMonthEstimates.length > 0) {
                    console.log('âš ï¸ ä½œæ¥­äºˆå®šæœˆãŒæœªè¨­å®šã®è¦‹ç©:', noWorkMonthEstimates.length, 'ä»¶');
                    console.log('  ã“ã‚Œã‚‰ã®è¦‹ç©ã¯æœˆåˆ¥é›†è¨ˆã«å«ã¾ã‚Œã¾ã›ã‚“');
                    console.log('  è©³ç´°:', noWorkMonthEstimates.map(e => ({
                        version: e.version,
                        task: e.task,
                        workMonths: normalizeEstimate(e).workMonths
                    })));
                }
                
                // é¸æŠæœˆã¨ã¯ç•°ãªã‚‹ä½œæ¥­äºˆå®šæœˆã®è¦‹ç©ã‚’ç¢ºèª
                const otherMonthEstimates = estimates.filter(e => {
                    const est = normalizeEstimate(e);
                    return est.workMonths.length > 0 && !est.workMonths.includes(selectedMonth);
                });
                if (otherMonthEstimates.length > 0) {
                    console.log('â„¹ï¸ ä»–ã®æœˆã«äºˆå®šã•ã‚Œã¦ã„ã‚‹è¦‹ç©:', otherMonthEstimates.length, 'ä»¶');
                    const monthCounts = {};
                    otherMonthEstimates.forEach(e => {
                        const est = normalizeEstimate(e);
                        est.workMonths.forEach(m => {
                            monthCounts[m] = (monthCounts[m] || 0) + 1;
                        });
                    });
                    console.log('  æœˆåˆ¥å†…è¨³:', monthCounts);
                }
                
                // è¤‡æ•°æœˆè¦‹ç©ã®æƒ…å ±
                const multiMonthEstimates = estimates.filter(e => {
                    const est = normalizeEstimate(e);
                    return est.workMonths.length > 1 && est.workMonths.includes(selectedMonth);
                });
                if (multiMonthEstimates.length > 0) {
                    console.log('ğŸ“… è¤‡æ•°æœˆè¦‹ç©ï¼ˆé¸æŠæœˆã‚’å«ã‚€ï¼‰:', multiMonthEstimates.length, 'ä»¶');
                    multiMonthEstimates.forEach(e => {
                        const est = normalizeEstimate(e);
                        console.log(`  ${est.version} - ${est.task} [${est.process}]:`, est.monthlyHours);
                    });
                }
                
                // é¸æŠæœˆã®å®Ÿç¸¾ãŒã‚ã‚‹ãŒè¦‹ç©ãŒãªã„å¯¾å¿œã‚’ç¢ºèª
                const actualTasks = new Set(filteredActuals.map(a => `${a.version}-${a.task}`));
                const estimateTasks = new Set(filteredEstimates.map(e => `${e.version}-${e.task}`));
                const actualOnlyTasks = [...actualTasks].filter(t => !estimateTasks.has(t));
                if (actualOnlyTasks.length > 0) {
                    console.log('â„¹ï¸ å®Ÿç¸¾ã®ã¿ã§è¦‹ç©ãŒãªã„å¯¾å¿œ:', actualOnlyTasks);
                    console.log('  ç†ç”±: è¦‹ç©ã®ä½œæ¥­äºˆå®šæœˆãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã‹ã€åˆ¥ã®æœˆã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™');
                }
                
                // é¸æŠæœˆã®è¦‹ç©ãŒã‚ã‚‹ãŒå®Ÿç¸¾ãŒãªã„å¯¾å¿œã‚’ç¢ºèª
                const estimateOnlyTasks = [...estimateTasks].filter(t => !actualTasks.has(t));
                if (estimateOnlyTasks.length > 0) {
                    console.log('â„¹ï¸ è¦‹ç©ã®ã¿ã§å®Ÿç¸¾ãŒãªã„å¯¾å¿œ:', estimateOnlyTasks);
                }
            }
            
            // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            const titleElement = document.getElementById('reportPeriodTitle');
            if (filterType === 'month') {
                if (selectedMonth === 'all') {
                    titleElement.textContent = 'å…¨æœŸé–“ã®é›†è¨ˆ';
                } else {
                    const [year, month] = selectedMonth.split('-');
                    titleElement.textContent = `${year}å¹´${parseInt(month)}æœˆã®é›†è¨ˆ`;
                }
            } else {
                if (selectedVersion === 'all') {
                    titleElement.textContent = 'å…¨ç‰ˆæ•°ã®é›†è¨ˆ';
                } else {
                    titleElement.textContent = `${selectedVersion} ã®é›†è¨ˆ`;
                }
            }
            
            const totalEst = filteredEstimates.reduce((sum, e) => sum + e.hours, 0);
            const totalAct = filteredActuals.reduce((sum, a) => sum + a.hours, 0);
            const diff = totalAct - totalEst;
            const rate = totalEst > 0 ? (totalAct / totalEst * 100).toFixed(1) : 0;

            // äººæ—¥ã¨äººæœˆã®è¨ˆç®—ï¼ˆå®Ÿåƒæ—¥æ•°ãƒ™ãƒ¼ã‚¹ï¼‰
            let workingDaysPerMonth = 20; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            if (filterType === 'month' && selectedMonth !== 'all') {
                const [year, month] = selectedMonth.split('-');
                workingDaysPerMonth = getWorkingDays(parseInt(year), parseInt(month));
            }
            const estManDays = (totalEst / 8).toFixed(1);
            const estManMonths = (totalEst / 8 / workingDaysPerMonth).toFixed(2);
            const actManDays = (totalAct / 8).toFixed(1);
            const actManMonths = (totalAct / 8 / workingDaysPerMonth).toFixed(2);

            document.getElementById('totalEstimate').textContent = totalEst.toFixed(1) + 'h';
            document.getElementById('totalActual').textContent = totalAct.toFixed(1) + 'h';
            document.getElementById('totalDiff').textContent = (diff >= 0 ? '+' : '') + diff.toFixed(1) + 'h';
            document.getElementById('actualRate').textContent = rate + '%';
            
            // è£œè¶³æƒ…å ±ã¨ã—ã¦äººæ—¥ãƒ»äººæœˆã‚’è¡¨ç¤º
            document.getElementById('totalEstimateManpower').textContent = `${estManDays}äººæ—¥ / ${estManMonths}äººæœˆ`;
            document.getElementById('totalActualManpower').textContent = `${actManDays}äººæ—¥ / ${actManMonths}äººæœˆ`;

            // ãƒ¬ãƒãƒ¼ãƒˆè©³ç´°ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('reportDetailView').innerHTML = '';

            // åˆ†ææ©Ÿèƒ½ã®è¡¨ç¤º
            renderReportAnalytics(filteredActuals, filteredEstimates, selectedMonth, workingDaysPerMonth);

            // è©³ç´°ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            if (viewType === 'grouped') {
                renderReportGrouped(filteredActuals, filteredEstimates);
            } else if (viewType === 'matrix') {
                renderReportMatrix(filteredActuals, filteredEstimates, selectedMonth);
            }
            // viewTypeãŒnoneã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆåˆ†æãƒ‘ãƒãƒ«ã¯ä¿æŒã•ã‚Œã‚‹ï¼‰

            renderMemberReport(filteredActuals, filteredEstimates);
            renderVersionReport(filteredActuals, filteredEstimates);
            updateProgressReport();
        }

        // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«å¿œã˜ãŸåˆ†æãƒ‘ãƒãƒ«ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—
        function getAnalysisGradients() {
            const gradients = {
                'purple': {
                    phase1: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    phase2: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    phase3: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
                },
                'deep-blue': {
                    phase1: 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)',
                    phase2: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    phase3: 'linear-gradient(135deg, #0891b2 0%, #06b6d4 100%)'
                },
                'teal': {
                    phase1: 'linear-gradient(135deg, #0f766e 0%, #14b8a6 100%)',
                    phase2: 'linear-gradient(135deg, #10b981 0%, #34d399 100%)',
                    phase3: 'linear-gradient(135deg, #06b6d4 0%, #0ea5e9 100%)'
                },
                'cyan': {
                    phase1: 'linear-gradient(135deg, #0891b2 0%, #06b6d4 100%)',
                    phase2: 'linear-gradient(135deg, #14b8a6 0%, #2dd4bf 100%)',
                    phase3: 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)'
                },
                'ocean': {
                    phase1: 'linear-gradient(135deg, #0c4a6e 0%, #0284c7 100%)',
                    phase2: 'linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%)',
                    phase3: 'linear-gradient(135deg, #14b8a6 0%, #34d399 100%)'
                },
                'sky': {
                    phase1: 'linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%)',
                    phase2: 'linear-gradient(135deg, #06b6d4 0%, #22d3ee 100%)',
                    phase3: 'linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%)'
                },
                'indigo': {
                    phase1: 'linear-gradient(135deg, #4338ca 0%, #6366f1 100%)',
                    phase2: 'linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%)',
                    phase3: 'linear-gradient(135deg, #06b6d4 0%, #0ea5e9 100%)'
                },
                'navy': {
                    phase1: 'linear-gradient(135deg, #1e40af 0%, #3b82f6 100%)',
                    phase2: 'linear-gradient(135deg, #6366f1 0%, #818cf8 100%)',
                    phase3: 'linear-gradient(135deg, #14b8a6 0%, #2dd4bf 100%)'
                },
                'slate': {
                    phase1: 'linear-gradient(135deg, #334155 0%, #475569 100%)',
                    phase2: 'linear-gradient(135deg, #64748b 0%, #94a3b8 100%)',
                    phase3: 'linear-gradient(135deg, #0891b2 0%, #06b6d4 100%)'
                },
                'green': {
                    phase1: 'linear-gradient(135deg, #047857 0%, #10b981 100%)',
                    phase2: 'linear-gradient(135deg, #34d399 0%, #6ee7b7 100%)',
                    phase3: 'linear-gradient(135deg, #0891b2 0%, #14b8a6 100%)'
                },
                'emerald': {
                    phase1: 'linear-gradient(135deg, #059669 0%, #10b981 100%)',
                    phase2: 'linear-gradient(135deg, #34d399 0%, #6ee7b7 100%)',
                    phase3: 'linear-gradient(135deg, #06b6d4 0%, #22d3ee 100%)'
                }
            };
            return gradients[currentThemeColor] || gradients['purple'];
        }

        function renderReportAnalytics(filteredActuals, filteredEstimates, selectedMonth, workingDaysPerMonth) {
            const container = document.getElementById('reportDetailView');
            let html = '';

            // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«å¿œã˜ãŸã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—
            const colors = getAnalysisGradients();

            // Phase 1: è¦‹ç©ç²¾åº¦ã¨ç•°å¸¸å€¤è¡¨ç¤º
            if (reportSettings.accuracyEnabled || reportSettings.anomalyEnabled || reportSettings.warningTasksEnabled) {
                html += `<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid #dee2e6;">`;
                html += `<h3 onclick="togglePhaseCollapse('phase1')" style="margin: 0; color: #495057; font-size: 18px; cursor: pointer; display: flex; align-items: center; user-select: none;">`;
                html += `<span id="phase1-arrow" style="margin-right: 10px; font-size: 14px;">${phaseCollapsed.phase1 ? 'â–¶' : 'â–¼'}</span>`;
                html += 'Phase 1: è¦‹ç©ç²¾åº¦åˆ†æ</h3>';
                html += `<div id="phase1-content" style="display: ${phaseCollapsed.phase1 ? 'none' : 'block'}; margin-top: 15px;">`;

                // å·¥ç¨‹åˆ¥ã®ç²¾åº¦è¨ˆç®—
                if (reportSettings.accuracyEnabled) {
                    const processSummary = {};
                    const processOrder = ['UI', 'PG', 'PT', 'IT', 'ST'];

                    filteredEstimates.forEach(e => {
                        const processKey = processOrder.includes(e.process) ? e.process : 'ãã®ä»–';
                        if (!processSummary[processKey]) {
                            processSummary[processKey] = { estimate: 0, actual: 0 };
                        }
                        processSummary[processKey].estimate += e.hours;
                    });

                    filteredActuals.forEach(a => {
                        const processKey = processOrder.includes(a.process) ? a.process : 'ãã®ä»–';
                        if (!processSummary[processKey]) {
                            processSummary[processKey] = { estimate: 0, actual: 0 };
                        }
                        processSummary[processKey].actual += a.hours;
                    });

                    html += '<div style="background: #ffffff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e9ecef;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #495057; font-size: 16px;">å·¥ç¨‹åˆ¥è¦‹ç©ç²¾åº¦</h4>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">';

                    const sortedProcesses = [
                        ...processOrder.filter(p => processSummary[p]),
                        ...(processSummary['ãã®ä»–'] ? ['ãã®ä»–'] : [])
                    ];

                    sortedProcesses.forEach(proc => {
                        const data = processSummary[proc];
                        const accuracy = data.estimate > 0 ? (data.actual / data.estimate * 100).toFixed(1) : 0;
                        const isOverrun = accuracy > 150;
                        const isGood = accuracy >= 80 && accuracy <= 120;

                        html += '<div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #e9ecef;">';
                        html += `<div style="font-weight: 600; margin-bottom: 5px; color: #495057;">${proc}</div>`;
                        html += `<div style="font-size: 20px; font-weight: bold; color: ${isOverrun ? '#dc3545' : isGood ? '#28a745' : '#ffc107'};">${accuracy}%</div>`;
                        html += `<div style="font-size: 12px; color: #6c757d;">${data.estimate.toFixed(1)}h â†’ ${data.actual.toFixed(1)}h</div>`;
                        html += '</div>';
                    });

                    html += '</div></div>';
                }

                // ç•°å¸¸å€¤ã®å¼·èª¿è¡¨ç¤º
                if (reportSettings.anomalyEnabled) {
                    const anomalies = [];
                    const taskSummary = {};

                    filteredEstimates.forEach(e => {
                        const key = `${e.version}-${e.task}-${e.process}`;
                        if (!taskSummary[key]) {
                            taskSummary[key] = { version: e.version, task: e.task, process: e.process, estimate: 0, actual: 0 };
                        }
                        taskSummary[key].estimate += e.hours;
                    });

                    filteredActuals.forEach(a => {
                        const key = `${a.version}-${a.task}-${a.process}`;
                        if (!taskSummary[key]) {
                            taskSummary[key] = { version: a.version, task: a.task, process: a.process, estimate: 0, actual: 0 };
                        }
                        taskSummary[key].actual += a.hours;
                    });

                    Object.values(taskSummary).forEach(task => {
                        const overrun = task.estimate > 0 ? ((task.actual - task.estimate) / task.estimate * 100) : 0;
                        if (overrun > 50) {
                            anomalies.push({ ...task, overrun });
                        }
                    });

                    if (anomalies.length > 0) {
                        anomalies.sort((a, b) => b.overrun - a.overrun);

                        html += '<div style="background: #fff5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #f5c6cb;">';
                        html += '<h4 style="margin: 0 0 10px 0; color: #721c24; font-size: 16px;">ç•°å¸¸å€¤æ¤œå‡ºï¼ˆ50%ä»¥ä¸Šè¶…éï¼‰</h4>';
                        html += `<div style="color: #856404; font-size: 14px; margin-bottom: 10px;">æ¤œå‡ºæ•°: ${anomalies.length}ä»¶</div>`;
                        html += '<div style="max-height: 200px; overflow-y: auto;">';

                        anomalies.slice(0, 10).forEach(anomaly => {
                            html += '<div style="background: #ffffff; padding: 8px; border-radius: 4px; margin-bottom: 5px; font-size: 13px; border: 1px solid #f5c6cb;">';
                            html += `<div style="font-weight: 600; color: #495057;">${anomaly.version} - ${anomaly.task} [${anomaly.process}]</div>`;
                            html += `<div style="color: #495057;">è¦‹ç©: ${anomaly.estimate.toFixed(1)}h â†’ å®Ÿç¸¾: ${anomaly.actual.toFixed(1)}h <span style="color: #dc3545; font-weight: bold;">(+${anomaly.overrun.toFixed(0)}%)</span></div>`;
                            html += '</div>';
                        });

                        if (anomalies.length > 10) {
                            html += `<div style="text-align: center; padding: 5px; color: #6c757d;">ä»– ${anomalies.length - 10}ä»¶...</div>`;
                        }

                        html += '</div></div>';
                    }
                }

                // è­¦å‘Šã‚¿ã‚¹ã‚¯ä¸€è¦§
                if (reportSettings.warningTasksEnabled) {
                    const warnings = [];
                    const taskSummary = {};

                    filteredEstimates.forEach(e => {
                        const key = `${e.version}-${e.task}`;
                        if (!taskSummary[key]) {
                            taskSummary[key] = { version: e.version, task: e.task, estimate: 0, actual: 0, processes: new Set() };
                        }
                        taskSummary[key].estimate += e.hours;
                        taskSummary[key].processes.add(e.process);
                    });

                    filteredActuals.forEach(a => {
                        const key = `${a.version}-${a.task}`;
                        if (!taskSummary[key]) {
                            taskSummary[key] = { version: a.version, task: a.task, estimate: 0, actual: 0, processes: new Set() };
                        }
                        taskSummary[key].actual += a.hours;
                        taskSummary[key].processes.add(a.process);
                    });

                    Object.values(taskSummary).forEach(task => {
                        const overrun = task.estimate > 0 ? ((task.actual - task.estimate) / task.estimate * 100) : 0;
                        if (overrun > 50) {
                            warnings.push({ ...task, overrun, processCount: task.processes.size });
                        }
                    });

                    if (warnings.length > 0) {
                        warnings.sort((a, b) => b.overrun - a.overrun);

                        html += '<div style="background: #ffffff; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">';
                        html += '<h4 style="margin: 0 0 10px 0; color: #495057; font-size: 16px;">è¦æ³¨æ„ã‚¿ã‚¹ã‚¯</h4>';
                        html += '<div style="max-height: 150px; overflow-y: auto;">';

                        warnings.slice(0, 5).forEach((warning, idx) => {
                            html += '<div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 5px; border: 1px solid #e9ecef;">';
                            html += `<div style="font-weight: 600; color: #495057;">#${idx + 1} ${warning.version} - ${warning.task}</div>`;
                            html += `<div style="font-size: 13px; color: #495057;">è¦‹ç©: ${warning.estimate.toFixed(1)}h â†’ å®Ÿç¸¾: ${warning.actual.toFixed(1)}h <span style="color: #dc3545; font-weight: bold;">(+${warning.overrun.toFixed(0)}%)</span></div>`;
                            html += `<div style="font-size: 12px; color: #6c757d;">å·¥ç¨‹æ•°: ${warning.processCount}</div>`;
                            html += '</div>';
                        });

                        html += '</div></div>';
                    }
                }

                html += '</div>'; // close phase1-content
                html += '</div>';
            }

            // Phase 2: ã‚°ãƒ©ãƒ•ã¨æœˆåˆ¥æ¨ç§»
            if (reportSettings.chartEnabled || reportSettings.trendEnabled) {
                html += `<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid #dee2e6;">`;
                html += `<h3 onclick="togglePhaseCollapse('phase2')" style="margin: 0; color: #495057; font-size: 18px; cursor: pointer; display: flex; align-items: center; user-select: none;">`;
                html += `<span id="phase2-arrow" style="margin-right: 10px; font-size: 14px;">${phaseCollapsed.phase2 ? 'â–¶' : 'â–¼'}</span>`;
                html += 'Phase 2: ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«åˆ†æ</h3>';
                html += `<div id="phase2-content" style="display: ${phaseCollapsed.phase2 ? 'none' : 'block'}; margin-top: 15px;">`;

                // å·¥ç¨‹åˆ¥ãƒãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
                if (reportSettings.chartEnabled) {
                    const processSummary = {};
                    const processOrder = ['UI', 'PG', 'PT', 'IT', 'ST'];

                    filteredEstimates.forEach(e => {
                        const processKey = processOrder.includes(e.process) ? e.process : 'ãã®ä»–';
                        if (!processSummary[processKey]) {
                            processSummary[processKey] = { estimate: 0, actual: 0 };
                        }
                        processSummary[processKey].estimate += e.hours;
                    });

                    filteredActuals.forEach(a => {
                        const processKey = processOrder.includes(a.process) ? a.process : 'ãã®ä»–';
                        if (!processSummary[processKey]) {
                            processSummary[processKey] = { estimate: 0, actual: 0 };
                        }
                        processSummary[processKey].actual += a.hours;
                    });

                    const maxHours = Math.max(...Object.values(processSummary).map(p => Math.max(p.estimate, p.actual)));

                    html += '<div style="background: #ffffff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e9ecef;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #495057; font-size: 16px;">å·¥ç¨‹åˆ¥è¦‹ç©vså®Ÿç¸¾</h4>';

                    const sortedProcesses = [
                        ...processOrder.filter(p => processSummary[p]),
                        ...(processSummary['ãã®ä»–'] ? ['ãã®ä»–'] : [])
                    ];

                    sortedProcesses.forEach(proc => {
                        const data = processSummary[proc];
                        const estWidth = (data.estimate / maxHours * 100).toFixed(1);
                        const actWidth = (data.actual / maxHours * 100).toFixed(1);

                        html += '<div style="margin-bottom: 15px;">';
                        html += `<div style="font-weight: 600; margin-bottom: 5px; color: #495057;">${proc}</div>`;
                        html += '<div style="display: grid; grid-template-columns: 60px 1fr; gap: 10px; align-items: center;">';
                        html += '<div style="text-align: right; font-size: 13px; color: #6c757d;">è¦‹ç©</div>';
                        html += `<div style="background: #e9ecef; border-radius: 4px; height: 20px; position: relative;">`;
                        html += `<div style="background: #4dabf7; height: 100%; width: ${estWidth}%; border-radius: 4px; display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; min-width: 30px;">`;
                        html += `<span style="font-size: 12px; font-weight: 600; color: white;">${data.estimate.toFixed(1)}h</span>`;
                        html += '</div></div>';
                        html += '<div style="text-align: right; font-size: 13px; color: #6c757d;">å®Ÿç¸¾</div>';
                        html += `<div style="background: #e9ecef; border-radius: 4px; height: 20px;">`;
                        html += `<div style="background: ${data.actual > data.estimate ? '#dc3545' : '#28a745'}; height: 100%; width: ${actWidth}%; border-radius: 4px; display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; min-width: 30px;">`;
                        html += `<span style="font-size: 12px; font-weight: 600; color: white;">${data.actual.toFixed(1)}h</span>`;
                        html += '</div></div>';
                        html += '</div></div>';
                    });

                    html += '</div>';
                }

                // æœˆåˆ¥æ¨ç§»åˆ†æ
                if (reportSettings.trendEnabled && selectedMonth === 'all') {
                    const monthlyData = {};

                    filteredEstimates.forEach(e => {
                        const est = normalizeEstimate(e);
                        est.workMonths.forEach(month => {
                            if (!monthlyData[month]) {
                                monthlyData[month] = { estimate: 0, actual: 0 };
                            }
                            const monthlyHours = est.monthlyHours[month] || 0;
                            monthlyData[month].estimate += monthlyHours;
                        });
                    });

                    filteredActuals.forEach(a => {
                        const month = a.workMonth;
                        if (!monthlyData[month]) {
                            monthlyData[month] = { estimate: 0, actual: 0 };
                        }
                        monthlyData[month].actual += a.hours;
                    });

                    const sortedMonths = Object.keys(monthlyData).sort();

                    if (sortedMonths.length > 1) {
                        html += '<div style="background: #ffffff; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">';
                        html += '<h4 style="margin: 0 0 10px 0; color: #495057; font-size: 16px;">æœˆåˆ¥æ¨ç§»</h4>';

                        const maxMonthlyHours = Math.max(...Object.values(monthlyData).map(m => Math.max(m.estimate, m.actual)));

                        sortedMonths.slice(-6).forEach(month => {
                            const data = monthlyData[month];
                            const [year, monthNum] = month.split('-');
                            const estWidth = (data.estimate / maxMonthlyHours * 100).toFixed(1);
                            const actWidth = (data.actual / maxMonthlyHours * 100).toFixed(1);
                            const diff = data.actual - data.estimate;

                            html += '<div style="margin-bottom: 12px;">';
                            html += `<div style="font-weight: 600; margin-bottom: 5px; color: #495057;">${year}å¹´${parseInt(monthNum)}æœˆ</div>`;
                            html += '<div style="display: flex; gap: 5px; align-items: center;">';
                            html += `<div style="flex: 1; background: #e9ecef; border-radius: 4px; height: 24px; position: relative;">`;
                            html += `<div style="background: #4dabf7; height: 100%; width: ${estWidth}%; border-radius: 4px;"></div>`;
                            html += '</div>';
                            html += `<div style="flex: 1; background: #e9ecef; border-radius: 4px; height: 24px;">`;
                            html += `<div style="background: ${data.actual > data.estimate ? '#dc3545' : '#28a745'}; height: 100%; width: ${actWidth}%; border-radius: 4px;"></div>`;
                            html += '</div>';
                            html += `<div style="min-width: 80px; text-align: right; font-size: 13px; color: #495057;">${diff > 0 ? '+' : ''}${diff.toFixed(1)}h</div>`;
                            html += '</div></div>';
                        });

                        html += '</div>';
                    }
                }

                html += '</div>'; // close phase2-content
                html += '</div>';
            }

            // Phase 3: æ‹…å½“è€…åˆ¥åˆ†æã¨ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
            if (reportSettings.memberAnalysisEnabled || reportSettings.insightsEnabled) {
                html += `<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid #dee2e6;">`;
                html += `<h3 onclick="togglePhaseCollapse('phase3')" style="margin: 0; color: #495057; font-size: 18px; cursor: pointer; display: flex; align-items: center; user-select: none;">`;
                html += `<span id="phase3-arrow" style="margin-right: 10px; font-size: 14px;">${phaseCollapsed.phase3 ? 'â–¶' : 'â–¼'}</span>`;
                html += 'Phase 3: æ‹…å½“è€…åˆ†æã¨ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h3>';
                html += `<div id="phase3-content" style="display: ${phaseCollapsed.phase3 ? 'none' : 'block'}; margin-top: 15px;">`;

                // æ‹…å½“è€…åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
                if (reportSettings.memberAnalysisEnabled) {
                    const memberSummary = {};

                    filteredEstimates.forEach(e => {
                        if (!memberSummary[e.member]) {
                            memberSummary[e.member] = { estimate: 0, actual: 0, tasks: new Set() };
                        }
                        memberSummary[e.member].estimate += e.hours;
                        memberSummary[e.member].tasks.add(`${e.version}-${e.task}`);
                    });

                    filteredActuals.forEach(a => {
                        if (!memberSummary[a.member]) {
                            memberSummary[a.member] = { estimate: 0, actual: 0, tasks: new Set() };
                        }
                        memberSummary[a.member].actual += a.hours;
                        memberSummary[a.member].tasks.add(`${a.version}-${a.task}`);
                    });

                    const members = Object.keys(memberSummary).sort((a, b) =>
                        memberSummary[b].actual - memberSummary[a].actual
                    );

                    if (members.length > 0) {
                        html += '<div style="background: #ffffff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e9ecef;">';
                        html += '<h4 style="margin: 0 0 10px 0; color: #495057; font-size: 16px;">æ‹…å½“è€…åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h4>';
                        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';

                        members.forEach(member => {
                            const data = memberSummary[member];
                            const accuracy = data.estimate > 0 ? (data.actual / data.estimate * 100).toFixed(1) : 0;
                            const diff = data.actual - data.estimate;
                            const manDays = (data.actual / 8).toFixed(1);

                            html += '<div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #e9ecef;">';
                            html += `<div style="font-weight: 600; margin-bottom: 5px; color: #495057;">${member}</div>`;
                            html += `<div style="font-size: 13px; color: #495057;">å®Ÿç¸¾: ${data.actual.toFixed(1)}h (${manDays}äººæ—¥)</div>`;
                            html += `<div style="font-size: 13px; color: #495057;">ç²¾åº¦: <span style="font-weight: 600;">${accuracy}%</span></div>`;
                            html += `<div style="font-size: 13px; color: #495057;">å·®åˆ†: <span style="color: ${diff > 0 ? '#dc3545' : '#28a745'};">${diff > 0 ? '+' : ''}${diff.toFixed(1)}h</span></div>`;
                            html += `<div style="font-size: 12px; color: #6c757d; margin-top: 5px;">æ‹…å½“ã‚¿ã‚¹ã‚¯: ${data.tasks.size}ä»¶</div>`;
                            html += '</div>';
                        });

                        html += '</div></div>';
                    }
                }

                // AIãƒ©ã‚¤ã‚¯ãªã‚¤ãƒ³ã‚µã‚¤ãƒˆ
                if (reportSettings.insightsEnabled) {
                    const insights = [];

                    // å…¨ä½“ã®ç²¾åº¦ãƒã‚§ãƒƒã‚¯
                    const totalEst = filteredEstimates.reduce((sum, e) => sum + e.hours, 0);
                    const totalAct = filteredActuals.reduce((sum, a) => sum + a.hours, 0);
                    const overallAccuracy = totalEst > 0 ? (totalAct / totalEst * 100) : 0;

                    if (overallAccuracy > 120) {
                        insights.push({
                            type: 'warning',
                            icon: '',
                            title: 'è¦‹ç©ç²¾åº¦ã«èª²é¡Œ',
                            message: `å…¨ä½“ã§è¦‹ç©ã‚’${(overallAccuracy - 100).toFixed(0)}%è¶…éã—ã¦ã„ã¾ã™ã€‚ã‚¿ã‚¹ã‚¯åˆ†è§£ã®è¦‹ç›´ã—ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚`
                        });
                    } else if (overallAccuracy >= 90 && overallAccuracy <= 110) {
                        insights.push({
                            type: 'success',
                            icon: '',
                            title: 'å„ªã‚ŒãŸè¦‹ç©ç²¾åº¦',
                            message: `è¦‹ç©ç²¾åº¦${overallAccuracy.toFixed(1)}%ã§ã€éå¸¸ã«æ­£ç¢ºãªè¦‹ç©ãŒã§ãã¦ã„ã¾ã™ã€‚`
                        });
                    }

                    // æœ€ã‚‚åŠ¹ç‡çš„ãªå·¥ç¨‹
                    const processSummary = {};
                    filteredEstimates.forEach(e => {
                        if (!processSummary[e.process]) processSummary[e.process] = { estimate: 0, actual: 0 };
                        processSummary[e.process].estimate += e.hours;
                    });
                    filteredActuals.forEach(a => {
                        if (!processSummary[a.process]) processSummary[a.process] = { estimate: 0, actual: 0 };
                        processSummary[a.process].actual += a.hours;
                    });

                    let bestProcess = null;
                    let bestAccuracy = 1000;
                    Object.entries(processSummary).forEach(([proc, data]) => {
                        if (data.estimate > 0) {
                            const accuracy = Math.abs(100 - (data.actual / data.estimate * 100));
                            if (accuracy < bestAccuracy) {
                                bestAccuracy = accuracy;
                                bestProcess = proc;
                            }
                        }
                    });

                    if (bestProcess) {
                        insights.push({
                            type: 'info',
                            icon: '',
                            title: 'æœ€é©ãªå·¥ç¨‹',
                            message: `${bestProcess}å·¥ç¨‹ã®è¦‹ç©ç²¾åº¦ãŒæœ€ã‚‚é«˜ãã€è¨ˆç”»é€šã‚Šã«é€²è¡Œã—ã¦ã„ã¾ã™ã€‚`
                        });
                    }

                    // æ‹…å½“è€…ã®è² è·ãƒã‚§ãƒƒã‚¯
                    const memberSummary = {};
                    filteredActuals.forEach(a => {
                        if (!memberSummary[a.member]) memberSummary[a.member] = 0;
                        memberSummary[a.member] += a.hours;
                    });

                    const maxMember = Object.entries(memberSummary).sort((a, b) => b[1] - a[1])[0];
                    if (maxMember && selectedMonth !== 'all') {
                        const manDays = (maxMember[1] / 8).toFixed(1);
                        const manMonths = (maxMember[1] / 8 / workingDaysPerMonth).toFixed(2);
                        if (manMonths > 1.2) {
                            insights.push({
                                type: 'warning',
                                icon: '',
                                title: 'é«˜è² è·æ‹…å½“è€…ã‚ã‚Š',
                                message: `${maxMember[0]}ã•ã‚“ã®ä½œæ¥­é‡ãŒ${manMonths}äººæœˆï¼ˆ${manDays}äººæ—¥ï¼‰ã§ã€ãƒªã‚½ãƒ¼ã‚¹é…åˆ†ã®è¦‹ç›´ã—ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`
                            });
                        }
                    }

                    // ã‚¿ã‚¹ã‚¯å®Œäº†ç‡
                    const estimatedTasks = new Set(filteredEstimates.map(e => `${e.version}-${e.task}`));
                    const actualTasks = new Set(filteredActuals.map(a => `${a.version}-${a.task}`));
                    const completedTasks = [...estimatedTasks].filter(t => actualTasks.has(t));
                    const completionRate = estimatedTasks.size > 0 ? (completedTasks.length / estimatedTasks.size * 100).toFixed(0) : 0;

                    if (completionRate < 100 && selectedMonth !== 'all') {
                        const pendingCount = estimatedTasks.size - completedTasks.length;
                        insights.push({
                            type: 'info',
                            icon: '',
                            title: 'æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚ã‚Š',
                            message: `è¦‹ç©æ¸ˆã¿ã‚¿ã‚¹ã‚¯ã®ã†ã¡${pendingCount}ä»¶ãŒæœªå®Œäº†ã§ã™ã€‚é€²æ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
                        });
                    }

                    if (insights.length > 0) {
                        html += '<div style="background: #ffffff; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">';
                        html += '<h4 style="margin: 0 0 10px 0; color: #495057; font-size: 16px;">ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h4>';

                        insights.forEach(insight => {
                            const bgColor = insight.type === 'warning' ? '#fff5f5' :
                                          insight.type === 'success' ? '#d4edda' :
                                          '#cce5ff';
                            const borderColor = insight.type === 'warning' ? '#f5c6cb' :
                                          insight.type === 'success' ? '#c3e6cb' :
                                          '#b8daff';
                            const textColor = insight.type === 'warning' ? '#721c24' :
                                          insight.type === 'success' ? '#155724' :
                                          '#004085';

                            html += `<div style="background: ${bgColor}; padding: 12px; border-radius: 6px; margin-bottom: 8px; border: 1px solid ${borderColor};">`;
                            html += `<div style="font-weight: 600; margin-bottom: 3px; color: ${textColor};">${insight.title}</div>`;
                            html += `<div style="font-size: 13px; color: ${textColor};">${insight.message}</div>`;
                            html += '</div>';
                        });

                        html += '</div>';
                    }
                }

                html += '</div>'; // close phase3-content
                html += '</div>';
            }

            container.innerHTML += html;
        }

        function renderReportGrouped(filteredActuals, filteredEstimates) {
            const container = document.getElementById('reportDetailView');

            // é¸æŠæœˆã®å®Ÿåƒæ—¥æ•°ã‚’å–å¾—
            const selectedMonth = document.getElementById('reportMonth').value;
            let workingDaysPerMonth = 20; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            if (selectedMonth !== 'all') {
                const [year, month] = selectedMonth.split('-');
                workingDaysPerMonth = getWorkingDays(parseInt(year), parseInt(month));
            }

            // ç‰ˆæ•°ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const versionGroups = {};
            
            // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿ï¼‰
            filteredEstimates.forEach(e => {
                // ç‰ˆæ•°ã¾ãŸã¯å¯¾å¿œåãŒæœªè¨­å®šã®å ´åˆã¯ã€Œãã®ä»–ä»˜éšä½œæ¥­ã€ã¨ã—ã¦æ‰±ã†
                let version, taskKey;
                if (isOtherWork(e)) {
                    version = 'ãã®ä»–ä»˜éšä½œæ¥­';
                    taskKey = e.task && e.task.trim() !== '' ? e.task : 'æœªåˆ†é¡ä½œæ¥­';
                } else {
                    version = e.version;
                    taskKey = e.task;
                }

                if (!versionGroups[version]) {
                    versionGroups[version] = {};
                }
                if (!versionGroups[version][taskKey]) {
                    versionGroups[version][taskKey] = {
                        task: taskKey,
                        estimates: {},
                        actuals: {}
                    };
                }
                if (!versionGroups[version][taskKey].estimates[e.process]) {
                    versionGroups[version][taskKey].estimates[e.process] = { members: new Set(), hours: 0 };
                }
                versionGroups[version][taskKey].estimates[e.process].members.add(e.member);
                versionGroups[version][taskKey].estimates[e.process].hours += e.hours;
            });
            
            // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆæ‹…å½“è€…ã‚‚é›†è¨ˆï¼‰
            filteredActuals.forEach(a => {
                // ç‰ˆæ•°ã¾ãŸã¯å¯¾å¿œåãŒæœªè¨­å®šã®å ´åˆã¯ã€Œãã®ä»–ä»˜éšä½œæ¥­ã€ã¨ã—ã¦æ‰±ã†
                let version, taskKey;
                if (isOtherWork(a)) {
                    version = 'ãã®ä»–ä»˜éšä½œæ¥­';
                    taskKey = a.task && a.task.trim() !== '' ? a.task : 'æœªåˆ†é¡ä½œæ¥­';
                } else {
                    version = a.version;
                    taskKey = a.task;
                }

                if (!versionGroups[version]) {
                    versionGroups[version] = {};
                }
                if (!versionGroups[version][taskKey]) {
                    versionGroups[version][taskKey] = {
                        task: taskKey,
                        estimates: {},
                        actuals: {}
                    };
                }
                if (!versionGroups[version][taskKey].actuals[a.process]) {
                    versionGroups[version][taskKey].actuals[a.process] = { members: new Set(), hours: 0 };
                }
                versionGroups[version][taskKey].actuals[a.process].members.add(a.member);
                versionGroups[version][taskKey].actuals[a.process].hours += a.hours;
            });
            
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
            if (Object.keys(versionGroups).length === 0) {
                container.innerHTML += '<p style="color: #999; text-align: center; padding: 40px;">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            let html = '<h3 style="margin-top: 30px;">å¯¾å¿œåˆ¥è©³ç´°ï¼ˆè¦‹ç© vs å®Ÿç¸¾ï¼‰</h3>';
            html += '<div style="margin-bottom: 30px;">';

            // ç‰ˆæ•°ã”ã¨ã«è¡¨ç¤ºï¼ˆã€Œãã®ä»–ä»˜éšä½œæ¥­ã€ã‚’æœ€å¾Œã«ï¼‰
            const versions = Object.keys(versionGroups).sort((a, b) => {
                if (a === 'ãã®ä»–ä»˜éšä½œæ¥­') return 1;
                if (b === 'ãã®ä»–ä»˜éšä½œæ¥­') return -1;
                return a.localeCompare(b);
            });

            versions.forEach(version => {
                // å…ˆã«ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ã‚’ç”Ÿæˆã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                let tableBody = '';
                let versionTotalEst = 0;
                let versionTotalAct = 0;

                Object.values(versionGroups[version]).forEach(taskGroup => {
                    const processOrder = ['UI', 'PG', 'PT', 'IT', 'ST'];
                    const allProcesses = new Set([...Object.keys(taskGroup.estimates), ...Object.keys(taskGroup.actuals)]);

                    // processOrderã«å«ã¾ã‚Œã‚‹å·¥ç¨‹ã‚’å…ˆã«ã€ãã®å¾Œã«å«ã¾ã‚Œãªã„å·¥ç¨‹ã‚’è¿½åŠ 
                    const sortedProcesses = [
                        ...processOrder.filter(p => allProcesses.has(p)),
                        ...[...allProcesses].filter(p => !processOrder.includes(p))
                    ];

                    if (sortedProcesses.length === 0) return;
                    
                    // å…ˆã«åˆè¨ˆã‚’è¨ˆç®—
                    let totalEst = 0;
                    let totalAct = 0;
                    sortedProcesses.forEach(proc => {
                        const est = taskGroup.estimates[proc] || { members: new Set(), hours: 0 };
                        const act = taskGroup.actuals[proc] || { members: new Set(), hours: 0 };
                        totalEst += est.hours;
                        totalAct += act.hours;
                    });
                    const totalDiff = totalAct - totalEst;

                    // ç‰ˆæ•°ã®åˆè¨ˆã«åŠ ç®—
                    versionTotalEst += totalEst;
                    versionTotalAct += totalAct;
                    
                    // è¡Œã‚’è¡¨ç¤º
                    sortedProcesses.forEach((proc, index) => {
                        const est = taskGroup.estimates[proc] || { members: new Set(), hours: 0 };
                        const act = taskGroup.actuals[proc] || { members: new Set(), hours: 0 };
                        const diff = act.hours - est.hours;

                        // å®Ÿç¸¾ãƒ™ãƒ¼ã‚¹ã§æ‹…å½“è€…ã‚’è¡¨ç¤ºï¼ˆå®Ÿç¸¾ãŒãªã‘ã‚Œã°è¦‹ç©ï¼‰
                        let memberDisplay = '-';
                        if (act.members.size > 0) {
                            memberDisplay = Array.from(act.members).join(',');
                        } else if (est.members.size > 0) {
                            memberDisplay = Array.from(est.members).join(',');
                        }

                        tableBody += '<tr>';
                        if (index === 0) {
                            // å¯¾å¿œåã‚’ã€Œï¼šã€ï¼ˆå…¨è§’ã‚³ãƒ­ãƒ³ï¼‰ã§åˆ†å‰²ã—ã¦2è¡Œè¡¨ç¤º
                            let taskDisplayHtml = taskGroup.task;
                            if (taskGroup.task.includes('ï¼š')) {
                                const parts = taskGroup.task.split('ï¼š');
                                const restPart = parts.slice(1).join('ï¼š');
                                taskDisplayHtml = `${parts[0]}<br><span style="font-size: 13px; font-weight: normal;">${restPart}</span>`;
                            }
                            tableBody += `<td rowspan="${sortedProcesses.length}" style="vertical-align: top; padding-top: 12px; font-weight: 600;">${taskDisplayHtml}</td>`;
                        }
                        tableBody += `<td><span class="badge badge-${proc.toLowerCase()}">${proc}</span></td>`;
                        tableBody += `<td style="word-break: break-word;">${memberDisplay}</td>`;
                        tableBody += `<td style="text-align: right;">${est.hours > 0 ? est.hours.toFixed(1) + 'h' : '-'}</td>`;
                        tableBody += `<td style="text-align: right;">${act.hours > 0 ? act.hours.toFixed(1) + 'h' : '-'}</td>`;
                        tableBody += `<td style="text-align: right; color: ${diff > 0 ? '#e74c3c' : diff < 0 ? '#27ae60' : '#666'}">${diff !== 0 ? (diff > 0 ? '+' : '') + diff.toFixed(1) + 'h' : '-'}</td>`;
                        if (index === 0) {
                            tableBody += `<td rowspan="${sortedProcesses.length}" style="vertical-align: top; padding-top: 12px; text-align: right;">
                                <div style="font-weight: 600;">è¦‹ç©: ${totalEst.toFixed(1)}h</div>
                                <div style="font-weight: 600;">å®Ÿç¸¾: ${totalAct.toFixed(1)}h</div>
                                <div style="font-weight: 700; color: ${totalDiff > 0 ? '#e74c3c' : totalDiff < 0 ? '#27ae60' : '#666'}">å·®ç•°: ${totalDiff > 0 ? '+' : ''}${totalDiff.toFixed(1)}h</div>
                            </td>`;
                        }
                        tableBody += '</tr>';
                    });
                });

                // ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º
                if (tableBody) {
                    const versionTotalDiff = versionTotalAct - versionTotalEst;

                    html += `<div style="margin-bottom: 30px;">`;
                    html += `<h3 class="version-header theme-bg theme-${currentThemeColor}" style="color: white; padding: 12px 20px; border-radius: 8px; margin: 0 0 15px 0; font-size: 18px;">${version}</h3>`;
                    html += '<div class="table-wrapper"><table>';
                    html += '<tr><th style="min-width: 150px;">å¯¾å¿œå</th><th style="min-width: 80px;">å·¥ç¨‹</th><th style="min-width: 80px;">æ‹…å½“</th><th style="min-width: 80px;">è¦‹ç©</th><th style="min-width: 80px;">å®Ÿç¸¾</th><th style="min-width: 80px;">å·®ç•°</th><th style="min-width: 100px;">å¯¾å¿œåˆè¨ˆ</th></tr>';
                    html += tableBody;

                    // åˆè¨ˆè¡Œã‚’è¿½åŠ 
                    html += '<tr style="background: #f5f5f5; font-weight: bold; border-top: 2px solid #ddd;">';
                    html += `<td style="padding: 12px; position: sticky; left: 0; background: #f5f5f5; z-index: 1;">åˆè¨ˆ</td>`;
                    html += '<td></td>';
                    html += '<td></td>';
                    html += `<td style="text-align: right;">${versionTotalEst.toFixed(1)}h</td>`;
                    html += `<td style="text-align: right;">${versionTotalAct.toFixed(1)}h</td>`;
                    html += `<td style="text-align: right; color: ${versionTotalDiff > 0 ? '#e74c3c' : versionTotalDiff < 0 ? '#27ae60' : '#666'}">${versionTotalDiff > 0 ? '+' : ''}${versionTotalDiff.toFixed(1)}h</td>`;
                    html += '<td></td>';
                    html += '</tr>';

                    html += '</table></div>';
                    html += '</div>';
                }
            });

            html += '</div>';
            container.innerHTML += html;
        }

        function renderReportMatrix(filteredActuals, filteredEstimates, selectedMonth) {
            const container = document.getElementById('reportDetailView');

            // å…¨æœŸé–“ã‹ã¤è¨­å®šãŒã‚ªãƒ³ã®æ™‚ã®ã¿è‰²ä»˜ã‘ã™ã‚‹
            const showMonthColors = selectedMonth === 'all' && showMonthColorsSetting;

            // ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æœˆã‚’åé›†ï¼ˆå‡¡ä¾‹ç”¨ï¼‰
            const usedMonths = new Set();

            // ç‰ˆæ•°ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const versionGroups = {};

            // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿ï¼‰
            filteredEstimates.forEach(e => {
                // ç‰ˆæ•°ã¾ãŸã¯å¯¾å¿œåãŒæœªè¨­å®šã®å ´åˆã¯ã€Œãã®ä»–ä»˜éšä½œæ¥­ã€ã¨ã—ã¦æ‰±ã†
                let version, taskKey;
                if (isOtherWork(e)) {
                    version = 'ãã®ä»–ä»˜éšä½œæ¥­';
                    taskKey = e.task && e.task.trim() !== '' ? e.task : 'æœªåˆ†é¡ä½œæ¥­';
                } else {
                    version = e.version;
                    taskKey = e.task;
                }

                if (!versionGroups[version]) {
                    versionGroups[version] = {};
                }
                if (!versionGroups[version][taskKey]) {
                    versionGroups[version][taskKey] = {
                        task: taskKey,
                        estimates: {},
                        actuals: {}
                    };
                }

                // æ­£è¦åŒ–ã—ã¦workMonthsã‚’å–å¾—
                const est = normalizeEstimate(e);
                if (est.workMonths && est.workMonths.length > 0) {
                    est.workMonths.forEach(m => usedMonths.add(m));
                }

                versionGroups[version][taskKey].estimates[e.process] = {
                    member: e.member,
                    hours: e.hours,
                    workMonths: est.workMonths || []
                };
            });
            
            // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            filteredActuals.forEach(a => {
                // ç‰ˆæ•°ã¾ãŸã¯å¯¾å¿œåãŒæœªè¨­å®šã®å ´åˆã¯ã€Œãã®ä»–ä»˜éšä½œæ¥­ã€ã¨ã—ã¦æ‰±ã†
                let version, taskKey;
                if (isOtherWork(a)) {
                    version = 'ãã®ä»–ä»˜éšä½œæ¥­';
                    taskKey = a.task && a.task.trim() !== '' ? a.task : 'æœªåˆ†é¡ä½œæ¥­';
                } else {
                    version = a.version;
                    taskKey = a.task;
                }

                if (!versionGroups[version]) {
                    versionGroups[version] = {};
                }
                if (!versionGroups[version][taskKey]) {
                    versionGroups[version][taskKey] = {
                        task: taskKey,
                        estimates: {},
                        actuals: {}
                    };
                }
                if (!versionGroups[version][taskKey].actuals[a.process]) {
                    versionGroups[version][taskKey].actuals[a.process] = { member: a.member, hours: 0 };
                }
                versionGroups[version][taskKey].actuals[a.process].hours += a.hours;
            });
            
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
            if (Object.keys(versionGroups).length === 0) {
                container.innerHTML += '<p style="color: #999; text-align: center; padding: 40px;">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            const processOrder = ['UI', 'PG', 'PT', 'IT', 'ST'];

            let html = '<h3 style="margin-top: 30px;">å¯¾å¿œåˆ¥ãƒãƒˆãƒªã‚¯ã‚¹ï¼ˆè¦‹ç© vs å®Ÿç¸¾ï¼‰</h3>';

            // æœˆã‚«ãƒ©ãƒ¼å‡¡ä¾‹ã‚’è¿½åŠ ï¼ˆå…¨æœŸé–“ã®æ™‚ã®ã¿ï¼‰
            if (showMonthColors) {
                html += generateMonthColorLegend(usedMonths);
            }

            html += '<div style="margin-bottom: 30px;">';

            // ç‰ˆæ•°ã”ã¨ã«è¡¨ç¤ºï¼ˆã€Œãã®ä»–ä»˜éšä½œæ¥­ã€ã‚’æœ€å¾Œã«ï¼‰
            const versions = Object.keys(versionGroups).sort((a, b) => {
                if (a === 'ãã®ä»–ä»˜éšä½œæ¥­') return 1;
                if (b === 'ãã®ä»–ä»˜éšä½œæ¥­') return -1;
                return a.localeCompare(b);
            });

            versions.forEach(version => {
                // ã“ã®ç‰ˆæ•°ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®å…¨å·¥ç¨‹ã‚’åé›†
                const versionProcesses = new Set();
                Object.values(versionGroups[version]).forEach(taskGroup => {
                    Object.keys(taskGroup.estimates).forEach(p => versionProcesses.add(p));
                    Object.keys(taskGroup.actuals).forEach(p => versionProcesses.add(p));
                });

                // processOrderã«å«ã¾ã‚Œã‚‹å·¥ç¨‹ã‚’å…ˆã«ã€ãã®å¾Œã«å«ã¾ã‚Œãªã„å·¥ç¨‹ã‚’è¿½åŠ 
                const displayProcesses = [
                    ...processOrder.filter(p => versionProcesses.has(p)),
                    ...[...versionProcesses].filter(p => !processOrder.includes(p))
                ];

                // å…ˆã«ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ã‚’ç”Ÿæˆã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                let tableBody = '';
                let versionTotalEst = 0;
                let versionTotalAct = 0;

                Object.values(versionGroups[version]).forEach(taskGroup => {
                    // å…¨å·¥ç¨‹ã‚’å–å¾—
                    const allProcesses = new Set([...Object.keys(taskGroup.estimates), ...Object.keys(taskGroup.actuals)]);

                    let totalEst = 0;
                    let totalAct = 0;

                    // å…ˆã«åˆè¨ˆã‚’è¨ˆç®—ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®æœ‰ç„¡ã‚’ç¢ºèª
                    displayProcesses.forEach(proc => {
                        const est = taskGroup.estimates[proc] || { member: '-', hours: 0 };
                        const act = taskGroup.actuals[proc] || { member: '-', hours: 0 };
                        totalEst += est.hours;
                        totalAct += act.hours;
                    });

                    // è¦‹ç©ã¾ãŸã¯å®Ÿç¸¾ã®ã„ãšã‚Œã‹ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿è¡Œã‚’è¿½åŠ 
                    if (totalEst > 0 || totalAct > 0) {
                        // ç‰ˆæ•°ã®åˆè¨ˆã«åŠ ç®—
                        versionTotalEst += totalEst;
                        versionTotalAct += totalAct;

                        // å¯¾å¿œåã‚’ã€Œï¼šã€ï¼ˆå…¨è§’ã‚³ãƒ­ãƒ³ï¼‰ã§åˆ†å‰²ã—ã¦2è¡Œè¡¨ç¤º
                        let taskDisplayHtml = taskGroup.task;
                        if (taskGroup.task.includes('ï¼š')) {
                            const parts = taskGroup.task.split('ï¼š');
                            const restPart = parts.slice(1).join('ï¼š');
                            taskDisplayHtml = `${parts[0]}<br><span style="font-size: 13px; font-weight: normal;">${restPart}</span>`;
                        }

                        tableBody += '<tr>';
                        tableBody += `<td style="font-weight: 600;">${taskDisplayHtml}</td>`;

                        displayProcesses.forEach(proc => {
                            const est = taskGroup.estimates[proc] || { member: '-', hours: 0, workMonths: [] };
                            const act = taskGroup.actuals[proc] || { member: '-', hours: 0 };

                            if (est.hours > 0 || act.hours > 0) {
                                const diff = act.hours - est.hours;

                                // å…¨æœŸé–“ã®æ™‚ã®ã¿æœˆã«åŸºã¥ãèƒŒæ™¯è‰²ã‚’é©ç”¨
                                const monthColor = showMonthColors ? getMonthColor(est.workMonths || []) : { bg: '', tooltip: '' };
                                const bgStyle = showMonthColors ? `background: ${monthColor.bg};` : '';

                                tableBody += `<td style="text-align: center; ${bgStyle}" ${showMonthColors ? `title="${monthColor.tooltip}"` : ''}>
                                    <div style="font-weight: 600;">${est.hours > 0 ? est.hours.toFixed(1) : '-'} / ${act.hours > 0 ? act.hours.toFixed(1) : '-'}</div>
                                    <div style="font-size: 11px; color: #666;">(${est.member !== '-' ? est.member : act.member})</div>
                                    <div style="font-size: 11px; color: ${diff > 0 ? '#e74c3c' : diff < 0 ? '#27ae60' : '#666'}">${diff !== 0 ? (diff > 0 ? '+' : '') + diff.toFixed(1) : '-'}</div>
                                </td>`;
                            } else {
                                tableBody += `<td style="text-align: center; color: #ccc;">-</td>`;
                            }
                        });

                        const totalDiff = totalAct - totalEst;
                        // äººæ—¥ãƒ»äººæœˆã‚’è¨ˆç®—ï¼ˆè¦‹ç©ãƒ™ãƒ¼ã‚¹ï¼‰
                        const estDays = totalEst / 8;
                        const estMonths = estDays / 20;

                        tableBody += `<td style="text-align: center;">
                            <div style="font-weight: 700;">${totalEst.toFixed(1)} / ${totalAct.toFixed(1)}</div>
                            <div style="font-size: 10px; color: #666;">${estDays.toFixed(1)}äººæ—¥ / ${estMonths.toFixed(2)}äººæœˆ</div>
                            <div style="font-weight: 700; color: ${totalDiff > 0 ? '#e74c3c' : totalDiff < 0 ? '#27ae60' : '#666'}">${totalDiff > 0 ? '+' : ''}${totalDiff.toFixed(1)}</div>
                        </td>`;
                        tableBody += '</tr>';
                    }
                });

                // ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º
                if (tableBody) {
                    const versionTotalDiff = versionTotalAct - versionTotalEst;

                    html += `<div style="margin-bottom: 30px;">`;
                    html += `<h3 class="version-header theme-bg theme-${currentThemeColor}" style="color: white; padding: 12px 20px; border-radius: 8px; margin: 0 0 15px 0; font-size: 18px;">${version}</h3>`;
                    html += '<div class="table-wrapper"><table>';
                    html += '<tr><th style="min-width: 200px;">å¯¾å¿œå</th>';
                    displayProcesses.forEach(proc => {
                        html += `<th style="min-width: 120px; text-align: center;">${proc}<br><small style="font-weight: normal; opacity: 0.8;">è¦‹ç©/å®Ÿç¸¾</small></th>`;
                    });
                    html += '<th style="min-width: 100px; text-align: center;">åˆè¨ˆ<br><small style="font-weight: normal; opacity: 0.8;">è¦‹ç©/å®Ÿç¸¾</small></th></tr>';
                    html += tableBody;

                    // åˆè¨ˆè¡Œã‚’è¿½åŠ 
                    html += '<tr style="background: #f5f5f5; font-weight: bold; border-top: 2px solid #ddd;">';
                    html += `<td style="padding: 12px; position: sticky; left: 0; background: #f5f5f5; z-index: 1;">åˆè¨ˆ</td>`;
                    // å„å·¥ç¨‹ã®åˆ—ã‚’ç©ºã«ã™ã‚‹
                    displayProcesses.forEach(() => {
                        html += '<td></td>';
                    });
                    // åˆè¨ˆåˆ—
                    html += `<td style="text-align: center;">`;
                    html += `<div style="font-weight: 700;">${versionTotalEst.toFixed(1)} / ${versionTotalAct.toFixed(1)}</div>`;
                    html += `<div style="font-weight: 700; color: ${versionTotalDiff > 0 ? '#e74c3c' : versionTotalDiff < 0 ? '#27ae60' : '#666'}">${versionTotalDiff > 0 ? '+' : ''}${versionTotalDiff.toFixed(1)}</div>`;
                    html += '</td>';
                    html += '</tr>';

                    html += '</table></div>';
                    html += '</div>';
                }
            });

            html += '</div>';
            container.innerHTML += html;
        }

        function renderMemberReport(filteredActuals, filteredEstimates) {
            // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã¨å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ‹…å½“è€…ã‚’å‹•çš„ã«æŠ½å‡º
            const allMembers = new Set();
            filteredEstimates.forEach(e => allMembers.add(e.member));
            filteredActuals.forEach(a => allMembers.add(a.member));
            
            // è¡¨ç¤ºé †ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
            let members;
            const memberOrderInput = document.getElementById('memberOrder').value.trim();
            if (memberOrderInput) {
                const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
                const orderedMembers = [];
                const unorderedMembers = [];
                
                // æŒ‡å®šã•ã‚ŒãŸé †åºã§è¿½åŠ 
                orderList.forEach(name => {
                    if (allMembers.has(name)) {
                        orderedMembers.push(name);
                    }
                });
                
                // æŒ‡å®šã•ã‚Œã¦ã„ãªã„æ‹…å½“è€…ã‚’å¾Œã‚ã«è¿½åŠ 
                Array.from(allMembers).forEach(m => {
                    if (!orderedMembers.includes(m)) {
                        unorderedMembers.push(m);
                    }
                });
                
                members = [...orderedMembers, ...unorderedMembers.sort()];
            } else {
                members = Array.from(allMembers).sort();
            }
            
            if (members.length === 0) {
                document.getElementById('memberReport').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            let html = '<div class="table-wrapper"><table><tr><th>æ‹…å½“è€…</th><th>è¦‹ç©å·¥æ•°</th><th>å®Ÿç¸¾å·¥æ•°</th><th>å·®ç•°</th><th>å·®ç•°ç‡</th></tr>';

            members.forEach(member => {
                const est = filteredEstimates.filter(e => e.member === member).reduce((sum, e) => sum + e.hours, 0);
                const act = filteredActuals.filter(a => a.member === member).reduce((sum, a) => sum + a.hours, 0);
                const diff = act - est;
                const rate = est > 0 ? ((diff / est) * 100).toFixed(1) : 0;

                html += `
                    <tr>
                        <td><strong>${member}</strong></td>
                        <td>${est.toFixed(1)}h</td>
                        <td>${act.toFixed(1)}h</td>
                        <td style="color: ${diff >= 0 ? '#e74c3c' : '#27ae60'}">${(diff >= 0 ? '+' : '')}${diff.toFixed(1)}h</td>
                        <td>${rate}%</td>
                    </tr>
                `;
            });

            html += '</table></div>';
            document.getElementById('memberReport').innerHTML = html;
        }

        function renderVersionReport(filteredActuals, filteredEstimates) {
            const versions = [...new Set(filteredEstimates.map(e => e.version))];
            
            if (versions.length === 0) {
                document.getElementById('versionReport').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">è©²å½“ã™ã‚‹è¦‹ç©ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            let html = '<div class="table-wrapper"><table><tr><th>ç‰ˆæ•°</th><th>è¦‹ç©å·¥æ•°</th><th>å®Ÿç¸¾å·¥æ•°</th><th>é€²æ—ç‡</th></tr>';

            versions.forEach(version => {
                const est = filteredEstimates.filter(e => e.version === version).reduce((sum, e) => sum + e.hours, 0);
                const act = filteredActuals.filter(a => a.version === version).reduce((sum, a) => sum + a.hours, 0);
                const progress = est > 0 ? (act / est * 100).toFixed(1) : 0;

                html += `
                    <tr>
                        <td><strong>${version}</strong></td>
                        <td>${est.toFixed(1)}h</td>
                        <td>${act.toFixed(1)}h</td>
                        <td>${progress}%</td>
                    </tr>
                `;
            });

            html += '</table></div>';
            document.getElementById('versionReport').innerHTML = html;
        }

        function deleteEstimate(id) {
            // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const estimate = estimates.find(e => e.id === id);
            if (!estimate) return;

            // 1æ®µéšç›®ï¼šè©³ç´°æƒ…å ±ä»˜ãã®ç¢ºèª
            const detail = `ã“ã®è¦‹ç©ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nå¯¾å¿œå: ${estimate.task}\nå·¥ç¨‹: ${estimate.process}\nå·¥æ•°: ${estimate.hours}h\næ‹…å½“: ${estimate.member}`;
            if (!confirm(detail)) return;

            // 2æ®µéšç›®ï¼šæœ€çµ‚è­¦å‘Š
            const warning = 'ã€è­¦å‘Šã€‘ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\næœ¬å½“ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ';
            if (!confirm(warning)) return;

            // å‰Šé™¤å®Ÿè¡Œ
            estimates = estimates.filter(e => e.id !== id);
            saveData();
            renderEstimateList();
            updateQuickTaskList();
            updateReport();
            alert('è¦‹ç©ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // ä½œæ¥­æœˆé–¢é€£ã®é–¢æ•°
        function updateWorkMonthOptions() {
            const select = document.getElementById('assignWorkMonth');
            if (!select) return;

            const filter = document.getElementById('estimateMonthFilter');

            // è¦‹ç©ã¨å®Ÿç¸¾ã‹ã‚‰æœˆã‚’æŠ½å‡º
            const months = new Set();
            
            // è¦‹ç©ã‹ã‚‰ä½œæ¥­äºˆå®šæœˆã‚’æŠ½å‡º
            estimates.forEach(e => {
                if (e.workMonth) {
                    months.add(e.workMonth);
                }
            });
            
            // å®Ÿç¸¾ã‹ã‚‰æœˆã‚’æŠ½å‡º
            actuals.forEach(a => {
                if (a.date) {
                    const month = a.date.substring(0, 7); // YYYY-MM
                    months.add(month);
                }
            });
            
            // ç¾åœ¨æœˆã®3ãƒ¶æœˆå‰ã‹ã‚‰6ãƒ¶æœˆå¾Œã¾ã§ã‚’è¿½åŠ 
            const now = new Date();
            for (let i = -3; i <= 6; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const monthStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                months.add(monthStr);
            }
            
            const sortedMonths = Array.from(months).sort(); // æ˜‡é †ï¼ˆå¤ã„æœˆâ†’æ–°ã—ã„æœˆï¼‰
            
            // å‰²ã‚Šå½“ã¦å…ˆé¸æŠè‚¢ã‚’æ›´æ–°
            select.innerHTML = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                return `<option value="${m}">${year}å¹´${parseInt(month)}æœˆ</option>`;
            }).join('');

            // ãƒ•ã‚£ãƒ«ã‚¿é¸æŠè‚¢ã‚’æ›´æ–°ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
            if (filter) {
                const currentFilterValue = filter.value;
                filter.innerHTML = '<option value="all">å…¨ã¦</option><option value="unassigned">æœªè¨­å®šã®ã¿</option>';
                sortedMonths.forEach(m => {
                    const [year, month] = m.split('-');
                    filter.innerHTML += `<option value="${m}">${year}å¹´${parseInt(month)}æœˆ</option>`;
                });
                filter.value = currentFilterValue;
            }
        }

        function toggleEstimateEditMode() {
            const checkbox1 = document.getElementById('estimateEditMode');
            const checkbox2 = document.getElementById('estimateEditMode2');

            // ã‚¤ãƒ™ãƒ³ãƒˆå…ƒã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç‰¹å®šã—ã¦çŠ¶æ…‹ã‚’åŒæœŸ
            if (checkbox1 && checkbox2) {
                if (event && event.target === checkbox1) {
                    checkbox2.checked = checkbox1.checked;
                    estimateEditMode = checkbox1.checked;
                } else if (event && event.target === checkbox2) {
                    checkbox1.checked = checkbox2.checked;
                    estimateEditMode = checkbox2.checked;
                } else {
                    // ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰å‘¼ã°ã‚ŒãŸå ´åˆï¼‰
                    estimateEditMode = checkbox1.checked;
                    checkbox2.checked = checkbox1.checked;
                }
            } else if (checkbox1) {
                estimateEditMode = checkbox1.checked;
            } else if (checkbox2) {
                estimateEditMode = checkbox2.checked;
            }

            // è¦‹ç©ä¸€è¦§ã‚’å†æç”»
            renderEstimateList();
        }

        function toggleWorkMonthSelectionMode() {
            const checkbox1 = document.getElementById('workMonthSelectionMode');
            const checkbox2 = document.getElementById('workMonthSelectionMode2');

            // ã©ã¡ã‚‰ã‹ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰å‘¼ã°ã‚ŒãŸå ´åˆã€çŠ¶æ…‹ã‚’åŒæœŸ
            if (checkbox1 && checkbox2) {
                if (event && event.target === checkbox1) {
                    checkbox2.checked = checkbox1.checked;
                    workMonthSelectionMode = checkbox1.checked;
                } else if (event && event.target === checkbox2) {
                    checkbox1.checked = checkbox2.checked;
                    workMonthSelectionMode = checkbox2.checked;
                } else {
                    // ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰å‘¼ã°ã‚ŒãŸå ´åˆï¼‰
                    workMonthSelectionMode = checkbox1.checked;
                    checkbox2.checked = checkbox1.checked;
                }
            } else if (checkbox1) {
                workMonthSelectionMode = checkbox1.checked;
            }

            const modePanel = document.getElementById('workMonthAssignmentMode');

            if (workMonthSelectionMode) {
                modePanel.style.display = 'block';
                selectedEstimateIds.clear();
                updateSelectedWorkHours();
                initDragHandle(); // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
            } else {
                modePanel.style.display = 'none';
                selectedEstimateIds.clear();
            }

            renderEstimateList();
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã®åˆæœŸåŒ–
        function initDragHandle() {
            const dragHandle = document.getElementById('dragHandle');
            const panel = document.getElementById('workMonthAssignmentMode');
            
            if (!dragHandle || !panel) return;
            
            let isDragging = false;
            let startY = 0;
            let startTop = 20; // åˆæœŸä½ç½®
            
            // ä¿å­˜ã•ã‚ŒãŸä½ç½®ã‚’å¾©å…ƒ
            const savedTop = localStorage.getItem('manhour_panelTop');
            if (savedTop) {
                startTop = parseInt(savedTop);
                panel.style.top = startTop + 'px';
            }
            
            // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
            dragHandle.addEventListener('mousedown', function(e) {
                isDragging = true;
                startY = e.clientY;
                const currentTop = parseInt(panel.style.top) || 20;
                startTop = currentTop;
                dragHandle.style.background = 'rgba(0,0,0,0.2)';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const deltaY = e.clientY - startY;
                let newTop = startTop + deltaY;
                
                // ç”»é¢å†…ã«åˆ¶é™ï¼ˆæœ€å°10pxã€æœ€å¤§ã¯ç”»é¢é«˜ã•-ãƒ‘ãƒãƒ«é«˜ã•-10pxï¼‰
                const panelHeight = panel.offsetHeight;
                const maxTop = window.innerHeight - panelHeight - 10;
                newTop = Math.max(10, Math.min(newTop, maxTop));
                
                panel.style.top = newTop + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    dragHandle.style.background = 'rgba(0,0,0,0.1)';
                    // ä½ç½®ã‚’ä¿å­˜
                    const currentTop = parseInt(panel.style.top) || 20;
                    localStorage.setItem('manhour_panelTop', currentTop);
                }
            });
            
            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
            dragHandle.addEventListener('touchstart', function(e) {
                isDragging = true;
                startY = e.touches[0].clientY;
                const currentTop = parseInt(panel.style.top) || 20;
                startTop = currentTop;
                dragHandle.style.background = 'rgba(0,0,0,0.2)';
                e.preventDefault();
            });
            
            document.addEventListener('touchmove', function(e) {
                if (!isDragging) return;
                
                const deltaY = e.touches[0].clientY - startY;
                let newTop = startTop + deltaY;
                
                // ç”»é¢å†…ã«åˆ¶é™
                const panelHeight = panel.offsetHeight;
                const maxTop = window.innerHeight - panelHeight - 10;
                newTop = Math.max(10, Math.min(newTop, maxTop));
                
                panel.style.top = newTop + 'px';
            });
            
            document.addEventListener('touchend', function() {
                if (isDragging) {
                    isDragging = false;
                    dragHandle.style.background = 'rgba(0,0,0,0.1)';
                    // ä½ç½®ã‚’ä¿å­˜
                    const currentTop = parseInt(panel.style.top) || 20;
                    localStorage.setItem('manhour_panelTop', currentTop);
                }
            });
        }

        function toggleEstimateSelection(id, event) {
            if (!workMonthSelectionMode) return;
            
            event.stopPropagation();
            
            if (selectedEstimateIds.has(id)) {
                selectedEstimateIds.delete(id);
            } else {
                selectedEstimateIds.add(id);
            }
            
            updateSelectedWorkHours();
            renderEstimateList();
        }

        function selectTaskEstimates(version, task, event) {
            if (!workMonthSelectionMode) return;
            
            event.stopPropagation();
            
            // ã“ã®å¯¾å¿œã®å…¨å·¥ç¨‹ã‚’å–å¾—
            const taskEstimates = estimates.filter(e => e.version === version && e.task === task);
            const taskIds = taskEstimates.map(e => e.id);
            
            // å…¨ã¦é¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const allSelected = taskIds.every(id => selectedEstimateIds.has(id));
            
            if (allSelected) {
                // å…¨ã¦é¸æŠè§£é™¤
                taskIds.forEach(id => selectedEstimateIds.delete(id));
            } else {
                // å…¨ã¦é¸æŠ
                taskIds.forEach(id => selectedEstimateIds.add(id));
            }
            
            updateSelectedWorkHours();
            renderEstimateList();
        }

        function updateSelectedWorkHours() {
            const selectedEstimates = estimates.filter(e => selectedEstimateIds.has(e.id));
            const totalHours = selectedEstimates.reduce((sum, e) => sum + e.hours, 0);
            const days = totalHours / 8;

            // ç¾åœ¨ã®æœˆã®å®Ÿåƒæ—¥æ•°ã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
            const workingDaysPerMonth = getCurrentMonthWorkingDays();
            const months = days / workingDaysPerMonth;

            document.getElementById('selectedWorkHours').textContent =
                `é¸æŠä¸­: ${totalHours.toFixed(1)}h (${days.toFixed(1)}äººæ—¥ / ${months.toFixed(2)}äººæœˆ)`;
        }

        function executeWorkMonthAssignment() {
            if (selectedEstimateIds.size === 0) {
                alert('ä½œæ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const workMonth = document.getElementById('assignWorkMonth').value;
            const [year, month] = workMonth.split('-');
            
            if (!confirm(`é¸æŠã—ãŸ${selectedEstimateIds.size}ä»¶ã®ä½œæ¥­ã«ã€Œ${year}å¹´${parseInt(month)}æœˆã€ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            // é¸æŠã•ã‚ŒãŸè¦‹ç©ã«ä½œæ¥­æœˆã‚’è¨­å®š
            estimates.forEach(e => {
                if (selectedEstimateIds.has(e.id)) {
                    e.workMonth = workMonth;
                }
            });
            
            selectedEstimateIds.clear();
            saveData();
            updateWorkMonthOptions();
            updateSelectedWorkHours();
            renderEstimateList();
            updateReport();
            
            alert('ä½œæ¥­æœˆã‚’å‰²ã‚Šå½“ã¦ã¾ã—ãŸ');
        }

        function cancelWorkMonthSelection() {
            selectedEstimateIds.clear();
            updateSelectedWorkHours();
            renderEstimateList();
        }

        function deleteActual(id) {
            if (!confirm('ã“ã®å®Ÿç¸¾ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) return;
            actuals = actuals.filter(a => a.id !== id);
            saveData();
            updateMonthOptions();
            renderActualList();
            renderTodayActuals();
            updateReport();
            alert('å®Ÿç¸¾ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        function exportBackup() {
            autoBackup();
            alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ');
        }

        function importBackup() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.json')) {
                // JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ãŸãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) {
                            estimates = data.estimates || [];
                            actuals = data.actuals || [];
                            companyHolidays = data.companyHolidays || [];
                            vacations = data.vacations || [];
                            remainingEstimates = data.remainingEstimates || [];

                            // æ¬¡ã®IDã‚’è¨­å®š
                            if (companyHolidays.length > 0) {
                                nextCompanyHolidayId = Math.max(...companyHolidays.map(h => h.id)) + 1;
                            }
                            if (vacations.length > 0) {
                                nextVacationId = Math.max(...vacations.map(v => v.id)) + 1;
                            }

                            // æ‹…å½“è€…è¡¨ç¤ºé †ã‚’å¾©å…ƒ
                            if (data.memberOrder) {
                                document.getElementById('memberOrder').value = data.memberOrder;
                                localStorage.setItem('manhour_memberOrder', data.memberOrder);
                            }

                            saveData(true); // å¾©å…ƒæ™‚ã¯è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—

                            updateMonthOptions();
                            updateActualMonthOptions();
                            updateMemberOptions();
                            updateQuickTaskList();
                            renderEstimateList();
                            renderActualList();
                            renderTodayActuals();
                            updateReport();
                            renderCompanyHolidayList();

                            alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
                        }
                    } catch (error) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                };
                reader.readAsText(file);
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                // Excelãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
                handleExcelImport(file);
            } else {
                alert('å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚JSON ã¾ãŸã¯ Excel ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            }
            
            event.target.value = '';
        }

        async function handleExcelImport(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(arrayBuffer);
                
                const estimatesSheet = workbook.getWorksheet('è¦‹ç©ãƒ‡ãƒ¼ã‚¿');
                const actualsSheet = workbook.getWorksheet('å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿');
                
                if (!estimatesSheet || !actualsSheet) {
                    alert('Excelãƒ•ã‚¡ã‚¤ãƒ«ã«ã€Œè¦‹ç©ãƒ‡ãƒ¼ã‚¿ã€ã¨ã€Œå®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã€ã®ã‚·ãƒ¼ãƒˆãŒå¿…è¦ã§ã™');
                    return;
                }
                
                // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
                const newEstimates = [];
                estimatesSheet.eachRow((row, rowNumber) => {
                    if (rowNumber === 1) return; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                    
                    const version = row.getCell(1).value;
                    const task = row.getCell(2).value;
                    const process = row.getCell(3).value;
                    const member = row.getCell(4).value;
                    const hours = parseFloat(row.getCell(5).value);
                    
                    if (version && task && process && member && hours) {
                        newEstimates.push({
                            id: Date.now() + Math.random(),
                            version: String(version),
                            task: String(task),
                            process: String(process),
                            member: String(member),
                            hours: hours,
                            createdAt: new Date().toISOString()
                        });
                    }
                });
                
                // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
                const newActuals = [];
                actualsSheet.eachRow((row, rowNumber) => {
                    if (rowNumber === 1) return; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                    
                    const dateValue = row.getCell(1).value;
                    const version = row.getCell(2).value;
                    const task = row.getCell(3).value;
                    const process = row.getCell(4).value;
                    const member = row.getCell(5).value;
                    const hours = parseFloat(row.getCell(6).value);
                    
                    // æ—¥ä»˜ã®å‡¦ç†
                    let dateStr = '';
                    if (dateValue instanceof Date) {
                        dateStr = dateValue.toISOString().split('T')[0];
                    } else if (typeof dateValue === 'string') {
                        dateStr = dateValue;
                    } else if (typeof dateValue === 'number') {
                        // Excel ã®ã‚·ãƒªã‚¢ãƒ«å€¤ã‚’æ—¥ä»˜ã«å¤‰æ›
                        const date = new Date((dateValue - 25569) * 86400 * 1000);
                        dateStr = date.toISOString().split('T')[0];
                    }
                    
                    if (dateStr && version && task && process && member && hours) {
                        newActuals.push({
                            id: Date.now() + Math.random(),
                            date: dateStr,
                            version: String(version),
                            task: String(task),
                            process: String(process),
                            member: String(member),
                            hours: hours,
                            createdAt: new Date().toISOString()
                        });
                    }
                });
                
                if (newEstimates.length === 0 && newActuals.length === 0) {
                    alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚Excelã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                if (confirm(`è¦‹ç©: ${newEstimates.length}ä»¶ã€å®Ÿç¸¾: ${newActuals.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) {
                    estimates = newEstimates;
                    actuals = newActuals;
                    saveData(true); // å¾©å…ƒæ™‚ã¯è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    
                    updateMonthOptions();
                    updateActualMonthOptions();
                    updateMemberOptions();
                    updateQuickTaskList();
                    renderEstimateList();
                    renderActualList();
                    renderTodayActuals();
                    updateReport();
                    
                    alert('Excelãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('Excelèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('Excelãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // Excelå‡ºåŠ›æ©Ÿèƒ½
        async function exportToExcel() {
            try {
                const workbook = new ExcelJS.Workbook();
                
                // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã®æœŸé–“ã‚’å–å¾—
                let minDate = null;
                let maxDate = null;
                
                actuals.forEach(a => {
                    const date = new Date(a.date);
                    if (!minDate || date < minDate) minDate = date;
                    if (!maxDate || date > maxDate) maxDate = date;
                });
                
                // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç¾åœ¨æœˆã‚’ä½¿ç”¨
                if (!minDate || !maxDate) {
                    const now = new Date();
                    minDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    maxDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                }
                
                // æ‹…å½“è€…ä¸€è¦§ã‚’å–å¾—ï¼ˆè¡¨ç¤ºé †ã‚’è€ƒæ…®ï¼‰
                let members = [...new Set(actuals.map(a => a.member))];

                // è¡¨ç¤ºé †ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆè¨­å®šã§å®šã‚ãŸé †åºã‚’ä½¿ç”¨ï¼‰
                const memberOrderInput = document.getElementById('memberOrder').value.trim();
                if (memberOrderInput) {
                    const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
                    const orderedMembers = [];
                    const unorderedMembers = [];
                    
                    // æŒ‡å®šã•ã‚ŒãŸé †åºã§è¿½åŠ 
                    orderList.forEach(name => {
                        if (members.includes(name)) {
                            orderedMembers.push(name);
                        }
                    });
                    
                    // æŒ‡å®šã•ã‚Œã¦ã„ãªã„æ‹…å½“è€…ã‚’å¾Œã‚ã«è¿½åŠ 
                    members.forEach(m => {
                        if (!orderedMembers.includes(m)) {
                            unorderedMembers.push(m);
                        }
                    });
                    
                    members = [...orderedMembers, ...unorderedMembers.sort()];
                } else {
                    members.sort();
                }
                
                // æ‹…å½“è€…ã”ã¨ã«å®Ÿç¸¾ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
                members.forEach(member => {
                    const worksheet = workbook.addWorksheet(`å®Ÿç¸¾_${member}`);
                    
                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                    worksheet.columns = [
                        { header: 'æ—¥ä»˜', key: 'date', width: 12, style: { numFmt: 'yyyy/mm/dd' } },
                        { header: 'æ›œæ—¥', key: 'weekday', width: 8 },
                        { header: 'å‚™è€ƒ', key: 'note', width: 15 },
                        { header: 'ä½œæ¥­', key: 'work', width: 50 },
                        { header: 'æ™‚é–“(h)', key: 'hours', width: 10 }
                    ];
                    
                    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«
                    worksheet.getRow(1).font = { bold: true };
                    worksheet.getRow(1).fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFD3D3D3' }
                    };
                    
                    // å…¨æ—¥ä»˜ã‚’ç”Ÿæˆï¼ˆåœŸæ—¥ç¥æ—¥å«ã‚€ï¼‰
                    const currentDate = new Date(minDate);
                    while (currentDate <= maxDate) {
                        const dateStr = currentDate.toISOString().split('T')[0];
                        const weekday = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][currentDate.getDay()];
                        
                        // ç¥æ—¥ãƒã‚§ãƒƒã‚¯
                        const holiday = getHoliday(dateStr);
                        const note = holiday || '';
                        
                        // ã“ã®æ—¥ä»˜ã®ã“ã®æ‹…å½“è€…ã®å®Ÿç¸¾ã‚’å–å¾—
                        const dayActuals = actuals.filter(a => 
                            a.date === dateStr && a.member === member
                        );
                        
                        if (dayActuals.length === 0) {
                            // å®Ÿç¸¾ãŒãªã„æ—¥ã‚‚å‡ºåŠ›
                            worksheet.addRow({
                                date: new Date(currentDate),
                                weekday: weekday,
                                note: note,
                                work: '',
                                hours: ''
                            });
                        } else {
                            // å®Ÿç¸¾ãŒã‚ã‚‹å ´åˆã€å„å®Ÿç¸¾ã‚’è¡Œã¨ã—ã¦è¿½åŠ 
                            dayActuals.forEach((actual, index) => {
                                // ä½œæ¥­åã‚’ã€Œç‰ˆæ•°_å¯¾å¿œå_å·¥ç¨‹ã€ã®å½¢å¼ã«
                                const workName = `${actual.version}_${actual.task}_${actual.process}`;
                                
                                worksheet.addRow({
                                    date: new Date(currentDate),
                                    weekday: weekday,
                                    note: note,
                                    work: workName,
                                    hours: actual.hours
                                });
                            });
                        }
                        
                        // æ¬¡ã®æ—¥ã¸
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    // ç½«ç·šã¨æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è¨­å®š
                    worksheet.eachRow((row, rowNumber) => {
                        row.eachCell((cell, colNumber) => {
                            cell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                            
                            // æ—¥ä»˜åˆ—ï¼ˆ1åˆ—ç›®ï¼‰ã®è¡¨ç¤ºå½¢å¼ã‚’è¨­å®š
                            if (colNumber === 1 && rowNumber > 1) {
                                cell.numFmt = 'yyyy/mm/dd';
                            }
                        });
                    });
                    
                    // åœŸæ—¥ç¥æ—¥ã«è‰²ã‚’ä»˜ã‘ã‚‹
                    let currentRow = 2; // ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ¬¡ã‹ã‚‰
                    const checkDate = new Date(minDate);
                    while (checkDate <= maxDate) {
                        const day = checkDate.getDay();
                        const dateStr = checkDate.toISOString().split('T')[0];
                        const isHoliday = getHoliday(dateStr) !== null;
                        
                        // ã“ã®æ—¥ä»˜ã®è¡Œæ•°ã‚’å–å¾—
                        const dayActuals = actuals.filter(a => 
                            a.date === dateStr && a.member === member
                        );
                        const rowCount = Math.max(1, dayActuals.length);
                        
                        if (day === 0 || isHoliday) {
                            // æ—¥æ›œæ—¥ã¾ãŸã¯ç¥æ—¥ï¼ˆèµ¤ï¼‰
                            for (let i = 0; i < rowCount; i++) {
                                worksheet.getRow(currentRow + i).fill = {
                                    type: 'pattern',
                                    pattern: 'solid',
                                    fgColor: { argb: 'FFFFCCCC' }
                                };
                            }
                        } else if (day === 6) {
                            // åœŸæ›œæ—¥ï¼ˆé’ï¼‰
                            for (let i = 0; i < rowCount; i++) {
                                worksheet.getRow(currentRow + i).fill = {
                                    type: 'pattern',
                                    pattern: 'solid',
                                    fgColor: { argb: 'FFCCCCFF' }
                                };
                            }
                        }
                        
                        currentRow += rowCount;
                        checkDate.setDate(checkDate.getDate() + 1);
                    }
                });
                
                // è¦‹ç©ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
                const estimateSheet = workbook.addWorksheet('è¦‹ç©');
                
                estimateSheet.columns = [
                    { header: 'ç‰ˆæ•°', key: 'version', width: 15 },
                    { header: 'ä½œæ¥­æœˆ', key: 'workMonth', width: 12 },
                    { header: 'å¯¾å¿œå', key: 'task', width: 40 },
                    { header: 'å·¥ç¨‹', key: 'process', width: 10 },
                    { header: 'æ‹…å½“', key: 'member', width: 12 },
                    { header: 'è¦‹ç©å·¥æ•°', key: 'hours', width: 12 }
                ];
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«
                estimateSheet.getRow(1).font = { bold: true };
                estimateSheet.getRow(1).fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFD3D3D3' }
                };
                
                // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                estimates.forEach(est => {
                    const normalized = normalizeEstimate(est);
                    
                    // ä½œæ¥­æœˆã®è¡¨ç¤º
                    let workMonthDisplay = '';
                    if (normalized.workMonths.length === 0) {
                        workMonthDisplay = 'æœªè¨­å®š';
                    } else if (normalized.workMonths.length === 1) {
                        const [y, m] = normalized.workMonths[0].split('-');
                        workMonthDisplay = `${y}å¹´${parseInt(m)}æœˆ`;
                    } else {
                        const [y1, m1] = normalized.workMonths[0].split('-');
                        const [y2, m2] = normalized.workMonths[normalized.workMonths.length - 1].split('-');
                        workMonthDisplay = `${y1}å¹´${parseInt(m1)}æœˆã€œ${y2}å¹´${parseInt(m2)}æœˆ`;
                    }
                    
                    estimateSheet.addRow({
                        version: est.version,
                        workMonth: workMonthDisplay,
                        task: est.task,
                        process: est.process,
                        member: est.member,
                        hours: est.hours
                    });
                });
                
                // ç½«ç·šã‚’è¿½åŠ 
                estimateSheet.eachRow((row, rowNumber) => {
                    row.eachCell((cell) => {
                        cell.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                    });
                });
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
                const now = new Date();
                const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
                const filename = `å·¥æ•°ç®¡ç†_${timestamp}.xlsx`;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                
            } catch (error) {
                console.error('Excelå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
                alert('Excelãƒ•ã‚¡ã‚¤ãƒ«ã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // æ‰“ã¡åˆã‚ã›ã‚’å…¨å“¡åˆ†è¿½åŠ 
        function addMeeting() {
            console.log('addMeeting called');
            const hours = parseFloat(document.getElementById('meetingHours').value);

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã®æ—¥ä»˜ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ä»Šæ—¥ã®æ—¥ä»˜
            const modal = document.getElementById('otherWorkModal');
            let date;
            if (modal.dataset.calendarDate) {
                date = modal.dataset.calendarDate;
            } else {
                const today = new Date();
                date = today.toISOString().split('T')[0];
            }
            
            console.log('hours:', hours, 'date:', date);
            
            if (!hours || hours <= 0) {
                alert('å·¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // å…¨æ‹…å½“è€…ã‚’å–å¾—
            const members = new Set();
            estimates.forEach(e => members.add(e.member));
            actuals.forEach(a => members.add(a.member));
            
            console.log('members:', Array.from(members));
            
            if (members.size === 0) {
                alert('æ‹…å½“è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«è¦‹ç©ã¾ãŸã¯å®Ÿç¸¾ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // å…¨æ‹…å½“è€…åˆ†ã®å®Ÿç¸¾ã‚’è¿½åŠ 
            let count = 0;
            members.forEach(member => {
                actuals.push({
                    id: Date.now() + count,
                    date: date,
                    version: '',  // ç‰ˆæ•°ãªã—
                    task: 'æ‰“ã¡åˆã‚ã›',
                    process: '',
                    member: member,
                    hours: hours
                });
                count++;
            });
            
            console.log('actuals added, count:', count);
            
            saveData();
            renderActualList();
            renderTodayActuals();
            updateReport();
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.getElementById('meetingHours').value = '';
            closeOtherWorkModal();
            
            alert(`æ‰“ã¡åˆã‚ã›ã‚’${members.size}ååˆ†ç™»éŒ²ã—ã¾ã—ãŸï¼ˆ${date}ï¼‰`);
        }
        
        // ãã®ä»–ä½œæ¥­ã‚’è¿½åŠ 
        function addOtherWork() {
            console.log('addOtherWork called');
            const workName = document.getElementById('otherWorkName').value.trim();
            const member = document.getElementById('otherWorkMember').value;
            const hours = parseFloat(document.getElementById('otherWorkHours').value);

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã®æ—¥ä»˜ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ä»Šæ—¥ã®æ—¥ä»˜
            const modal = document.getElementById('otherWorkModal');
            let date;
            if (modal.dataset.calendarDate) {
                date = modal.dataset.calendarDate;
            } else {
                const today = new Date();
                date = today.toISOString().split('T')[0];
            }
            
            console.log('workName:', workName, 'member:', member, 'hours:', hours, 'date:', date);
            
            if (!workName) {
                alert('ä½œæ¥­åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!member) {
                alert('æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!hours || hours <= 0) {
                alert('å·¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ãã®ä»–ä½œæ¥­ã‚’è¿½åŠ 
            actuals.push({
                id: Date.now(),
                date: date,
                version: '',  // ç‰ˆæ•°ãªã—
                task: workName,
                process: '',
                member: member,
                hours: hours
            });
            
            console.log('other work added');
            
            saveData();
            renderActualList();
            renderTodayActuals();
            updateReport();
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.getElementById('otherWorkName').value = '';
            document.getElementById('otherWorkMember').value = '';
            document.getElementById('otherWorkHours').value = '';
            closeOtherWorkModal();
            
            alert(`ãã®ä»–ä½œæ¥­ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆ${date}ï¼‰`);
        }
        
        // ãã®ä»–ä½œæ¥­ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openOtherWorkModal() {
            // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            const otherWorkMemberSelect = document.getElementById('otherWorkMember');
            if (otherWorkMemberSelect) {
                // æ‹…å½“è€…ã‚’æŠ½å‡º
                const members = new Set();
                estimates.forEach(e => members.add(e.member));
                actuals.forEach(a => members.add(a.member));
                
                // è¡¨ç¤ºé †ã§ã‚½ãƒ¼ãƒˆ
                let sortedMembers;
                const memberOrderInput = document.getElementById('memberOrder').value.trim();
                if (memberOrderInput) {
                    const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
                    const orderedMembers = [];
                    const unorderedMembers = [];
                    
                    orderList.forEach(name => {
                        if (members.has(name)) {
                            orderedMembers.push(name);
                        }
                    });
                    
                    Array.from(members).forEach(m => {
                        if (!orderedMembers.includes(m)) {
                            unorderedMembers.push(m);
                        }
                    });
                    
                    sortedMembers = [...orderedMembers, ...unorderedMembers.sort()];
                } else {
                    sortedMembers = Array.from(members).sort();
                }
                
                otherWorkMemberSelect.innerHTML = '<option value="">é¸æŠ...</option>';
                sortedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    otherWorkMemberSelect.appendChild(option);
                });
            }
            
            document.getElementById('otherWorkModal').style.display = 'flex';
            // æ‰“ã¡åˆã‚ã›ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            switchOtherWorkTab('meeting');
        }
        
        // ãã®ä»–ä½œæ¥­ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeOtherWorkModal() {
            const modal = document.getElementById('otherWorkModal');
            modal.style.display = 'none';

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            delete modal.dataset.calendarDate;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelector('#otherWorkModal .modal-header h3').textContent = 'ãã®ä»–ä½œæ¥­ã‚’ç™»éŒ²';
        }
        
        // ãã®ä»–ä½œæ¥­ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function switchOtherWorkTab(tab) {
            const meetingTab = document.getElementById('meetingTab');
            const customTab = document.getElementById('customTab');
            const meetingForm = document.getElementById('meetingForm');
            const customForm = document.getElementById('customForm');
            
            if (tab === 'meeting') {
                meetingTab.classList.add('active');
                customTab.classList.remove('active');
                meetingForm.style.display = 'block';
                customForm.style.display = 'none';
            } else {
                meetingTab.classList.remove('active');
                customTab.classList.add('active');
                meetingForm.style.display = 'none';
                customForm.style.display = 'block';
            }
        }
    </script>
</body>
</html>

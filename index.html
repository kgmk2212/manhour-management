<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工数管理システム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/japanese-holidays@1.3.0/lib/japanese-holidays.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    body {
        font-family: 'Segoe UI', 'Yu Gothic', 'Meiryo', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 10px;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        overflow: hidden;
    }

    header {
        background: #2c3e50;
        color: white;
        padding: 20px;
    }

    h1 {
        font-size: 24px;
        margin-bottom: 10px;
    }

    .header-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .tabs {
        display: flex;
        gap: 5px;
        background: #ecf0f1;
        padding: 10px;
        overflow-x: auto;
    }

    .tab {
        padding: 12px 20px;
        background: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        white-space: nowrap;
    }

    .tab.active {
        background: #3498db;
        color: white;
    }

    .content {
        padding: 20px;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
    }

    .btn-primary {
        background: #3498db;
        color: white;
    }

    .btn-success {
        background: #27ae60;
        color: white;
    }

    .btn-danger {
        background: #e74c3c;
        color: white;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    input, select {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
    }

    .quick-input {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-radius: 10px;
        color: white;
        margin-bottom: 20px;
    }

    .quick-form {
        display: grid;
        gap: 10px;
        margin-top: 15px;
    }

    .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        background: white;
        min-width: 600px;
    }

    th {
        background: #34495e;
        color: white;
        padding: 12px;
        text-align: left;
        white-space: nowrap;
    }

    td {
        padding: 8px 10px;
        border-bottom: 1px solid #eee;
        white-space: nowrap;
    }

    /* マトリクス表示用のスタイル */
    table tr td:first-child,
    table tr th:first-child {
        position: sticky;
        left: 0;
        background: white;
        z-index: 1;
    }

    table tr th:first-child {
        z-index: 2;
    }

    /* 週末・祝日の行 */
    table tr[style*="ffebee"] td:first-child {
        background: #ffebee;
    }

    /* 小計行 */
    table tr[style*="fff3cd"] td:first-child {
        background: #fff3cd;
    }

    /* 総合計行 */
    table tr[style*="2c3e50"] td:first-child {
        background: #2c3e50;
        color: white;
    }

    /* モーダル */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.2s;
    }

    .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s;
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 18px;
    }

    .modal-close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
    }

    .modal-close:hover {
        opacity: 0.8;
    }

    .modal-body {
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
    }

    .work-item {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #3498db;
    }

    .work-item:last-child {
        margin-bottom: 0;
    }

    .work-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .work-item-title {
        font-weight: 600;
        font-size: 15px;
        color: #2c3e50;
    }

    .work-item-hours {
        font-size: 18px;
        font-weight: 700;
        color: #3498db;
    }

    .work-item-details {
        font-size: 13px;
        color: #666;
        line-height: 1.6;
    }

    .work-item-details span {
        display: inline-block;
        margin-right: 12px;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-ui { background: #e3f2fd; color: #1976d2; }
    .badge-pg { background: #f3e5f5; color: #7b1fa2; }
    .badge-pt { background: #fff3e0; color: #f57c00; }
    .badge-it { background: #e8f5e9; color: #388e3c; }
    .badge-st { background: #fce4ec; color: #c2185b; }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-radius: 10px;
        color: white;
    }

    .stat-card h3 {
        font-size: 14px;
        margin-bottom: 10px;
    }

    .stat-card .value {
        font-size: 32px;
        font-weight: 700;
    }

    @media (max-width: 768px) {
        body {
            padding: 0;
        }

        .container {
            border-radius: 0;
        }

        h1 {
            font-size: 18px;
        }

        .header-buttons {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }

        .quick-form {
            grid-template-columns: 1fr;
        }

        table {
            font-size: 13px;
        }

        th, td {
            padding: 8px;
        }
    }
</style>

</head>
<body>
    <div class="container">
        <header>
            <h1>工数管理システム</h1>
            <div class="header-buttons">
                <button class="btn btn-success" onclick="exportBackup()">バックアップ</button>
                <button class="btn btn-primary" onclick="importBackup()">復元</button>
            </div>
        </header>

    <div class="tabs">
        <button class="tab active" onclick="showTab('quick')">クイック入力</button>
        <button class="tab" onclick="showTab('estimate')">見積管理</button>
        <button class="tab" onclick="showTab('actual')">実績一覧</button>
        <button class="tab" onclick="showTab('report')">レポート</button>
        <button class="tab" onclick="showTab('settings')">⚙️ 設定</button>
    </div>

    <div class="content">
        <div id="quick" class="tab-content active">
            <div class="quick-input">
                <h2>今日の実績を入力</h2>
                <div class="quick-form">
                    <div class="form-group">
                        <label>対応選択</label>
                        <select id="quickTask" onchange="autoFillTaskInfo()">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>工程</label>
                        <input type="text" id="quickProcess" readonly>
                    </div>
                    <div class="form-group">
                        <label>実績工数 (h)</label>
                        <input type="number" id="quickHours" step="0.5" min="0">
                    </div>
                    <button class="btn btn-success" onclick="quickAddActual()">追加</button>
                </div>
            </div>

            <h3>今日の入力済み実績</h3>
            <div id="todayActuals"></div>
        </div>

        <div id="estimate" class="tab-content">
            <h2>見積データ管理</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3>新規見積登録</h3>
                <div class="form-group">
                    <label>版数</label>
                    <input type="text" id="estVersion" placeholder="第2025.11版">
                </div>
                <div class="form-group">
                    <label>対応名</label>
                    <input type="text" id="estTask" placeholder="帳票A_X対応">
                </div>
                <h4>各工程の見積</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div class="form-group">
                        <label>UI (担当)</label>
                        <select id="estUI_member">
                            <option value="">-</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                        <input type="number" id="estUI" placeholder="時間" step="0.5" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>PG (担当)</label>
                        <select id="estPG_member">
                            <option value="">-</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                        <input type="number" id="estPG" placeholder="時間" step="0.5" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>PT (担当)</label>
                        <select id="estPT_member">
                            <option value="">-</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                        <input type="number" id="estPT" placeholder="時間" step="0.5" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>IT (担当)</label>
                        <select id="estIT_member">
                            <option value="">-</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                        <input type="number" id="estIT" placeholder="時間" step="0.5" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>ST (担当)</label>
                        <select id="estST_member">
                            <option value="">-</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                        <input type="number" id="estST" placeholder="時間" step="0.5" style="margin-top: 5px;">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addEstimate()" style="margin-top: 15px;">登録</button>
            </div>

            <h3>登録済み見積一覧</h3>
            <div id="estimateList"></div>
        </div>

        <div id="actual" class="tab-content">
            <h2>実績データ一覧</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="form-group">
                    <label>表示形式</label>
                    <select id="actualViewType" onchange="renderActualList()">
                        <option value="matrix">担当者×日付マトリクス</option>
                        <option value="list">リスト形式</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>表示期間</label>
                    <select id="actualMonthFilter" onchange="renderActualList()">
                        <option value="all">全期間</option>
                    </select>
                </div>
            </div>
            
            <div id="actualList"></div>
        </div>

        <div id="report" class="tab-content">
            <h2>工数レポート</h2>
            
            <div class="form-group" style="max-width: 300px; margin-bottom: 20px;">
                <label>表示月を選択</label>
                <select id="reportMonth" onchange="updateReport()">
                    <option value="all">全期間</option>
                </select>
            </div>

            <h3 id="reportPeriodTitle">全期間の集計</h3>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>総見積工数</h3>
                    <div class="value" id="totalEstimate">0h</div>
                </div>
                <div class="stat-card">
                    <h3>総実績工数</h3>
                    <div class="value" id="totalActual">0h</div>
                </div>
                <div class="stat-card">
                    <h3>差異</h3>
                    <div class="value" id="totalDiff">0h</div>
                </div>
                <div class="stat-card">
                    <h3>実績率</h3>
                    <div class="value" id="actualRate">0%</div>
                </div>
            </div>

            <h3>担当者別工数</h3>
            <div id="memberReport"></div>

            <h3 style="margin-top: 20px;">版数別進捗</h3>
            <div id="versionReport"></div>
        </div>

        <div id="settings" class="tab-content">
            <h2>⚙️ 設定</h2>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3>担当者表示順</h3>
                <p style="color: #666; margin-bottom: 15px;">担当者の表示順序を指定できます。この順序は実績一覧、レポート、入力フォームなど全ての画面に適用されます。</p>
                
                <div class="form-group">
                    <label>表示順序 <button onclick="showMemberOrderHelp()" style="border: none; background: none; cursor: pointer; color: #3498db; font-size: 18px;">ℹ️</button></label>
                    <input type="text" id="memberOrder" placeholder="例: A,B,C,D または 山田,佐藤,田中" onchange="updateAllDisplays()">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ・カンマ区切りで入力してください<br>
                        ・指定した順番で表示されます<br>
                        ・指定していない担当者は後ろにアルファベット順で表示されます<br>
                        ・設定は自動的に保存されます
                    </small>
                </div>
                
                <button class="btn btn-primary" onclick="updateAllDisplays()" style="margin-top: 10px;">設定を適用</button>
            </div>
        </div>
    </div>
</div>

<input type="file" id="fileInput" accept=".json,.xlsx,.xls" style="display: none;" onchange="handleFileImport(event)">

<!-- 作業詳細モーダル -->
<div id="workModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">作業詳細</h3>
            <button class="modal-close" onclick="closeWorkModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
        </div>
    </div>
</div>

<!-- 実績編集モーダル -->
<div id="editActualModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>実績データを編集</h3>
            <button class="modal-close" onclick="closeEditActualModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editActualId">
            <div class="form-group">
                <label>日付</label>
                <input type="date" id="editActualDate">
            </div>
            <div class="form-group">
                <label>版数</label>
                <input type="text" id="editActualVersion" placeholder="第2025.12版">
            </div>
            <div class="form-group">
                <label>対応名</label>
                <input type="text" id="editActualTask" placeholder="帳票A_新規作成">
            </div>
            <div class="form-group">
                <label>工程</label>
                <select id="editActualProcess">
                    <option value="UI">UI</option>
                    <option value="PG">PG</option>
                    <option value="PT">PT</option>
                    <option value="IT">IT</option>
                    <option value="ST">ST</option>
                </select>
            </div>
            <div class="form-group">
                <label>担当</label>
                <select id="editActualMember">
                </select>
            </div>
            <div class="form-group">
                <label>実績工数</label>
                <input type="number" id="editActualHours" step="0.5" min="0" placeholder="8">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveActualEdit()">保存</button>
                <button class="btn" onclick="closeEditActualModal()" style="background: #95a5a6; color: white;">キャンセル</button>
            </div>
        </div>
    </div>
</div>

<!-- 見積編集モーダル -->
<div id="editEstimateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>見積データを編集</h3>
            <button class="modal-close" onclick="closeEditEstimateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editEstimateId">
            <div class="form-group">
                <label>版数</label>
                <input type="text" id="editEstimateVersion" placeholder="第2025.12版">
            </div>
            <div class="form-group">
                <label>対応名</label>
                <input type="text" id="editEstimateTask" placeholder="帳票A_新規作成">
            </div>
            <div class="form-group">
                <label>工程</label>
                <select id="editEstimateProcess">
                    <option value="UI">UI</option>
                    <option value="PG">PG</option>
                    <option value="PT">PT</option>
                    <option value="IT">IT</option>
                    <option value="ST">ST</option>
                </select>
            </div>
            <div class="form-group">
                <label>担当</label>
                <select id="editEstimateMember">
                </select>
            </div>
            <div class="form-group">
                <label>見積工数</label>
                <input type="number" id="editEstimateHours" step="0.5" min="0" placeholder="8">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveEstimateEdit()">保存</button>
                <button class="btn" onclick="closeEditEstimateModal()" style="background: #95a5a6; color: white;">キャンセル</button>
            </div>
        </div>
    </div>
</div>

<script>
    let estimates = [];
    let actuals = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadData();
        updateMonthOptions();
        updateActualMonthOptions();
        updateMemberOptions();
        updateQuickTaskList();
        renderEstimateList();
        setDefaultActualMonth(); // 前月をデフォルト表示
        renderActualList();
        renderTodayActuals();
        updateReport();
    });

    function saveData() {
        localStorage.setItem('manhour_estimates', JSON.stringify(estimates));
        localStorage.setItem('manhour_actuals', JSON.stringify(actuals));
        
        // 担当者表示順を保存
        const memberOrder = document.getElementById('memberOrder').value.trim();
        if (memberOrder) {
            localStorage.setItem('manhour_memberOrder', memberOrder);
        }
        
        autoBackup();
    }

    function updateMemberOptions() {
        // 見積と実績データから担当者を抽出
        const members = new Set();
        estimates.forEach(e => members.add(e.member));
        actuals.forEach(a => members.add(a.member));
        
        // 表示順が設定されている場合はそれを使用
        let sortedMembers;
        const memberOrderInput = document.getElementById('memberOrder').value.trim();
        if (memberOrderInput) {
            const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
            const orderedMembers = [];
            const unorderedMembers = [];
            
            orderList.forEach(name => {
                if (members.has(name)) {
                    orderedMembers.push(name);
                }
            });
            
            Array.from(members).forEach(m => {
                if (!orderedMembers.includes(m)) {
                    unorderedMembers.push(m);
                }
            });
            
            sortedMembers = [...orderedMembers, ...unorderedMembers.sort()];
        } else {
            sortedMembers = Array.from(members).sort();
        }
        
        // 各工程の担当者選択肢を更新
        const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
        processes.forEach(process => {
            const select = document.getElementById(`est${process}_member`);
            if (select) {
                const currentValue = select.value;
                select.innerHTML = '<option value="">-</option>';
                
                sortedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    select.appendChild(option);
                });
                
                // 以前の選択を復元
                if (currentValue && sortedMembers.includes(currentValue)) {
                    select.value = currentValue;
                }
            }
        });
        
        // クイック入力の担当者選択肢も更新
        const quickMemberSelect = document.getElementById('quickMember');
        if (quickMemberSelect) {
            const currentValue = quickMemberSelect.value;
            quickMemberSelect.innerHTML = '';
            
            sortedMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                quickMemberSelect.appendChild(option);
            });
            
            // 以前の選択を復元
            if (currentValue && sortedMembers.includes(currentValue)) {
                quickMemberSelect.value = currentValue;
            } else if (sortedMembers.length > 0) {
                quickMemberSelect.value = sortedMembers[0];
            }
        }
    }

    function loadData() {
        const savedEstimates = localStorage.getItem('manhour_estimates');
        const savedActuals = localStorage.getItem('manhour_actuals');
        
        if (savedEstimates) estimates = JSON.parse(savedEstimates);
        if (savedActuals) actuals = JSON.parse(savedActuals);
        
        // 担当者表示順を読み込み
        const savedMemberOrder = localStorage.getItem('manhour_memberOrder');
        if (savedMemberOrder) {
            document.getElementById('memberOrder').value = savedMemberOrder;
        }
    }

    function updateMonthOptions() {
        const select = document.getElementById('reportMonth');
        const months = new Set();
        
        // 実績データから月を抽出
        actuals.forEach(a => {
            if (a.date) {
                const month = a.date.substring(0, 7); // YYYY-MM形式
                months.add(month);
            }
        });
        
        // 月を降順でソート
        const sortedMonths = Array.from(months).sort().reverse();
        
        // 選択肢を生成
        select.innerHTML = '<option value="all">全期間</option>';
        sortedMonths.forEach(month => {
            const [year, monthNum] = month.split('-');
            const option = document.createElement('option');
            option.value = month;
            option.textContent = `${year}年${monthNum}月`;
            select.appendChild(option);
        });
    }

    function updateActualMonthOptions() {
        const select = document.getElementById('actualMonthFilter');
        const months = new Set();
        
        // 実績データから月を抽出
        actuals.forEach(a => {
            if (a.date) {
                const month = a.date.substring(0, 7); // YYYY-MM形式
                months.add(month);
            }
        });
        
        // 月を降順でソート
        const sortedMonths = Array.from(months).sort().reverse();
        
        // 選択肢を生成
        select.innerHTML = '<option value="all">全期間</option>';
        sortedMonths.forEach(month => {
            const [year, monthNum] = month.split('-');
            const option = document.createElement('option');
            option.value = month;
            option.textContent = `${year}年${monthNum}月`;
            select.appendChild(option);
        });
    }

    function setDefaultActualMonth() {
        // 前月を計算
        const today = new Date();
        const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const defaultMonth = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;
        
        const select = document.getElementById('actualMonthFilter');
        
        // 前月のオプションが存在するか確認
        const options = Array.from(select.options);
        const hasDefaultMonth = options.some(opt => opt.value === defaultMonth);
        
        if (hasDefaultMonth) {
            select.value = defaultMonth;
        } else if (options.length > 1) {
            // 前月のデータがない場合は、最新月を選択
            select.value = options[1].value; // options[0]は「全期間」なので、options[1]が最新月
        }
    }

    function autoBackup() {
        const data = {
            estimates: estimates,
            actuals: actuals,
            memberOrder: document.getElementById('memberOrder').value.trim(),
            timestamp: new Date().toISOString(),
            version: '1.0'
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        // ローカルタイムでファイル名を生成
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        const second = String(now.getSeconds()).padStart(2, '0');
        const timestamp = `${year}-${month}-${day}_${hour}-${minute}-${second}`;
        
        a.href = url;
        a.download = `工数管理_バックアップ_${timestamp}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(tabName).classList.add('active');
    }

    function addEstimate() {
        const version = document.getElementById('estVersion').value;
        const task = document.getElementById('estTask').value;
        
        if (!version || !task) {
            alert('版数と対応名を入力してください');
            return;
        }

        const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
        
        processes.forEach(proc => {
            const hours = parseFloat(document.getElementById(`est${proc}`).value);
            const member = document.getElementById(`est${proc}_member`).value;
            
            if (hours > 0 && member) {
                estimates.push({
                    id: Date.now() + Math.random(),
                    version: version,
                    task: task,
                    process: proc,
                    member: member,
                    hours: hours,
                    createdAt: new Date().toISOString()
                });
            }
        });

        saveData();
        clearEstimateForm();
        updateMemberOptions();
        renderEstimateList();
        updateQuickTaskList();
        updateReport();
        alert('見積を登録しました');
    }

    function clearEstimateForm() {
        document.getElementById('estVersion').value = '';
        document.getElementById('estTask').value = '';
        ['UI', 'PG', 'PT', 'IT', 'ST'].forEach(proc => {
            document.getElementById(`est${proc}`).value = '';
            document.getElementById(`est${proc}_member`).value = '';
        });
    }

    function updateQuickTaskList() {
        const select = document.getElementById('quickTask');
        select.innerHTML = '<option value="">選択してください</option>';
        
        const uniqueTasks = [...new Set(estimates.map(e => `${e.version}|${e.task}|${e.process}`))];
        
        uniqueTasks.forEach(task => {
            const [version, taskName, process] = task.split('|');
            const option = document.createElement('option');
            option.value = task;
            option.textContent = `${version} - ${taskName} [${process}]`;
            select.appendChild(option);
        });
    }

    function autoFillTaskInfo() {
        const selected = document.getElementById('quickTask').value;
        if (!selected) {
            document.getElementById('quickProcess').value = '';
            return;
        }
        
        const [version, task, process] = selected.split('|');
        document.getElementById('quickProcess').value = process;
    }

    function quickAddActual() {
        const selected = document.getElementById('quickTask').value;
        const hours = parseFloat(document.getElementById('quickHours').value);
        
        if (!selected || !hours) {
            alert('対応と実績工数を入力してください');
            return;
        }

        const [version, task, process] = selected.split('|');
        const estimate = estimates.find(e => 
            e.version === version && e.task === task && e.process === process
        );

        if (!estimate) {
            alert('見積データが見つかりません');
            return;
        }

        actuals.push({
            id: Date.now(),
            date: new Date().toISOString().split('T')[0],
            version: version,
            task: task,
            process: process,
            member: estimate.member,
            hours: hours,
            createdAt: new Date().toISOString()
        });

        saveData();
        document.getElementById('quickHours').value = '';
        updateMonthOptions();
        updateActualMonthOptions();
        updateMemberOptions();
        renderTodayActuals();
        renderActualList();
        updateReport();
        alert('実績を追加しました');
    }

    function renderTodayActuals() {
        const today = new Date().toISOString().split('T')[0];
        const todayData = actuals.filter(a => a.date === today);
        
        const container = document.getElementById('todayActuals');
        
        if (todayData.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">まだ実績が入力されていません</p>';
            return;
        }

        let html = '<div class="table-wrapper"><table><tr><th>時刻</th><th>版数</th><th>対応名</th><th>工程</th><th>担当</th><th>工数</th><th>操作</th></tr>';
        
        todayData.forEach(a => {
            const time = new Date(a.createdAt).toLocaleTimeString('ja-JP');
            html += `
                <tr>
                    <td>${time}</td>
                    <td>${a.version}</td>
                    <td>${a.task}</td>
                    <td><span class="badge badge-${a.process.toLowerCase()}">${a.process}</span></td>
                    <td>${a.member}</td>
                    <td>${a.hours}h</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editActual(${a.id})" style="margin-right: 5px;">編集</button>
                        <button class="btn btn-danger btn-small" onclick="deleteActual(${a.id})">削除</button>
                    </td>
                </tr>
            `;
        });
        
        html += '</table></div>';
        container.innerHTML = html;
    }

    function renderEstimateList() {
        const container = document.getElementById('estimateList');
        
        if (estimates.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">見積データがありません</p>';
            return;
        }

        let html = '<div class="table-wrapper"><table><tr><th>版数</th><th>対応名</th><th>工程</th><th>担当</th><th>見積工数</th><th>操作</th></tr>';
        
        estimates.forEach(e => {
            html += `
                <tr>
                    <td>${e.version}</td>
                    <td>${e.task}</td>
                    <td><span class="badge badge-${e.process.toLowerCase()}">${e.process}</span></td>
                    <td>${e.member}</td>
                    <td>${e.hours}h</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editEstimate(${e.id})" style="margin-right: 5px;">編集</button>
                        <button class="btn btn-danger btn-small" onclick="deleteEstimate(${e.id})">削除</button>
                    </td>
                </tr>
            `;
        });
        
        html += '</table></div>';
        container.innerHTML = html;
    }

    function renderActualList() {
        const container = document.getElementById('actualList');
        const viewType = document.getElementById('actualViewType').value;
        
        if (actuals.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">実績データがありません</p>';
            return;
        }

        if (viewType === 'matrix') {
            renderActualMatrix();
        } else {
            renderActualListView();
        }
    }

    function renderActualMatrix() {
        const container = document.getElementById('actualList');
        const selectedMonth = document.getElementById('actualMonthFilter').value;
        const memberOrderInput = document.getElementById('memberOrder').value.trim();
        
        // 月でフィルタリング
        let filteredActuals = actuals;
        if (selectedMonth !== 'all') {
            filteredActuals = actuals.filter(a => a.date && a.date.startsWith(selectedMonth));
        }
        
        if (filteredActuals.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">選択した期間に実績データがありません</p>';
            return;
        }
        
        // 担当者を抽出して並び替え
        let members = [...new Set(filteredActuals.map(a => a.member))];
        
        // 表示順が指定されている場合
        if (memberOrderInput) {
            const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
            const orderedMembers = [];
            const unorderedMembers = [];
            
            // 指定された順序で追加
            orderList.forEach(name => {
                if (members.includes(name)) {
                    orderedMembers.push(name);
                }
            });
            
            // 指定されていない担当者を後ろに追加
            members.forEach(m => {
                if (!orderedMembers.includes(m)) {
                    unorderedMembers.push(m);
                }
            });
            
            members = [...orderedMembers, ...unorderedMembers.sort()];
        } else {
            members.sort();
        }
        
        // 実績データの日付範囲を取得
        const dates = filteredActuals.map(a => a.date).sort();
        
        // 表示範囲を決定
        let startDate, endDate;
        if (selectedMonth !== 'all') {
            // 選択した月のみ（月初から月末まで正確に）
            const [year, month] = selectedMonth.split('-');
            const yearNum = parseInt(year);
            const monthNum = parseInt(month);
            
            // 月の最初の日
            startDate = `${year}-${month}-01`;
            
            // 月の最後の日を計算
            const lastDay = new Date(yearNum, monthNum, 0).getDate();
            endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
        } else {
            // 全期間（最小日付の月初から最大日付の月末まで）
            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];
            
            const [minYear, minMonth] = minDate.split('-');
            const [maxYear, maxMonth] = maxDate.split('-');
            
            startDate = `${minYear}-${minMonth}-01`;
            
            const lastDay = new Date(parseInt(maxYear), parseInt(maxMonth), 0).getDate();
            endDate = `${maxYear}-${maxMonth}-${String(lastDay).padStart(2, '0')}`;
        }
        
        // 日付範囲を生成
        const allDates = [];
        let currentDateStr = startDate;
        while (currentDateStr <= endDate) {
            allDates.push(currentDateStr);
            
            // 次の日付を計算
            const [y, m, d] = currentDateStr.split('-').map(Number);
            const nextDate = new Date(y, m - 1, d + 1);
            currentDateStr = `${nextDate.getFullYear()}-${String(nextDate.getMonth() + 1).padStart(2, '0')}-${String(nextDate.getDate()).padStart(2, '0')}`;
        }
        
        let html = '';
        
        // 月の合計を最上部に表示（月選択時のみ）
        if (selectedMonth !== 'all') {
            const [year, month] = selectedMonth.split('-');
            
            // 稼働日数を計算（実績が入力されている日数）
            const workedDays = new Set(filteredActuals.map(a => a.date)).size;
            
            html += `<div style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 5px 0;">${year}年${parseInt(month)}月の合計</h3>
                <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">稼働日数: ${workedDays}日</p>
            </div>`;
            
            // 同じtable-wrapper内に合計表を配置
            html += '<div class="table-wrapper"><table>';
            
            // 合計行
            html += '<tr style="background: #2c3e50; color: white; font-weight: 700;"><th style="min-width: 100px;">総合計</th>';
            
            let monthGrandTotal = 0;
            members.forEach(member => {
                const memberTotal = filteredActuals.filter(a => a.member === member).reduce((sum, a) => sum + a.hours, 0);
                monthGrandTotal += memberTotal;
                html += `<th style="text-align: center; min-width: 80px;">${memberTotal.toFixed(1)}h</th>`;
            });
            
            html += `<th style="background: #ffc107; text-align: center; min-width: 80px;">${monthGrandTotal.toFixed(1)}h</th>`;
            html += '</tr>';
            
            // ヘッダー行
            html += '<tr><th style="min-width: 100px;">日付</th>';
            
            // 担当者ヘッダー
            members.forEach(member => {
                html += `<th style="min-width: 80px; text-align: center;">${member}</th>`;
            });
            html += '<th style="min-width: 80px; text-align: center;">日別合計</th></tr>';
        } else {
            // 全期間表示の場合は通常通りヘッダーのみ
            html += '<div class="table-wrapper"><table>';
            html += '<tr><th style="min-width: 100px;">日付</th>';
            
            // 担当者ヘッダー
            members.forEach(member => {
                html += `<th style="min-width: 80px; text-align: center;">${member}</th>`;
            });
            html += '<th style="min-width: 80px; text-align: center;">日別合計</th></tr>';
        }
        
        let currentMonth = '';
        let monthTotals = {};
        members.forEach(m => monthTotals[m] = 0);
        let monthTotal = 0;
        
        // 日付ごとの行
        allDates.forEach(date => {
            const dateObj = new Date(date);
            const month = `${dateObj.getFullYear()}年${dateObj.getMonth() + 1}月`;
            const dayOfWeek = getDayOfWeek(date);
            const isWeekend = dayOfWeek === '土' || dayOfWeek === '日';
            
            // 祝日判定
            const holiday = getHoliday(date);
            const isHoliday = holiday !== null;
            
            // 月が変わったら月次小計行を挿入（全期間表示時のみ）
            if (selectedMonth === 'all' && currentMonth && currentMonth !== month) {
                html += '<tr style="background: #fff3cd; font-weight: 600;">';
                html += `<td>${currentMonth} 小計</td>`;
                members.forEach(member => {
                    html += `<td style="text-align: center;">${monthTotals[member].toFixed(1)}h</td>`;
                });
                html += `<td style="background: #ffc107; color: white; text-align: center;">${monthTotal.toFixed(1)}h</td>`;
                html += '</tr>';
                
                // リセット
                members.forEach(m => monthTotals[m] = 0);
                monthTotal = 0;
            }
            
            currentMonth = month;
            
            // 日付行（祝日または週末）
            const bgColor = (isWeekend || isHoliday) ? '#ffebee' : 'white';
            html += `<tr style="background: ${bgColor};">`;
            
            // 日付セル
            const [year, m, day] = date.split('-');
            const dateColor = (isWeekend || isHoliday) ? 'color: #c62828;' : '';
            const holidayName = isHoliday ? ` ${holiday}` : '';
            html += `<td style="font-weight: 500; ${dateColor}">
                ${parseInt(m)}/${parseInt(day)} (${dayOfWeek})${holidayName}
            </td>`;
            
            let dayTotal = 0;
            
            // 担当者ごとのセル
            members.forEach(member => {
                const dayActuals = filteredActuals.filter(a => a.member === member && a.date === date);
                const memberDayTotal = dayActuals.reduce((sum, a) => sum + a.hours, 0);
                dayTotal += memberDayTotal;
                monthTotals[member] += memberDayTotal;
                
                if (memberDayTotal > 0) {
                    // クリックで詳細表示
                    html += `<td style="background: #e3f2fd; text-align: center; cursor: pointer;" 
                                onclick="showWorkDetail('${member}', '${date}')">
                        <strong>${memberDayTotal.toFixed(1)}</strong>
                    </td>`;
                } else {
                    html += `<td style="background: #fafafa; text-align: center; color: #ccc;">-</td>`;
                }
            });
            
            monthTotal += dayTotal;
            
            // 日別合計
            if (dayTotal > 0) {
                html += `<td style="font-weight: 700; background: #fff3cd; text-align: center;">${dayTotal.toFixed(1)}h</td>`;
            } else {
                html += `<td style="background: #fafafa; text-align: center; color: #ccc;">-</td>`;
            }
            
            html += '</tr>';
        });
        
        // 最後の月の小計（全期間表示時のみ）
        if (selectedMonth === 'all' && currentMonth) {
            html += '<tr style="background: #fff3cd; font-weight: 600;">';
            html += `<td>${currentMonth} 小計</td>`;
            members.forEach(member => {
                html += `<td style="text-align: center;">${monthTotals[member].toFixed(1)}h</td>`;
            });
            html += `<td style="background: #ffc107; color: white; text-align: center;">${monthTotal.toFixed(1)}h</td>`;
            html += '</tr>';
        }
        
        // 全期間の合計行
        html += '<tr style="background: #2c3e50; color: white; font-weight: 700;">';
        html += '<td>総合計</td>';
        let grandTotal = 0;
        
        members.forEach(member => {
            const memberTotal = filteredActuals.filter(a => a.member === member).reduce((sum, a) => sum + a.hours, 0);
            grandTotal += memberTotal;
            html += `<td style="text-align: center;">${memberTotal.toFixed(1)}h</td>`;
        });
        
        html += `<td style="background: #ffc107; text-align: center;">${grandTotal.toFixed(1)}h</td>`;
        html += '</tr>';
        
        html += '</table></div>';
        
        // 詳細リスト（削除用）
        html += '<h3 style="margin-top: 30px;">詳細データ（削除用）</h3>';
        html += '<div class="table-wrapper"><table><tr><th>日付</th><th>担当者</th><th>版数</th><th>対応名</th><th>工程</th><th>実績工数</th><th>操作</th></tr>';
        
        const sortedActuals = [...filteredActuals].sort((a, b) => {
            if (a.date !== b.date) return b.date.localeCompare(a.date);
            return a.member.localeCompare(b.member);
        });
        
        sortedActuals.forEach(a => {
            html += `
                <tr>
                    <td>${a.date}</td>
                    <td>${a.member}</td>
                    <td>${a.version}</td>
                    <td>${a.task}</td>
                    <td><span class="badge badge-${a.process.toLowerCase()}">${a.process}</span></td>
                    <td>${a.hours}h</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editActual(${a.id})" style="margin-right: 5px;">編集</button>
                        <button class="btn btn-danger btn-small" onclick="deleteActual(${a.id})">削除</button>
                    </td>
                </tr>
            `;
        });
        
        html += '</table></div>';
        container.innerHTML = html;
    }


    function renderActualListView() {
        const container = document.getElementById('actualList');
        let html = '<div class="table-wrapper"><table><tr><th>日付</th><th>版数</th><th>対応名</th><th>工程</th><th>担当</th><th>実績工数</th><th>操作</th></tr>';
        
        const sortedActuals = [...actuals].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        sortedActuals.forEach(a => {
            html += `
                <tr>
                    <td>${a.date}</td>
                    <td>${a.version}</td>
                    <td>${a.task}</td>
                    <td><span class="badge badge-${a.process.toLowerCase()}">${a.process}</span></td>
                    <td>${a.member}</td>
                    <td>${a.hours}h</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editActual(${a.id})" style="margin-right: 5px;">編集</button>
                        <button class="btn btn-danger btn-small" onclick="deleteActual(${a.id})">削除</button>
                    </td>
                </tr>
            `;
        });
        
        html += '</table></div>';
        container.innerHTML = html;
    }

    function getDayOfWeek(dateStr) {
        const days = ['日', '月', '火', '水', '木', '金', '土'];
        const date = new Date(dateStr);
        return days[date.getDay()];
    }

    function getHoliday(dateStr) {
        // YYYY-MM-DD形式の文字列をDateオブジェクトに変換
        const date = new Date(dateStr + 'T00:00:00');
        
        // japanese-holidaysライブラリを使用
        if (typeof JapaneseHolidays !== 'undefined') {
            const holiday = JapaneseHolidays.isHoliday(date);
            return holiday || null;
        }
        
        return null;
    }

    function showWorkDetail(member, date) {
        const dayActuals = actuals.filter(a => a.member === member && a.date === date);
        
        if (dayActuals.length === 0) return;
        
        const dateObj = new Date(date);
        const [year, month, day] = date.split('-');
        const dayOfWeek = getDayOfWeek(date);
        
        // モーダルタイトル
        document.getElementById('modalTitle').textContent = 
            `${member}さんの作業 - ${year}年${parseInt(month)}月${parseInt(day)}日(${dayOfWeek})`;
        
        // モーダル本文
        let html = '';
        const totalHours = dayActuals.reduce((sum, a) => sum + a.hours, 0);
        
        dayActuals.forEach(actual => {
            html += `
                <div class="work-item">
                    <div class="work-item-header">
                        <div class="work-item-title">${actual.task}</div>
                        <div class="work-item-hours">${actual.hours}h</div>
                    </div>
                    <div class="work-item-details">
                        <span><strong>版数:</strong> ${actual.version}</span>
                        <span><strong>工程:</strong> <span class="badge badge-${actual.process.toLowerCase()}">${actual.process}</span></span>
                    </div>
                </div>
            `;
        });
        
        html += `
            <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #eee; text-align: right;">
                <strong style="font-size: 16px;">合計: ${totalHours.toFixed(1)}時間</strong>
                <span style="color: #666; font-size: 14px; margin-left: 10px;">(${dayActuals.length}件)</span>
            </div>
        `;
        
        document.getElementById('modalBody').innerHTML = html;
        document.getElementById('workModal').style.display = 'block';
    }

    function closeWorkModal() {
        document.getElementById('workModal').style.display = 'none';
    }

    function editActual(id) {
        const actual = actuals.find(a => a.id === id);
        if (!actual) {
            alert('データが見つかりません');
            return;
        }
        
        // フォームに既存データを設定
        document.getElementById('editActualId').value = id;
        document.getElementById('editActualDate').value = actual.date;
        document.getElementById('editActualVersion').value = actual.version;
        document.getElementById('editActualTask').value = actual.task;
        document.getElementById('editActualProcess').value = actual.process;
        document.getElementById('editActualHours').value = actual.hours;
        
        // 担当者選択肢を更新
        const memberSelect = document.getElementById('editActualMember');
        const allMembers = new Set();
        estimates.forEach(e => allMembers.add(e.member));
        actuals.forEach(a => allMembers.add(a.member));
        
        let sortedMembers;
        const memberOrderInput = document.getElementById('memberOrder').value.trim();
        if (memberOrderInput) {
            const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
            const orderedMembers = [];
            const unorderedMembers = [];
            
            orderList.forEach(name => {
                if (allMembers.has(name)) {
                    orderedMembers.push(name);
                }
            });
            
            Array.from(allMembers).forEach(m => {
                if (!orderedMembers.includes(m)) {
                    unorderedMembers.push(m);
                }
            });
            
            sortedMembers = [...orderedMembers, ...unorderedMembers.sort()];
        } else {
            sortedMembers = Array.from(allMembers).sort();
        }
        
        memberSelect.innerHTML = '';
        sortedMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member;
            option.textContent = member;
            memberSelect.appendChild(option);
        });
        
        memberSelect.value = actual.member;
        
        // モーダルを表示
        document.getElementById('editActualModal').style.display = 'block';
    }

    function closeEditActualModal() {
        document.getElementById('editActualModal').style.display = 'none';
    }

    function saveActualEdit() {
        const id = parseFloat(document.getElementById('editActualId').value);
        const date = document.getElementById('editActualDate').value;
        const version = document.getElementById('editActualVersion').value;
        const task = document.getElementById('editActualTask').value;
        const process = document.getElementById('editActualProcess').value;
        const member = document.getElementById('editActualMember').value;
        const hours = parseFloat(document.getElementById('editActualHours').value);
        
        if (!date || !version || !task || !process || !member || !hours) {
            alert('すべての項目を入力してください');
            return;
        }
        
        // データを更新
        const actualIndex = actuals.findIndex(a => a.id === id);
        if (actualIndex !== -1) {
            actuals[actualIndex] = {
                ...actuals[actualIndex],
                date: date,
                version: version,
                task: task,
                process: process,
                member: member,
                hours: hours
            };
            
            saveData();
            closeEditActualModal();
            
            updateMonthOptions();
            updateActualMonthOptions();
            updateMemberOptions();
            updateQuickTaskList();
            renderTodayActuals();
            renderActualList();
            updateReport();
            
            alert('実績データを更新しました');
        } else {
            alert('データの更新に失敗しました');
        }
    }

    function editEstimate(id) {
        const estimate = estimates.find(e => e.id === id);
        if (!estimate) {
            alert('データが見つかりません');
            return;
        }
        
        // フォームに既存データを設定
        document.getElementById('editEstimateId').value = id;
        document.getElementById('editEstimateVersion').value = estimate.version;
        document.getElementById('editEstimateTask').value = estimate.task;
        document.getElementById('editEstimateProcess').value = estimate.process;
        document.getElementById('editEstimateHours').value = estimate.hours;
        
        // 担当者選択肢を更新
        const memberSelect = document.getElementById('editEstimateMember');
        const allMembers = new Set();
        estimates.forEach(e => allMembers.add(e.member));
        actuals.forEach(a => allMembers.add(a.member));
        
        let sortedMembers;
        const memberOrderInput = document.getElementById('memberOrder').value.trim();
        if (memberOrderInput) {
            const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
            const orderedMembers = [];
            const unorderedMembers = [];
            
            orderList.forEach(name => {
                if (allMembers.has(name)) {
                    orderedMembers.push(name);
                }
            });
            
            Array.from(allMembers).forEach(m => {
                if (!orderedMembers.includes(m)) {
                    unorderedMembers.push(m);
                }
            });
            
            sortedMembers = [...orderedMembers, ...unorderedMembers.sort()];
        } else {
            sortedMembers = Array.from(allMembers).sort();
        }
        
        memberSelect.innerHTML = '';
        sortedMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member;
            option.textContent = member;
            memberSelect.appendChild(option);
        });
        
        memberSelect.value = estimate.member;
        
        // モーダルを表示
        document.getElementById('editEstimateModal').style.display = 'block';
    }

    function closeEditEstimateModal() {
        document.getElementById('editEstimateModal').style.display = 'none';
    }

    function saveEstimateEdit() {
        const id = parseFloat(document.getElementById('editEstimateId').value);
        const version = document.getElementById('editEstimateVersion').value;
        const task = document.getElementById('editEstimateTask').value;
        const process = document.getElementById('editEstimateProcess').value;
        const member = document.getElementById('editEstimateMember').value;
        const hours = parseFloat(document.getElementById('editEstimateHours').value);
        
        if (!version || !task || !process || !member || !hours) {
            alert('すべての項目を入力してください');
            return;
        }
        
        // データを更新
        const estimateIndex = estimates.findIndex(e => e.id === id);
        if (estimateIndex !== -1) {
            estimates[estimateIndex] = {
                ...estimates[estimateIndex],
                version: version,
                task: task,
                process: process,
                member: member,
                hours: hours
            };
            
            saveData();
            closeEditEstimateModal();
            
            updateMemberOptions();
            updateQuickTaskList();
            renderEstimateList();
            updateReport();
            
            alert('見積データを更新しました');
        } else {
            alert('データの更新に失敗しました');
        }
    }

    function showMemberOrderHelp() {
        alert('担当者の表示順を指定できます。\n\n例:\nA,B,C,D\n山田,佐藤,田中\n\n・カンマ区切りで入力\n・指定した順番で表示されます\n・指定していない担当者は後ろにアルファベット順で表示されます');
    }

    function updateAllDisplays() {
        saveData();
        updateMemberOptions();
        renderActualList();
        updateReport();
        alert('設定を適用しました');
    }

    // モーダル外をクリックで閉じる
    window.onclick = function(event) {
        const workModal = document.getElementById('workModal');
        const editActualModal = document.getElementById('editActualModal');
        const editEstimateModal = document.getElementById('editEstimateModal');
        
        if (event.target === workModal) {
            closeWorkModal();
        }
        if (event.target === editActualModal) {
            closeEditActualModal();
        }
        if (event.target === editEstimateModal) {
            closeEditEstimateModal();
        }
    }

    function updateReport() {
        const selectedMonth = document.getElementById('reportMonth').value;
        
        // フィルタリング
        let filteredActuals = actuals;
        if (selectedMonth !== 'all') {
            filteredActuals = actuals.filter(a => a.date && a.date.startsWith(selectedMonth));
        }
        
        // タイトル更新
        const titleElement = document.getElementById('reportPeriodTitle');
        if (selectedMonth === 'all') {
            titleElement.textContent = '全期間の集計';
        } else {
            const [year, month] = selectedMonth.split('-');
            titleElement.textContent = `${year}年${month}月の集計`;
        }
        
        const totalEst = estimates.reduce((sum, e) => sum + e.hours, 0);
        const totalAct = filteredActuals.reduce((sum, a) => sum + a.hours, 0);
        const diff = totalAct - totalEst;
        const rate = totalEst > 0 ? (totalAct / totalEst * 100).toFixed(1) : 0;

        document.getElementById('totalEstimate').textContent = totalEst.toFixed(1) + 'h';
        document.getElementById('totalActual').textContent = totalAct.toFixed(1) + 'h';
        document.getElementById('totalDiff').textContent = (diff >= 0 ? '+' : '') + diff.toFixed(1) + 'h';
        document.getElementById('actualRate').textContent = rate + '%';

        renderMemberReport(filteredActuals);
        renderVersionReport(filteredActuals);
    }

    function renderMemberReport(filteredActuals) {
        // 見積データと実績データから担当者を動的に抽出
        const allMembers = new Set();
        estimates.forEach(e => allMembers.add(e.member));
        filteredActuals.forEach(a => allMembers.add(a.member));
        
        // 表示順が設定されている場合はそれを使用
        let members;
        const memberOrderInput = document.getElementById('memberOrder').value.trim();
        if (memberOrderInput) {
            const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
            const orderedMembers = [];
            const unorderedMembers = [];
            
            // 指定された順序で追加
            orderList.forEach(name => {
                if (allMembers.has(name)) {
                    orderedMembers.push(name);
                }
            });
            
            // 指定されていない担当者を後ろに追加
            Array.from(allMembers).forEach(m => {
                if (!orderedMembers.includes(m)) {
                    unorderedMembers.push(m);
                }
            });
            
            members = [...orderedMembers, ...unorderedMembers.sort()];
        } else {
            members = Array.from(allMembers).sort();
        }
        
        if (members.length === 0) {
            document.getElementById('memberReport').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">データがありません</p>';
            return;
        }
        
        let html = '<div class="table-wrapper"><table><tr><th>担当者</th><th>見積工数</th><th>実績工数</th><th>差異</th><th>差異率</th></tr>';

        members.forEach(member => {
            const est = estimates.filter(e => e.member === member).reduce((sum, e) => sum + e.hours, 0);
            const act = filteredActuals.filter(a => a.member === member).reduce((sum, a) => sum + a.hours, 0);
            const diff = act - est;
            const rate = est > 0 ? ((diff / est) * 100).toFixed(1) : 0;

            html += `
                <tr>
                    <td><strong>${member}</strong></td>
                    <td>${est.toFixed(1)}h</td>
                    <td>${act.toFixed(1)}h</td>
                    <td style="color: ${diff >= 0 ? '#e74c3c' : '#27ae60'}">${(diff >= 0 ? '+' : '')}${diff.toFixed(1)}h</td>
                    <td>${rate}%</td>
                </tr>
            `;
        });

        html += '</table></div>';
        document.getElementById('memberReport').innerHTML = html;
    }

    function renderVersionReport(filteredActuals) {
        const versions = [...new Set(estimates.map(e => e.version))];
        let html = '<div class="table-wrapper"><table><tr><th>版数</th><th>見積工数</th><th>実績工数</th><th>進捗率</th></tr>';

        versions.forEach(version => {
            const est = estimates.filter(e => e.version === version).reduce((sum, e) => sum + e.hours, 0);
            const act = filteredActuals.filter(a => a.version === version).reduce((sum, a) => sum + a.hours, 0);
            const progress = est > 0 ? (act / est * 100).toFixed(1) : 0;

            html += `
                <tr>
                    <td><strong>${version}</strong></td>
                    <td>${est.toFixed(1)}h</td>
                    <td>${act.toFixed(1)}h</td>
                    <td>${progress}%</td>
                </tr>
            `;
        });

        html += '</table></div>';
        document.getElementById('versionReport').innerHTML = html;
    }

    function deleteEstimate(id) {
        if (!confirm('この見積を削除しますか?')) return;
        estimates = estimates.filter(e => e.id !== id);
        saveData();
        renderEstimateList();
        updateQuickTaskList();
        updateReport();
        alert('見積を削除しました');
    }

    function deleteActual(id) {
        if (!confirm('この実績を削除しますか?')) return;
        actuals = actuals.filter(a => a.id !== id);
        saveData();
        updateMonthOptions();
        renderActualList();
        renderTodayActuals();
        updateReport();
        alert('実績を削除しました');
    }

    function exportBackup() {
        autoBackup();
        alert('バックアップを作成しました');
    }

    function importBackup() {
        document.getElementById('fileInput').click();
    }

    function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const fileName = file.name.toLowerCase();
        
        if (fileName.endsWith('.json')) {
            // JSONファイルの処理
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('現在のデータを復元したデータで上書きしますか？')) {
                        estimates = data.estimates || [];
                        actuals = data.actuals || [];
                        
                        // 担当者表示順を復元
                        if (data.memberOrder) {
                            document.getElementById('memberOrder').value = data.memberOrder;
                            localStorage.setItem('manhour_memberOrder', data.memberOrder);
                        }
                        
                        saveData();
                        
                        updateMonthOptions();
                        updateActualMonthOptions();
                        updateMemberOptions();
                        updateQuickTaskList();
                        renderEstimateList();
                        renderActualList();
                        renderTodayActuals();
                        updateReport();
                        
                        alert('データを復元しました');
                    }
                } catch (error) {
                    alert('ファイルの読み込みに失敗しました');
                }
            };
            reader.readAsText(file);
        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            // Excelファイルの処理
            handleExcelImport(file);
        } else {
            alert('対応していないファイル形式です。JSON または Excel ファイルを選択してください。');
        }
        
        event.target.value = '';
    }

    async function handleExcelImport(file) {
        try {
            const arrayBuffer = await file.arrayBuffer();
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(arrayBuffer);
            
            const estimatesSheet = workbook.getWorksheet('見積データ');
            const actualsSheet = workbook.getWorksheet('実績データ');
            
            if (!estimatesSheet || !actualsSheet) {
                alert('Excelファイルに「見積データ」と「実績データ」のシートが必要です');
                return;
            }
            
            // 見積データの読み込み
            const newEstimates = [];
            estimatesSheet.eachRow((row, rowNumber) => {
                if (rowNumber === 1) return; // ヘッダー行をスキップ
                
                const version = row.getCell(1).value;
                const task = row.getCell(2).value;
                const process = row.getCell(3).value;
                const member = row.getCell(4).value;
                const hours = parseFloat(row.getCell(5).value);
                
                if (version && task && process && member && hours) {
                    newEstimates.push({
                        id: Date.now() + Math.random(),
                        version: String(version),
                        task: String(task),
                        process: String(process),
                        member: String(member),
                        hours: hours,
                        createdAt: new Date().toISOString()
                    });
                }
            });
            
            // 実績データの読み込み
            const newActuals = [];
            actualsSheet.eachRow((row, rowNumber) => {
                if (rowNumber === 1) return; // ヘッダー行をスキップ
                
                const dateValue = row.getCell(1).value;
                const version = row.getCell(2).value;
                const task = row.getCell(3).value;
                const process = row.getCell(4).value;
                const member = row.getCell(5).value;
                const hours = parseFloat(row.getCell(6).value);
                
                // 日付の処理
                let dateStr = '';
                if (dateValue instanceof Date) {
                    dateStr = dateValue.toISOString().split('T')[0];
                } else if (typeof dateValue === 'string') {
                    dateStr = dateValue;
                } else if (typeof dateValue === 'number') {
                    // Excel のシリアル値を日付に変換
                    const date = new Date((dateValue - 25569) * 86400 * 1000);
                    dateStr = date.toISOString().split('T')[0];
                }
                
                if (dateStr && version && task && process && member && hours) {
                    newActuals.push({
                        id: Date.now() + Math.random(),
                        date: dateStr,
                        version: String(version),
                        task: String(task),
                        process: String(process),
                        member: String(member),
                        hours: hours,
                        createdAt: new Date().toISOString()
                    });
                }
            });
            
            if (newEstimates.length === 0 && newActuals.length === 0) {
                alert('データが見つかりませんでした。Excelのフォーマットを確認してください。');
                return;
            }
            
            if (confirm(`見積: ${newEstimates.length}件、実績: ${newActuals.length}件のデータを読み込みました。\n現在のデータを上書きしますか？`)) {
                estimates = newEstimates;
                actuals = newActuals;
                saveData();
                
                updateMonthOptions();
                updateActualMonthOptions();
                updateMemberOptions();
                updateQuickTaskList();
                renderEstimateList();
                renderActualList();
                renderTodayActuals();
                updateReport();
                
                alert('Excelデータを読み込みました');
            }
            
        } catch (error) {
            console.error('Excel読み込みエラー:', error);
            alert('Excelファイルの読み込みに失敗しました: ' + error.message);
        }
    }
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>工数管理システム</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📊</text></svg>">
    <!-- 早期テーマ・タブ読み込み：CSS読み込み前に実行してちらつき防止 -->
    <script>
        (function () {
            try {
                var settings = localStorage.getItem('manhour_settings');
                if (settings) {
                    var parsed = JSON.parse(settings);
                    if (parsed.themeColor) {
                        window.__earlyThemeColor = parsed.themeColor;
                    }
                    if (parsed.themeBackgroundColor) {
                        window.__earlyBackgroundColor = parsed.themeBackgroundColor;
                    }
                }
                // 保存されたタブを読み込み
                var savedTab = localStorage.getItem('manhour_currentTab');
                if (savedTab && ['quick', 'estimate', 'actual', 'report', 'schedule', 'settings'].indexOf(savedTab) !== -1) {
                    window.__earlySavedTab = savedTab;
                }
                // モーダルデザインスタイルを早期適用
                if (parsed && parsed.modalDesignStyle === 'classic') {
                    document.documentElement.dataset.modalDesign = 'classic';
                }
                // モバイルタブデザインを読み込み・即座に適用（CSS読み込み前）
                var mobileTabDesign = localStorage.getItem('mobileTabDesign') || 'capsule';
                if (['classic', 'dock', 'capsule'].indexOf(mobileTabDesign) !== -1) {
                    document.documentElement.dataset.earlyTabDesign = mobileTabDesign;
                }
            } catch (e) { }
        })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@holiday-jp/holiday_jp/holiday_jp.min.js"></script>
    <link rel="stylesheet" href="style.css?v=20260212b">
    <style>
        /* 早期テーマ適用用のCSS変数 */
        :root {
            --early-theme-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --early-bg-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
        /* タブを初期非表示（JS初期化完了後に表示） */
        @media (max-width: 768px) {
            .tabs:not(.style-ready) {
                opacity: 0 !important;
                transform: translateY(calc(120% + env(safe-area-inset-bottom, 0px))) !important;
            }
        }
    </style>
</head>

<body>
    <!-- 早期テーマ適用スクリプト -->
    <script>
        (function () {
            var themeColor = window.__earlyThemeColor || 'deep-blue';
            var backgroundColor = window.__earlyBackgroundColor || 'same';
            var gradients = {
                'purple': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'deep-blue': 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)',
                'teal': 'linear-gradient(135deg, #0f766e 0%, #0d9488 100%)',
                'cyan': 'linear-gradient(135deg, #0891b2 0%, #06b6d4 100%)',
                'ocean': 'linear-gradient(135deg, #0c4a6e 0%, #075985 100%)',
                'sky': 'linear-gradient(135deg, #0369a1 0%, #0284c7 100%)',
                'indigo': 'linear-gradient(135deg, #4338ca 0%, #6366f1 100%)',
                'navy': 'linear-gradient(135deg, #1e40af 0%, #3b82f6 100%)',
                'slate': 'linear-gradient(135deg, #334155 0%, #475569 100%)',
                'green': 'linear-gradient(135deg, #047857 0%, #059669 100%)',
                'emerald': 'linear-gradient(135deg, #059669 0%, #10b981 100%)'
            };
            var gradient = gradients[themeColor] || gradients['deep-blue'];

            // 背景色を決定（'same'または'default'ならメインカラー、それ以外は指定色）
            var bgGradient;
            if (backgroundColor === 'same' || backgroundColor === 'default') {
                bgGradient = gradient;
            } else {
                bgGradient = gradients[backgroundColor] || gradient;
            }

            // CSS変数を設定
            document.documentElement.style.setProperty('--early-theme-gradient', gradient);
            document.documentElement.style.setProperty('--early-bg-gradient', bgGradient);
            document.documentElement.dataset.earlyTheme = themeColor;

            // 保存されたタブを早期適用
            if (window.__earlySavedTab && window.__earlySavedTab !== 'quick') {
                document.documentElement.dataset.earlyTab = window.__earlySavedTab;
            }
        })();
    </script>
    <style>
        /* 早期テーマ適用 */
        [data-early-theme] .tab.active,
        [data-early-theme] .quick-input.theme-bg,
        [data-early-theme] .stat-card.theme-bg {
            background: var(--early-theme-gradient) !important;
        }

        /* セグメントボタンのちらつき防止 */
        [data-early-theme] .segment-buttons button.active {
            background: var(--early-theme-gradient) !important;
            color: white !important;
        }

        [data-early-theme] .segment-buttons button:not(.active) {
            background: white !important;
            color: #333 !important;
        }

        /* ページ読込中の背景安定化 */
        body {
            background: var(--early-bg-gradient, var(--early-theme-gradient, linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)));
        }

        /* 早期テーマ適用：ヘッダーにテーマカラーを反映 */
        [data-early-theme] header {
            background: var(--early-theme-gradient) !important;
        }

        /* 早期タブ適用：デフォルトのquickタブを非表示にし、保存タブを表示 */
        [data-early-tab] #quick.tab-content.active {
            display: none !important;
        }

        [data-early-tab="estimate"] #estimate.tab-content {
            display: block !important;
        }

        [data-early-tab="actual"] #actual.tab-content {
            display: block !important;
        }

        [data-early-tab="report"] #report.tab-content {
            display: block !important;
        }

        [data-early-tab="settings"] #settings.tab-content {
            display: block !important;
        }

        /* 早期タブ適用：タブボタンのactive状態も切り替え */
        [data-early-tab] .tab[data-tab="quick"].active {
            background: transparent !important;
            color: inherit !important;
            box-shadow: none !important;
        }

        [data-early-tab="estimate"] .tab[data-tab="estimate"],
        [data-early-tab="actual"] .tab[data-tab="actual"],
        [data-early-tab="report"] .tab[data-tab="report"],
        [data-early-tab="settings"] .tab[data-tab="settings"] {
            background: var(--early-theme-gradient) !important;
            color: white !important;
        }
    </style>
    <div class="container">
        <header>
            <h1>工数管理システム</h1>
            <div class="header-buttons">
                <button class="btn btn-success" id="btnExportBackup">バックアップ</button>
                <button class="btn btn-primary" id="btnImportBackup">復元</button>
            </div>
        </header>

        <div class="tabs">
            <!-- フィルタドロワー（展開時に表示） -->
            <div class="tab-filter-drawer" id="tabFilterDrawer">
                <div class="tab-filter-content" id="tabFilterContent">
                    <!-- タブに応じてフィルタ内容が動的に切り替わる -->
                </div>
            </div>
            <!-- タブボタンエリア -->
            <div class="tab-buttons-wrapper">
                <div class="tab-buttons-area">
                    <div class="tab-indicator"></div>
                    <button class="tab active tab-theme-deep-blue" data-tab="quick">クイック入力</button>
                    <button class="tab" data-tab="report">レポート</button>
                    <button class="tab" data-tab="estimate">見積一覧</button>
                    <button class="tab" data-tab="actual">実績一覧</button>
                    <button class="tab" data-tab="schedule" id="scheduleTab">📅 スケジュール</button>
                    <button class="tab" data-tab="settings">⚙️ 設定</button>
                </div>
                <!-- フィルタトグルボタン（固定表示） -->
                <button class="tab-filter-toggle" id="tabFilterToggle" title="フィルタ">
                    <span class="filter-icon">▼</span>
                </button>
            </div>
        </div>

        <div class="content">
            <div id="quick" class="tab-content active">
                <div class="quick-input theme-bg theme-deep-blue">
                    <h2 id="quickModeTitle">今日の実績を入力</h2>

                    <!-- セグメントボタンを右側に配置 -->
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                        <div class="segment-buttons">
                            <button id="quickActualModeBtn" class="active">実績入力</button>
                            <button id="quickEstimateModeBtn">見積登録</button>
                            <button id="quickVacationModeBtn">休暇登録</button>
                        </div>
                    </div>

                    <!-- 実績入力フォーム -->
                    <div id="quickActualForm" class="quick-form">


                        <!-- 1. 作業日 (一番上) -->
                        <div class="form-group quick-form-date">
                            <label>作業日</label>
                            <input type="date" id="quickWorkDate"
                                style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; width: 100%; max-width: 100%; box-sizing: border-box;">
                            <script>document.getElementById('quickWorkDate').value=new Date().toLocaleDateString('sv-SE');</script>
                        </div>

                        <!-- 2. 対応検索 -->
                        <div class="form-group">
                            <label>対応検索・選択</label>
                            <div style="position: relative;">
                                <input type="text" id="quickTaskSearch" placeholder="クリックして対応を選択..." autocomplete="off"
                                    style="padding-right: 35px; background: rgba(255,255,255,0.95); color: #333; border: none;">
                                <button id="quickTaskClearBtn"
                                    style="display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer; font-size: 18px; padding: 4px 8px; line-height: 1;"
                                    title="クリア">×</button>
                                <div id="quickTaskDropdown" class="custom-dropdown" style="display: none;">
                                    <!-- JavaScriptで動的に生成 -->
                                </div>
                            </div>
                        </div>

                        <!-- 3. 担当・時間 (2列グリッド) -->
                        <div class="quick-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="form-group quick-form-member">
                                <label>担当</label>
                                <select id="quickMemberSelect"
                                    style="background: rgba(255,255,255,0.95); color: #333; border: none;">
                                    <option value="">（自動）</option>
                                </select>
                                <small style="color: rgba(255,255,255,0.7); font-size: 11px;">通常は自動</small>
                            </div>
                            <div class="form-group quick-form-hours">
                                <label>実績工数 (h)</label>
                                <input type="number" id="quickHours" step="0.25" min="0" value="8"
                                    style="background: rgba(255,255,255,0.95); color: #333; border: none;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" id="btnQuickAddActual" style="flex: 2;">追加</button>
                            <button class="btn" id="btnOpenOtherWork"
                                style="flex: 1; background: rgba(255,255,255,0.2); color: white;">その他</button>
                        </div>

                    </div>

                    <!-- 見積登録フォーム -->
                    <div id="quickEstimateForm" class="quick-form" style="display: none;">
                        <div class="form-group">
                            <label>版数</label>
                            <select id="quickEstVersion">
                                <option value="">-- 版数を選択 --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>帳票名</label>
                            <select id="quickEstFormNameSelect"
                                style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white;">
                                <option value="">-- 帳票名を選択 --</option>
                                <option value="__new__">新規入力</option>
                            </select>
                            <input type="text" id="quickEstFormName" placeholder="帳票A"
                                style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; display: none;">
                            <small
                                style="color: rgba(255,255,255,0.7); display: block; margin-top: 5px; font-size: 11px;">既存の帳票名を選択、または新規入力できます</small>
                        </div>
                        <div class="form-group">
                            <label>対応名</label>
                            <input type="text" id="quickEstTask" placeholder="X対応"
                                style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white;">
                        </div>
                        <div class="form-group">
                            <label>作業月</label>
                            <div style="display: flex; gap: 12px; margin-bottom: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="quickEstMonthType" value="single" checked
                                        style="width: auto; margin-right: 4px;">
                                    <span style="color: rgba(255,255,255,0.75); font-size: 11px;">単一月</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="quickEstMonthType" value="multi"
                                        style="width: auto; margin-right: 4px;">
                                    <span style="color: rgba(255,255,255,0.75); font-size: 11px;">複数月</span>
                                </label>
                            </div>
                            <div id="quickEstMonthInputs">
                                <div id="quickEstSingleMonthInput" style="display: block;">
                                    <select id="quickEstStartMonth"></select>
                                </div>
                                <div id="quickEstMultiMonthInput" style="display: none;">
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <select id="quickEstStartMonthMulti"></select>
                                        <span>〜</span>
                                        <select id="quickEstEndMonth"></select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <h4 style="margin-bottom: 10px; color: rgba(255,255,255,0.9);">各工程の見積</h4>
                        <div class="estimate-table-wrapper">
                            <table class="estimate-table" id="quickEstimateTable" style="width: 100%; margin: 0;">
                                <thead>
                                    <tr>
                                        <th style="width: 60px; padding: 8px; text-align: center;">工程</th>
                                        <th style="width: 120px; padding: 8px;">担当</th>
                                        <th style="width: 100px; padding: 8px;">時間</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span
                                                class="badge badge-ui">UI</span></td>
                                        <td><select id="quickEstUI_member" style="margin: 0;"></select></td>
                                        <td><input type="number" id="quickEstUI" placeholder="h" step="0.5"
                                                style="margin: 0;"></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span
                                                class="badge badge-pg">PG</span></td>
                                        <td><select id="quickEstPG_member" style="margin: 0;"></select></td>
                                        <td><input type="number" id="quickEstPG" placeholder="h" step="0.5"
                                                style="margin: 0;"></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span
                                                class="badge badge-pt">PT</span></td>
                                        <td><select id="quickEstPT_member" style="margin: 0;"></select></td>
                                        <td><input type="number" id="quickEstPT" placeholder="h" step="0.5"
                                                style="margin: 0;"></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span
                                                class="badge badge-it">IT</span></td>
                                        <td><select id="quickEstIT_member" style="margin: 0;"></select></td>
                                        <td><input type="number" id="quickEstIT" placeholder="h" step="0.5"
                                                style="margin: 0;"></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span
                                                class="badge badge-st">ST</span></td>
                                        <td><select id="quickEstST_member" style="margin: 0;"></select></td>
                                        <td><input type="number" id="quickEstST" placeholder="h" step="0.5"
                                                style="margin: 0;"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 合計表示エリア -->
                        <div id="quickEstimateTotals"
                            style="background: rgba(25, 118, 210, 0.15); padding: 12px 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #1976d2;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <span style="font-weight: 600; color: rgba(255,255,255,0.9);">対応合計:</span>
                                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                    <span style="color: rgba(255,255,255,0.95);"><strong
                                            id="quickEstTotalHours">0.0</strong> h</span>
                                    <span style="color: rgba(255,255,255,0.8);">(<span id="quickEstTotalDays">0.0</span>
                                        人日)</span>
                                    <span style="color: rgba(255,255,255,0.8);">(<span
                                            id="quickEstTotalMonths">0.00</span>
                                        人月)</span>
                                </div>
                            </div>
                        </div>

                        <!-- 月分割アシスタント -->
                        <div
                            style="background: rgba(251, 146, 60, 0.15); padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #fb923c;">
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="quickEnableMonthSplit" onchange="toggleQuickMonthSplit()"
                                        style="width: auto; margin-right: 10px;">
                                    <span style="font-weight: 600; color: #ea580c;">📅 複数月に分割して登録</span>
                                </label>
                                <small style="color: rgba(255,255,255,0.8); display: block; margin-top: 5px;">
                                    一つの工程を複数月で作業する場合に、月別の工数を設定できます
                                </small>
                            </div>

                            <div id="quickMonthSplitPanel" style="display: none; margin-top: 15px;">
                                <div class="form-group">
                                    <label>分割する工程を選択</label>
                                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="quickSplitUI"
                                                class="quick-split-process-checkbox"
                                                style="width: auto; margin-right: 5px;">
                                            <span>UI</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="quickSplitPG"
                                                class="quick-split-process-checkbox"
                                                style="width: auto; margin-right: 5px;">
                                            <span>PG</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="quickSplitPT"
                                                class="quick-split-process-checkbox"
                                                style="width: auto; margin-right: 5px;">
                                            <span>PT</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="quickSplitIT"
                                                class="quick-split-process-checkbox"
                                                style="width: auto; margin-right: 5px;">
                                            <span>IT</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="quickSplitST"
                                                class="quick-split-process-checkbox"
                                                style="width: auto; margin-right: 5px;">
                                            <span>ST</span>
                                        </label>
                                    </div>
                                    <small style="color: rgba(255,255,255,0.7); display: block; margin-top: 5px;">
                                        チェックした工程のみが月分割されます。チェックしていない工程は通常通り登録されます。
                                    </small>
                                </div>

                                <div class="form-group">
                                    <label>総工数</label>
                                    <input type="number" id="quickTotalHours" step="0.1" min="0" placeholder="例: 80">
                                    <span style="margin-left: 5px;">時間</span>
                                </div>

                                <div class="form-group">
                                    <label>作業期間</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <select id="quickStartMonth"></select>
                                        <span>〜</span>
                                        <select id="quickEndMonth"></select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>分割方法</label>
                                    <div style="display: flex; gap: 20px;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="radio" name="quickSplitMethod" value="equal" checked
                                                style="width: auto; margin-right: 5px;">
                                            <span>均等分割</span>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="radio" name="quickSplitMethod" value="manual"
                                                style="width: auto; margin-right: 5px;">
                                            <span>手動設定</span>
                                        </label>
                                    </div>
                                </div>

                                <div id="quickMonthPreview" style="margin-top: 15px;"></div>
                            </div>
                        </div>

                        <button class="btn" id="btnAddQuickEstimate"
                            style="margin-top: 15px; background: rgba(255,255,255,0.9); color: #7b3ff2; font-weight: 600;">登録</button>
                    </div>

                    <!-- 休暇登録フォーム -->
                    <div id="quickVacationForm" class="quick-form" style="display: none;">
                        <div class="form-group">
                            <label>担当者</label>
                            <select id="quickVacationMember">
                            </select>
                        </div>
                        <div class="form-group">
                            <label>日付</label>
                            <input type="date" id="quickVacationDate" style="max-width: 200px;">
                            <script>document.getElementById('quickVacationDate').value=new Date().toLocaleDateString('sv-SE');</script>
                        </div>
                        <div class="form-group">
                            <label>休暇タイプ</label>
                            <select id="quickVacationType">
                                <option value="有休">有給休暇（有休）</option>
                                <option value="特休">特別休暇（特休）</option>
                                <option value="代休">代休（代休）</option>
                                <option value="振休">振替休日（振休）</option>
                                <option value="時間休">時間休</option>
                            </select>
                        </div>
                        <div class="form-group" id="quickVacationHoursGroup">
                            <label>時間数 (h)</label>
                            <input type="number" id="quickVacationHours" step="1" min="1" placeholder="1" value="8">
                            <small style="color: rgba(255,255,255,0.8); display: block; margin-top: 5px;">
                                時間休は1h単位で入力してください。全日休暇は8hです。
                            </small>
                        </div>
                        <button class="btn" id="btnAddQuickVacation"
                            style="background: rgba(255,255,255,0.9); color: #7b3ff2; font-weight: 600;">登録</button>
                    </div>
                </div>

                <h3 id="quickBottomTitle">今日の入力済み実績</h3>
                <div id="todayActuals"></div>
            </div>

            <div id="report" class="tab-content">
                <h2>工数レポート</h2>

                <!-- バージョン1: 横並びコンパクトレイアウト -->
                <div id="reportFiltersCompact" class="inline-filter"
                    style="display: flex; flex-wrap: nowrap; gap: 10px; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 6px; overflow-x: auto;">
                    <div style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">フィルタ:</label>
                        <select id="reportFilterType" style="padding: 3px 6px; font-size: 12px;">
                            <option value="month">月別</option>
                            <option value="version">版数別</option>
                        </select>
                    </div>
                    <div id="reportMonthFilterCompact"
                        style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">表示月:</label>
                        <select id="reportMonth" style="padding: 3px 6px; font-size: 12px;">
                            <option value="all">全期間</option>
                        </select>
                    </div>
                    <div id="reportVersionFilterCompact"
                        style="display: none; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">版数:</label>
                        <select id="reportVersion" style="padding: 3px 6px; font-size: 12px;">
                            <option value="all">全版数</option>
                        </select>
                    </div>
                </div>

                <!-- バージョン2: セグメントボタンレイアウト（切り替え用） -->
                <div id="reportFiltersSegmented" class="inline-filter"
                    style="display: none; margin-bottom: 20px; background: #f8f9fa; padding: 12px; border-radius: 6px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                        <div id="reportVersionFilterSegmented" style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">版数:</label>
                            <!-- セグメントボタン版 -->
                            <div id="reportVersionButtons2" class="segment-buttons"
                                style="max-width: min(800px, calc(100vw - 110px));">
                            </div>
                            <!-- Select版（要素数が多い場合） -->
                            <select id="reportVersion2" style="padding: 4px 8px; font-size: 13px; display: none;">
                                <option value="all">全版数</option>
                            </select>
                        </div>
                        <div id="reportMonthFilterSegmented" style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">表示月:</label>
                            <!-- セグメントボタン版 -->
                            <div id="reportMonthButtons2" class="segment-buttons"
                                style="max-width: min(800px, calc(100vw - 130px));">
                            </div>
                            <!-- Select版（要素数が多い場合） -->
                            <select id="reportMonth2" style="padding: 4px 8px; font-size: 13px; display: none;">
                                <option value="all">全期間</option>
                            </select>
                        </div>
                    </div>
                </div>

                <h3 id="reportPeriodTitle">全期間の集計</h3>





                <div class="stats-grid">
                    <div class="stat-card theme-bg theme-deep-blue">
                        <h3>総見積工数</h3>
                        <div class="value" id="totalEstimate">0h</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 5px;"
                            id="totalEstimateManpower"></div>
                    </div>
                    <div class="stat-card theme-bg theme-deep-blue">
                        <h3>総実績工数</h3>
                        <div class="value" id="totalActual">0h</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 5px;"
                            id="totalActualManpower"></div>
                    </div>
                    <div class="stat-card theme-bg theme-deep-blue">
                        <h3>差異</h3>
                        <div class="value" id="totalDiff">0h</div>
                    </div>
                    <div class="stat-card theme-bg theme-deep-blue">
                        <h3>実績率</h3>
                        <div class="value" id="actualRate">0%</div>
                    </div>
                </div>

                <!-- キャパシティ分析 -->
                <div id="capacityAnalysis" class="capacity-analysis-section" style="margin: 20px 0; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); padding: 20px 24px; border-radius: 12px; border: 1px solid #cbd5e1;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: #334155;">キャパシティ分析</h4>
                            <span id="capacityWarningBadge" class="capacity-warning-badge" style="display: none;">⚠️ 超過中</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 14px; color: #64748b;">
                                標準: <strong id="capacityStandard" style="color: #334155; font-size: 16px;">176h</strong>
                                <span style="font-size: 12px; color: #94a3b8;" id="capacityStandardDetail">(22日×8h×1人)</span>
                            </div>
                            <!-- 設定ボタン -->
                            <div style="position: relative;">
                                <button id="capacitySettingsBtn" class="capacity-settings-btn" title="表示設定">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                    </svg>
                                </button>
                                <div id="capacitySettingsDropdown" class="capacity-settings-dropdown">
                                    <label><input type="radio" name="capacityDisplayMode" value="simple"> シンプル</label>
                                    <label><input type="radio" name="capacityDisplayMode" value="warning_bg" checked> 超過時に背景変化</label>
                                    <label><input type="radio" name="capacityDisplayMode" value="warning_badge"> 超過時に警告バッジ</label>
                                    <label><input type="radio" name="capacityDisplayMode" value="gauge"> ゲージ表示</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- バー表示（デフォルト） -->
                    <div id="capacityBarView">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <!-- ラベル列 -->
                            <div style="display: flex; flex-direction: column; gap: 6px; width: 45px; flex-shrink: 0;">
                                <div style="font-size: 13px; color: #64748b; text-align: right; font-weight: 500; height: 24px; line-height: 24px;">見積</div>
                                <div style="font-size: 13px; color: #64748b; text-align: right; font-weight: 500; height: 24px; line-height: 24px;">実績</div>
                            </div>
                            <!-- バーコンテナ（グレー背景=100%、超過分ははみ出る） -->
                            <div id="capacityBarContainer" style="flex: 1; position: relative; overflow: visible;">
                                <!-- 見積バー -->
                                <div id="capacityEstimateBarRow" style="position: relative; height: 24px; margin-bottom: 6px;">
                                    <!-- 100%の背景 -->
                                    <div class="capacity-bg-bar" style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: linear-gradient(90deg, #e2e8f0 0%, #cbd5e1 100%); border-radius: 12px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);"></div>
                                    <!-- 実際のバー -->
                                    <div id="capacityEstimateBar" style="position: absolute; left: 0; top: 0; height: 100%; width: 70%; background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 12px; transition: width 0.3s ease;"></div>
                                    <!-- 超過部分（100%超えた分のみ表示） -->
                                    <div id="capacityEstimateStripe" class="capacity-bar-overflow" style="display: none;"></div>
                                </div>
                                <!-- 実績バー -->
                                <div id="capacityActualBarRow" style="position: relative; height: 24px;">
                                    <!-- 100%の背景 -->
                                    <div class="capacity-bg-bar" style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: linear-gradient(90deg, #e2e8f0 0%, #cbd5e1 100%); border-radius: 12px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);"></div>
                                    <!-- 実際のバー -->
                                    <div id="capacityActualBar" style="position: absolute; left: 0; top: 0; height: 100%; width: 52%; background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%); border-radius: 12px; transition: width 0.3s ease;"></div>
                                    <!-- 超過部分（100%超えた分のみ表示） -->
                                    <div id="capacityActualStripe" class="capacity-bar-overflow" style="display: none;"></div>
                                </div>
                            </div>
                            <!-- 数値列 -->
                            <div style="display: flex; flex-direction: column; gap: 6px; min-width: 100px; flex-shrink: 0;">
                                <div style="font-size: 15px; font-weight: 600; color: #334155; height: 24px; line-height: 24px;" id="capacityEstimateText">160h (91%)</div>
                                <div style="font-size: 15px; font-weight: 600; color: #334155; height: 24px; line-height: 24px;" id="capacityActualText">120h (68%)</div>
                            </div>
                        </div>
                    </div>

                    <!-- ゲージ表示（切り替え時） -->
                    <div id="capacityGaugeView" class="capacity-gauge-container" style="display: none;">
                        <!-- 見積ゲージ -->
                        <div class="capacity-gauge" id="capacityEstimateGauge">
                            <div class="capacity-gauge-bg"></div>
                            <div class="capacity-gauge-fill"></div>
                            <div class="capacity-gauge-mask"></div>
                            <div class="capacity-gauge-needle" id="capacityEstimateNeedle" style="transform: translateX(-50%) rotate(-90deg);"></div>
                            <div class="capacity-gauge-center"></div>
                            <div class="capacity-gauge-value" id="capacityEstimateGaugeValue">0%</div>
                            <div class="capacity-gauge-label" id="capacityEstimateGaugeLabel">見積 0h</div>
                        </div>
                        <!-- 実績ゲージ -->
                        <div class="capacity-gauge" id="capacityActualGauge">
                            <div class="capacity-gauge-bg"></div>
                            <div class="capacity-gauge-fill"></div>
                            <div class="capacity-gauge-mask"></div>
                            <div class="capacity-gauge-needle" id="capacityActualNeedle" style="transform: translateX(-50%) rotate(-90deg);"></div>
                            <div class="capacity-gauge-center"></div>
                            <div class="capacity-gauge-value" id="capacityActualGaugeValue" style="color: #22c55e;">0%</div>
                            <div class="capacity-gauge-label" id="capacityActualGaugeLabel">実績 0h</div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-top: 14px; font-size: 14px;">
                        <div id="capacityDiffContainer">
                            <span style="color: #64748b;">余裕:</span>
                            <strong id="capacityDiff" style="color: #16a34a; font-size: 16px;">+16h</strong>
                        </div>
                        <div>
                            <span id="capacityRemainingLabel" style="color: #64748b;">実績残り:</span>
                            <strong id="capacityRemaining" style="color: #334155; font-size: 16px;">56h</strong>
                        </div>
                    </div>
                </div>

                <!-- 換算基準表示エリア -->
                <div id="reportConversionParams"
                    style="margin-bottom: 25px; background: #e3f2fd; padding: 10px 15px; border-radius: 6px; font-size: 13px; color: #1565c0; display: none;">
                </div>



                <div id="reportDetailView"></div>

                <h3>担当者別工数</h3>
                <div id="memberReport"></div>

                <h3 style="margin-top: 20px;">版数別進捗</h3>
                <div id="versionReport"></div>

                <!-- 進捗管理セクション（折りたたみ可能） -->
                <div style="margin-top: 30px; background: #f8f9fa; padding: 20px 0; border-radius: 8px;">
                    <h3 onclick="window.toggleProgressSection && window.toggleProgressSection()" 
                        style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
                        <span id="progressSectionIcon" style="font-size: 12px; width: 16px;">▶</span>
                        進捗管理（見込残存時間ベース）
                    </h3>
                    
                    <div id="progressSectionContent" style="display: none;">
                        <p style="color: #666; margin-bottom: 15px; font-size: 13px;">
                            見込残存時間を入力すると、より正確な進捗率と予測総工数が表示されます。
                        </p>

                        <!-- フィルタ -->
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
                            <select id="progressVersionFilter"
                                style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="all">全版数</option>
                            </select>
                            <select id="progressStatusFilter"
                                style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="all">全ステータス</option>
                                <option value="completed">完了</option>
                                <option value="ontrack">順調</option>
                                <option value="warning">注意</option>
                                <option value="exceeded">超過</option>
                            </select>
                            <button class="btn btn-primary" id="btnOpenBulkRemaining"
                                style="padding: 8px 16px; font-size: 13px;">
                                一括編集
                            </button>
                        </div>

                        <!-- 進捗サマリーカード -->
                        <div class="stats-grid" id="progressSummaryCards">
                            <!-- 動的に生成 -->
                        </div>

                        <!-- 詳細テーブル -->
                        <div id="progressDetailTable" style="margin-top: 20px;">
                            <!-- 動的に生成 -->
                        </div>
                    </div>
                </div>

                <!-- Excel出力セクション -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 30px 0;">
                    <h3>📊 Excel出力</h3>
                    <p style="color: #666; margin-bottom: 15px;">実績データと見積データをExcel形式で出力します。</p>

                    <div style="margin-bottom: 15px;">
                        <h4 style="margin-bottom: 8px; font-size: 14px;">出力内容:</h4>
                        <ul style="color: #666; font-size: 13px; margin-left: 20px;">
                            <li><strong>実績シート（担当者別）:</strong> 日付、曜日、備考、作業、時間</li>
                            <li><strong>見積シート:</strong> 版数、作業月、対応名、工程、担当、見積工数</li>
                        </ul>
                    </div>

                    <button class="btn btn-success" id="btnExportExcel" style="font-weight: 600;">
                        📥 Excelファイルをダウンロード
                    </button>
                </div>
            </div>

            <div id="estimate" class="tab-content">
                <h2>見積一覧</h2>

                <!-- 合計工数表示 -->
                <div id="estimateTotalCard"
                    style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">合計工数</div>
                            <div style="font-size: 28px; font-weight: bold;" id="estimateTotalHours">0h</div>
                        </div>
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">人日 / 人月</div>
                            <div style="font-size: 18px; font-weight: 600;" id="estimateTotalManpower">0人日 / 0人月
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 担当者別合計表示 -->
                <div id="estimateMemberSummary"
                    style="background: #f8f9fa; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none;">
                    <div style="font-size: 14px; font-weight: 600; color: #495057; margin-bottom: 10px;">担当者別合計
                    </div>
                    <div id="estimateMemberSummaryContent" style="display: flex; flex-wrap: wrap; gap: 12px;">
                    </div>
                </div>

                <!-- 新規登録ボタン -->
                <button class="btn btn-primary" id="btnOpenAddEstimateModal"
                    style="margin-bottom: 15px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                    <span style="font-size: 16px;">+</span> 新規登録
                </button>

                <!-- バージョン1: 横並びコンパクトレイアウト -->
                <div id="estimateFiltersCompact" class="inline-filter" style="margin-bottom: 20px;">
                    <div
                        style="display: flex; flex-wrap: nowrap; gap: 10px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 6px; overflow-x: auto;">
                        <div style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                            <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">フィルタ:</label>
                            <select id="estimateFilterType" style="padding: 3px 6px; font-size: 12px;">
                                <option value="month">月別</option>
                                <option value="version">版数別</option>
                            </select>
                        </div>
                        <div id="estimateMonthFilterCompact"
                            style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                            <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">表示月:</label>
                            <select id="estimateMonthFilter" style="padding: 3px 6px; font-size: 12px;">
                                <option value="all">全期間</option>
                            </select>
                        </div>
                        <div id="estimateVersionFilterCompact"
                            style="display: none; align-items: center; gap: 5px; flex-shrink: 0;">
                            <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">版数:</label>
                            <select id="estimateVersionFilter" style="padding: 3px 6px; font-size: 12px;">
                                <option value="all">全版数</option>
                            </select>
                        </div>

                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 10px;">
                        <label
                            style="display: flex; align-items: center; cursor: pointer; user-select: none; font-size: 12px; font-weight: 500; white-space: nowrap;">
                            <input type="checkbox" id="workMonthSelectionMode" style="width: auto; margin-right: 5px;">
                            <span>作業月割り当て</span>
                        </label>
                    </div>
                </div>

                <!-- バージョン2: セグメントボタンレイアウト（切り替え用） -->
                <div id="estimateFiltersSegmented" class="inline-filter"
                    style="display: none; margin-bottom: 20px; background: #f8f9fa; padding: 12px; border-radius: 6px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                        <div id="estimateVersionFilterSegmented" style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">版数:</label>
                            <!-- セグメントボタン版 -->
                            <div id="estimateVersionButtons2" class="segment-buttons"
                                style="max-width: min(800px, calc(100vw - 110px));">
                            </div>
                            <!-- Select版（セグメントボタン生成用に必要） -->
                            <select id="estimateVersionFilter2"
                                style="padding: 4px 8px; font-size: 13px; display: none;">
                                <option value="all">全版数</option>
                            </select>
                        </div>

                        <div id="estimateMonthFilterSegmented" style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">表示月:</label>
                            <!-- セグメントボタン版 -->
                            <div id="estimateMonthButtons2" class="segment-buttons"
                                style="max-width: min(800px, calc(100vw - 130px));">
                            </div>
                            <!-- Select版（セグメントボタン生成用に必要） -->
                            <select id="estimateMonthFilter2" style="padding: 4px 8px; font-size: 13px; display: none;">
                                <option value="all">全期間</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 10px;">
                        <label
                            style="display: flex; align-items: center; cursor: pointer; user-select: none; font-size: 13px; font-weight: 500; white-space: nowrap;">
                            <input type="checkbox" id="workMonthSelectionMode2" style="width: auto; margin-right: 5px;">
                            <span>作業月割り当て</span>
                        </label>
                    </div>
                </div>

                <!-- 作業月割り当てモード（フロート表示） -->
                <div id="workMonthAssignmentMode"
                    style="display: none; background: linear-gradient(135deg, #fff3cd 0%, #ffe5a0 100%); padding: 18px; border-radius: 8px; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.2); border-left: 4px solid #ffc107; max-width: 90vw;">
                    <!-- ドラッグハンドル -->
                    <div id="dragHandle"
                        style="position: absolute; top: 0; left: 0; right: 0; height: 8px; background: rgba(0,0,0,0.1); border-radius: 8px 8px 0 0; cursor: ns-resize; display: flex; align-items: center; justify-content: center; z-index: 1;">
                        <div style="width: 40px; height: 4px; background: rgba(0,0,0,0.3); border-radius: 2px;">
                        </div>
                    </div>

                    <!-- 閉じるボタン -->
                    <!-- 閉じるボタン -->
                    <button id="btnCloseWorkMonthAssignmentMode"
                        style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 2px solid #856404; font-size: 20px; font-weight: bold; color: #856404; cursor: pointer; padding: 0; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.2); line-height: 1;"
                        onmouseover="this.style.background='#856404'; this.style.color='white';"
                        onmouseout="this.style.background='rgba(255,255,255,0.9)'; this.style.color='#856404';">&times;</button>

                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-top: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: 600; color: #856404;">割り当て先:</label>
                            <select id="assignWorkMonth"
                                style="padding: 8px 12px; border: 2px solid #ffc107; border-radius: 6px; font-weight: 500; font-size: 14px; background: white;">
                            </select>
                        </div>
                        <button class="btn btn-success" id="btnExecuteWorkMonthAssignment"
                            style="margin: 0; font-weight: 600; padding: 8px 20px;">
                            ✓ 割り当て実行
                        </button>
                        <button class="btn" id="btnCancelWorkMonthSelection"
                            style="margin: 0; background: #6c757d; color: white; padding: 8px 16px;">
                            選択解除
                        </button>
                        <div id="selectedWorkHours"
                            style="margin-left: auto; font-weight: 700; font-size: 18px; color: #1976d2; white-space: nowrap;">
                            選択中: 0h (0人日 / 0人月)
                        </div>
                    </div>
                </div>



                <!-- 換算基準表示エリア -->
                <div id="estimateConversionParams"
                    style="margin-bottom: 15px; margin-top: 0px; background: #e3f2fd; padding: 10px 15px; border-radius: 6px; font-size: 13px; color: #1565c0; display: none;">
                </div>

                <div id="estimateList"></div>

                <div id="estimateMemberSummary" style="margin-top: 30px; display: none;"></div>


            </div>

            <div id="actual" class="tab-content">
                <h2>実績データ一覧</h2>

                <!-- バージョン1: 横並びコンパクトレイアウト -->
                <div id="actualFiltersCompact" class="inline-filter"
                    style="display: flex; flex-wrap: nowrap; gap: 10px; align-items: center; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 6px; overflow-x: auto;">
                    <div style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">表示モード:</label>
                        <select id="actualViewMode" style="padding: 3px 6px; font-size: 12px;">
                            <option value="all">全担当者</option>
                            <option value="member">担当者別</option>
                        </select>
                    </div>

                    <div id="memberSelectGroup" style="display: none; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">担当者:</label>
                        <select id="actualMemberSelect" style="padding: 3px 6px; font-size: 12px;">
                        </select>
                    </div>

                    <div style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">表示形式:</label>
                        <select id="actualViewType" style="padding: 3px 6px; font-size: 12px;">
                            <option value="matrix">カレンダー</option>
                            <option value="list">リスト</option>
                        </select>
                    </div>

                    <div style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                        <label style="font-size: 12px; font-weight: 500; white-space: nowrap;">表示期間:</label>
                        <select id="actualMonthFilter" style="padding: 3px 6px; font-size: 12px;">
                            <option value="all">全期間</option>
                        </select>
                    </div>
                </div>

                <!-- バージョン2: セグメントボタンレイアウト（切り替え用） -->
                <div id="actualFiltersSegmented" class="inline-filter"
                    style="display: none; margin-bottom: 20px; background: #f8f9fa; padding: 12px; border-radius: 6px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">表示モード:</label>
                            <select id="actualViewMode2" style="padding: 4px 8px; font-size: 13px;">
                                <option value="all">全担当者</option>
                                <option value="member">担当者別</option>
                            </select>
                        </div>

                        <div id="memberSelectGroup2" style="display: none; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">担当者:</label>
                            <!-- セグメントボタン版 -->
                            <div id="actualMemberButtons2" class="segment-buttons"
                                style="max-width: min(600px, calc(100vw - 120px));">
                            </div>
                            <!-- Select版（要素数が多い場合） -->
                            <select id="actualMemberSelect2" style="padding: 4px 8px; font-size: 13px; display: none;">
                            </select>
                        </div>

                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">表示形式:</label>
                            <div class="segment-buttons">
                                <button id="btnActualMatrix" class="active">カレンダー</button>
                                <button id="btnActualList">リスト</button>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label style="font-size: 13px; font-weight: 500; white-space: nowrap;">表示期間:</label>
                            <!-- セグメントボタン版 -->
                            <div id="actualMonthButtons2" class="segment-buttons"
                                style="max-width: min(800px, calc(100vw - 140px));">
                            </div>
                            <!-- Select版（要素数が多い場合） -->
                            <select id="actualMonthFilter2" style="padding: 4px 8px; font-size: 13px; display: none;">
                                <option value="all">全期間</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="actualList"></div>
            </div>
            <!-- /report -->

            <!-- [GANTT-CHART] スケジュールタブ -->
            <div id="schedule" class="tab-content">
                <!-- ツールバー -->
                <div class="schedule-toolbar">
                    <div class="schedule-nav">
                        <button onclick="navigateScheduleMonth(-1)" class="schedule-nav-btn">◀ 前月</button>
                        <span id="scheduleCurrentMonth" class="schedule-current-month">2026年1月</span>
                        <button onclick="navigateScheduleMonth(1)" class="schedule-nav-btn">次月 ▶</button>
                        <button onclick="goToScheduleToday()" class="schedule-nav-btn schedule-today-btn">今日</button>
                    </div>
                    <div class="schedule-view-toggle">
                        <button onclick="setScheduleViewMode('member')" class="schedule-view-btn active"
                            id="viewMemberBtn">担当者別</button>
                        <button onclick="setScheduleViewMode('task')" class="schedule-view-btn"
                            id="viewTaskBtn">タスク別</button>
                    </div>
                    <div class="schedule-actions">
                        <button onclick="exportSchedulesToExcel()" class="btn btn-outline" title="Excel出力">📥 出力</button>
                        <span class="unscheduled-wrapper">
                            <button onclick="openAutoGenerateModal()" class="btn btn-secondary" style="position:relative;">⚡ 自動生成<span id="unscheduledBadge" class="unscheduled-badge" style="display:none;" onclick="event.stopPropagation(); toggleUnscheduledDropdown()"></span></button>
                            <div id="unscheduledDropdown" class="unscheduled-dropdown" style="display:none;"></div>
                        </span>
                        <button onclick="openCreateScheduleModal()" class="btn btn-primary" title="キーボード: N">+
                            予定作成</button>
                        <span class="keyboard-hint"
                            title="キーボードショートカット: N=新規, ←→=月移動, T=今日, M=担当者別, K=タスク別, Esc=閉じる">⌨️</span>
                    </div>
                </div>

                <!-- フィルタバー -->
                <div class="schedule-filter-bar">
                    <div class="schedule-filter-item">
                        <label>版数</label>
                        <select id="scheduleFilterVersion" onchange="applyScheduleFilters()">
                            <option value="">すべて</option>
                        </select>
                    </div>
                    <div class="schedule-filter-item">
                        <label>担当者</label>
                        <select id="scheduleFilterMember" onchange="applyScheduleFilters()">
                            <option value="">すべて</option>
                        </select>
                    </div>
                    <div class="schedule-filter-item">
                        <label>ステータス</label>
                        <select id="scheduleFilterStatus" onchange="applyScheduleFilters()">
                            <option value="">すべて</option>
                            <option value="pending">未着手</option>
                            <option value="in_progress">進行中</option>
                            <option value="completed">完了</option>
                        </select>
                    </div>
                    <button onclick="clearScheduleFilters()" class="btn btn-sm btn-outline">クリア</button>
                    <button onclick="deleteFilteredSchedules()" class="btn btn-sm btn-danger-outline"
                        title="フィルタされたスケジュールを削除">🗑️ 一括削除</button>
                    <span class="filter-result-count" id="scheduleFilterCount"></span>
                </div>

                <!-- サマリーパネル -->
                <div class="schedule-summary" id="scheduleSummary">
                    <div class="schedule-summary-item">
                        <span class="schedule-summary-label">完了</span>
                        <span class="schedule-summary-value" id="summaryCompleted">0/0</span>
                    </div>
                    <div class="schedule-summary-item">
                        <span class="schedule-summary-label">進行中</span>
                        <span class="schedule-summary-value schedule-active" id="summaryInProgress">0件</span>
                    </div>
                    <div class="schedule-summary-item">
                        <span class="schedule-summary-label">遅延</span>
                        <span class="schedule-summary-value schedule-warning" id="summaryDelayed">0件</span>
                    </div>
                    <div class="schedule-summary-item">
                        <span class="schedule-summary-label">残作業</span>
                        <span class="schedule-summary-value" id="summaryRemaining">0h</span>
                    </div>
                    <div class="schedule-summary-item">
                        <span class="schedule-summary-label">本日の予定</span>
                        <span class="schedule-summary-value schedule-today" id="summaryToday">0件</span>
                    </div>
                </div>

                <!-- ガントチャート -->
                <div class="gantt-container" id="ganttContainer">
                    <canvas id="ganttCanvas"></canvas>
                </div>

                <!-- 空の状態メッセージ -->
                <div id="scheduleEmptyMessage" class="schedule-empty-message" style="display: none;">
                    <p>スケジュールがありません</p>
                    <p style="font-size: 14px; color: #888;">「+ 予定作成」ボタンから予定を追加してください</p>
                </div>
            </div>
            <!-- /schedule -->

            <div id="settings" class="tab-content">
                <h2>⚙️ 設定</h2>

                <!-- テーマカラー設定 -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>🎨 テーマカラー</h3>
                    <p style="color: #666; margin-bottom: 15px;">アプリの配色を変更できます。クイック入力エリア、レポート集計、アクティブタブに適用されます。</p>

                    <div class="form-group">
                        <label>色</label>
                        <select id="themeColor">
                            <option value="deep-blue">ディープブルー</option>
                            <option value="teal">ティール</option>
                            <option value="cyan">シアン</option>
                            <option value="ocean">オーシャン</option>
                            <option value="sky">スカイブルー</option>
                            <option value="indigo">インディゴ</option>
                            <option value="navy">ネイビー</option>
                            <option value="slate">スレート</option>
                            <option value="green">グリーン</option>
                            <option value="emerald">エメラルド</option>
                            <option value="purple">紫</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>デザイン</label>
                        <select id="themePattern">
                            <option value="none">シンプル（模様なし）</option>
                            <option value="wave">波模様</option>
                            <option value="stripe">右ストライプ</option>
                            <option value="glow">グロー効果</option>
                            <option value="corner">コーナーアクセント</option>
                            <option value="dot">ドット</option>
                            <option value="dots">複数ドット</option>
                            <option value="diagonal">斜線パターン</option>
                            <option value="circle">サークル</option>
                            <option value="layer">レイヤー</option>
                            <option value="line">グラデーションライン</option>
                            <option value="bar">左バー</option>
                            <option value="border">上部ボーダー</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>タブの色</label>
                        <select id="themeTabColor">
                            <option value="same">メインカラーと同じ</option>
                            <option value="default">デフォルト（青）</option>
                            <option value="deep-blue">ディープブルー</option>
                            <option value="teal">ティール</option>
                            <option value="cyan">シアン</option>
                            <option value="ocean">オーシャン</option>
                            <option value="sky">スカイブルー</option>
                            <option value="indigo">インディゴ</option>
                            <option value="navy">ネイビー</option>
                            <option value="slate">スレート</option>
                            <option value="green">グリーン</option>
                            <option value="emerald">エメラルド</option>
                            <option value="purple">紫</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            タブの色を個別に設定できます
                        </small>
                    </div>

                    <div class="form-group">
                        <label>背景色</label>
                        <select id="themeBackgroundColor">
                            <option value="same">メインカラーと同じ</option>
                            <option value="deep-blue">ディープブルー</option>
                            <option value="teal">ティール</option>
                            <option value="cyan">シアン</option>
                            <option value="ocean">オーシャン</option>
                            <option value="sky">スカイブルー</option>
                            <option value="indigo">インディゴ</option>
                            <option value="navy">ネイビー</option>
                            <option value="slate">スレート</option>
                            <option value="green">グリーン</option>
                            <option value="emerald">エメラルド</option>
                            <option value="purple">紫</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ページ全体の背景色を個別に設定できます
                        </small>
                    </div>

                    <!-- プレビュー -->
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">プレビュー</label>
                        <div id="themePreview"
                            style="padding: 20px; border-radius: 8px; color: white; position: relative; overflow: hidden;">
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">クイック実績入力</div>
                            <div style="font-size: 14px;">レポート集計カード・アクティブタブにも適用されます</div>
                        </div>
                    </div>

                    <small style="color: #666; display: block; margin-top: 10px;">
                        ・設定は自動的に保存されます<br>
                        ・ページをリロードしても設定は保持されます
                    </small>
                </div>

                <!-- マトリクス表示の月色分け設定 -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>📊 マトリクス表示</h3>
                    <p style="color: #666; margin-bottom: 15px;">見積一覧・レポートのマトリクス表示に関する設定です。</p>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="showMonthColorsCheckbox" style="width: auto; margin-right: 10px;"
                                checked>
                            <span>見積一覧で月ごとに色分けする</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ・オン: 見積一覧（全期間表示・月別表示）で工程の割当月に応じてセルを色分けします<br>
                            ・オフ: 色分けを無効にします
                        </small>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">レポートマトリクスの背景色</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                <input type="radio" name="reportMatrixBgColorMode" value="none"
                                    style="margin-top: 3px; margin-right: 8px; flex-shrink: 0;">
                                <span style="flex: 1;">
                                    <strong>なし（白背景）</strong><br>
                                    <small style="color: #666;">背景色を表示しません</small>
                                </span>
                            </label>
                            <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                <input type="radio" name="reportMatrixBgColorMode" value="month"
                                    style="margin-top: 3px; margin-right: 8px; flex-shrink: 0;" checked>
                                <span style="flex: 1;">
                                    <strong>月ごとの色</strong><br>
                                    <small style="color: #666;">作業月に応じて背景色を表示します（見積一覧と同様）</small>
                                </span>
                            </label>
                            <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                <input type="radio" name="reportMatrixBgColorMode" value="deviation"
                                    style="margin-top: 3px; margin-right: 8px; flex-shrink: 0;">
                                <span style="flex: 1;">
                                    <strong>乖離率の色</strong><br>
                                    <small style="color: #666;">見積と実績の乖離率に応じて背景色をグラデーション表示します</small>
                                </span>
                            </label>
                        </div>
                        <small style="color: #666; display: block; margin-top: 10px;">
                            月別表示・版数別表示・全期間表示すべてに適用されます
                        </small>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="showProgressBarsCheckbox"
                                style="width: auto; margin-right: 10px; flex-shrink: 0;" checked>
                            <span>レポートで進捗バーを表示する</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ・オン: レポートのマトリクス表示で見込残存時間ベースの進捗バーを表示します<br>
                            ・オフ: 進捗バーを非表示にします
                        </small>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">進捗バーのスタイル</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                <input type="radio" name="progressBarStyle" value="inline"
                                    style="margin-top: 3px; margin-right: 8px; flex-shrink: 0;" checked>
                                <span style="flex: 1;">
                                    <strong>セル内に表示</strong><br>
                                    <small style="color: #666;">進捗バーをセルのコンテンツとして表示（パーセンテージ表示可能）</small>
                                </span>
                            </label>
                            <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                <input type="radio" name="progressBarStyle" value="bottom"
                                    style="margin-top: 3px; margin-right: 8px; flex-shrink: 0;">
                                <span style="flex: 1;">
                                    <strong>セル下部に表示</strong><br>
                                    <small style="color: #666;">進捗バーをセルの下部枠線として表示（パーセンテージは非表示）</small>
                                </span>
                            </label>
                        </div>
                        <small style="color: #666; display: block; margin-top: 10px;">
                            進捗バーの表示位置を選択できます
                        </small>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="showProgressPercentageCheckbox"
                                style="width: auto; margin-right: 10px; flex-shrink: 0;" checked>
                            <span>進捗バーにパーセンテージを表示する</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ・オン: 進捗バーの下にパーセンテージ（例: 75%）を表示します<br>
                            ・オフ: パーセンテージを非表示にします（ツールチップで確認可能）<br>
                            ・注意: 「セル下部に表示」スタイルではパーセンテージは表示されません
                        </small>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label
                            style="font-weight: 600; margin-bottom: 10px; display: block;">見積と実績の表示形式（レポートのマトリクス）</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                <input type="radio" name="matrixEstActFormat" value="twoRows"
                                    style="margin-top: 3px; margin-right: 8px; flex-shrink: 0;" checked>
                                <span style="flex: 1;">
                                    <strong>2行表示</strong><br>
                                    <small style="color: #666;">見積と実績を2行で表示（見積は細字、実績は太字）</small>
                                </span>
                            </label>
                            <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                <input type="radio" name="matrixEstActFormat" value="slash"
                                    style="margin-top: 3px; margin-right: 8px; flex-shrink: 0;">
                                <span style="flex: 1;">
                                    <strong>スラッシュ横並び</strong><br>
                                    <small style="color: #666;">例: 10.0 / 15.5</small>
                                </span>
                            </label>
                        </div>
                        <small style="color: #666; display: block; margin-top: 10px;">
                            レポートタブのマトリクス表示で、見積と実績をどのように表示するか選択できます
                        </small>
                    </div>


                </div>

                <!-- 表示形式設定 -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>📋 表示形式</h3>
                    <p style="color: #666; margin-bottom: 15px;">見積一覧とレポートの表示形式を設定できます。</p>

                    <div class="form-group">
                        <label>見積一覧の表示形式</label>
                        <select id="defaultEstimateViewType">
                            <option value="grouped">グループ</option>
                            <option value="matrix" selected>マトリクス</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>レポートの表示形式</label>
                        <select id="defaultReportViewType">
                            <option value="grouped">グループ</option>
                            <option value="matrix" selected>マトリクス</option>
                        </select>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>自動バックアップ</h3>
                    <p style="color: #666; margin-bottom: 15px;">データ保存時に自動的にJSONファイルをダウンロードします。</p>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="autoBackupEnabled" style="width: auto; margin-right: 10px;">
                            <span>自動バックアップを有効にする</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ・オンにすると、実績や見積の登録・編集時に自動でバックアップファイルがダウンロードされます<br>
                            ・オフにしても、手動バックアップボタンは使用できます
                        </small>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>クイック入力モード</h3>
                    <p style="color: #666; margin-bottom: 15px;">クイック入力タブの実績入力/見積登録モードの動作を設定できます。</p>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="rememberQuickInputMode" style="width: auto; margin-right: 10px;">
                            <span>前回のモード（実績/見積）を記憶する</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ・オフ（デフォルト）: 常に実績入力モードで開始します<br>
                            ・オン: 前回使用したモード（実績入力 or 見積登録）を記憶し、次回も同じモードで開始します
                        </small>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>担当者表示順</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        担当者の表示順序を指定できます。この順序は実績一覧、レポート、入力フォームなど全ての画面に適用されます。
                    </p>

                    <div class="form-group">
                        <label>表示順序 <button id="btnShowMemberOrderHelp"
                                style="border: none; background: none; cursor: pointer; color: #3498db; font-size: 18px;">ℹ️</button></label>
                        <input type="text" id="memberOrder" placeholder="例: A,B,C,D または 山田,佐藤,田中">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ・カンマ区切りで入力してください<br>
                            ・指定した順番で表示されます<br>
                            ・指定していない担当者は後ろにアルファベット順で表示されます<br>
                            ・設定は自動的に保存されます
                        </small>
                    </div>

                    <button class="btn btn-primary" id="btnUpdateAllDisplays" style="margin-top: 10px;">設定を適用</button>
                </div>

                <!-- UI/UX設定 -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>🖥️ UI/UX設定</h3>
                    <p style="color: #666; margin-bottom: 15px;">画面表示や操作性に関する設定です。</p>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="tabBarAlwaysVisible" style="width: auto; margin-right: 10px;">
                            <span>タブバーを常に表示する</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px; margin-left: 30px;">
                            スクロール時もタブバーを隠さずに常に表示します。
                        </small>
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="tabFilterAlwaysExpanded" style="width: auto; margin-right: 10px;">
                            <span>タブ内フィルタを常に展開する</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px; margin-left: 30px;">
                            タブバー内のフィルタセクションを常に展開状態で表示します。
                        </small>
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="hideInlineFilters" style="width: auto; margin-right: 10px;">
                            <span>ページ内フィルタを非表示にする</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px; margin-left: 30px;">
                            各タブ内のフィルタエリアを非表示にします。実績一覧の表示形式切替はタブフィルタに統合されます。
                        </small>
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label>フィルタボタンのスタイル</label>
                        <select id="tabFilterButtonStyle">
                            <option value="pill">丸ボタン（Pill）</option>
                            <option value="segment">四角ボタン（Segment）</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px; margin-left: 30px;">
                            タブ内フィルタのボタンデザインを選択できます。
                        </small>
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label>フィルタのレイアウト（PC表示時）</label>
                        <select id="tabFilterLayout">
                            <option value="two-lines">2行表示</option>
                            <option value="one-line">1行表示</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px; margin-left: 30px;">
                            PC表示時のフィルタ表示レイアウトを選択できます。
                        </small>
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label>UIデザイン</label>
                        <select id="modalDesignStyle">
                            <option value="modern">モダン（デフォルト）</option>
                            <option value="classic">クラシック</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px; margin-left: 30px;">
                            全モーダル・カレンダー・アラートのデザインを切り替えます。
                        </small>
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label>モバイルタブのデザイン</label>
                        <select id="mobileTabDesign">
                            <option value="classic">Classic (標準)</option>
                            <option value="dock" selected>Solid Dock (ネイティブ風)</option>
                            <option value="capsule">Floating Capsule (モダン)</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px; margin-left: 30px;">
                            スマートフォン表示時の下部タブバーのデザインを選択できます。
                        </small>
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="debugModeEnabled" style="width: auto; margin-right: 10px;">
                            <span>デバッグモードを有効にする</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px; margin-left: 30px;">
                            エラー発生時に詳細なエラーメッセージを表示します。通常はオフで問題ありません。
                        </small>
                    </div>

                    <!-- 開発中の機能設定（現在未使用・将来の機能追加時に再利用） -->
                    <div class="form-group" style="margin-top: 15px; display: none;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="devFeaturesEnabled" style="width: auto; margin-right: 10px;">
                            <span>開発中の機能を表示する</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px; margin-left: 30px;">
                            開発中の機能（スケジュール/ガントチャートなど）を表示します。機能が不完全な場合があります。
                        </small>
                    </div>
                </div>

                <!-- グラフカラーパターン設定 -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>🎨 グラフカラーパターン</h3>
                    <p style="color: #666; margin-bottom: 15px;">レポートの担当者分析グラフ（見積・実績の棒グラフと工数内訳ドーナツグラフ）の配色を変更できます。
                    </p>

                    <div class="form-group">
                        <label>カラーパターン</label>
                        <select id="chartColorScheme">
                            <option value="auto">テーマカラーに合わせる（自動）</option>
                            <option value="classic">クラシック</option>
                            <option value="deep-blue">ディープブルー</option>
                            <option value="indigo">インディゴ</option>
                            <option value="ocean">オーシャン</option>
                            <option value="sky">スカイブルー</option>
                            <option value="navy">ネイビー</option>
                            <option value="teal">ティール</option>
                            <option value="cyan">シアン</option>
                            <option value="green">グリーン</option>
                            <option value="emerald">エメラルド</option>
                            <option value="slate">スレート</option>
                            <option value="purple">紫</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ・「テーマカラーに合わせる（自動）」を選択すると、テーマカラー変更時にグラフの色も自動で変わります<br>
                            ・特定の色を固定したい場合は、個別のカラーパターンを選択してください<br>
                            ・設定は自動的に保存され、レポートの担当者分析グラフに適用されます
                        </small>
                    </div>

                    <!-- プレビュー -->
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">プレビュー</label>

                        <!-- 棒グラフプレビュー -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; color: #495057;">見積
                                vs
                                実績の棒グラフ</div>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div id="chartPreviewEstimateBar"
                                        style="width: 40px; height: 20px; border-radius: 3px;"></div>
                                    <span style="font-size: 12px; color: #495057;">見積</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div id="chartPreviewActualBar"
                                        style="width: 40px; height: 20px; border-radius: 3px;">
                                    </div>
                                    <span style="font-size: 12px; color: #495057;">実績</span>
                                </div>
                            </div>
                        </div>

                        <!-- ドーナツグラフプレビュー -->
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px; color: #495057;">
                                工数内訳ドーナツグラフ</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <div id="chartPreviewUI" style="width: 20px; height: 20px; border-radius: 3px;">
                                    </div>
                                    <span style="font-size: 12px; color: #495057;">UI</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <div id="chartPreviewPG" style="width: 20px; height: 20px; border-radius: 3px;">
                                    </div>
                                    <span style="font-size: 12px; color: #495057;">PG</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <div id="chartPreviewPT" style="width: 20px; height: 20px; border-radius: 3px;">
                                    </div>
                                    <span style="font-size: 12px; color: #495057;">PT</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <div id="chartPreviewIT" style="width: 20px; height: 20px; border-radius: 3px;">
                                    </div>
                                    <span style="font-size: 12px; color: #495057;">IT</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <div id="chartPreviewST" style="width: 20px; height: 20px; border-radius: 3px;">
                                    </div>
                                    <span style="font-size: 12px; color: #495057;">ST</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>📊 レポート分析機能</h3>
                    <p style="color: #666; margin-bottom: 15px;">レポートに表示する分析機能を選択できます。</p>

                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">Phase 1:
                            即効性の高い改善</label>

                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="reportAccuracyEnabled" style="width: auto; margin-right: 10px;"
                                checked>
                            <span>見積精度の%表示（工程別、版数別）</span>
                        </label>

                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="reportAnomalyEnabled" style="width: auto; margin-right: 10px;"
                                checked>
                            <span>異常値のハイライト表示（50%超過を強調）</span>
                        </label>

                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="reportWarningTasksEnabled"
                                style="width: auto; margin-right: 10px;" checked>
                            <span>要注意タスクのリスト表示</span>
                        </label>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">Phase 2:
                            視覚化の強化</label>

                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="reportChartEnabled" style="width: auto; margin-right: 10px;"
                                checked>
                            <span>棒グラフ表示（版数別、工程別）</span>
                        </label>

                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="reportTrendEnabled" style="width: auto; margin-right: 10px;"
                                checked>
                            <span>月別推移の表示</span>
                        </label>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">Phase 3: 高度な分析</label>

                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="reportMemberAnalysisEnabled"
                                style="width: auto; margin-right: 10px;" checked>
                            <span>担当者別の詳細分析</span>
                        </label>

                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="reportInsightsEnabled" style="width: auto; margin-right: 10px;"
                                checked>
                            <span>インサイト・推奨アクションの表示</span>
                        </label>
                    </div>

                    <small style="color: #666; display: block; margin-top: 10px;">
                        ・設定は自動的に保存されます<br>
                        ・不要な機能をオフにすることで、シンプルなレポート表示にできます
                    </small>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>🏢 会社休日設定</h3>
                    <p style="color: #666; margin-bottom: 15px;">会社の夏季休暇、年末年始休暇などを登録できます。実働日数の計算に反映されます。</p>

                    <div class="form-group">
                        <label>休日名</label>
                        <input type="text" id="companyHolidayName" placeholder="例: 夏季休暇">
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <div class="form-group" style="flex: 1; margin: 0;">
                            <label>開始日</label>
                            <input type="date" id="companyHolidayStartDate">
                        </div>
                        <div class="form-group" style="flex: 1; margin: 0;">
                            <label>終了日</label>
                            <input type="date" id="companyHolidayEndDate">
                        </div>
                    </div>

                    <button class="btn btn-primary" id="btnAddCompanyHoliday"
                        style="margin-bottom: 20px;">休日を追加</button>

                    <div id="companyHolidayList"></div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json,.xlsx,.xls" style="display: none;">

    <!-- 作業詳細モーダル -->
    <div id="workModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">作業詳細</h3>
                <button class="modal-close" id="btnCloseWorkModal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>

    <!-- 見積詳細モーダル -->
    <div id="estimateDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="estimateDetailModalTitle">見積詳細</h3>
                <button class="modal-close" id="btnCloseEstimateDetailModal">&times;</button>
            </div>
            <div class="modal-body" id="estimateDetailModalBody"></div>
        </div>
    </div>

    <!-- 実績編集モーダル -->
    <div id="editActualModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>実績データを編集</h3>
                <button class="modal-close" id="btnCloseEditActualModal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editActualId">
                <div class="fm-row">
                    <div class="form-group">
                        <label>日付</label>
                        <input type="date" id="editActualDate">
                    </div>
                    <div class="form-group">
                        <label>版数</label>
                        <select id="editActualVersion">
                            <option value="">-- 版数を選択 --</option>
                        </select>
                    </div>
                </div>
                <div class="fm-row">
                    <div class="form-group">
                        <label>工程</label>
                        <select id="editActualProcess">
                            <option value="">全工程</option>
                            <option value="UI">UI</option>
                            <option value="PG">PG</option>
                            <option value="PT">PT</option>
                            <option value="IT">IT</option>
                            <option value="ST">ST</option>
                        </select>
                        <div class="fm-hint">候補を絞り込めます</div>
                    </div>
                    <div class="form-group">
                        <label>担当</label>
                        <select id="editActualMember">
                        </select>
                        <span id="editActualMemberDisplay" class="fm-readonly-field"
                            style="display: none;"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label>対応名</label>
                    <select id="editActualTaskSelect">
                        <option value="">-- 対応を選択 --</option>
                    </select>
                    <input type="text" id="editActualTaskSearch" placeholder="対応名を入力" style="display: none;">
                </div>
                <div class="fm-section">
                    <div class="fm-section-label">工数</div>
                    <div class="fm-row">
                        <div class="form-group">
                            <label>実績工数 (h)</label>
                            <input type="number" id="editActualHours" step="0.25" min="0" placeholder="8">
                        </div>
                        <div class="form-group" id="remainingHoursGroup">
                            <label>見込残存 (h)</label>
                            <input type="number" id="editActualRemainingHours" step="0.25" min="0" placeholder="0">
                            <div class="fm-hint">0=完了</div>
                        </div>
                    </div>
                </div>
                <div class="fm-actions">
                    <button class="btn btn-primary" id="btnSaveActualEdit">保存</button>
                    <button class="btn" id="editActualOtherBtn"
                        style="background: #27ae60; color: white; display: none;">その他作業</button>
                    <button class="btn" id="editActualVacationBtn"
                        style="background: #f57c00; color: white; display: none;">休暇登録</button>
                    <button class="btn" id="btnCloseEditActualModalCancel"
                        style="background: #95a5a6; color: white;">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 見込残存時間一括編集モーダル -->
    <div id="bulkRemainingModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 85vh;">
            <div class="modal-header">
                <h3>見込残存時間の一括編集</h3>
                <button class="modal-close" onclick="closeBulkRemainingModal()">&times;</button>
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: calc(85vh - 120px);">
                <div class="form-group">
                    <label>版数フィルタ</label>
                    <select id="bulkRemainingVersionFilter" onchange="renderBulkRemainingTable()" style="max-width: 200px;">
                        <option value="all">全版数</option>
                    </select>
                </div>
                <div class="table-wrapper" style="overflow-x: auto;">
                    <table id="bulkRemainingTable" class="fm-bulk-table">
                        <thead>
                            <tr>
                                <th>版数</th>
                                <th>対応名</th>
                                <th>工程</th>
                                <th>担当</th>
                                <th style="text-align: right;">見積</th>
                                <th style="text-align: right;">実績</th>
                                <th style="text-align: right;">残存</th>
                                <th style="text-align: right;">予測総工数</th>
                                <th style="text-align: center;">状態</th>
                            </tr>
                        </thead>
                        <tbody id="bulkRemainingTableBody">
                            <!-- 動的に生成 -->
                        </tbody>
                    </table>
                </div>
                <div class="fm-actions fm-actions-end">
                    <button class="btn btn-primary" id="btnSaveBulkRemaining">保存</button>
                    <button class="btn" id="btnCloseBulkRemaining"
                        style="background: #95a5a6; color: white;">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 休暇登録モーダル -->
    <div id="vacationModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);">
                <h3 style="color: white;">休暇を登録</h3>
                <button class="modal-close" id="btnCloseVacationModal" style="color: white;">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="vacationModalMember">
                <input type="hidden" id="vacationModalDate">
                <div class="fm-info-card">
                    <div class="fm-row">
                        <div>
                            <div class="fm-info-card-label">担当者</div>
                            <div id="vacationModalMemberDisplay" class="fm-readonly-field"></div>
                        </div>
                        <div>
                            <div class="fm-info-card-label">日付</div>
                            <div id="vacationModalDateDisplay" class="fm-readonly-field"></div>
                        </div>
                    </div>
                </div>
                <div class="fm-row">
                    <div class="form-group">
                        <label>休暇タイプ</label>
                        <select id="vacationModalType">
                            <option value="有休">有給休暇（有休）</option>
                            <option value="特休">特別休暇（特休）</option>
                            <option value="代休">代休（代休）</option>
                            <option value="振休">振替休日（振休）</option>
                            <option value="時間休">時間休</option>
                        </select>
                    </div>
                    <div class="form-group" id="vacationModalHoursGroup">
                        <label>時間数 (h)</label>
                        <input type="number" id="vacationModalHours" step="1" min="1" max="8" value="8">
                        <div class="fm-hint">時間休は1h単位。全日休暇は8h</div>
                    </div>
                </div>
                <div class="fm-actions">
                    <button class="btn btn-primary" id="btnSaveVacationFromModal"
                        style="background: #f57c00;">登録</button>
                    <button class="btn" id="btnCloseVacationModalCancel"
                        style="background: #95a5a6; color: white;">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 見積編集モーダル -->
    <div id="editEstimateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>見積データを編集</h3>
                <button class="modal-close" id="btnCloseEditEstimateModal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editEstimateId">
                <div class="fm-row">
                    <div class="form-group">
                        <label>版数</label>
                        <select id="editEstimateVersion">
                            <option value="">-- 版数を選択 --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>工程</label>
                        <select id="editEstimateProcess">
                            <option value="UI">UI</option>
                            <option value="PG">PG</option>
                            <option value="PT">PT</option>
                            <option value="IT">IT</option>
                            <option value="ST">ST</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>対応名</label>
                    <input type="text" id="editEstimateTaskSearch" placeholder="検索または新規入力" list="editEstimateTaskList">
                    <datalist id="editEstimateTaskList"></datalist>
                </div>
                <div class="fm-row">
                    <div class="form-group">
                        <label>担当</label>
                        <select id="editEstimateMember"></select>
                    </div>
                    <div class="form-group">
                        <label>見積工数 (h)</label>
                        <input type="number" id="editEstimateHours" step="0.5" min="0" placeholder="8">
                        <div class="fm-hint">分割時は総工数</div>
                    </div>
                </div>
                <div class="fm-section">
                    <div class="fm-section-label">作業月</div>
                    <div class="fm-pill-group">
                        <label class="fm-pill-option">
                            <input type="radio" name="editWorkMonthMode" value="single" checked>
                            <span>単一月</span>
                        </label>
                        <label class="fm-pill-option">
                            <input type="radio" name="editWorkMonthMode" value="multi">
                            <span>複数月分割</span>
                        </label>
                    </div>
                    <div id="editSingleMonthSection">
                        <select id="editEstimateWorkMonth">
                            <option value="">-- 作業月を選択 --</option>
                        </select>
                    </div>
                    <div id="editMultiMonthSection" style="display: none;">
                        <div class="fm-info-card">
                            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                                <select id="editStartMonth" style="flex: 1;"></select>
                                <span style="color: #999;">〜</span>
                                <select id="editEndMonth" style="flex: 1;"></select>
                            </div>
                            <div class="fm-pill-group">
                                <label class="fm-pill-option">
                                    <input type="radio" name="editSplitMethod" value="equal" checked>
                                    <span>均等</span>
                                </label>
                                <label class="fm-pill-option">
                                    <input type="radio" name="editSplitMethod" value="manual">
                                    <span>手動</span>
                                </label>
                            </div>
                            <div id="editMonthPreview"></div>
                        </div>
                    </div>
                </div>
                <div class="fm-actions">
                    <button class="btn btn-primary" id="btnSaveEstimateEdit">保存</button>
                    <button class="btn" id="btnCloseEditEstimateModalCancel"
                        style="background: #95a5a6; color: white;">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 対応編集モーダル -->
    <div id="editTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>対応名を編集</h3>
                <button class="modal-close" id="btnCloseEditTaskModal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTaskOldVersion">
                <input type="hidden" id="editTaskOldName">
                <div class="fm-row">
                    <div class="form-group">
                        <label>版数</label>
                        <select id="editTaskVersion">
                            <option value="">-- 版数を選択 --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>帳票名</label>
                        <select id="editTaskFormNameSelect">
                            <option value="">-- 帳票名を選択 --</option>
                            <option value="__new__">新規入力</option>
                        </select>
                        <input type="text" id="editTaskFormName" placeholder="帳票A" style="display: none;">
                    </div>
                </div>
                <div class="form-group">
                    <label>対応名</label>
                    <input type="text" id="editTaskName" placeholder="X対応">
                </div>
                <div class="fm-callout">
                    <div class="fm-callout-title">変更内容</div>
                    <div class="fm-callout-text">
                        この対応のすべての工程（UI、PG、PT、IT、ST）の版数と対応名が変更されます。関連する実績データも自動的に更新されます。</div>
                </div>
                <div class="fm-actions">
                    <button class="btn btn-primary" id="btnSaveTaskEdit">保存</button>
                    <button class="btn" id="btnCloseEditTaskModalCancel"
                        style="background: #95a5a6; color: white;">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 工程内訳表示モーダル -->
    <div id="processBreakdownModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="breakdownModalTitle">工程内訳</h3>
                <button class="modal-close" id="btnCloseProcessBreakdownModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="breakdownModalContent"></div>
            </div>
        </div>
    </div>

    <!-- 見込残存時間入力モーダル -->
    <div id="remainingHoursModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>工程の詳細</h3>
                <button class="modal-close" onclick="closeRemainingHoursModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="remainingHoursInfo" class="fm-info-card" style="font-size: 14px;">
                    <!-- 版数、対応名、工程情報を表示 -->
                </div>
                <div id="remainingHoursMemberSelect" class="form-group" style="display: none;">
                    <label>担当者</label>
                    <select id="remainingHoursMember"></select>
                </div>
                <div class="form-group">
                    <label>見込残存時間 (h)</label>
                    <input type="number" id="remainingHoursInput" step="0.1" min="0">
                    <div class="fm-hint">0=完了（100%）</div>
                </div>
                <div id="remainingHoursActualsList" style="display: none;">
                    <div class="fm-section">
                        <div class="fm-section-label">実績一覧</div>
                        <div id="remainingHoursActualsContent" class="fm-info-card"
                            style="max-height: 200px; overflow-y: auto;">
                        </div>
                    </div>
                </div>
                <div class="fm-actions fm-actions-end">
                    <button class="btn" onclick="closeRemainingHoursModal()"
                        style="background: #95a5a6; color: white;">キャンセル</button>
                    <button class="btn btn-success" onclick="saveRemainingHoursFromModal()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 見積登録モーダル -->
    <div id="addEstimateModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>📝 見積登録</h3>
                <button class="modal-close" onclick="closeAddEstimateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- セグメントコントロール -->
                <div class="segment-control" id="addEstModeSelector">
                    <button type="button" class="segment-btn active" data-mode="normal" onclick="switchEstimateMode('normal')">通常の見積</button>
                    <button type="button" class="segment-btn" data-mode="other" onclick="switchEstimateMode('other')">その他工数</button>
                </div>

                <!-- ========== 通常モードのフォーム ========== -->
                <div id="addEstNormalForm" class="estimate-form-compact">
                    <div class="fm-row">
                        <div class="form-group">
                            <label>版数</label>
                            <select id="addEstVersion" onchange="handleVersionChange('addEstVersion')">
                                <option value="">-- 版数を選択 --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>帳票名</label>
                            <select id="addEstFormNameSelect" onchange="handleAddFormNameChange()">
                                <option value="">-- 帳票名を選択 --</option>
                                <option value="__new__">新規入力</option>
                            </select>
                            <input type="text" id="addEstFormName" placeholder="帳票A" style="display: none;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>対応名</label>
                        <input type="text" id="addEstTask" placeholder="X対応">
                    </div>
                    <div class="form-group">
                        <label>作業月</label>
                        <div class="fm-pill-group">
                            <label class="fm-pill-option">
                                <input type="radio" name="addEstMonthType" value="single" checked
                                    onchange="switchAddEstMonthType()">
                                <span>単一月</span>
                            </label>
                            <label class="fm-pill-option">
                                <input type="radio" name="addEstMonthType" value="multi" onchange="switchAddEstMonthType()">
                                <span>複数月</span>
                            </label>
                        </div>
                        <div id="addEstMonthInputs">
                            <div id="addEstSingleMonthInput" style="display: block;">
                                <select id="addEstStartMonth"></select>
                            </div>
                            <div id="addEstMultiMonthInput" style="display: none;">
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <select id="addEstStartMonthMulti" style="flex: 1;"></select>
                                    <span style="color: #999;">〜</span>
                                    <select id="addEstEndMonth" style="flex: 1;"></select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="fm-section">
                        <div class="fm-section-label">各工程の見積</div>
                        <div class="estimate-table-wrapper">
                            <table class="fm-process-table" id="addEstimateTable">
                                <colgroup>
                                    <col class="col-process">
                                    <col class="col-member">
                                    <col class="col-hours">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th style="width: 50px; text-align: center;">工程</th>
                                        <th>担当</th>
                                        <th style="width: 80px;">時間</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span class="badge badge-ui">UI</span></td>
                                        <td><select id="addEstUI_member" style="margin: 0;"></select></td>
                                        <td><input type="number" id="addEstUI" placeholder="h" step="0.5" style="margin: 0;" oninput="updateAddEstimateTotals()"></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span class="badge badge-pg">PG</span></td>
                                        <td><select id="addEstPG_member" style="margin: 0;" onchange="autoFillMember('addEstPG_member')"></select></td>
                                        <td><input type="number" id="addEstPG" placeholder="h" step="0.5" style="margin: 0;" oninput="updateAddEstimateTotals()"></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span class="badge badge-pt">PT</span></td>
                                        <td><select id="addEstPT_member" style="margin: 0;" onchange="autoFillMember('addEstPT_member')"></select></td>
                                        <td><input type="number" id="addEstPT" placeholder="h" step="0.5" style="margin: 0;" oninput="updateAddEstimateTotals()"></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span class="badge badge-it">IT</span></td>
                                        <td><select id="addEstIT_member" style="margin: 0;" onchange="autoFillMember('addEstIT_member')"></select></td>
                                        <td><input type="number" id="addEstIT" placeholder="h" step="0.5" style="margin: 0;" oninput="updateAddEstimateTotals()"></td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: center; font-weight: 600;"><span class="badge badge-st">ST</span></td>
                                        <td><select id="addEstST_member" style="margin: 0;" onchange="autoFillMember('addEstST_member')"></select></td>
                                        <td><input type="number" id="addEstST" placeholder="h" step="0.5" style="margin: 0;" oninput="updateAddEstimateTotals()"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="addEstimateTotals" class="fm-summary-bar">
                            <div class="fm-summary-row">
                                <span class="fm-summary-label">合計</span>
                                <div class="fm-summary-values">
                                    <span><strong id="addEstTotalHours">0.0</strong> h</span>
                                    <span><span id="addEstTotalDays">0.0</span> 人日</span>
                                    <span><span id="addEstTotalMonths">0.00</span> 人月</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== その他工数モードのフォーム ========== -->
                <div id="addEstOtherForm" style="display: none;">
                    <div class="fm-hint" style="margin-bottom: 12px;">版数・帳票名に紐付かない工数を登録します</div>
                    <div class="form-group">
                        <label>作業名</label>
                        <input type="text" id="addEstOtherTask" placeholder="打ち合わせ、レビュー等">
                    </div>
                    <div class="fm-row">
                        <div class="form-group">
                            <label>担当者</label>
                            <select id="addEstOtherMember"></select>
                        </div>
                        <div class="form-group">
                            <label>作業月</label>
                            <select id="addEstOtherMonth"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>見積工数 (h)</label>
                        <input type="number" id="addEstOtherHours" step="0.5" min="0" placeholder="例: 2">
                    </div>
                </div>

                <div class="fm-actions">
                    <button class="btn btn-primary" id="addEstSubmitBtn" onclick="addEstimateFromModal()">登録</button>
                    <button class="btn" onclick="closeAddEstimateModal()"
                        style="background: #95a5a6; color: white;">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 既存見積の月分割モーダル -->
    <div id="splitEstimateModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>見積を複数月に分割</h3>
                <button class="modal-close" onclick="closeSplitEstimateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="splitEstimateId">
                <div class="fm-info-card">
                    <div class="fm-row">
                        <div>
                            <div class="fm-info-card-label">対象見積</div>
                            <div id="splitEstimateInfo" style="color: #555;"></div>
                        </div>
                        <div>
                            <div class="fm-info-card-label">総工数</div>
                            <div style="display: flex; gap: 6px; align-items: center;">
                                <input type="number" id="splitTotalHours" step="0.1" min="0" readonly class="fm-readonly-field" style="width: auto;">
                                <span style="color: #999; font-size: 12px;">h</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>作業期間</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="splitStartMonth" onchange="updateSplitPreview()" style="flex: 1;"></select>
                        <span style="color: #999;">〜</span>
                        <select id="splitEndMonth" onchange="updateSplitPreview()" style="flex: 1;"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label>分割方法</label>
                    <div class="fm-pill-group">
                        <label class="fm-pill-option">
                            <input type="radio" name="splitMethodModal" value="equal" checked
                                onchange="updateSplitPreview()">
                            <span>均等分割</span>
                        </label>
                        <label class="fm-pill-option">
                            <input type="radio" name="splitMethodModal" value="manual" onchange="updateSplitPreview()">
                            <span>手動設定</span>
                        </label>
                    </div>
                </div>
                <div id="splitPreview"></div>
                <div class="fm-actions">
                    <button class="btn btn-primary" onclick="executeSplitEstimate()">分割を適用</button>
                    <button class="btn" onclick="closeSplitEstimateModal()"
                        style="background: #95a5a6; color: white;">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <!-- その他作業モーダル -->
    <div id="otherWorkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>その他作業の登録</h3>
                <button class="modal-close" onclick="closeOtherWorkModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- タブ切り替え -->
                <div class="fm-tab-bar">
                    <button id="meetingTab" class="fm-tab-btn active"
                        onclick="switchOtherWorkTab('meeting')">打ち合わせ</button>
                    <button id="customTab" class="fm-tab-btn" onclick="switchOtherWorkTab('custom')">任意作業</button>
                </div>

                <!-- 打ち合わせタブ -->
                <div id="meetingForm" class="other-work-form">
                    <div class="fm-hint" style="margin-bottom: 15px;">全担当者に同じ工数で登録されます。</div>
                    <div class="form-group">
                        <label>工数 (h)</label>
                        <input type="number" id="meetingHours" step="0.5" min="0" placeholder="例: 2">
                    </div>
                    <button class="btn btn-success" onclick="addMeeting()">全員分追加</button>
                </div>

                <!-- 任意作業タブ -->
                <div id="customForm" class="other-work-form" style="display: none;">
                    <div class="form-group">
                        <label>作業名</label>
                        <input type="text" id="otherWorkName" placeholder="例: 環境構築、ドキュメント作成">
                    </div>
                    <div class="fm-row">
                        <div class="form-group">
                            <label>担当</label>
                            <select id="otherWorkMember">
                                <option value="">選択...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>工数 (h)</label>
                            <input type="number" id="otherWorkHours" step="0.5" min="0" placeholder="例: 4">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addOtherWork()">追加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- カスタムアラート -->
    <div id="customAlert" class="modal">
        <div class="custom-alert-content">
            <div class="custom-alert-accent"></div>
            <div class="custom-alert-icon-wrap">
                <div class="custom-alert-icon" id="customAlertIcon"></div>
            </div>
            <div class="custom-alert-body" id="customAlertMessage">
            </div>
            <div class="custom-alert-footer">
                <button class="btn" onclick="closeCustomAlert()">OK</button>
            </div>
        </div>
    </div>

    <!-- [GANTT-CHART] 予定作成モーダル -->
    <div id="createScheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>予定の作成</h3>
                <span class="close" onclick="closeCreateScheduleModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>版数</label>
                    <select id="scheduleVersion" onchange="updateScheduleTaskOptions()">
                        <option value="">選択してください</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>タスク</label>
                    <select id="scheduleTask" onchange="updateScheduleProcessOptions()">
                        <option value="">選択してください</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>工程</label>
                    <select id="scheduleProcess" onchange="updateScheduleMemberOptions()">
                        <option value="">選択してください</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>担当者</label>
                    <select id="scheduleMember" onchange="populateScheduleEstimateHours()">
                        <option value="">選択してください</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>見積工数</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="number" id="scheduleEstimatedHours" readonly style="flex: 1;">
                        <span>時間</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>着手日</label>
                    <input type="date" id="scheduleStartDate" onchange="recalculateScheduleEndDate()">
                </div>
                <div class="form-group">
                    <label>終了予定日</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="text" id="scheduleEndDate" readonly style="flex: 1; background: #f0f0f0;">
                        <span id="scheduleWorkingDays" style="color: #666; font-size: 13px;"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label>メモ</label>
                    <textarea id="scheduleNote" rows="2" placeholder="メモ（任意）"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeCreateScheduleModal()" class="btn btn-secondary">キャンセル</button>
                <button onclick="saveScheduleFromModal()" class="btn btn-primary">作成</button>
            </div>
        </div>
    </div>

    <!-- [GANTT-CHART] 予定詳細モーダル -->
    <div id="scheduleDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="scheduleDetailTitle">予定詳細</h3>
                <span class="close" onclick="closeScheduleDetailModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- 進捗状況 -->
                <div class="schedule-detail-progress">
                    <div class="schedule-progress-bar-container">
                        <div class="schedule-progress-bar" id="detailProgressBar"></div>
                    </div>
                    <div class="schedule-progress-stats">
                        <span id="detailProgressRate">0%</span>
                    </div>
                </div>

                <!-- 計画情報 -->
                <div class="schedule-detail-info">
                    <div class="schedule-info-row">
                        <span class="schedule-info-label">計画期間</span>
                        <span class="schedule-info-value" id="detailPlanPeriod"></span>
                    </div>
                    <div class="schedule-info-row">
                        <span class="schedule-info-label">見積工数</span>
                        <span class="schedule-info-value" id="detailEstimatedHours"></span>
                    </div>
                    <div class="schedule-info-row">
                        <span class="schedule-info-label">実績工数</span>
                        <span class="schedule-info-value" id="detailActualHours"></span>
                    </div>
                    <div class="schedule-info-row">
                        <span class="schedule-info-label">残作業</span>
                        <span class="schedule-info-value" id="detailRemainingHours"></span>
                    </div>
                    <div class="schedule-info-row schedule-remaining-edit">
                        <span class="schedule-info-label">見込み残</span>
                        <div class="schedule-remaining-input-group">
                            <input type="number" id="detailUserRemainingHours" step="0.25" min="0" placeholder="0.0">
                            <span class="input-suffix">h</span>
                            <button onclick="saveScheduleRemainingHours()" class="btn btn-sm btn-outline">更新</button>
                        </div>
                    </div>
                </div>

                <!-- 実績一覧 -->
                <div class="schedule-actual-list" id="detailActualList">
                    <!-- 動的に生成 -->
                </div>

                <!-- 編集フォーム -->
                <div class="schedule-edit-section">
                    <div class="form-group">
                        <label>ステータス</label>
                        <div class="schedule-status-buttons" id="detailStatusButtons">
                            <button onclick="setScheduleStatus('pending')" class="status-btn status-pending"
                                data-status="pending">未着手</button>
                            <button onclick="setScheduleStatus('in_progress')" class="status-btn status-in-progress"
                                data-status="in_progress">進行中</button>
                            <button onclick="setScheduleStatus('completed')" class="status-btn status-completed"
                                data-status="completed">完了</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>着手日を変更</label>
                        <input type="date" id="detailStartDate" onchange="recalculateScheduleEndDateDetail()">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="openEstimateFromSchedule()" class="btn btn-outline" title="対応する見積データを編集">見積を編集</button>
                <div style="flex: 1;"></div>
                <button onclick="deleteScheduleFromModal()" class="btn btn-danger">削除</button>
                <button onclick="closeScheduleDetailModal()" class="btn btn-secondary">閉じる</button>
                <button onclick="saveScheduleDetailChanges()" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>

    <!-- スケジュール変更確認モーダル -->
    <div id="scheduleChangeConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>スケジュール更新の確認</h3>
                <span class="close" onclick="closeScheduleChangeConfirmModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="scheduleChangeMessage"></div>
            </div>
            <div class="modal-footer">
                <button onclick="handleScheduleChangeOption('keep')" class="btn btn-secondary">そのまま</button>
                <button onclick="handleScheduleChangeOption('update')" class="btn btn-primary">スケジュールも更新</button>
            </div>
        </div>
    </div>

    <!-- スケジュール自動生成モーダル -->
    <div id="autoGenerateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>スケジュール自動生成</h3>
                <span class="close" onclick="closeAutoGenerateModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p class="modal-description">見積データからスケジュールを自動生成します。担当者ごとに工程順（UI→PG→PT→IT→ST）で予定が作成されます。</p>

                <div class="form-group">
                    <label>対象版数 <span class="required">*</span></label>
                    <select id="autoGenVersion"
                        onchange="updateAutoGenerateTargetOptions(); updateAutoGeneratePreview();">
                        <option value="">選択してください</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>開始日 <span class="required">*</span></label>
                    <input type="date" id="autoGenStartDate" onchange="updateAutoGeneratePreview()">
                </div>

                <div class="form-group">
                    <label>生成モード</label>
                    <select id="autoGenMode" onchange="updateAutoGenerateTargetOptions(); updateAutoGeneratePreview();">
                        <option value="all">全ての見積</option>
                        <option value="member">担当者を指定</option>
                        <option value="task">タスクを指定</option>
                    </select>
                </div>

                <div class="form-group" id="autoGenTargetContainer" style="display: none;">
                    <label>対象</label>
                    <select id="autoGenTarget" onchange="updateAutoGeneratePreview();">
                        <option value="">選択してください</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>プレビュー</label>
                    <div id="autoGenPreview" class="auto-gen-preview">
                        <p class="text-muted">版数と開始日を選択してください</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeAutoGenerateModal()" class="btn btn-secondary">キャンセル</button>
                <button onclick="executeAutoGenerate()" class="btn btn-primary">生成</button>
            </div>
        </div>
    </div>

    <!-- モジュールスクリプト -->
    <script type="module" src="js/init.js?v=20260210-4"></script>
</body>

</html>
<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥æ•°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@holiday-jp/holiday_jp/holiday_jp.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    body {
        font-family: 'Segoe UI', 'Yu Gothic', 'Meiryo', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 10px;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        overflow: hidden;
    }

    header {
        background: #2c3e50;
        color: white;
        padding: 20px;
    }

    h1 {
        font-size: 24px;
        margin-bottom: 10px;
    }

    .header-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .tabs {
        display: flex;
        gap: 5px;
        background: #ecf0f1;
        padding: 10px;
        overflow-x: auto;
    }

    .tab {
        padding: 12px 20px;
        background: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        white-space: nowrap;
    }

    .tab.active {
        background: #3498db;
        color: white;
    }

    .content {
        padding: 20px;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
    }

    .btn-primary {
        background: #3498db;
        color: white;
    }

    .btn-success {
        background: #27ae60;
        color: white;
    }

    .btn-danger {
        background: #e74c3c;
        color: white;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    input, select {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
    }

    .quick-input {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-radius: 10px;
        color: white;
        margin-bottom: 20px;
    }

    .quick-form {
        display: grid;
        gap: 10px;
        margin-top: 15px;
    }

    .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        background: white;
        min-width: 600px;
    }

    th {
        background: #34495e;
        color: white;
        padding: 12px;
        text-align: left;
        white-space: nowrap;
    }

    td {
        padding: 8px 10px;
        border-bottom: 1px solid #eee;
        white-space: nowrap;
    }

    /* ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    table tr td:first-child,
    table tr th:first-child {
        position: sticky;
        left: 0;
        background: white;
        z-index: 1;
    }

    table tr th:first-child {
        z-index: 2;
    }

    /* é€±æœ«ãƒ»ç¥æ—¥ã®è¡Œ */
    table tr[style*="ffebee"] td:first-child {
        background: #ffebee;
    }

    /* å°è¨ˆè¡Œ */
    table tr[style*="fff3cd"] td:first-child {
        background: #fff3cd;
    }

    /* ç·åˆè¨ˆè¡Œ */
    table tr[style*="2c3e50"] td:first-child {
        background: #2c3e50;
        color: white;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.2s;
    }

    .custom-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 100;
        margin-top: 4px;
    }

    .custom-dropdown-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
        font-size: 14px;
        color: #333;
    }

    .custom-dropdown-item:last-child {
        border-bottom: none;
    }

    .custom-dropdown-item:hover {
        background-color: #e3f2fd;
        color: #000;
    }

    .custom-dropdown-item.selected {
        background-color: #e3f2fd;
        color: #000;
    }

    .custom-dropdown-empty {
        padding: 20px;
        text-align: center;
        color: #999;
        font-size: 14px;
    }

    #quickTaskSearch {
        cursor: text;
    }

    #quickTaskSearch:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s;
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 18px;
    }

    .modal-close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
    }

    .modal-close:hover {
        opacity: 0.8;
    }

    .modal-body {
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
    }

    .work-item {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #3498db;
    }

    .work-item:last-child {
        margin-bottom: 0;
    }

    .work-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .work-item-title {
        font-weight: 600;
        font-size: 15px;
        color: #2c3e50;
    }

    .work-item-hours {
        font-size: 18px;
        font-weight: 700;
        color: #3498db;
    }

    .work-item-details {
        font-size: 13px;
        color: #666;
        line-height: 1.6;
    }

    .work-item-details span {
        display: inline-block;
        margin-right: 12px;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-ui { background: #e3f2fd; color: #1976d2; }
    .badge-pg { background: #f3e5f5; color: #7b1fa2; }
    .badge-pt { background: #fff3e0; color: #f57c00; }
    .badge-it { background: #e8f5e9; color: #388e3c; }
    .badge-st { background: #fce4ec; color: #c2185b; }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-radius: 10px;
        color: white;
    }

    .stat-card h3 {
        font-size: 14px;
        margin-bottom: 10px;
    }

    .stat-card .value {
        font-size: 32px;
        font-weight: 700;
    }

    @media (max-width: 768px) {
        body {
            padding: 0;
        }

        .container {
            border-radius: 0;
        }

        h1 {
            font-size: 18px;
        }

        .header-buttons {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }

        .quick-form {
            grid-template-columns: 1fr;
        }

        table {
            font-size: 13px;
        }

        th, td {
            padding: 8px;
        }
    }
</style>

</head>
<body>
    <div class="container">
        <header>
            <h1>å·¥æ•°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <div class="header-buttons">
                <button class="btn btn-success" onclick="exportBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                <button class="btn btn-primary" onclick="importBackup()">å¾©å…ƒ</button>
            </div>
        </header>

    <div class="tabs">
        <button class="tab active" onclick="showTab('quick')">ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›</button>
        <button class="tab" onclick="showTab('estimate')">è¦‹ç©ç®¡ç†</button>
        <button class="tab" onclick="showTab('actual')">å®Ÿç¸¾ä¸€è¦§</button>
        <button class="tab" onclick="showTab('report')">ãƒ¬ãƒãƒ¼ãƒˆ</button>
        <button class="tab" onclick="showTab('settings')">âš™ï¸ è¨­å®š</button>
    </div>

    <div class="content">
        <div id="quick" class="tab-content active">
            <div class="quick-input">
                <h2>ä»Šæ—¥ã®å®Ÿç¸¾ã‚’å…¥åŠ›</h2>
                <div class="quick-form">
                    <div class="form-group">
                        <label>æ‹…å½“è€…ã‚’é¸æŠ</label>
                        <select id="quickMemberSelect" onchange="updateQuickTasksByMember()">
                            <option value="">æ‹…å½“è€…ã‚’é¸æŠ...</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ğŸ‘† ã¾ãšæ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„
                        </small>
                    </div>
                    
                    <div id="quickTaskSelectArea" style="display: none;">
                        <div class="form-group">
                            <label>å¯¾å¿œã‚’é¸æŠ ã¾ãŸã¯ å¯¾å¿œåã§æ¤œç´¢</label>
                            <div style="position: relative;">
                                <input 
                                    type="text" 
                                    id="quickTaskSearch" 
                                    placeholder="å¯¾å¿œåã§æ¤œç´¢ã—ã¦é¸æŠ..." 
                                    autocomplete="off"
                                    oninput="filterQuickTaskListByMember()"
                                    onfocus="showQuickTaskDropdown()"
                                    onblur="hideQuickTaskDropdown()">
                                <div id="quickTaskDropdown" class="custom-dropdown" style="display: none;">
                                    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                                </div>
                            </div>
                            <small style="color: #666; display: block; margin-top: 5px;">
                                â†‘ å…¥åŠ›ã—ã¦çµã‚Šè¾¼ã¿ã€ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠ
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label>é¸æŠã—ãŸå¯¾å¿œ</label>
                            <input type="text" id="quickTaskDisplay" readonly style="background: #f5f5f5;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="form-group">
                                <label>æ‹…å½“ã‚’å¤‰æ›´ã™ã‚‹å ´åˆ</label>
                                <select id="quickMemberOverride">
                                    <option value="">ï¼ˆå¤‰æ›´ãªã—ï¼‰</option>
                                </select>
                                <small style="color: #999; font-size: 11px;">é€šå¸¸ã¯å¤‰æ›´ä¸è¦</small>
                            </div>
                            <div class="form-group">
                                <label>å®Ÿç¸¾å·¥æ•° (h)</label>
                                <input type="number" id="quickHours" step="0.5" min="0">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="quickAddActual()">è¿½åŠ </button>
                    </div>
                </div>
            </div>

            <h3>ä»Šæ—¥ã®å…¥åŠ›æ¸ˆã¿å®Ÿç¸¾</h3>
            <div id="todayActuals"></div>
        </div>

        <div id="estimate" class="tab-content">
            <h2>è¦‹ç©ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3>æ–°è¦è¦‹ç©ç™»éŒ²</h3>
                <div class="form-group">
                    <label>ç‰ˆæ•°</label>
                    <input type="text" id="estVersion" placeholder="ç¬¬2025.11ç‰ˆ">
                </div>
                <div class="form-group">
                    <label>å¯¾å¿œå</label>
                    <input type="text" id="estTask" placeholder="å¸³ç¥¨A_Xå¯¾å¿œ">
                </div>
                <h4>å„å·¥ç¨‹ã®è¦‹ç©</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div class="form-group">
                        <label>UI (æ‹…å½“)</label>
                        <select id="estUI_member">
                            <option value="">-</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                        <input type="number" id="estUI" placeholder="æ™‚é–“" step="0.5" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>PG (æ‹…å½“)</label>
                        <select id="estPG_member">
                            <option value="">-</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                        <input type="number" id="estPG" placeholder="æ™‚é–“" step="0.5" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>PT (æ‹…å½“)</label>
                        <select id="estPT_member">
                            <option value="">-</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                        <input type="number" id="estPT" placeholder="æ™‚é–“" step="0.5" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>IT (æ‹…å½“)</label>
                        <select id="estIT_member">
                            <option value="">-</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                        <input type="number" id="estIT" placeholder="æ™‚é–“" step="0.5" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>ST (æ‹…å½“)</label>
                        <select id="estST_member">
                            <option value="">-</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                        <input type="number" id="estST" placeholder="æ™‚é–“" step="0.5" style="margin-top: 5px;">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addEstimate()" style="margin-top: 15px;">ç™»éŒ²</button>
            </div>

            <h3>ç™»éŒ²æ¸ˆã¿è¦‹ç©ä¸€è¦§</h3>
            <div class="form-group" style="max-width: 300px; margin-bottom: 15px;">
                <label>è¡¨ç¤ºå½¢å¼</label>
                <select id="estimateViewType" onchange="renderEstimateList()">
                    <option value="grouped">å¯¾å¿œåˆ¥ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤º</option>
                    <option value="matrix">å¯¾å¿œåˆ¥ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º</option>
                    <option value="list">è©³ç´°ãƒªã‚¹ãƒˆè¡¨ç¤º</option>
                </select>
            </div>
            <div id="estimateList"></div>
        </div>

        <div id="actual" class="tab-content">
            <h2>å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="form-group">
                    <label>è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
                    <select id="actualViewMode" onchange="renderActualList()">
                        <option value="all">å…¨æ‹…å½“è€…</option>
                        <option value="member">æ‹…å½“è€…åˆ¥</option>
                    </select>
                </div>
                
                <div class="form-group" id="memberSelectGroup" style="display: none;">
                    <label>æ‹…å½“è€…</label>
                    <select id="actualMemberSelect" onchange="renderActualList()">
                    </select>
                </div>
                
                <div class="form-group">
                    <label>è¡¨ç¤ºå½¢å¼</label>
                    <select id="actualViewType" onchange="renderActualList()">
                        <option value="matrix">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å½¢å¼</option>
                        <option value="list">ãƒªã‚¹ãƒˆå½¢å¼</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>è¡¨ç¤ºæœŸé–“</label>
                    <select id="actualMonthFilter" onchange="renderActualList()">
                        <option value="all">å…¨æœŸé–“</option>
                    </select>
                </div>
            </div>
            
            <div id="actualList"></div>
        </div>

        <div id="report" class="tab-content">
            <h2>å·¥æ•°ãƒ¬ãƒãƒ¼ãƒˆ</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="form-group">
                    <label>è¡¨ç¤ºæœˆã‚’é¸æŠ</label>
                    <select id="reportMonth" onchange="updateReport()">
                        <option value="all">å…¨æœŸé–“</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è¡¨ç¤ºå½¢å¼</label>
                    <select id="reportViewType" onchange="updateReport()">
                        <option value="summary">ã‚µãƒãƒªãƒ¼è¡¨ç¤º</option>
                        <option value="grouped">å¯¾å¿œåˆ¥ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤º</option>
                        <option value="matrix">å¯¾å¿œåˆ¥ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º</option>
                    </select>
                </div>
            </div>

            <h3 id="reportPeriodTitle">å…¨æœŸé–“ã®é›†è¨ˆ</h3>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ç·è¦‹ç©å·¥æ•°</h3>
                    <div class="value" id="totalEstimate">0h</div>
                </div>
                <div class="stat-card">
                    <h3>ç·å®Ÿç¸¾å·¥æ•°</h3>
                    <div class="value" id="totalActual">0h</div>
                </div>
                <div class="stat-card">
                    <h3>å·®ç•°</h3>
                    <div class="value" id="totalDiff">0h</div>
                </div>
                <div class="stat-card">
                    <h3>å®Ÿç¸¾ç‡</h3>
                    <div class="value" id="actualRate">0%</div>
                </div>
            </div>

            <div id="reportDetailView"></div>

            <h3>æ‹…å½“è€…åˆ¥å·¥æ•°</h3>
            <div id="memberReport"></div>

            <h3 style="margin-top: 20px;">ç‰ˆæ•°åˆ¥é€²æ—</h3>
            <div id="versionReport"></div>
        </div>

        <div id="settings" class="tab-content">
            <h2>âš™ï¸ è¨­å®š</h2>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3>æ‹…å½“è€…è¡¨ç¤ºé †</h3>
                <p style="color: #666; margin-bottom: 15px;">æ‹…å½“è€…ã®è¡¨ç¤ºé †åºã‚’æŒ‡å®šã§ãã¾ã™ã€‚ã“ã®é †åºã¯å®Ÿç¸¾ä¸€è¦§ã€ãƒ¬ãƒãƒ¼ãƒˆã€å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ãªã©å…¨ã¦ã®ç”»é¢ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚</p>
                
                <div class="form-group">
                    <label>è¡¨ç¤ºé †åº <button onclick="showMemberOrderHelp()" style="border: none; background: none; cursor: pointer; color: #3498db; font-size: 18px;">â„¹ï¸</button></label>
                    <input type="text" id="memberOrder" placeholder="ä¾‹: A,B,C,D ã¾ãŸã¯ å±±ç”°,ä½è—¤,ç”°ä¸­" onchange="updateAllDisplays()">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ãƒ»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„<br>
                        ãƒ»æŒ‡å®šã—ãŸé †ç•ªã§è¡¨ç¤ºã•ã‚Œã¾ã™<br>
                        ãƒ»æŒ‡å®šã—ã¦ã„ãªã„æ‹…å½“è€…ã¯å¾Œã‚ã«ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã§è¡¨ç¤ºã•ã‚Œã¾ã™<br>
                        ãƒ»è¨­å®šã¯è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã¾ã™
                    </small>
                </div>
                
                <button class="btn btn-primary" onclick="updateAllDisplays()" style="margin-top: 10px;">è¨­å®šã‚’é©ç”¨</button>
            </div>
        </div>
    </div>
</div>

<input type="file" id="fileInput" accept=".json,.xlsx,.xls" style="display: none;" onchange="handleFileImport(event)">

<!-- ä½œæ¥­è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="workModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">ä½œæ¥­è©³ç´°</h3>
            <button class="modal-close" onclick="closeWorkModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
        </div>
    </div>
</div>

<!-- å®Ÿç¸¾ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editActualModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†</h3>
            <button class="modal-close" onclick="closeEditActualModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editActualId">
            <div class="form-group">
                <label>æ—¥ä»˜</label>
                <input type="date" id="editActualDate">
            </div>
            <div class="form-group">
                <label>ç‰ˆæ•°</label>
                <input type="text" id="editActualVersion" placeholder="ç¬¬2025.12ç‰ˆ">
            </div>
            <div class="form-group">
                <label>å¯¾å¿œå</label>
                <input type="text" id="editActualTaskSearch" placeholder="æ¤œç´¢ã¾ãŸã¯æ–°è¦å…¥åŠ›" list="editActualTaskList" oninput="handleActualTaskInput()">
                <datalist id="editActualTaskList">
                </datalist>
                <small style="color: #666; display: block; margin-top: 5px;">
                    â†‘ æ—¢å­˜ã®å¯¾å¿œåã‚’é¸æŠã€ã¾ãŸã¯æ–°ã—ã„åå‰ã‚’å…¥åŠ›
                </small>
            </div>
            <div class="form-group">
                <label>å·¥ç¨‹</label>
                <select id="editActualProcess">
                    <option value="UI">UI</option>
                    <option value="PG">PG</option>
                    <option value="PT">PT</option>
                    <option value="IT">IT</option>
                    <option value="ST">ST</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ‹…å½“</label>
                <select id="editActualMember">
                </select>
            </div>
            <div class="form-group">
                <label>å®Ÿç¸¾å·¥æ•°</label>
                <input type="number" id="editActualHours" step="0.5" min="0" placeholder="8">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveActualEdit()">ä¿å­˜</button>
                <button class="btn" onclick="closeEditActualModal()" style="background: #95a5a6; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
</div>

<!-- è¦‹ç©ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="editEstimateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†</h3>
            <button class="modal-close" onclick="closeEditEstimateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editEstimateId">
            <div class="form-group">
                <label>ç‰ˆæ•°</label>
                <input type="text" id="editEstimateVersion" placeholder="ç¬¬2025.12ç‰ˆ">
            </div>
            <div class="form-group">
                <label>å¯¾å¿œå</label>
                <input type="text" id="editEstimateTaskSearch" placeholder="æ¤œç´¢ã¾ãŸã¯æ–°è¦å…¥åŠ›" list="editEstimateTaskList" oninput="handleEstimateTaskInput()">
                <datalist id="editEstimateTaskList">
                </datalist>
                <small style="color: #666; display: block; margin-top: 5px;">
                    â†‘ æ—¢å­˜ã®å¯¾å¿œåã‚’é¸æŠã€ã¾ãŸã¯æ–°ã—ã„åå‰ã‚’å…¥åŠ›
                </small>
            </div>
            <div class="form-group">
                <label>å·¥ç¨‹</label>
                <select id="editEstimateProcess">
                    <option value="UI">UI</option>
                    <option value="PG">PG</option>
                    <option value="PT">PT</option>
                    <option value="IT">IT</option>
                    <option value="ST">ST</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ‹…å½“</label>
                <select id="editEstimateMember">
                </select>
            </div>
            <div class="form-group">
                <label>è¦‹ç©å·¥æ•°</label>
                <input type="number" id="editEstimateHours" step="0.5" min="0" placeholder="8">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveEstimateEdit()">ä¿å­˜</button>
                <button class="btn" onclick="closeEditEstimateModal()" style="background: #95a5a6; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
</div>

<script>
    let estimates = [];
    let actuals = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadData();
        updateMonthOptions();
        updateActualMonthOptions();
        updateMemberOptions();
        updateQuickTaskList();
        renderEstimateList();
        setDefaultActualMonth(); // å‰æœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º
        renderActualList();
        renderTodayActuals();
        updateReport();
    });

    function saveData(skipAutoBackup = false) {
        localStorage.setItem('manhour_estimates', JSON.stringify(estimates));
        localStorage.setItem('manhour_actuals', JSON.stringify(actuals));
        
        // æ‹…å½“è€…è¡¨ç¤ºé †ã‚’ä¿å­˜
        const memberOrder = document.getElementById('memberOrder').value.trim();
        if (memberOrder) {
            localStorage.setItem('manhour_memberOrder', memberOrder);
        }
        
        // å¾©å…ƒæ™‚ãªã©ã€è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆ
        if (!skipAutoBackup) {
            autoBackup();
        }
    }

    function updateMemberOptions() {
        // è¦‹ç©ã¨å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ‹…å½“è€…ã‚’æŠ½å‡º
        const members = new Set();
        estimates.forEach(e => members.add(e.member));
        actuals.forEach(a => members.add(a.member));
        
        // è¡¨ç¤ºé †ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
        let sortedMembers;
        const memberOrderInput = document.getElementById('memberOrder').value.trim();
        if (memberOrderInput) {
            const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
            const orderedMembers = [];
            const unorderedMembers = [];
            
            orderList.forEach(name => {
                if (members.has(name)) {
                    orderedMembers.push(name);
                }
            });
            
            Array.from(members).forEach(m => {
                if (!orderedMembers.includes(m)) {
                    unorderedMembers.push(m);
                }
            });
            
            sortedMembers = [...orderedMembers, ...unorderedMembers.sort()];
        } else {
            sortedMembers = Array.from(members).sort();
        }
        
        // å„å·¥ç¨‹ã®æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
        const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
        processes.forEach(process => {
            const select = document.getElementById(`est${process}_member`);
            if (select) {
                const currentValue = select.value;
                select.innerHTML = '<option value="">-</option>';
                
                sortedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    select.appendChild(option);
                });
                
                // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
                if (currentValue && sortedMembers.includes(currentValue)) {
                    select.value = currentValue;
                }
            }
        });
        
        // ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã®æ‹…å½“è€…é¸æŠè‚¢ã‚‚æ›´æ–°
        const quickMemberSelect = document.getElementById('quickMember');
        if (quickMemberSelect) {
            const currentValue = quickMemberSelect.value;
            quickMemberSelect.innerHTML = '';
            
            sortedMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                quickMemberSelect.appendChild(option);
            });
            
            // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
            if (currentValue && sortedMembers.includes(currentValue)) {
                quickMemberSelect.value = currentValue;
            } else if (sortedMembers.length > 0) {
                quickMemberSelect.value = sortedMembers[0];
            }
        }
    }

    function loadData() {
        const savedEstimates = localStorage.getItem('manhour_estimates');
        const savedActuals = localStorage.getItem('manhour_actuals');
        
        if (savedEstimates) estimates = JSON.parse(savedEstimates);
        if (savedActuals) actuals = JSON.parse(savedActuals);
        
        // æ‹…å½“è€…è¡¨ç¤ºé †ã‚’èª­ã¿è¾¼ã¿
        const savedMemberOrder = localStorage.getItem('manhour_memberOrder');
        if (savedMemberOrder) {
            document.getElementById('memberOrder').value = savedMemberOrder;
        }
    }

    function updateMonthOptions() {
        const select = document.getElementById('reportMonth');
        const months = new Set();
        
        // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æœˆã‚’æŠ½å‡º
        actuals.forEach(a => {
            if (a.date) {
                const month = a.date.substring(0, 7); // YYYY-MMå½¢å¼
                months.add(month);
            }
        });
        
        // æœˆã‚’é™é †ã§ã‚½ãƒ¼ãƒˆ
        const sortedMonths = Array.from(months).sort().reverse();
        
        // é¸æŠè‚¢ã‚’ç”Ÿæˆ
        select.innerHTML = '<option value="all">å…¨æœŸé–“</option>';
        sortedMonths.forEach(month => {
            const [year, monthNum] = month.split('-');
            const option = document.createElement('option');
            option.value = month;
            option.textContent = `${year}å¹´${monthNum}æœˆ`;
            select.appendChild(option);
        });
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å‰æœˆã‚’é¸æŠ
        const today = new Date();
        const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const defaultMonth = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;
        
        // å‰æœˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const options = Array.from(select.options);
        const hasDefaultMonth = options.some(opt => opt.value === defaultMonth);
        
        if (hasDefaultMonth) {
            select.value = defaultMonth;
        } else if (options.length > 1) {
            // å‰æœˆã®ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã€æœ€æ–°æœˆã‚’é¸æŠ
            select.value = options[1].value; // options[0]ã¯ã€Œå…¨æœŸé–“ã€ãªã®ã§ã€options[1]ãŒæœ€æ–°æœˆ
        }
    }

    function updateActualMonthOptions() {
        const select = document.getElementById('actualMonthFilter');
        const months = new Set();
        
        // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æœˆã‚’æŠ½å‡º
        actuals.forEach(a => {
            if (a.date) {
                const month = a.date.substring(0, 7); // YYYY-MMå½¢å¼
                months.add(month);
            }
        });
        
        // æœˆã‚’é™é †ã§ã‚½ãƒ¼ãƒˆ
        const sortedMonths = Array.from(months).sort().reverse();
        
        // é¸æŠè‚¢ã‚’ç”Ÿæˆ
        select.innerHTML = '<option value="all">å…¨æœŸé–“</option>';
        sortedMonths.forEach(month => {
            const [year, monthNum] = month.split('-');
            const option = document.createElement('option');
            option.value = month;
            option.textContent = `${year}å¹´${monthNum}æœˆ`;
            select.appendChild(option);
        });
    }

    function setDefaultActualMonth() {
        // å‰æœˆã‚’è¨ˆç®—
        const today = new Date();
        const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const defaultMonth = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;
        
        const select = document.getElementById('actualMonthFilter');
        
        // å‰æœˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const options = Array.from(select.options);
        const hasDefaultMonth = options.some(opt => opt.value === defaultMonth);
        
        if (hasDefaultMonth) {
            select.value = defaultMonth;
        } else if (options.length > 1) {
            // å‰æœˆã®ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã€æœ€æ–°æœˆã‚’é¸æŠ
            select.value = options[1].value; // options[0]ã¯ã€Œå…¨æœŸé–“ã€ãªã®ã§ã€options[1]ãŒæœ€æ–°æœˆ
        }
    }

    function autoBackup() {
        const data = {
            estimates: estimates,
            actuals: actuals,
            memberOrder: document.getElementById('memberOrder').value.trim(),
            timestamp: new Date().toISOString(),
            version: '1.0'
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        const second = String(now.getSeconds()).padStart(2, '0');
        const timestamp = `${year}-${month}-${day}_${hour}-${minute}-${second}`;
        
        a.href = url;
        a.download = `å·¥æ•°ç®¡ç†_ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—_${timestamp}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(tabName).classList.add('active');
    }

    function addEstimate() {
        const version = document.getElementById('estVersion').value;
        const task = document.getElementById('estTask').value;
        
        if (!version || !task) {
            alert('ç‰ˆæ•°ã¨å¯¾å¿œåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        const processes = ['UI', 'PG', 'PT', 'IT', 'ST'];
        
        processes.forEach(proc => {
            const hours = parseFloat(document.getElementById(`est${proc}`).value);
            const member = document.getElementById(`est${proc}_member`).value;
            
            if (hours > 0 && member) {
                estimates.push({
                    id: Date.now() + Math.random(),
                    version: version,
                    task: task,
                    process: proc,
                    member: member,
                    hours: hours,
                    createdAt: new Date().toISOString()
                });
            }
        });

        saveData();
        clearEstimateForm();
        updateMemberOptions();
        renderEstimateList();
        updateQuickTaskList();
        updateReport();
        alert('è¦‹ç©ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
    }

    function clearEstimateForm() {
        document.getElementById('estVersion').value = '';
        document.getElementById('estTask').value = '';
        ['UI', 'PG', 'PT', 'IT', 'ST'].forEach(proc => {
            document.getElementById(`est${proc}`).value = '';
            document.getElementById(`est${proc}_member`).value = '';
        });
    }

    // ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ç”¨ã®å¤‰æ•°
    let allQuickTasks = [];
    let selectedQuickTask = null;
    let currentQuickMember = null;

    function updateQuickTaskList() {
        // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä¸€æ„ã®ã‚¿ã‚¹ã‚¯ã‚’æŠ½å‡ºï¼ˆæ‹…å½“è€…æƒ…å ±ã‚‚å«ã‚€ï¼‰
        const taskMap = new Map();
        estimates.forEach(e => {
            const key = `${e.version}|${e.task}|${e.process}|${e.member}`;
            if (!taskMap.has(key)) {
                taskMap.set(key, {
                    version: e.version,
                    task: e.task,
                    process: e.process,
                    member: e.member,
                    display: `${e.version} - ${e.task} [${e.process}]`
                });
            }
        });
        
        allQuickTasks = Array.from(taskMap.values());
        
        // æ‹…å½“è€…ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
        updateQuickMemberSelect();
    }

    function updateQuickMemberSelect() {
        const select = document.getElementById('quickMemberSelect');
        const members = new Set();
        
        // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ‹…å½“è€…ã‚’æŠ½å‡º
        estimates.forEach(e => members.add(e.member));
        
        // è¡¨ç¤ºé †ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
        let sortedMembers;
        const memberOrderInput = document.getElementById('memberOrder').value.trim();
        if (memberOrderInput) {
            const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
            const orderedMembers = orderList.filter(m => members.has(m));
            const unorderedMembers = Array.from(members).filter(m => !orderedMembers.includes(m)).sort();
            sortedMembers = [...orderedMembers, ...unorderedMembers];
        } else {
            sortedMembers = Array.from(members).sort();
        }
        
        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆï¼ˆæœ€åˆã®é¸æŠè‚¢ã‚’æ®‹ã™ï¼‰
        const currentValue = select.value;
        select.innerHTML = '<option value="">æ‹…å½“è€…ã‚’é¸æŠ...</option>';
        sortedMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member;
            option.textContent = member;
            select.appendChild(option);
        });
        
        // å‰å›é¸æŠã—ã¦ã„ãŸå€¤ã‚’å¾©å…ƒ
        if (currentValue && sortedMembers.includes(currentValue)) {
            select.value = currentValue;
        }
    }

    function updateQuickTasksByMember() {
        const selectedMember = document.getElementById('quickMemberSelect').value;
        currentQuickMember = selectedMember;
        
        const taskSelectArea = document.getElementById('quickTaskSelectArea');
        const memberOverride = document.getElementById('quickMemberOverride');
        
        if (!selectedMember) {
            taskSelectArea.style.display = 'none';
            return;
        }
        
        // ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
        taskSelectArea.style.display = 'block';
        
        // æ‹…å½“å¤‰æ›´ç”¨ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
        const allMembers = new Set();
        estimates.forEach(e => allMembers.add(e.member));
        memberOverride.innerHTML = '<option value="">ï¼ˆå¤‰æ›´ãªã—ï¼‰</option>';
        Array.from(allMembers).sort().forEach(member => {
            if (member !== selectedMember) {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                memberOverride.appendChild(option);
            }
        });
        
        // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
        document.getElementById('quickTaskSearch').value = '';
        document.getElementById('quickTaskDisplay').value = '';
        selectedQuickTask = null;
        
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¡¨ç¤ºï¼ˆæ‹…å½“è€…ã®å¯¾å¿œã®ã¿ï¼‰
        filterQuickTaskListByMember();
    }

    function showQuickTaskDropdown() {
        if (currentQuickMember) {
            filterQuickTaskListByMember();
        }
    }

    function hideQuickTaskDropdown() {
        // å°‘ã—é…å»¶ã•ã›ã¦ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        setTimeout(() => {
            document.getElementById('quickTaskDropdown').style.display = 'none';
        }, 200);
    }

    function filterQuickTaskListByMember() {
        if (!currentQuickMember) return;
        
        const searchText = document.getElementById('quickTaskSearch').value.toLowerCase();
        const dropdown = document.getElementById('quickTaskDropdown');
        
        // é¸æŠä¸­ã®æ‹…å½“è€…ã®ã‚¿ã‚¹ã‚¯ã®ã¿è¡¨ç¤º
        let filtered = allQuickTasks.filter(taskInfo => taskInfo.member === currentQuickMember);
        
        if (searchText) {
            filtered = filtered.filter(taskInfo => 
                taskInfo.display.toLowerCase().includes(searchText)
            );
        }
        
        if (filtered.length === 0) {
            dropdown.innerHTML = '<div class="custom-dropdown-empty">è©²å½“ã™ã‚‹å¯¾å¿œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
        } else {
            dropdown.innerHTML = filtered.map(taskInfo => {
                const value = `${taskInfo.version}|${taskInfo.task}|${taskInfo.process}|${taskInfo.member}`;
                return `<div class="custom-dropdown-item" onmousedown="selectQuickTaskNew('${value.replace(/'/g, "\\'")}', '${taskInfo.display.replace(/'/g, "\\'")}')">${taskInfo.display}</div>`;
            }).join('');
        }
        
        dropdown.style.display = 'block';
    }

    function selectQuickTaskNew(value, display) {
        selectedQuickTask = value;
        document.getElementById('quickTaskSearch').value = display;
        document.getElementById('quickTaskDisplay').value = display;
        document.getElementById('quickTaskDropdown').style.display = 'none';
    }

    function quickAddActual() {
        const hours = parseFloat(document.getElementById('quickHours').value);
        const memberOverride = document.getElementById('quickMemberOverride').value;
        
        if (!selectedQuickTask || !hours) {
            alert('å¯¾å¿œã¨å®Ÿç¸¾å·¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        const [version, task, process, originalMember] = selectedQuickTask.split('|');
        
        // æ‹…å½“è€…ã®å¤‰æ›´ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°å…ƒã®æ‹…å½“è€…
        const finalMember = memberOverride || originalMember;

        actuals.push({
            id: Date.now(),
            date: new Date().toISOString().split('T')[0],
            version: version,
            task: task,
            process: process,
            member: finalMember,
            hours: hours,
            createdAt: new Date().toISOString()
        });

        saveData();
        
        // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ‹…å½“è€…ã¯ç¶­æŒï¼‰
        document.getElementById('quickTaskSearch').value = '';
        document.getElementById('quickTaskDisplay').value = '';
        document.getElementById('quickHours').value = '';
        document.getElementById('quickMemberOverride').value = '';
        selectedQuickTask = null;
        
        updateMonthOptions();
        updateActualMonthOptions();
        updateMemberOptions();
        renderTodayActuals();
        renderActualList();
        updateReport();
        alert('å®Ÿç¸¾ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    }

    function renderTodayActuals() {
        const today = new Date().toISOString().split('T')[0];
        const todayData = actuals.filter(a => a.date === today);
        
        const container = document.getElementById('todayActuals');
        
        if (todayData.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">ã¾ã å®Ÿç¸¾ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            return;
        }

        let html = '<div class="table-wrapper"><table><tr><th>æ™‚åˆ»</th><th>ç‰ˆæ•°</th><th>å¯¾å¿œå</th><th>å·¥ç¨‹</th><th>æ‹…å½“</th><th>å·¥æ•°</th><th>æ“ä½œ</th></tr>';
        
        todayData.forEach(a => {
            const time = new Date(a.createdAt).toLocaleTimeString('ja-JP');
            html += `
                <tr>
                    <td>${time}</td>
                    <td>${a.version}</td>
                    <td>${a.task}</td>
                    <td><span class="badge badge-${a.process.toLowerCase()}">${a.process}</span></td>
                    <td>${a.member}</td>
                    <td>${a.hours}h</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editActual(${a.id})" style="margin-right: 5px;">ç·¨é›†</button>
                        <button class="btn btn-danger btn-small" onclick="deleteActual(${a.id})">å‰Šé™¤</button>
                    </td>
                </tr>
            `;
        });
        
        html += '</table></div>';
        container.innerHTML = html;
    }

    function renderEstimateList() {
        const container = document.getElementById('estimateList');
        const viewType = document.getElementById('estimateViewType').value;
        
        if (estimates.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">è¦‹ç©ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }

        if (viewType === 'grouped') {
            renderEstimateGrouped();
        } else if (viewType === 'matrix') {
            renderEstimateMatrix();
        } else {
            renderEstimateDetailList();
        }
    }

    // æœˆã®å®Ÿåƒæ—¥æ•°ã‚’è¨ˆç®—ï¼ˆåœŸæ—¥ç¥æ—¥ã‚’é™¤ãï¼‰
    function getWorkingDays(year, month) {
        const lastDay = new Date(year, month, 0).getDate();
        let workingDays = 0;
        
        for (let day = 1; day <= lastDay; day++) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const date = new Date(year, month - 1, day);
            const dayOfWeek = date.getDay();
            const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6); // æ—¥æ›œoråœŸæ›œ
            const holiday = getHoliday(dateStr);
            
            if (!isWeekend && !holiday) {
                workingDays++;
            }
        }
        
        return workingDays;
    }
    
    // ç¾åœ¨ã®å¹´æœˆã®å®Ÿåƒæ—¥æ•°ã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ä½¿ç”¨ï¼‰
    function getCurrentMonthWorkingDays() {
        const now = new Date();
        return getWorkingDays(now.getFullYear(), now.getMonth() + 1);
    }
    
    // æ•°å€¤ã‚’æ•´æ•°è¡¨ç¤ºï¼ˆå°æ•°ç‚¹ä»¥ä¸‹ãŒ0ã®å ´åˆï¼‰ã¾ãŸã¯å°æ•°è¡¨ç¤º
    function formatNumber(num, decimals = 1) {
        const rounded = parseFloat(num.toFixed(decimals));
        return rounded % 1 === 0 ? rounded.toFixed(0) : rounded.toFixed(decimals);
    }

    function renderEstimateGrouped() {
        const container = document.getElementById('estimateList');
        
        // ç‰ˆæ•°ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const versionGroups = {};
        estimates.forEach(e => {
            if (!versionGroups[e.version]) {
                versionGroups[e.version] = {};
            }
            const taskKey = e.task;
            if (!versionGroups[e.version][taskKey]) {
                versionGroups[e.version][taskKey] = {
                    task: e.task,
                    processes: []
                };
            }
            versionGroups[e.version][taskKey].processes.push({
                process: e.process,
                member: e.member,
                hours: e.hours,
                id: e.id
            });
        });
        
        // å®Ÿåƒæ—¥æ•°ã‚’è¨ˆç®—ï¼ˆå½“æœˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
        const workingDaysPerMonth = getCurrentMonthWorkingDays();
        
        let html = '<div style="margin-bottom: 30px;">';
        html += `<div style="background: #e3f2fd; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; color: #1565c0;">
            <strong>æ›ç®—åŸºæº–:</strong> 1äººæ—¥ = 8hã€1äººæœˆ = ${workingDaysPerMonth}äººæ—¥ï¼ˆå½“æœˆã®å®Ÿåƒæ—¥æ•°ã€åœŸæ—¥ç¥æ—¥é™¤ãï¼‰
        </div>`;
        
        // ç‰ˆæ•°ã”ã¨ã«è¡¨ç¤º
        Object.keys(versionGroups).sort().forEach(version => {
            html += `<div style="margin-bottom: 30px;">`;
            html += `<h3 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border-radius: 8px; margin: 0 0 15px 0; font-size: 18px;">${version}</h3>`;
            html += '<div class="table-wrapper"><table>';
            html += '<tr><th style="min-width: 200px;">å¯¾å¿œå</th><th style="min-width: 80px;">å·¥ç¨‹</th><th style="min-width: 80px;">æ‹…å½“</th><th style="min-width: 80px;">å·¥æ•°</th><th style="min-width: 150px;">å¯¾å¿œåˆè¨ˆ</th><th style="min-width: 150px;">æ“ä½œ</th></tr>';
            
            Object.values(versionGroups[version]).forEach(taskGroup => {
                const total = taskGroup.processes.reduce((sum, p) => sum + p.hours, 0);
                const days = total / 8;
                const months = total / 8 / workingDaysPerMonth;
                
                const processOrder = ['UI', 'PG', 'PT', 'IT', 'ST'];
                const sortedProcesses = taskGroup.processes.sort((a, b) => 
                    processOrder.indexOf(a.process) - processOrder.indexOf(b.process)
                );
                
                sortedProcesses.forEach((proc, index) => {
                    html += '<tr>';
                    if (index === 0) {
                        html += `<td rowspan="${sortedProcesses.length}" style="vertical-align: top; padding-top: 12px; font-weight: 600;">${taskGroup.task}</td>`;
                    }
                    html += `<td><span class="badge badge-${proc.process.toLowerCase()}">${proc.process}</span></td>`;
                    html += `<td>${proc.member}</td>`;
                    html += `<td style="text-align: right;">${proc.hours}h</td>`;
                    if (index === 0) {
                        html += `<td rowspan="${sortedProcesses.length}" style="vertical-align: top; padding-top: 12px; text-align: right;">
                            <div style="font-weight: 700; color: #1976d2; font-size: 16px; margin-bottom: 4px;">${formatNumber(total, 1)}h</div>
                            <div style="font-size: 13px; color: #666;">${formatNumber(days, 1)}äººæ—¥ / ${formatNumber(months, 2)}äººæœˆ</div>
                        </td>`;
                    }
                    html += `<td>
                        <button class="btn btn-primary btn-small" onclick="editEstimate(${proc.id})" style="margin-right: 5px;">ç·¨é›†</button>
                        <button class="btn btn-danger btn-small" onclick="deleteEstimate(${proc.id})">å‰Šé™¤</button>
                    </td>`;
                    html += '</tr>';
                });
            });
            
            // ç‰ˆæ•°ã®åˆè¨ˆ
            const versionTotal = Object.values(versionGroups[version])
                .reduce((sum, taskGroup) => sum + taskGroup.processes.reduce((s, p) => s + p.hours, 0), 0);
            const versionDays = versionTotal / 8;
            const versionMonths = versionTotal / 8 / workingDaysPerMonth;
            
            html += `<tr style="background: #f5f5f5; font-weight: 700;">`;
            html += `<td colspan="3" style="text-align: right; padding-right: 20px;">${version} åˆè¨ˆ</td>`;
            html += `<td style="text-align: right;">${formatNumber(versionTotal, 1)}h</td>`;
            html += `<td style="text-align: right;">
                <div style="font-size: 15px; margin-bottom: 3px;">${formatNumber(versionDays, 1)}äººæ—¥ / ${formatNumber(versionMonths, 2)}äººæœˆ</div>
            </td>`;
            html += `<td></td>`;
            html += `</tr>`;
            
            html += '</table></div>';
            html += '</div>';
        });
        
        html += '</div>';
        container.innerHTML = html;
    }

    function renderEstimateMatrix() {
        const container = document.getElementById('estimateList');
        
        // å¯¾å¿œã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const taskGroups = {};
        estimates.forEach(e => {
            const key = `${e.version}|||${e.task}`;
            if (!taskGroups[key]) {
                taskGroups[key] = {
                    version: e.version,
                    task: e.task,
                    processes: {}
                };
            }
            taskGroups[key].processes[e.process] = {
                member: e.member,
                hours: e.hours,
                id: e.id
            };
        });
        
        const processOrder = ['UI', 'PG', 'PT', 'IT', 'ST'];
        
        let html = '<div class="table-wrapper"><table>';
        html += '<tr><th style="min-width: 120px;">ç‰ˆæ•°</th><th style="min-width: 200px;">å¯¾å¿œå</th>';
        processOrder.forEach(proc => {
            html += `<th style="min-width: 100px; text-align: center;">${proc}</th>`;
        });
        html += '<th style="min-width: 80px; text-align: center;">åˆè¨ˆ</th><th style="min-width: 150px;">æ“ä½œ</th></tr>';
        
        Object.values(taskGroups).forEach(group => {
            html += '<tr>';
            html += `<td style="font-weight: 600;">${group.version}</td>`;
            html += `<td>${group.task}</td>`;
            
            let total = 0;
            let firstId = null;
            processOrder.forEach(proc => {
                if (group.processes[proc]) {
                    const p = group.processes[proc];
                    total += p.hours;
                    if (!firstId) firstId = p.id;
                    html += `<td style="text-align: center;">
                        <div style="font-weight: 600;">${p.hours}h</div>
                        <div style="font-size: 12px; color: #666;">(${p.member})</div>
                    </td>`;
                } else {
                    html += `<td style="text-align: center; color: #ccc;">-</td>`;
                }
            });
            
            html += `<td style="text-align: center; font-weight: 700; color: #1976d2;">${total.toFixed(1)}h</td>`;
            html += `<td>
                <button class="btn btn-primary btn-small" onclick="editEstimate(${firstId})" style="margin-right: 5px;">ç·¨é›†</button>
                <button class="btn btn-danger btn-small" onclick="deleteEstimate(${firstId})">å‰Šé™¤</button>
            </td>`;
            html += '</tr>';
        });
        
        html += '</table></div>';
        container.innerHTML = html;
    }

    function renderEstimateDetailList() {
        const container = document.getElementById('estimateList');
        
        let html = '<div class="table-wrapper"><table><tr><th>ç‰ˆæ•°</th><th>å¯¾å¿œå</th><th>å·¥ç¨‹</th><th>æ‹…å½“</th><th>è¦‹ç©å·¥æ•°</th><th>æ“ä½œ</th></tr>';
        
        estimates.forEach(e => {
            html += `
                <tr>
                    <td>${e.version}</td>
                    <td>${e.task}</td>
                    <td><span class="badge badge-${e.process.toLowerCase()}">${e.process}</span></td>
                    <td>${e.member}</td>
                    <td>${e.hours}h</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editEstimate(${e.id})" style="margin-right: 5px;">ç·¨é›†</button>
                        <button class="btn btn-danger btn-small" onclick="deleteEstimate(${e.id})">å‰Šé™¤</button>
                    </td>
                </tr>
            `;
        });
        
        html += '</table></div>';
        container.innerHTML = html;
    }

    function renderActualList() {
        const container = document.getElementById('actualList');
        const viewType = document.getElementById('actualViewType').value;
        const viewMode = document.getElementById('actualViewMode').value;
        
        // æ‹…å½“è€…åˆ¥ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯æ‹…å½“è€…é¸æŠã‚’è¡¨ç¤º
        const memberSelectGroup = document.getElementById('memberSelectGroup');
        if (viewMode === 'member') {
            memberSelectGroup.style.display = 'block';
            updateMemberSelectOptions();
        } else {
            memberSelectGroup.style.display = 'none';
        }
        
        if (actuals.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }

        if (viewType === 'matrix') {
            if (viewMode === 'member') {
                renderMemberCalendar();
            } else {
                renderActualMatrix();
            }
        } else {
            renderActualListView();
        }
    }

    function updateMemberSelectOptions() {
        const select = document.getElementById('actualMemberSelect');
        const currentValue = select.value;
        
        // æ‹…å½“è€…ã‚’æŠ½å‡º
        const allMembers = new Set();
        actuals.forEach(a => allMembers.add(a.member));
        estimates.forEach(e => allMembers.add(e.member));
        
        // è¡¨ç¤ºé †ã§ã‚½ãƒ¼ãƒˆ
        let sortedMembers;
        const memberOrderInput = document.getElementById('memberOrder').value.trim();
        if (memberOrderInput) {
            const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
            const orderedMembers = [];
            const unorderedMembers = [];
            
            orderList.forEach(name => {
                if (allMembers.has(name)) {
                    orderedMembers.push(name);
                }
            });
            
            Array.from(allMembers).forEach(m => {
                if (!orderedMembers.includes(m)) {
                    unorderedMembers.push(m);
                }
            });
            
            sortedMembers = [...orderedMembers, ...unorderedMembers.sort()];
        } else {
            sortedMembers = Array.from(allMembers).sort();
        }
        
        select.innerHTML = '';
        sortedMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member;
            option.textContent = member;
            select.appendChild(option);
        });
        
        // ä»¥å‰ã®é¸æŠã‚’å¾©å…ƒ
        if (currentValue && sortedMembers.includes(currentValue)) {
            select.value = currentValue;
        } else if (sortedMembers.length > 0) {
            select.value = sortedMembers[0];
        }
    }

    function renderMemberCalendar() {
        const container = document.getElementById('actualList');
        const selectedMonth = document.getElementById('actualMonthFilter').value;
        const selectedMember = document.getElementById('actualMemberSelect').value;
        
        if (!selectedMember) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
            return;
        }
        
        // æ‹…å½“è€…ã¨æœˆã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        let filteredActuals = actuals.filter(a => a.member === selectedMember);
        if (selectedMonth !== 'all') {
            filteredActuals = filteredActuals.filter(a => a.date && a.date.startsWith(selectedMonth));
        }
        
        if (filteredActuals.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">é¸æŠã—ãŸæœŸé–“ã«å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }
        
        // æ—¥ä»˜ç¯„å›²ã‚’è¨ˆç®—
        const dates = filteredActuals.map(a => a.date).sort();
        let startDate, endDate;
        
        if (selectedMonth !== 'all') {
            const [year, month] = selectedMonth.split('-');
            const yearNum = parseInt(year);
            const monthNum = parseInt(month);
            
            startDate = `${year}-${month}-01`;
            const lastDay = new Date(yearNum, monthNum, 0).getDate();
            endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
        } else {
            const [minYear, minMonth] = dates[0].split('-');
            const [maxYear, maxMonth] = dates[dates.length - 1].split('-');
            
            startDate = `${minYear}-${minMonth}-01`;
            const lastDay = new Date(parseInt(maxYear), parseInt(maxMonth), 0).getDate();
            endDate = `${maxYear}-${maxMonth}-${String(lastDay).padStart(2, '0')}`;
        }
        
        // æ—¥ä»˜ãƒªã‚¹ãƒˆç”Ÿæˆ
        const allDates = [];
        let currentDateStr = startDate;
        while (currentDateStr <= endDate) {
            allDates.push(currentDateStr);
            const [y, m, d] = currentDateStr.split('-').map(Number);
            const nextDate = new Date(y, m - 1, d + 1);
            currentDateStr = `${nextDate.getFullYear()}-${String(nextDate.getMonth() + 1).padStart(2, '0')}-${String(nextDate.getDate()).padStart(2, '0')}`;
        }
        
        // åˆè¨ˆæƒ…å ±
        const totalHours = filteredActuals.reduce((sum, a) => sum + a.hours, 0);
        const workedDays = new Set(filteredActuals.map(a => a.date)).size;
        
        let html = `<h3 style="margin-bottom: 10px;">${selectedMember}ã®å®Ÿç¸¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>`;
        
        if (selectedMonth !== 'all') {
            const [year, month] = selectedMonth.split('-');
            html += `<div style="margin-bottom: 15px;">
                <p style="margin: 0 0 5px 0; font-weight: 600;">${year}å¹´${parseInt(month)}æœˆã®åˆè¨ˆ</p>
                <p style="margin: 0; color: #666; font-size: 14px;">ç¨¼åƒæ—¥æ•°: ${workedDays}æ—¥ / åˆè¨ˆå·¥æ•°: ${totalHours.toFixed(1)}h</p>
            </div>`;
        }
        
        html += '<div class="table-wrapper" style="overflow-x: auto;"><table style="min-width: 100%;">';
        html += '<tr><th style="min-width: 120px; position: static;">æ—¥ä»˜</th><th style="min-width: 300px;">ä½œæ¥­å†…å®¹</th><th style="min-width: 80px;">å·¥æ•°</th></tr>';
        
        allDates.forEach(date => {
            const dateObj = new Date(date);
            const dayOfWeek = getDayOfWeek(date);
            const holiday = getHoliday(date);
            const isWeekend = dayOfWeek === 'åœŸ' || dayOfWeek === 'æ—¥';
            const isHoliday = holiday !== null;
            
            const dayActuals = filteredActuals.filter(a => a.date === date);
            const dayTotal = dayActuals.reduce((sum, a) => sum + a.hours, 0);
            
            const bgColor = (isWeekend || isHoliday) ? '#ffebee' : 'white';
            const dateColor = (isWeekend || isHoliday) ? 'color: #c62828;' : '';
            const holidayName = isHoliday ? ` ${holiday}` : '';
            
            const [year, m, day] = date.split('-');
            const dateDisplay = `${parseInt(m)}/${parseInt(day)} (${dayOfWeek})${holidayName}`;
            
            if (dayActuals.length === 0) {
                html += `<tr style="background: ${bgColor};">`;
                html += `<td style="font-weight: 500; ${dateColor} position: static;">${dateDisplay}</td>`;
                html += `<td style="color: #999;">-</td>`;
                html += `<td style="text-align: center; color: #999;">-</td>`;
                html += `</tr>`;
            } else {
                dayActuals.forEach((actual, index) => {
                    if (index === 0) {
                        html += `<tr style="background: ${bgColor};">`;
                        html += `<td rowspan="${dayActuals.length}" style="font-weight: 500; ${dateColor} vertical-align: top; padding-top: 12px; position: static;">${dateDisplay}</td>`;
                    } else {
                        html += `<tr style="background: ${bgColor};">`;
                    }
                    html += `<td>${actual.version} - ${actual.task} [${actual.process}]</td>`;
                    html += `<td style="text-align: center; font-weight: 600;">${actual.hours}h</td>`;
                    html += `</tr>`;
                });
            }
        });
        
        // ç·åˆè¨ˆè¡Œ
        html += `<tr style="background: #1565c0; color: white; font-weight: 700;">`;
        html += `<td>ç·åˆè¨ˆ</td>`;
        html += `<td style="text-align: right;">${workedDays}æ—¥ç¨¼åƒ</td>`;
        html += `<td style="text-align: center;">${totalHours.toFixed(1)}h</td>`;
        html += `</tr>`;
        
        html += '</table></div>';
        container.innerHTML = html;
    }

    function renderActualMatrix() {
        const container = document.getElementById('actualList');
        const selectedMonth = document.getElementById('actualMonthFilter').value;
        const memberOrderInput = document.getElementById('memberOrder').value.trim();
        
        // æœˆã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        let filteredActuals = actuals;
        if (selectedMonth !== 'all') {
            filteredActuals = actuals.filter(a => a.date && a.date.startsWith(selectedMonth));
        }
        
        if (filteredActuals.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">é¸æŠã—ãŸæœŸé–“ã«å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }
        
        // æ‹…å½“è€…ã‚’æŠ½å‡ºã—ã¦ä¸¦ã³æ›¿ãˆ
        let members = [...new Set(filteredActuals.map(a => a.member))];
        
        // è¡¨ç¤ºé †ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
        if (memberOrderInput) {
            const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
            const orderedMembers = [];
            const unorderedMembers = [];
            
            // æŒ‡å®šã•ã‚ŒãŸé †åºã§è¿½åŠ 
            orderList.forEach(name => {
                if (members.includes(name)) {
                    orderedMembers.push(name);
                }
            });
            
            // æŒ‡å®šã•ã‚Œã¦ã„ãªã„æ‹…å½“è€…ã‚’å¾Œã‚ã«è¿½åŠ 
            members.forEach(m => {
                if (!orderedMembers.includes(m)) {
                    unorderedMembers.push(m);
                }
            });
            
            members = [...orderedMembers, ...unorderedMembers.sort()];
        } else {
            members.sort();
        }
        
        // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã®æ—¥ä»˜ç¯„å›²ã‚’å–å¾—
        const dates = filteredActuals.map(a => a.date).sort();
        
        // è¡¨ç¤ºç¯„å›²ã‚’æ±ºå®š
        let startDate, endDate;
        if (selectedMonth !== 'all') {
            // é¸æŠã—ãŸæœˆã®ã¿ï¼ˆæœˆåˆã‹ã‚‰æœˆæœ«ã¾ã§æ­£ç¢ºã«ï¼‰
            const [year, month] = selectedMonth.split('-');
            const yearNum = parseInt(year);
            const monthNum = parseInt(month);
            
            // æœˆã®æœ€åˆã®æ—¥
            startDate = `${year}-${month}-01`;
            
            // æœˆã®æœ€å¾Œã®æ—¥ã‚’è¨ˆç®—
            const lastDay = new Date(yearNum, monthNum, 0).getDate();
            endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
        } else {
            // å…¨æœŸé–“ï¼ˆæœ€å°æ—¥ä»˜ã®æœˆåˆã‹ã‚‰æœ€å¤§æ—¥ä»˜ã®æœˆæœ«ã¾ã§ï¼‰
            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];
            
            const [minYear, minMonth] = minDate.split('-');
            const [maxYear, maxMonth] = maxDate.split('-');
            
            startDate = `${minYear}-${minMonth}-01`;
            
            const lastDay = new Date(parseInt(maxYear), parseInt(maxMonth), 0).getDate();
            endDate = `${maxYear}-${maxMonth}-${String(lastDay).padStart(2, '0')}`;
        }
        
        // æ—¥ä»˜ç¯„å›²ã‚’ç”Ÿæˆ
        const allDates = [];
        let currentDateStr = startDate;
        while (currentDateStr <= endDate) {
            allDates.push(currentDateStr);
            
            // æ¬¡ã®æ—¥ä»˜ã‚’è¨ˆç®—
            const [y, m, d] = currentDateStr.split('-').map(Number);
            const nextDate = new Date(y, m - 1, d + 1);
            currentDateStr = `${nextDate.getFullYear()}-${String(nextDate.getMonth() + 1).padStart(2, '0')}-${String(nextDate.getDate()).padStart(2, '0')}`;
        }
        
        let html = '';
        
        // æœˆã®åˆè¨ˆã‚’æœ€ä¸Šéƒ¨ã«è¡¨ç¤ºï¼ˆæœˆé¸æŠæ™‚ã®ã¿ï¼‰
        if (selectedMonth !== 'all') {
            const [year, month] = selectedMonth.split('-');
            
            // ç¨¼åƒæ—¥æ•°ã‚’è¨ˆç®—ï¼ˆå®Ÿç¸¾ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹æ—¥æ•°ï¼‰
            const workedDays = new Set(filteredActuals.map(a => a.date)).size;
            
            html += `<div style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 5px 0;">${year}å¹´${parseInt(month)}æœˆã®åˆè¨ˆ</h3>
                <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">ç¨¼åƒæ—¥æ•°: ${workedDays}æ—¥</p>
            </div>`;
            
            // åŒã˜table-wrapperå†…ã«åˆè¨ˆè¡¨ã‚’é…ç½®
            html += '<div class="table-wrapper"><table>';
            
            // åˆè¨ˆè¡Œï¼ˆæ¿ƒã„é’è‰²ï¼‰
            html += '<tr style="background: #1565c0; color: white; font-weight: 700;"><th style="min-width: 100px;">ç·åˆè¨ˆ</th>';
            
            let monthGrandTotal = 0;
            members.forEach(member => {
                const memberTotal = filteredActuals.filter(a => a.member === member).reduce((sum, a) => sum + a.hours, 0);
                monthGrandTotal += memberTotal;
                html += `<th style="text-align: center; min-width: 80px;">${memberTotal.toFixed(1)}h</th>`;
            });
            
            html += `<th style="background: #ff9800; text-align: center; min-width: 80px;">${monthGrandTotal.toFixed(1)}h</th>`;
            html += '</tr>';
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆé€šå¸¸ã®è‰²ï¼‰
            html += '<tr><th style="min-width: 100px;">æ—¥ä»˜</th>';
            
            // æ‹…å½“è€…ãƒ˜ãƒƒãƒ€ãƒ¼
            members.forEach(member => {
                html += `<th style="min-width: 80px; text-align: center;">${member}</th>`;
            });
            html += '<th style="min-width: 80px; text-align: center;">æ—¥åˆ¥åˆè¨ˆ</th></tr>';
        } else {
            // å…¨æœŸé–“è¡¨ç¤ºã®å ´åˆã¯é€šå¸¸é€šã‚Šãƒ˜ãƒƒãƒ€ãƒ¼ã®ã¿
            html += '<div class="table-wrapper"><table>';
            html += '<tr><th style="min-width: 100px;">æ—¥ä»˜</th>';
            
            // æ‹…å½“è€…ãƒ˜ãƒƒãƒ€ãƒ¼
            members.forEach(member => {
                html += `<th style="min-width: 80px; text-align: center;">${member}</th>`;
            });
            html += '<th style="min-width: 80px; text-align: center;">æ—¥åˆ¥åˆè¨ˆ</th></tr>';
        }
        
        let currentMonth = '';
        let monthTotals = {};
        members.forEach(m => monthTotals[m] = 0);
        let monthTotal = 0;
        
        // æ—¥ä»˜ã”ã¨ã®è¡Œ
        allDates.forEach(date => {
            const dateObj = new Date(date);
            const month = `${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ`;
            const dayOfWeek = getDayOfWeek(date);
            const isWeekend = dayOfWeek === 'åœŸ' || dayOfWeek === 'æ—¥';
            
            // ç¥æ—¥åˆ¤å®š
            const holiday = getHoliday(date);
            const isHoliday = holiday !== null;
            
            // æœˆãŒå¤‰ã‚ã£ãŸã‚‰æœˆæ¬¡å°è¨ˆè¡Œã‚’æŒ¿å…¥ï¼ˆå…¨æœŸé–“è¡¨ç¤ºæ™‚ã®ã¿ï¼‰
            if (selectedMonth === 'all' && currentMonth && currentMonth !== month) {
                html += '<tr style="background: #fff3cd; font-weight: 600;">';
                html += `<td>${currentMonth} å°è¨ˆ</td>`;
                members.forEach(member => {
                    html += `<td style="text-align: center;">${monthTotals[member].toFixed(1)}h</td>`;
                });
                html += `<td style="background: #ffc107; color: white; text-align: center;">${monthTotal.toFixed(1)}h</td>`;
                html += '</tr>';
                
                // ãƒªã‚»ãƒƒãƒˆ
                members.forEach(m => monthTotals[m] = 0);
                monthTotal = 0;
            }
            
            currentMonth = month;
            
            // æ—¥ä»˜è¡Œï¼ˆç¥æ—¥ã¾ãŸã¯é€±æœ«ï¼‰
            const bgColor = (isWeekend || isHoliday) ? '#ffebee' : 'white';
            html += `<tr style="background: ${bgColor};">`;
            
            // æ—¥ä»˜ã‚»ãƒ«
            const [year, m, day] = date.split('-');
            const dateColor = (isWeekend || isHoliday) ? 'color: #c62828;' : '';
            const holidayName = isHoliday ? ` ${holiday}` : '';
            html += `<td style="font-weight: 500; ${dateColor}">
                ${parseInt(m)}/${parseInt(day)} (${dayOfWeek})${holidayName}
            </td>`;
            
            let dayTotal = 0;
            
            // æ‹…å½“è€…ã”ã¨ã®ã‚»ãƒ«
            members.forEach(member => {
                const dayActuals = filteredActuals.filter(a => a.member === member && a.date === date);
                const memberDayTotal = dayActuals.reduce((sum, a) => sum + a.hours, 0);
                dayTotal += memberDayTotal;
                monthTotals[member] += memberDayTotal;
                
                if (memberDayTotal > 0) {
                    // ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º
                    html += `<td style="background: #e3f2fd; text-align: center; cursor: pointer;" 
                                onclick="showWorkDetail('${member}', '${date}')">
                        <strong>${memberDayTotal.toFixed(1)}</strong>
                    </td>`;
                } else {
                    html += `<td style="background: #fafafa; text-align: center; color: #ccc;">-</td>`;
                }
            });
            
            monthTotal += dayTotal;
            
            // æ—¥åˆ¥åˆè¨ˆ
            if (dayTotal > 0) {
                html += `<td style="font-weight: 700; background: #fff3cd; text-align: center;">${dayTotal.toFixed(1)}h</td>`;
            } else {
                html += `<td style="background: #fafafa; text-align: center; color: #ccc;">-</td>`;
            }
            
            html += '</tr>';
        });
        
        // æœ€å¾Œã®æœˆã®å°è¨ˆï¼ˆå…¨æœŸé–“è¡¨ç¤ºæ™‚ã®ã¿ï¼‰
        if (selectedMonth === 'all' && currentMonth) {
            html += '<tr style="background: #fff3cd; font-weight: 600;">';
            html += `<td>${currentMonth} å°è¨ˆ</td>`;
            members.forEach(member => {
                html += `<td style="text-align: center;">${monthTotals[member].toFixed(1)}h</td>`;
            });
            html += `<td style="background: #ffc107; color: white; text-align: center;">${monthTotal.toFixed(1)}h</td>`;
            html += '</tr>';
        }
        
        // å…¨æœŸé–“ã®åˆè¨ˆè¡Œ
        html += '<tr style="background: #2c3e50; color: white; font-weight: 700;">';
        html += '<td>ç·åˆè¨ˆ</td>';
        let grandTotal = 0;
        
        members.forEach(member => {
            const memberTotal = filteredActuals.filter(a => a.member === member).reduce((sum, a) => sum + a.hours, 0);
            grandTotal += memberTotal;
            html += `<td style="text-align: center;">${memberTotal.toFixed(1)}h</td>`;
        });
        
        html += `<td style="background: #ffc107; text-align: center;">${grandTotal.toFixed(1)}h</td>`;
        html += '</tr>';
        
        html += '</table></div>';
        
        // è©³ç´°ãƒªã‚¹ãƒˆï¼ˆå‰Šé™¤ç”¨ï¼‰
        html += '<h3 style="margin-top: 30px;">è©³ç´°ãƒ‡ãƒ¼ã‚¿ï¼ˆå‰Šé™¤ç”¨ï¼‰</h3>';
        html += '<div class="table-wrapper"><table><tr><th>æ—¥ä»˜</th><th>æ‹…å½“è€…</th><th>ç‰ˆæ•°</th><th>å¯¾å¿œå</th><th>å·¥ç¨‹</th><th>å®Ÿç¸¾å·¥æ•°</th><th>æ“ä½œ</th></tr>';
        
        const sortedActuals = [...filteredActuals].sort((a, b) => {
            if (a.date !== b.date) return b.date.localeCompare(a.date);
            return a.member.localeCompare(b.member);
        });
        
        sortedActuals.forEach(a => {
            html += `
                <tr>
                    <td>${a.date}</td>
                    <td>${a.member}</td>
                    <td>${a.version}</td>
                    <td>${a.task}</td>
                    <td><span class="badge badge-${a.process.toLowerCase()}">${a.process}</span></td>
                    <td>${a.hours}h</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editActual(${a.id})" style="margin-right: 5px;">ç·¨é›†</button>
                        <button class="btn btn-danger btn-small" onclick="deleteActual(${a.id})">å‰Šé™¤</button>
                    </td>
                </tr>
            `;
        });
        
        html += '</table></div>';
        container.innerHTML = html;
    }


    function renderActualListView() {
        const container = document.getElementById('actualList');
        const viewMode = document.getElementById('actualViewMode').value;
        const selectedMonth = document.getElementById('actualMonthFilter').value;
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†
        let filteredActuals = actuals;
        
        // æ‹…å½“è€…åˆ¥ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
        if (viewMode === 'member') {
            const selectedMember = document.getElementById('actualMemberSelect').value;
            if (selectedMember) {
                filteredActuals = filteredActuals.filter(a => a.member === selectedMember);
            }
        }
        
        // æœˆã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        if (selectedMonth !== 'all') {
            filteredActuals = filteredActuals.filter(a => a.date && a.date.startsWith(selectedMonth));
        }
        
        let html = '<div class="table-wrapper"><table><tr><th>æ—¥ä»˜</th><th>ç‰ˆæ•°</th><th>å¯¾å¿œå</th><th>å·¥ç¨‹</th><th>æ‹…å½“</th><th>å®Ÿç¸¾å·¥æ•°</th><th>æ“ä½œ</th></tr>';
        
        const sortedActuals = [...filteredActuals].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        if (sortedActuals.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">é¸æŠã—ãŸæ¡ä»¶ã«è©²å½“ã™ã‚‹å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }
        
        sortedActuals.forEach(a => {
            html += `
                <tr>
                    <td>${a.date}</td>
                    <td>${a.version}</td>
                    <td>${a.task}</td>
                    <td><span class="badge badge-${a.process.toLowerCase()}">${a.process}</span></td>
                    <td>${a.member}</td>
                    <td>${a.hours}h</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editActual(${a.id})" style="margin-right: 5px;">ç·¨é›†</button>
                        <button class="btn btn-danger btn-small" onclick="deleteActual(${a.id})">å‰Šé™¤</button>
                    </td>
                </tr>
            `;
        });
        
        html += '</table></div>';
        container.innerHTML = html;
    }

    function getDayOfWeek(dateStr) {
        const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        const date = new Date(dateStr);
        return days[date.getDay()];
    }

    function getHoliday(dateStr) {
        // @holiday-jp/holiday_jp ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨
        if (typeof holiday_jp !== 'undefined' && typeof holiday_jp.isHoliday === 'function') {
            try {
                const date = new Date(dateStr + 'T00:00:00');
                const holiday = holiday_jp.isHoliday(date);
                if (holiday) {
                    // holiday.name ãŒç¥æ—¥å
                    return holiday.name || holiday;
                }
            } catch (error) {
                console.error('Holiday check error:', error);
            }
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ä¸»è¦ãªç¥æ—¥ã®ã¿å¯¾å¿œï¼ˆ2025-2030å¹´ï¼‰
        const holidays = {
            // 2025å¹´
            '2025-01-01': 'å…ƒæ—¥',
            '2025-01-13': 'æˆäººã®æ—¥',
            '2025-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
            '2025-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
            '2025-02-24': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2025-03-20': 'æ˜¥åˆ†ã®æ—¥',
            '2025-04-29': 'æ˜­å’Œã®æ—¥',
            '2025-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
            '2025-05-04': 'ã¿ã©ã‚Šã®æ—¥',
            '2025-05-05': 'ã“ã©ã‚‚ã®æ—¥',
            '2025-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2025-07-21': 'æµ·ã®æ—¥',
            '2025-08-11': 'å±±ã®æ—¥',
            '2025-09-15': 'æ•¬è€ã®æ—¥',
            '2025-09-23': 'ç§‹åˆ†ã®æ—¥',
            '2025-10-13': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
            '2025-11-03': 'æ–‡åŒ–ã®æ—¥',
            '2025-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
            '2025-11-24': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2025-12-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
            // 2026å¹´
            '2026-01-01': 'å…ƒæ—¥',
            '2026-01-12': 'æˆäººã®æ—¥',
            '2026-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
            '2026-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
            '2026-03-20': 'æ˜¥åˆ†ã®æ—¥',
            '2026-04-29': 'æ˜­å’Œã®æ—¥',
            '2026-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
            '2026-05-04': 'ã¿ã©ã‚Šã®æ—¥',
            '2026-05-05': 'ã“ã©ã‚‚ã®æ—¥',
            '2026-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2026-07-20': 'æµ·ã®æ—¥',
            '2026-08-11': 'å±±ã®æ—¥',
            '2026-09-21': 'æ•¬è€ã®æ—¥',
            '2026-09-22': 'ç§‹åˆ†ã®æ—¥',
            '2026-10-12': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
            '2026-11-03': 'æ–‡åŒ–ã®æ—¥',
            '2026-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
            '2026-12-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
            // 2027å¹´
            '2027-01-01': 'å…ƒæ—¥',
            '2027-01-11': 'æˆäººã®æ—¥',
            '2027-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
            '2027-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
            '2027-03-21': 'æ˜¥åˆ†ã®æ—¥',
            '2027-03-22': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2027-04-29': 'æ˜­å’Œã®æ—¥',
            '2027-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
            '2027-05-04': 'ã¿ã©ã‚Šã®æ—¥',
            '2027-05-05': 'ã“ã©ã‚‚ã®æ—¥',
            '2027-07-19': 'æµ·ã®æ—¥',
            '2027-08-11': 'å±±ã®æ—¥',
            '2027-09-20': 'æ•¬è€ã®æ—¥',
            '2027-09-23': 'ç§‹åˆ†ã®æ—¥',
            '2027-10-11': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
            '2027-11-03': 'æ–‡åŒ–ã®æ—¥',
            '2027-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
            '2027-12-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
            // 2028å¹´
            '2028-01-01': 'å…ƒæ—¥',
            '2028-01-10': 'æˆäººã®æ—¥',
            '2028-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
            '2028-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
            '2028-03-20': 'æ˜¥åˆ†ã®æ—¥',
            '2028-04-29': 'æ˜­å’Œã®æ—¥',
            '2028-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
            '2028-05-04': 'ã¿ã©ã‚Šã®æ—¥',
            '2028-05-05': 'ã“ã©ã‚‚ã®æ—¥',
            '2028-07-17': 'æµ·ã®æ—¥',
            '2028-08-11': 'å±±ã®æ—¥',
            '2028-09-18': 'æ•¬è€ã®æ—¥',
            '2028-09-22': 'ç§‹åˆ†ã®æ—¥',
            '2028-10-09': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
            '2028-11-03': 'æ–‡åŒ–ã®æ—¥',
            '2028-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
            '2028-12-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
            // 2029å¹´
            '2029-01-01': 'å…ƒæ—¥',
            '2029-01-08': 'æˆäººã®æ—¥',
            '2029-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
            '2029-02-12': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2029-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
            '2029-03-20': 'æ˜¥åˆ†ã®æ—¥',
            '2029-04-29': 'æ˜­å’Œã®æ—¥',
            '2029-04-30': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2029-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
            '2029-05-04': 'ã¿ã©ã‚Šã®æ—¥',
            '2029-05-05': 'ã“ã©ã‚‚ã®æ—¥',
            '2029-07-16': 'æµ·ã®æ—¥',
            '2029-08-11': 'å±±ã®æ—¥',
            '2029-09-17': 'æ•¬è€ã®æ—¥',
            '2029-09-23': 'ç§‹åˆ†ã®æ—¥',
            '2029-09-24': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2029-10-08': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
            '2029-11-03': 'æ–‡åŒ–ã®æ—¥',
            '2029-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
            '2029-12-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
            '2029-12-24': 'æŒ¯æ›¿ä¼‘æ—¥',
            // 2030å¹´
            '2030-01-01': 'å…ƒæ—¥',
            '2030-01-14': 'æˆäººã®æ—¥',
            '2030-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
            '2030-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
            '2030-03-20': 'æ˜¥åˆ†ã®æ—¥',
            '2030-04-29': 'æ˜­å’Œã®æ—¥',
            '2030-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
            '2030-05-04': 'ã¿ã©ã‚Šã®æ—¥',
            '2030-05-05': 'ã“ã©ã‚‚ã®æ—¥',
            '2030-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2030-07-15': 'æµ·ã®æ—¥',
            '2030-08-11': 'å±±ã®æ—¥',
            '2030-08-12': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2030-09-16': 'æ•¬è€ã®æ—¥',
            '2030-09-23': 'ç§‹åˆ†ã®æ—¥',
            '2030-10-14': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
            '2030-11-03': 'æ–‡åŒ–ã®æ—¥',
            '2030-11-04': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2030-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
            '2030-12-23': 'å¤©çš‡èª•ç”Ÿæ—¥'
        };
        
        return holidays[dateStr] || null;
    }

    function showWorkDetail(member, date) {
        const dayActuals = actuals.filter(a => a.member === member && a.date === date);
        
        if (dayActuals.length === 0) return;
        
        const dateObj = new Date(date);
        const [year, month, day] = date.split('-');
        const dayOfWeek = getDayOfWeek(date);
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«
        document.getElementById('modalTitle').textContent = 
            `${member}ã•ã‚“ã®ä½œæ¥­ - ${year}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥(${dayOfWeek})`;
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬æ–‡
        let html = '';
        const totalHours = dayActuals.reduce((sum, a) => sum + a.hours, 0);
        
        dayActuals.forEach(actual => {
            html += `
                <div class="work-item">
                    <div class="work-item-header">
                        <div class="work-item-title">${actual.task}</div>
                        <div class="work-item-hours">${actual.hours}h</div>
                    </div>
                    <div class="work-item-details">
                        <span><strong>ç‰ˆæ•°:</strong> ${actual.version}</span>
                        <span><strong>å·¥ç¨‹:</strong> <span class="badge badge-${actual.process.toLowerCase()}">${actual.process}</span></span>
                    </div>
                </div>
            `;
        });
        
        html += `
            <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #eee; text-align: right;">
                <strong style="font-size: 16px;">åˆè¨ˆ: ${totalHours.toFixed(1)}æ™‚é–“</strong>
                <span style="color: #666; font-size: 14px; margin-left: 10px;">(${dayActuals.length}ä»¶)</span>
            </div>
        `;
        
        document.getElementById('modalBody').innerHTML = html;
        document.getElementById('workModal').style.display = 'block';
    }

    function closeWorkModal() {
        document.getElementById('workModal').style.display = 'none';
    }

    function editActual(id) {
        const actual = actuals.find(a => a.id === id);
        if (!actual) {
            alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
        document.getElementById('editActualId').value = id;
        document.getElementById('editActualDate').value = actual.date;
        document.getElementById('editActualVersion').value = actual.version;
        document.getElementById('editActualTaskSearch').value = actual.task;
        document.getElementById('editActualProcess').value = actual.process;
        document.getElementById('editActualHours').value = actual.hours;
        
        // å¯¾å¿œåãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
        const taskDatalist = document.getElementById('editActualTaskList');
        taskDatalist.innerHTML = '';
        const uniqueTasks = [...new Set([...estimates.map(e => e.task), ...actuals.map(a => a.task)])];
        uniqueTasks.sort().forEach(task => {
            const option = document.createElement('option');
            option.value = task;
            taskDatalist.appendChild(option);
        });
        
        // æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
        const memberSelect = document.getElementById('editActualMember');
        const allMembers = new Set();
        estimates.forEach(e => allMembers.add(e.member));
        actuals.forEach(a => allMembers.add(a.member));
        
        let sortedMembers;
        const memberOrderInput = document.getElementById('memberOrder').value.trim();
        if (memberOrderInput) {
            const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
            const orderedMembers = [];
            const unorderedMembers = [];
            
            orderList.forEach(name => {
                if (allMembers.has(name)) {
                    orderedMembers.push(name);
                }
            });
            
            Array.from(allMembers).forEach(m => {
                if (!orderedMembers.includes(m)) {
                    unorderedMembers.push(m);
                }
            });
            
            sortedMembers = [...orderedMembers, ...unorderedMembers.sort()];
        } else {
            sortedMembers = Array.from(allMembers).sort();
        }
        
        memberSelect.innerHTML = '';
        sortedMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member;
            option.textContent = member;
            memberSelect.appendChild(option);
        });
        
        memberSelect.value = actual.member;
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        document.getElementById('editActualModal').style.display = 'block';
    }

    function closeEditActualModal() {
        document.getElementById('editActualModal').style.display = 'none';
    }

    function saveActualEdit() {
        const id = parseFloat(document.getElementById('editActualId').value);
        const date = document.getElementById('editActualDate').value;
        const version = document.getElementById('editActualVersion').value;
        const task = document.getElementById('editActualTaskSearch').value;
        const process = document.getElementById('editActualProcess').value;
        const member = document.getElementById('editActualMember').value;
        const hours = parseFloat(document.getElementById('editActualHours').value);
        
        if (!date || !version || !task || !process || !member || !hours) {
            alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        const actualIndex = actuals.findIndex(a => a.id === id);
        if (actualIndex !== -1) {
            actuals[actualIndex] = {
                ...actuals[actualIndex],
                date: date,
                version: version,
                task: task,
                process: process,
                member: member,
                hours: hours
            };
            
            saveData();
            closeEditActualModal();
            
            updateMonthOptions();
            updateActualMonthOptions();
            updateMemberOptions();
            updateQuickTaskList();
            renderTodayActuals();
            renderActualList();
            updateReport();
            
            alert('å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        } else {
            alert('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    }

    function editEstimate(id) {
        const estimate = estimates.find(e => e.id === id);
        if (!estimate) {
            alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
        document.getElementById('editEstimateId').value = id;
        document.getElementById('editEstimateVersion').value = estimate.version;
        document.getElementById('editEstimateTaskSearch').value = estimate.task;
        document.getElementById('editEstimateProcess').value = estimate.process;
        document.getElementById('editEstimateHours').value = estimate.hours;
        
        // å¯¾å¿œåãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
        const taskDatalist = document.getElementById('editEstimateTaskList');
        taskDatalist.innerHTML = '';
        const uniqueTasks = [...new Set([...estimates.map(e => e.task), ...actuals.map(a => a.task)])];
        uniqueTasks.sort().forEach(task => {
            const option = document.createElement('option');
            option.value = task;
            taskDatalist.appendChild(option);
        });
        
        // æ‹…å½“è€…é¸æŠè‚¢ã‚’æ›´æ–°
        const memberSelect = document.getElementById('editEstimateMember');
        const allMembers = new Set();
        estimates.forEach(e => allMembers.add(e.member));
        actuals.forEach(a => allMembers.add(a.member));
        
        let sortedMembers;
        const memberOrderInput = document.getElementById('memberOrder').value.trim();
        if (memberOrderInput) {
            const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
            const orderedMembers = [];
            const unorderedMembers = [];
            
            orderList.forEach(name => {
                if (allMembers.has(name)) {
                    orderedMembers.push(name);
                }
            });
            
            Array.from(allMembers).forEach(m => {
                if (!orderedMembers.includes(m)) {
                    unorderedMembers.push(m);
                }
            });
            
            sortedMembers = [...orderedMembers, ...unorderedMembers.sort()];
        } else {
            sortedMembers = Array.from(allMembers).sort();
        }
        
        memberSelect.innerHTML = '';
        sortedMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member;
            option.textContent = member;
            memberSelect.appendChild(option);
        });
        
        memberSelect.value = estimate.member;
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        document.getElementById('editEstimateModal').style.display = 'block';
    }

    function closeEditEstimateModal() {
        document.getElementById('editEstimateModal').style.display = 'none';
    }

    function saveEstimateEdit() {
        const id = parseFloat(document.getElementById('editEstimateId').value);
        const version = document.getElementById('editEstimateVersion').value;
        const task = document.getElementById('editEstimateTaskSearch').value;
        const process = document.getElementById('editEstimateProcess').value;
        const member = document.getElementById('editEstimateMember').value;
        const hours = parseFloat(document.getElementById('editEstimateHours').value);
        
        if (!version || !task || !process || !member || !hours) {
            alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        const estimateIndex = estimates.findIndex(e => e.id === id);
        if (estimateIndex !== -1) {
            estimates[estimateIndex] = {
                ...estimates[estimateIndex],
                version: version,
                task: task,
                process: process,
                member: member,
                hours: hours
            };
            
            saveData();
            closeEditEstimateModal();
            
            updateMemberOptions();
            updateQuickTaskList();
            renderEstimateList();
            updateReport();
            
            alert('è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        } else {
            alert('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    }

    function handleActualTaskInput() {
        // å¯¾å¿œåå…¥åŠ›æ™‚ã®å‡¦ç†ï¼ˆå°†æ¥çš„ã«æ‹¡å¼µå¯èƒ½ï¼‰
    }

    function handleEstimateTaskInput() {
        // å¯¾å¿œåå…¥åŠ›æ™‚ã®å‡¦ç†ï¼ˆå°†æ¥çš„ã«æ‹¡å¼µå¯èƒ½ï¼‰
    }

    function showMemberOrderHelp() {
        alert('æ‹…å½“è€…ã®è¡¨ç¤ºé †ã‚’æŒ‡å®šã§ãã¾ã™ã€‚\n\nä¾‹:\nA,B,C,D\nå±±ç”°,ä½è—¤,ç”°ä¸­\n\nãƒ»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›\nãƒ»æŒ‡å®šã—ãŸé †ç•ªã§è¡¨ç¤ºã•ã‚Œã¾ã™\nãƒ»æŒ‡å®šã—ã¦ã„ãªã„æ‹…å½“è€…ã¯å¾Œã‚ã«ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã§è¡¨ç¤ºã•ã‚Œã¾ã™');
    }

    function updateAllDisplays() {
        saveData();
        updateMemberOptions();
        renderActualList();
        updateReport();
        alert('è¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸ');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
    function handleModalClose(event) {
        const workModal = document.getElementById('workModal');
        const editActualModal = document.getElementById('editActualModal');
        const editEstimateModal = document.getElementById('editEstimateModal');
        
        if (event.target === workModal) {
            closeWorkModal();
        }
        if (event.target === editActualModal) {
            closeEditActualModal();
        }
        if (event.target === editEstimateModal) {
            closeEditEstimateModal();
        }
    }
    
    window.onclick = handleModalClose;
    window.ontouchend = handleModalClose;

    function updateReport() {
        const selectedMonth = document.getElementById('reportMonth').value;
        const viewType = document.getElementById('reportViewType').value;
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        let filteredActuals = actuals;
        if (selectedMonth !== 'all') {
            filteredActuals = actuals.filter(a => a.date && a.date.startsWith(selectedMonth));
        }
        
        // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
        const titleElement = document.getElementById('reportPeriodTitle');
        if (selectedMonth === 'all') {
            titleElement.textContent = 'å…¨æœŸé–“ã®é›†è¨ˆ';
        } else {
            const [year, month] = selectedMonth.split('-');
            titleElement.textContent = `${year}å¹´${month}æœˆã®é›†è¨ˆ`;
        }
        
        const totalEst = estimates.reduce((sum, e) => sum + e.hours, 0);
        const totalAct = filteredActuals.reduce((sum, a) => sum + a.hours, 0);
        const diff = totalAct - totalEst;
        const rate = totalEst > 0 ? (totalAct / totalEst * 100).toFixed(1) : 0;

        document.getElementById('totalEstimate').textContent = totalEst.toFixed(1) + 'h';
        document.getElementById('totalActual').textContent = totalAct.toFixed(1) + 'h';
        document.getElementById('totalDiff').textContent = (diff >= 0 ? '+' : '') + diff.toFixed(1) + 'h';
        document.getElementById('actualRate').textContent = rate + '%';

        // è©³ç´°ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        if (viewType === 'grouped') {
            renderReportGrouped(filteredActuals);
        } else if (viewType === 'matrix') {
            renderReportMatrix(filteredActuals);
        } else {
            document.getElementById('reportDetailView').innerHTML = '';
        }

        renderMemberReport(filteredActuals);
        renderVersionReport(filteredActuals);
    }

    function renderReportGrouped(filteredActuals) {
        const container = document.getElementById('reportDetailView');
        
        // ç‰ˆæ•°ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const versionGroups = {};
        
        // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        estimates.forEach(e => {
            if (!versionGroups[e.version]) {
                versionGroups[e.version] = {};
            }
            const taskKey = e.task;
            if (!versionGroups[e.version][taskKey]) {
                versionGroups[e.version][taskKey] = {
                    task: e.task,
                    estimates: {},
                    actuals: {}
                };
            }
            if (!versionGroups[e.version][taskKey].estimates[e.process]) {
                versionGroups[e.version][taskKey].estimates[e.process] = { members: new Set(), hours: 0 };
            }
            versionGroups[e.version][taskKey].estimates[e.process].members.add(e.member);
            versionGroups[e.version][taskKey].estimates[e.process].hours += e.hours;
        });
        
        // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆæ‹…å½“è€…ã‚‚é›†è¨ˆï¼‰
        filteredActuals.forEach(a => {
            if (!versionGroups[a.version]) {
                versionGroups[a.version] = {};
            }
            const taskKey = a.task;
            if (!versionGroups[a.version][taskKey]) {
                versionGroups[a.version][taskKey] = {
                    task: a.task,
                    estimates: {},
                    actuals: {}
                };
            }
            if (!versionGroups[a.version][taskKey].actuals[a.process]) {
                versionGroups[a.version][taskKey].actuals[a.process] = { members: new Set(), hours: 0 };
            }
            versionGroups[a.version][taskKey].actuals[a.process].members.add(a.member);
            versionGroups[a.version][taskKey].actuals[a.process].hours += a.hours;
        });
        
        let html = '<h3 style="margin-top: 30px;">å¯¾å¿œåˆ¥è©³ç´°ï¼ˆè¦‹ç© vs å®Ÿç¸¾ï¼‰</h3>';
        html += '<div style="margin-bottom: 30px;">';
        
        // ç‰ˆæ•°ã”ã¨ã«è¡¨ç¤º
        Object.keys(versionGroups).sort().forEach(version => {
            html += `<div style="margin-bottom: 30px;">`;
            html += `<h3 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border-radius: 8px; margin: 0 0 15px 0; font-size: 18px;">${version}</h3>`;
            html += '<div class="table-wrapper"><table>';
            html += '<tr><th style="min-width: 150px; max-width: 200px;">å¯¾å¿œå</th><th style="min-width: 80px;">å·¥ç¨‹</th><th style="min-width: 80px;">æ‹…å½“</th><th style="min-width: 80px;">è¦‹ç©</th><th style="min-width: 80px;">å®Ÿç¸¾</th><th style="min-width: 80px;">å·®ç•°</th><th style="min-width: 100px;">å¯¾å¿œåˆè¨ˆ</th></tr>';
            
            Object.values(versionGroups[version]).forEach(taskGroup => {
                const processOrder = ['UI', 'PG', 'PT', 'IT', 'ST'];
                const allProcesses = new Set([...Object.keys(taskGroup.estimates), ...Object.keys(taskGroup.actuals)]);
                const sortedProcesses = processOrder.filter(p => allProcesses.has(p));
                
                if (sortedProcesses.length === 0) return;
                
                let totalEst = 0;
                let totalAct = 0;
                
                sortedProcesses.forEach((proc, index) => {
                    const est = taskGroup.estimates[proc] || { members: new Set(), hours: 0 };
                    const act = taskGroup.actuals[proc] || { members: new Set(), hours: 0 };
                    const diff = act.hours - est.hours;
                    
                    totalEst += est.hours;
                    totalAct += act.hours;
                    
                    // å®Ÿç¸¾ãƒ™ãƒ¼ã‚¹ã§æ‹…å½“è€…ã‚’è¡¨ç¤ºï¼ˆå®Ÿç¸¾ãŒãªã‘ã‚Œã°è¦‹ç©ï¼‰
                    let memberDisplay = '-';
                    if (act.members.size > 0) {
                        memberDisplay = Array.from(act.members).join(',');
                    } else if (est.members.size > 0) {
                        memberDisplay = Array.from(est.members).join(',');
                    }
                    
                    html += '<tr>';
                    if (index === 0) {
                        html += `<td rowspan="${sortedProcesses.length}" style="vertical-align: top; padding-top: 12px; font-weight: 600; word-break: break-word; max-width: 200px;">${taskGroup.task}</td>`;
                    }
                    html += `<td><span class="badge badge-${proc.toLowerCase()}">${proc}</span></td>`;
                    html += `<td style="word-break: break-word;">${memberDisplay}</td>`;
                    html += `<td style="text-align: right;">${est.hours > 0 ? est.hours.toFixed(1) + 'h' : '-'}</td>`;
                    html += `<td style="text-align: right;">${act.hours > 0 ? act.hours.toFixed(1) + 'h' : '-'}</td>`;
                    html += `<td style="text-align: right; color: ${diff > 0 ? '#e74c3c' : diff < 0 ? '#27ae60' : '#666'}">${diff !== 0 ? (diff > 0 ? '+' : '') + diff.toFixed(1) + 'h' : '-'}</td>`;
                    if (index === 0) {
                        const totalDiff = totalAct - totalEst;
                        html += `<td rowspan="${sortedProcesses.length}" style="vertical-align: top; padding-top: 12px; text-align: right;">
                            <div style="font-weight: 600;">è¦‹ç©: ${totalEst.toFixed(1)}h</div>
                            <div style="font-weight: 600;">å®Ÿç¸¾: ${totalAct.toFixed(1)}h</div>
                            <div style="font-weight: 700; color: ${totalDiff > 0 ? '#e74c3c' : totalDiff < 0 ? '#27ae60' : '#666'}">å·®ç•°: ${totalDiff > 0 ? '+' : ''}${totalDiff.toFixed(1)}h</div>
                        </td>`;
                    }
                    html += '</tr>';
                });
            });
            
            html += '</table></div>';
            html += '</div>';
        });
        
        html += '</div>';
        container.innerHTML = html;
    }

    function renderReportMatrix(filteredActuals) {
        const container = document.getElementById('reportDetailView');
        
        // ç‰ˆæ•°ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const versionGroups = {};
        
        // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        estimates.forEach(e => {
            if (!versionGroups[e.version]) {
                versionGroups[e.version] = {};
            }
            const taskKey = e.task;
            if (!versionGroups[e.version][taskKey]) {
                versionGroups[e.version][taskKey] = {
                    task: e.task,
                    estimates: {},
                    actuals: {}
                };
            }
            versionGroups[e.version][taskKey].estimates[e.process] = { member: e.member, hours: e.hours };
        });
        
        // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        filteredActuals.forEach(a => {
            if (!versionGroups[a.version]) {
                versionGroups[a.version] = {};
            }
            const taskKey = a.task;
            if (!versionGroups[a.version][taskKey]) {
                versionGroups[a.version][taskKey] = {
                    task: a.task,
                    estimates: {},
                    actuals: {}
                };
            }
            if (!versionGroups[a.version][taskKey].actuals[a.process]) {
                versionGroups[a.version][taskKey].actuals[a.process] = { member: a.member, hours: 0 };
            }
            versionGroups[a.version][taskKey].actuals[a.process].hours += a.hours;
        });
        
        const processOrder = ['UI', 'PG', 'PT', 'IT', 'ST'];
        
        let html = '<h3 style="margin-top: 30px;">å¯¾å¿œåˆ¥ãƒãƒˆãƒªã‚¯ã‚¹ï¼ˆè¦‹ç© vs å®Ÿç¸¾ï¼‰</h3>';
        html += '<div style="margin-bottom: 30px;">';
        
        // ç‰ˆæ•°ã”ã¨ã«è¡¨ç¤º
        Object.keys(versionGroups).sort().forEach(version => {
            html += `<div style="margin-bottom: 30px;">`;
            html += `<h3 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border-radius: 8px; margin: 0 0 15px 0; font-size: 18px;">${version}</h3>`;
            html += '<div class="table-wrapper"><table>';
            html += '<tr><th style="min-width: 200px;">å¯¾å¿œå</th>';
            processOrder.forEach(proc => {
                html += `<th style="min-width: 120px; text-align: center;">${proc}<br><small style="font-weight: normal; opacity: 0.8;">è¦‹ç©/å®Ÿç¸¾</small></th>`;
            });
            html += '<th style="min-width: 100px; text-align: center;">åˆè¨ˆ<br><small style="font-weight: normal; opacity: 0.8;">è¦‹ç©/å®Ÿç¸¾</small></th></tr>';
            
            Object.values(versionGroups[version]).forEach(taskGroup => {
                html += '<tr>';
                html += `<td style="font-weight: 600;">${taskGroup.task}</td>`;
                
                let totalEst = 0;
                let totalAct = 0;
                
                processOrder.forEach(proc => {
                    const est = taskGroup.estimates[proc] || { member: '-', hours: 0 };
                    const act = taskGroup.actuals[proc] || { member: '-', hours: 0 };
                    
                    totalEst += est.hours;
                    totalAct += act.hours;
                    
                    if (est.hours > 0 || act.hours > 0) {
                        const diff = act.hours - est.hours;
                        html += `<td style="text-align: center;">
                            <div style="font-weight: 600;">${est.hours > 0 ? est.hours.toFixed(1) : '-'} / ${act.hours > 0 ? act.hours.toFixed(1) : '-'}</div>
                            <div style="font-size: 11px; color: #666;">(${est.member !== '-' ? est.member : act.member})</div>
                            <div style="font-size: 11px; color: ${diff > 0 ? '#e74c3c' : diff < 0 ? '#27ae60' : '#666'}">${diff !== 0 ? (diff > 0 ? '+' : '') + diff.toFixed(1) : '-'}</div>
                        </td>`;
                    } else {
                        html += `<td style="text-align: center; color: #ccc;">-</td>`;
                    }
                });
                
                const totalDiff = totalAct - totalEst;
                html += `<td style="text-align: center;">
                    <div style="font-weight: 700;">${totalEst.toFixed(1)} / ${totalAct.toFixed(1)}</div>
                    <div style="font-weight: 700; color: ${totalDiff > 0 ? '#e74c3c' : totalDiff < 0 ? '#27ae60' : '#666'}">${totalDiff > 0 ? '+' : ''}${totalDiff.toFixed(1)}</div>
                </td>`;
                html += '</tr>';
            });
            
            html += '</table></div>';
            html += '</div>';
        });
        
        html += '</div>';
        container.innerHTML = html;
    }

    function renderMemberReport(filteredActuals) {
        // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã¨å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ‹…å½“è€…ã‚’å‹•çš„ã«æŠ½å‡º
        const allMembers = new Set();
        estimates.forEach(e => allMembers.add(e.member));
        filteredActuals.forEach(a => allMembers.add(a.member));
        
        // è¡¨ç¤ºé †ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
        let members;
        const memberOrderInput = document.getElementById('memberOrder').value.trim();
        if (memberOrderInput) {
            const orderList = memberOrderInput.split(',').map(m => m.trim()).filter(m => m);
            const orderedMembers = [];
            const unorderedMembers = [];
            
            // æŒ‡å®šã•ã‚ŒãŸé †åºã§è¿½åŠ 
            orderList.forEach(name => {
                if (allMembers.has(name)) {
                    orderedMembers.push(name);
                }
            });
            
            // æŒ‡å®šã•ã‚Œã¦ã„ãªã„æ‹…å½“è€…ã‚’å¾Œã‚ã«è¿½åŠ 
            Array.from(allMembers).forEach(m => {
                if (!orderedMembers.includes(m)) {
                    unorderedMembers.push(m);
                }
            });
            
            members = [...orderedMembers, ...unorderedMembers.sort()];
        } else {
            members = Array.from(allMembers).sort();
        }
        
        if (members.length === 0) {
            document.getElementById('memberReport').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }
        
        let html = '<div class="table-wrapper"><table><tr><th>æ‹…å½“è€…</th><th>è¦‹ç©å·¥æ•°</th><th>å®Ÿç¸¾å·¥æ•°</th><th>å·®ç•°</th><th>å·®ç•°ç‡</th></tr>';

        members.forEach(member => {
            const est = estimates.filter(e => e.member === member).reduce((sum, e) => sum + e.hours, 0);
            const act = filteredActuals.filter(a => a.member === member).reduce((sum, a) => sum + a.hours, 0);
            const diff = act - est;
            const rate = est > 0 ? ((diff / est) * 100).toFixed(1) : 0;

            html += `
                <tr>
                    <td><strong>${member}</strong></td>
                    <td>${est.toFixed(1)}h</td>
                    <td>${act.toFixed(1)}h</td>
                    <td style="color: ${diff >= 0 ? '#e74c3c' : '#27ae60'}">${(diff >= 0 ? '+' : '')}${diff.toFixed(1)}h</td>
                    <td>${rate}%</td>
                </tr>
            `;
        });

        html += '</table></div>';
        document.getElementById('memberReport').innerHTML = html;
    }

    function renderVersionReport(filteredActuals) {
        const versions = [...new Set(estimates.map(e => e.version))];
        let html = '<div class="table-wrapper"><table><tr><th>ç‰ˆæ•°</th><th>è¦‹ç©å·¥æ•°</th><th>å®Ÿç¸¾å·¥æ•°</th><th>é€²æ—ç‡</th></tr>';

        versions.forEach(version => {
            const est = estimates.filter(e => e.version === version).reduce((sum, e) => sum + e.hours, 0);
            const act = filteredActuals.filter(a => a.version === version).reduce((sum, a) => sum + a.hours, 0);
            const progress = est > 0 ? (act / est * 100).toFixed(1) : 0;

            html += `
                <tr>
                    <td><strong>${version}</strong></td>
                    <td>${est.toFixed(1)}h</td>
                    <td>${act.toFixed(1)}h</td>
                    <td>${progress}%</td>
                </tr>
            `;
        });

        html += '</table></div>';
        document.getElementById('versionReport').innerHTML = html;
    }

    function deleteEstimate(id) {
        if (!confirm('ã“ã®è¦‹ç©ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) return;
        estimates = estimates.filter(e => e.id !== id);
        saveData();
        renderEstimateList();
        updateQuickTaskList();
        updateReport();
        alert('è¦‹ç©ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }

    function deleteActual(id) {
        if (!confirm('ã“ã®å®Ÿç¸¾ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) return;
        actuals = actuals.filter(a => a.id !== id);
        saveData();
        updateMonthOptions();
        renderActualList();
        renderTodayActuals();
        updateReport();
        alert('å®Ÿç¸¾ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }

    function exportBackup() {
        autoBackup();
        alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ');
    }

    function importBackup() {
        document.getElementById('fileInput').click();
    }

    function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const fileName = file.name.toLowerCase();
        
        if (fileName.endsWith('.json')) {
            // JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ãŸãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) {
                        estimates = data.estimates || [];
                        actuals = data.actuals || [];
                        
                        // æ‹…å½“è€…è¡¨ç¤ºé †ã‚’å¾©å…ƒ
                        if (data.memberOrder) {
                            document.getElementById('memberOrder').value = data.memberOrder;
                            localStorage.setItem('manhour_memberOrder', data.memberOrder);
                        }
                        
                        saveData(true); // å¾©å…ƒæ™‚ã¯è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—
                        
                        updateMonthOptions();
                        updateActualMonthOptions();
                        updateMemberOptions();
                        updateQuickTaskList();
                        renderEstimateList();
                        renderActualList();
                        renderTodayActuals();
                        updateReport();
                        
                        alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            };
            reader.readAsText(file);
        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            // Excelãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
            handleExcelImport(file);
        } else {
            alert('å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚JSON ã¾ãŸã¯ Excel ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        }
        
        event.target.value = '';
    }

    async function handleExcelImport(file) {
        try {
            const arrayBuffer = await file.arrayBuffer();
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(arrayBuffer);
            
            const estimatesSheet = workbook.getWorksheet('è¦‹ç©ãƒ‡ãƒ¼ã‚¿');
            const actualsSheet = workbook.getWorksheet('å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿');
            
            if (!estimatesSheet || !actualsSheet) {
                alert('Excelãƒ•ã‚¡ã‚¤ãƒ«ã«ã€Œè¦‹ç©ãƒ‡ãƒ¼ã‚¿ã€ã¨ã€Œå®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã€ã®ã‚·ãƒ¼ãƒˆãŒå¿…è¦ã§ã™');
                return;
            }
            
            // è¦‹ç©ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
            const newEstimates = [];
            estimatesSheet.eachRow((row, rowNumber) => {
                if (rowNumber === 1) return; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                
                const version = row.getCell(1).value;
                const task = row.getCell(2).value;
                const process = row.getCell(3).value;
                const member = row.getCell(4).value;
                const hours = parseFloat(row.getCell(5).value);
                
                if (version && task && process && member && hours) {
                    newEstimates.push({
                        id: Date.now() + Math.random(),
                        version: String(version),
                        task: String(task),
                        process: String(process),
                        member: String(member),
                        hours: hours,
                        createdAt: new Date().toISOString()
                    });
                }
            });
            
            // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
            const newActuals = [];
            actualsSheet.eachRow((row, rowNumber) => {
                if (rowNumber === 1) return; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                
                const dateValue = row.getCell(1).value;
                const version = row.getCell(2).value;
                const task = row.getCell(3).value;
                const process = row.getCell(4).value;
                const member = row.getCell(5).value;
                const hours = parseFloat(row.getCell(6).value);
                
                // æ—¥ä»˜ã®å‡¦ç†
                let dateStr = '';
                if (dateValue instanceof Date) {
                    dateStr = dateValue.toISOString().split('T')[0];
                } else if (typeof dateValue === 'string') {
                    dateStr = dateValue;
                } else if (typeof dateValue === 'number') {
                    // Excel ã®ã‚·ãƒªã‚¢ãƒ«å€¤ã‚’æ—¥ä»˜ã«å¤‰æ›
                    const date = new Date((dateValue - 25569) * 86400 * 1000);
                    dateStr = date.toISOString().split('T')[0];
                }
                
                if (dateStr && version && task && process && member && hours) {
                    newActuals.push({
                        id: Date.now() + Math.random(),
                        date: dateStr,
                        version: String(version),
                        task: String(task),
                        process: String(process),
                        member: String(member),
                        hours: hours,
                        createdAt: new Date().toISOString()
                    });
                }
            });
            
            if (newEstimates.length === 0 && newActuals.length === 0) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚Excelã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (confirm(`è¦‹ç©: ${newEstimates.length}ä»¶ã€å®Ÿç¸¾: ${newActuals.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) {
                estimates = newEstimates;
                actuals = newActuals;
                saveData(true); // å¾©å…ƒæ™‚ã¯è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—
                
                updateMonthOptions();
                updateActualMonthOptions();
                updateMemberOptions();
                updateQuickTaskList();
                renderEstimateList();
                renderActualList();
                renderTodayActuals();
                updateReport();
                
                alert('Excelãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
            }
            
        } catch (error) {
            console.error('Excelèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            alert('Excelãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
    }
</script>

</body>
</html>